<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>お問い合わせ | nihongotext.com</title>

  <link rel="preconnect" href="https://www.google.com" />
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin />

  <style>
    :root { --accent:#d33; --bg:#fff; --fg:#222; --muted:#666; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif; color:var(--fg); background:var(--bg); }
    header, footer { padding:16px; border-bottom:1px solid #eee; }
    footer { border-top:1px solid #eee; border-bottom:0; }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand { font-weight:700; font-size:20px; color:var(--accent); cursor:pointer; }
    .muted { color:var(--muted); }
    .lang-toggle button { border:1px solid #eee; background:#fafafa; padding:6px 10px; border-radius:8px; cursor:pointer; }
    main { max-width:880px; margin:24px auto; padding:0 16px 48px; display:grid; gap:28px; }
    .card { border:1px solid #eee; border-radius:16px; padding:18px; box-shadow:0 2px 8px rgba(0,0,0,.04); background:#fff; }
    .card h2 { margin:0 0 12px; font-size:22px; }
    label { display:block; font-size:14px; margin:10px 0 6px; color:var(--muted); }
    input[type="text"], input[type="email"], textarea {
      width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; font-size:16px; outline:none; background:#fff;
    }
    textarea { min-height:144px; resize:vertical; }
    .actions { margin-top:14px; display:flex; align-items:center; gap:12px; }
    .btn {
      appearance:none; border:none; border-radius:999px; padding:10px 18px; font-size:16px;
      background:var(--accent); color:#fff; cursor:pointer; box-shadow:0 2px 6px rgba(211,51,51,.35);
    }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .msg { margin-top:10px; font-size:14px; }
    .msg.ok { color:#0a7d33; }
    .msg.ng { color:#b00020; }
    .small-log { margin-top:10px; font-size:12px; color:#888; padding:8px 10px; background:#fafafa; border:1px dashed #eee; border-radius:8px; word-break:break-all; }
  </style>

  <!-- reCAPTCHA v2 (checkbox) - explicit render ONLY -->
  <script>
    // ====== guard: avoid double render ======
    window.__recaptchaReadyFired = false;
    function onRecaptchaReady(){
      if (window.__recaptchaReadyFired) return;
      window.__recaptchaReadyFired = true;
      try {
        if (window.grecaptcha && document.getElementById('recaptcha-container')) {
          window.__recaptchaWidgetId = window.grecaptcha.render('recaptcha-container', {
            sitekey: window.SITE_KEY,
            theme: 'light',
            size: 'normal'
          });
          logLine('recaptcha rendered, wid: ' + window.__recaptchaWidgetId);
        } else {
          logLine('recaptcha not rendered (grecaptcha or container missing)');
        }
      } catch(e){
        logLine('recaptcha render error: ' + String(e));
      }
    }
  </script>
  <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaReady&render=explicit" async defer></script>
</head>
<body>
  <header>
    <div class="row">
      <div class="brand" onclick="location.href='/'">nihongotext<span class="muted">.com</span></div>
      <div class="lang-toggle">
        <button id="langBtn" type="button" aria-label="Toggle language">日本語 / English</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Contact only -->
    <section class="card" id="contactCard">
      <h2 id="h_contact">お問い合わせ</h2>

      <label for="name" id="lb_name">お名前</label>
      <input id="name" type="text" autocomplete="name" />

      <label for="email" id="lb_email">メールアドレス</label>
      <input id="email" type="email" autocomplete="email" />

      <label for="subject" id="lb_subject">件名</label>
      <input id="subject" type="text" />

      <label for="message" id="lb_message">メッセージ</label>
      <textarea id="message"></textarea>

      <div id="captchaBox" style="margin-top:12px;">
        <div id="recaptcha-container" aria-label="reCAPTCHA"></div>
      </div>

      <div class="actions">
        <button class="btn" id="sendBtn" type="button">送信</button>
        <span id="status" class="msg" role="status" aria-live="polite"></span>
      </div>

      <!-- simple diagnostics -->
      <div id="miniLog" class="small-log" aria-live="polite"></div>
    </section>
  </main>

  <footer>
    <div class="muted">© <span id="yy"></span> nihongotext.com</div>
  </footer>

  <script>
    // ====== 固定値（必要なら差し替え） ======
    // 最新の GAS Web アプリ URL を指定
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";
    // reCAPTCHA v2 のサイトキー（管理画面の値）
    const SITE_KEY   = "6LcRKvArAAAAAFYmY21y9o_hwTszHwzp3bgRXtBV";
    window.SITE_KEY  = SITE_KEY; // onRecaptchaReady から参照

    // ====== 便利関数 ======
    const $ = (q)=> document.querySelector(q);
    function setMsgOk(msg){ const s=$("#status"); s.className="msg ok"; s.textContent=msg; }
    function setMsgNg(msg){ const s=$("#status"); s.className="msg ng"; s.textContent=msg; }
    function clearMsg(){ const s=$("#status"); s.className="msg"; s.textContent=""; }
    function logLine(m){
      const box = $("#miniLog");
      const host = location.host;
      box.textContent = `host: ${host} | ${m}`;
      // console へも出す
      try { console.log('[inquiry]', m); } catch(_){}
    }

    // ====== 言語テキスト ======
    const t = {
      ja: {
        contact:"お問い合わせ", name:"お名前", email:"メールアドレス", subject:"件名", message:"メッセージ",
        send:"送信",
        sent_ok:"送信しました。自動返信メールをご確認ください。",
        sent_ng:"送信できませんでした。しばらくしてから再度お試しください。",
        captcha_needed:"reCAPTCHA をチェックしてください。"
      },
      en: {
        contact:"Contact", name:"Name", email:"Email", subject:"Subject", message:"Message",
        send:"Send",
        sent_ok:"Your message has been sent. Please check the auto-reply.",
        sent_ng:"Failed to send. Please try again in a moment.",
        captcha_needed:"Please complete reCAPTCHA."
      }
    };
    let lang = "ja";
    function applyLang(){
      $("#h_contact").textContent = t[lang].contact;
      $("#lb_name").textContent   = t[lang].name;
      $("#lb_email").textContent  = t[lang].email;
      $("#lb_subject").textContent= t[lang].subject;
      $("#lb_message").textContent= t[lang].message;
      $("#sendBtn").textContent   = t[lang].send;
    }
    $("#langBtn").addEventListener("click", ()=>{ lang = (lang==="ja")?"en":"ja"; applyLang(); });

    // ====== JSONP helper（CORSを避ける） ======
    function jsonp(url, cbname, onerr){
      const s = document.createElement('script');
      s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + encodeURIComponent(cbname) + '&_ts=' + Date.now();
      s.async = true;
      s.onerror = () => onerr && onerr(new Error('jsonp_load_failed'));
      (document.head || document.documentElement).appendChild(s);
    }

    // ====== 送信処理 ======
    $("#sendBtn").addEventListener("click", function(){
      clearMsg();
      const btn = this;
      btn.disabled = true;

      const wid   = window.__recaptchaWidgetId;
      const token = (window.grecaptcha && wid!=null) ? window.grecaptcha.getResponse(wid) : "";
      if (!token) { setMsgNg(t[lang].captcha_needed); btn.disabled=false; return; }

      const name    = $("#name").value.trim();
      const email   = $("#email").value.trim();
      const subject = $("#subject").value.trim();
      const message = $("#message").value.trim();
      if (!message){ setMsgNg(t[lang].sent_ng); btn.disabled=false; window.grecaptcha.reset(wid); return; }

      const params = new URLSearchParams({ mode:'contact_submit', name, email, subject, message, token });

      const cbname = 'cb_' + Math.random().toString(36).slice(2);
      window[cbname] = function(res){
        try{
          if (res && res.ok) {
            setMsgOk(t[lang].sent_ok);
            $("#message").value = "";
          } else {
            const reason = (res && res.reason) ? res.reason : 'unknown';
            setMsgNg(`${t[lang].sent_ng} (${reason})`);
          }
        } finally {
          btn.disabled = false;
          try { window.grecaptcha.reset(wid); } catch(_){}
          delete window[cbname];
        }
      };

      jsonp(`${SCRIPT_URL}?${params.toString()}`, cbname, ()=>{
        setMsgNg(t[lang].sent_ng);
        btn.disabled=false;
        try { window.grecaptcha.reset(wid); } catch(_){}
        delete window[cbname];
      });
    });

    // ====== 起動時処理 ======
    (function boot(){
      // 年号
      $("#yy").textContent = String(new Date().getFullYear());
      applyLang();

      // --- SW / Cache の影響を排除（非同期・失敗は無視） ---
      try {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister()));
        }
        if ('caches' in window) {
          caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
        }
      } catch(_) {}

      // 状態表示
      logLine('grecaptcha: ' + (window.grecaptcha ? 'present' : 'not loaded'));
    })();
  </script>
</body>
</html>
