<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    :root{--accent:#ee3d2d}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;background:#fff7f6;margin:0}
    header,footer{max-width:980px;margin:0 auto;padding:12px 16px}
    main{max-width:980px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04);padding:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 260px}
    label{display:block;font-size:.9rem;margin:10px 0 6px}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:8px;padding:10px 12px;font-size:1rem;background:#fff}
    textarea{min-height:140px;resize:vertical}
    .actions{display:flex;align-items:center;gap:12px;margin-top:14px}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:999px;padding:10px 18px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .lang{display:flex;gap:8px;justify-content:flex-end}
    .pill{border:1px solid #ddd;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
    .pill.active{border-color:var(--accent);color:var(--accent);font-weight:700}
    .note{font-size:.85rem;color:#555;margin-top:6px}
    .status{margin-top:14px;border-radius:10px;padding:12px;font-size:.95rem;display:none}
    .ok{background:#edf9f1;color:#1e7e34;border:1px solid #c9eed7}
    .ng{background:#fff1f0;color:#b00020;border:1px solid #ffd5d1}
    .hint{font-size:.8rem;color:#777;margin-top:6px;line-height:1.5}
    .recwrap{display:flex;align-items:center;gap:12px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="row" style="align-items:center;">
      <div style="font-weight:800;color:#222;font-size:1.1rem;">nihongotext.com <span style="opacity:.6;font-weight:600">== beta version ==</span></div>
      <div class="lang" style="margin-left:auto">
        <button id="jaBtn" class="pill active">日本語</button>
        <button id="enBtn" class="pill">English</button>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <h2 id="t_title">お問い合わせ</h2>

      <form id="f" autocomplete="on">
        <div class="row">
          <div class="col">
            <label for="name" id="t_name">お名前</label>
            <input id="name" name="name" inputmode="text" />
          </div>
          <div class="col">
            <label for="email" id="t_email">メール</label>
            <input id="email" name="email" type="email" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="subject" id="t_subject">件名</label>
            <input id="subject" name="subject" />
          </div>
          <div class="col">
            <label for="category" id="t_category">カテゴリ</label>
            <select id="category" name="category">
              <option value="general">一般 / General</option>
              <option value="bug">不具合 / Bug</option>
              <option value="request">要望 / Request</option>
            </select>
          </div>
        </div>

        <div>
          <label for="message" id="t_message">内容</label>
          <textarea id="message" name="message"></textarea>
        </div>

        <div class="recwrap">
          <div id="recaptchaBox"></div>
        </div>

        <div class="actions">
          <button id="sendBtn" class="btn" type="submit">送信</button>
          <div id="status" class="status"></div>
        </div>

        <div class="note" id="t_privacy">
          送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。
        </div>
        <div class="hint" id="allowHint" style="display:none">
          ※ スクリプトを読み込めません。広告ブロッカー等をご利用の場合は、下記ドメインの許可をお願いします：<br>
          - script.google.com / script.googleapis.com / script.googleusercontent.com / www.google.com / www.gstatic.com / www.google.com/recaptcha/
        </div>
      </form>
    </div>
  </main>

  <footer>
    © 2025 nihongotext.com
  </footer>

  <!-- ===== 設定 ===== -->
  <script>
    // ★ あなたの reCAPTCHA v2（チェックボックス）のサイトキー
    const SITE_KEY = "6LcRKvArAAAAAFVmY21p9o_hwTszHwzp3bgRXtBV";
    // ★ あなたの GAS (exec) — JSONP 固定
    const ENDPOINT_EXEC = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";

    // i18n
    const I18N = {
      ja: {
        title:"お問い合わせ", name:"お名前", email:"メール", subject:"件名", category:"カテゴリ", message:"内容",
        send:"送信", sending:"送信しています…", sent:"送信しました。ありがとうございます！",
        failed:"送信に失敗しました。", privacy:"送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。"
      },
      en: {
        title:"Contact us", name:"Name", email:"Email", subject:"Subject", category:"Category", message:"Message",
        send:"Send", sending:"Sending…", sent:"Sent. Thank you!", failed:"Failed to send.",
        privacy:"By submitting, you agree to our Privacy Policy and Terms."
      }
    };
    let currentLang = "ja";
    function applyLang(){
      const t = I18N[currentLang];
      document.getElementById("t_title").textContent = t.title;
      document.getElementById("t_name").textContent = t.name;
      document.getElementById("t_email").textContent = t.email;
      document.getElementById("t_subject").textContent = t.subject;
      document.getElementById("t_category").textContent = t.category;
      document.getElementById("t_message").textContent = t.message;
      document.getElementById("t_privacy").textContent = t.privacy;
      document.getElementById("sendBtn").textContent = t.send;
      document.getElementById("jaBtn").classList.toggle("active", currentLang==="ja");
      document.getElementById("enBtn").classList.toggle("active", currentLang==="en");
    }
    addEventListener("DOMContentLoaded", () => {
      document.getElementById("jaBtn").onclick = () => { currentLang="ja"; applyLang(); };
      document.getElementById("enBtn").onclick = () => { currentLang="en"; applyLang(); };
      applyLang();
    });

    // ===== reCAPTCHA explicit render（重複描画防止） =====
    let recaptchaWidgetId = null;
    function onloadRecaptcha(){
      try{
        if (typeof grecaptcha !== "undefined" && recaptchaWidgetId === null){
          recaptchaWidgetId = grecaptcha.render("recaptchaBox", { sitekey: SITE_KEY });
        }
      }catch(e){
        console.warn("reCAPTCHA render skipped:", e);
        document.getElementById("allowHint").style.display = "block";
      }
    }

    // ===== JSONP 呼び出し（script 注入） =====
    function callJSONP(url, cbName){
      return new Promise((resolve,reject)=>{
        const s = document.createElement("script");
        s.src = url + (url.includes("?")?"&":"?") + "callback=" + encodeURIComponent(cbName) + "&_ts=" + Date.now();
        s.async = true;
        s.onerror = ()=> reject(new Error("jsonp_load_failed"));
        document.body.appendChild(s);
      });
    }

    // ===== 送信処理（GET/JSONP固定） =====
    document.getElementById("f").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      const status = document.getElementById("status");
      const t = I18N[currentLang];
      status.className = "status"; status.style.display="block"; status.textContent = t.sending;
      document.getElementById("sendBtn").disabled = true;

      try{
        // reCAPTCHA トークン取得
        if (typeof grecaptcha === "undefined"){
          document.getElementById("allowHint").style.display = "block";
          throw new Error("recaptcha_not_loaded");
        }
        const token = grecaptcha.getResponse(recaptchaWidgetId);
        if (!token){
          status.className = "status ng";
          status.textContent = (currentLang==="ja") ? "reCAPTCHA を完了してください。" : "Please complete reCAPTCHA.";
          document.getElementById("sendBtn").disabled = false;
          return;
        }

        // 入力
        const name    = document.getElementById("name").value.trim();
        const email   = document.getElementById("email").value.trim();
        const subject = document.getElementById("subject").value.trim();
        const message = document.getElementById("message").value.trim();
        if (!message){
          status.className = "status ng";
          status.textContent = (currentLang==="ja") ? "内容を入力してください。" : "Please enter a message.";
          document.getElementById("sendBtn").disabled = false;
          return;
        }

        // JSONP コールバック関数名（衝突回避の一意名）
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        window[cbName] = (res)=>{
          try{
            if (res && res.ok){
              status.className = "status ok";
              status.textContent = t.sent;
              document.getElementById("f").reset();
              if (typeof grecaptcha !== "undefined"){ grecaptcha.reset(recaptchaWidgetId); }
            }else{
              status.className = "status ng";
              const reason = (res && (res.reason||res.detail)) ? String(res.reason||res.detail) : "unknown";
              status.textContent = `${t.failed} (${reason})`;
              if (reason.includes("captcha")){
                if (typeof grecaptcha !== "undefined"){ grecaptcha.reset(recaptchaWidgetId); }
              }
            }
          } finally {
            delete window[cbName];
            document.getElementById("sendBtn").disabled = false;
          }
        };

        // パラメータ（日本語などを安全にエンコード）
        function enc(s){return encodeURIComponent(s||"");}
        const url = `${ENDPOINT_EXEC}?mode=contact_submit&name=${enc(name)}&email=${enc(email)}&subject=${enc(subject)}&message=${enc(message)}&token=${enc(token)}`;

        await callJSONP(url, cbName);

      }catch(err){
        status.className = "status ng";
        status.textContent = `${I18N[currentLang].failed} : ${err && err.message ? err.message : "network"}`;
        if (String(err && err.message).includes("jsonp_load_failed")){
          document.getElementById("allowHint").style.display = "block";
        }
        document.getElementById("sendBtn").disabled = false;
      }
    });
  </script>

  <!-- reCAPTCHA v2 (explicit) -->
  <script src="https://www.google.com/recaptcha/api.js?onload=onloadRecaptcha&render=explicit" async defer></script>
</body>
</html>
