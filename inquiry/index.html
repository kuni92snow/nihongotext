<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    :root{
      --brand:#e74c3c;
      --line:#f4c7c3;
      --bg:#fffaf9;
      --text:#333;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif; color:var(--text); background:#fff; margin:0;}
    header, footer{padding:12px 16px;}
    header{border-bottom:3px solid var(--brand);}
    .brand{font-weight:700; color:var(--brand); font-size:24px}
    .beta{font-size:12px; color:#999}
    .wrap{max-width:760px; margin:28px auto; padding:0 16px;}
    .card{background:var(--bg); border:2px solid var(--line); border-radius:10px; padding:16px 16px 20px;}
    h2{margin:0 0 12px 0; font-size:18px}
    label{display:block; font-size:12px; color:#666; margin:10px 0 6px}
    input, select, textarea{
      width:100%; box-sizing:border-box; padding:10px 12px; border:1.6px solid #ddd; border-radius:8px; font-size:14px;
      outline:none; background:#fff;
    }
    textarea{min-height:140px; resize:vertical;}
    .row{display:flex; gap:12px}
    .row .col{flex:1}
    .actions{margin-top:14px; display:flex; align-items:center; gap:10px}
    .btn{background:var(--brand); color:#fff; border:none; padding:9px 18px; border-radius:9px; font-weight:700; cursor:pointer}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .hint{font-size:12px; color:#777; margin-top:8px}
    .status{margin-top:14px; padding:10px; border-radius:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; white-space:pre-wrap}
    .status.ok{background:#eefbf1; border:1.5px solid #b8e6c1; color:#1b5e20}
    .status.err{background:#fff1f0; border:1.5px solid #ffc7c2; color:#8c1d18}
    .small{font-size:11px; color:#888}
    .captcha-box{margin-top:10px}
    .lang-toggle{float:right}
    .lang-toggle button{margin-left:8px; border:1px solid #ddd; background:#fff; padding:5px 10px; border-radius:16px; cursor:pointer; font-size:12px}
    .center{display:flex; align-items:center; gap:10px}
  </style>

  <!-- reCAPTCHA v2 checkbox -->
  <script>
    // === 設定 ===
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";
    const RECAPTCHA_SITE_KEY = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV";

    // 多重 render を避ける
    let __recaptchaId = null;
    function onRecaptchaApiLoaded(){
      const el = document.getElementById("recaptcha-container");
      if (el && window.grecaptcha && __recaptchaId === null){
        __recaptchaId = grecaptcha.render(el, { sitekey: RECAPTCHA_SITE_KEY, theme: "light" });
      }
    }
    function resetCaptcha(){
      try{ if (window.grecaptcha && __recaptchaId !== null){ grecaptcha.reset(__recaptchaId); } }catch(_){}
    }

    // JSONP 呼び出し
    function jsonp(url, cb){
      const cbName = "__cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
      url += (url.includes("?") ? "&" : "?") + "callback=" + cbName;
      const s = document.createElement("script");
      s.src = url;
      s.async = true;
      window[cbName] = function(res){
        try{ cb(res); } finally {
          delete window[cbName];
          s.remove();
        }
      };
      s.onerror = function(){
        try{ cb({ ok:false, stage:"network", reason:"jsonp_load_failed" }); } finally {
          delete window[cbName];
          s.remove();
        }
      };
      document.head.appendChild(s);
    }

    function setBusy(on){
      const btn = document.getElementById("sendBtn");
      const note = document.getElementById("sendingNote");
      btn.disabled = on;
      note.style.display = on ? "inline" : "none";
    }

    function showStatus(payload, ok){
      const box = document.getElementById("statusBox");
      const isOk = ok === true || payload?.ok === true;
      const pretty = JSON.stringify(payload, null, 2);
      box.className = "status " + (isOk ? "ok" : "err");
      box.textContent = pretty;
      box.style.display = "block";
    }

    function submitForm(ev){
      ev.preventDefault();

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const subject = document.getElementById("subject").value.trim();
      const message = document.getElementById("message").value.trim();

      if (!message){
        showStatus({ ok:false, stage:"validate", reason:"message_required" }, false);
        return;
      }

      // reCAPTCHA token
      let token = "";
      try {
        token = window.grecaptcha && __recaptchaId !== null ? grecaptcha.getResponse(__recaptchaId) : "";
      } catch(e){ token = ""; }

      if (!token){
        showStatus({ ok:false, stage:"captcha", reason:"no_token" }, false);
        return;
      }

      setBusy(true);

      const params = new URLSearchParams({
        mode: "contact_submit",
        name, email, subject, message, token
      });

      jsonp(GAS_ENDPOINT + "?" + params.toString(), function(res){
        setBusy(false);
        showStatus(res, res?.ok === true);
        resetCaptcha();
      });
    }

    // 簡易言語トグル（ラベルのみ）
    function setLang(lang){
      const jp = (lang === "ja");
      document.querySelector("[data-i=title]").textContent = jp ? "お問い合わせ" : "Contact us";
      document.querySelector("[for=name]").textContent = jp ? "お名前" : "Name";
      document.querySelector("[for=email]").textContent = jp ? "メール" : "Email";
      document.querySelector("[for=subject]").textContent = jp ? "件名" : "Subject";
      document.querySelector("[for=message]").textContent = jp ? "内容" : "Message";
      document.getElementById("sendBtn").textContent = jp ? "送信" : "Send";
      document.getElementById("policyNote").innerHTML = jp
        ? '送信すると、<a href="#">プライバシーポリシー</a> と <a href="#">利用規約</a> に同意したものとみなされます。'
        : 'By submitting, you agree to our <a href="#">Privacy Policy</a> and <a href="#">Terms</a>.';
    }

    document.addEventListener("DOMContentLoaded", function(){
      document.getElementById("form").addEventListener("submit", submitForm);
      setLang("ja");
    });
  </script>
  <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaApiLoaded&render=explicit" async defer></script>
</head>
<body>
  <header>
    <div class="lang-toggle">
      <button onclick="setLang('ja')">日本語</button>
      <button onclick="setLang('en')">English</button>
    </div>
    <div class="brand">nihongotext.com <span class="beta">== beta version ==</span></div>
  </header>

  <main class="wrap">
    <div class="card">
      <h2 data-i="title">お問い合わせ</h2>

      <form id="form" novalidate>
        <div class="row">
          <div class="col">
            <label for="name">お名前</label>
            <input id="name" name="name" autocomplete="name" />
          </div>
          <div class="col">
            <label for="email">メール</label>
            <input id="email" name="email" type="email" autocomplete="email" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="subject">件名</label>
            <input id="subject" name="subject" />
          </div>
          <div class="col">
            <label>&nbsp;</label>
            <select id="category" disabled>
              <option>一般</option>
              <option>バグ報告</option>
              <option>機能要望</option>
            </select>
          </div>
        </div>

        <label for="message">内容</label>
        <textarea id="message" name="message"></textarea>

        <div class="captcha-box">
          <div id="recaptcha-container"></div>
        </div>

        <div class="actions">
          <button id="sendBtn" class="btn" type="submit">送信</button>
          <span id="sendingNote" class="small" style="display:none;">送信しています…</span>
        </div>

        <div id="policyNote" class="hint">
          送信すると、<a href="#">プライバシーポリシー</a> と <a href="#">利用規約</a> に同意したものとみなされます。
        </div>

        <div id="statusBox" class="status" style="display:none"></div>
        <div class="hint small">※ ステータスには GAS から返る <code>ok / stage / reason / detail</code> を表示します。</div>
      </form>
    </div>
  </main>

  <footer>
    <div class="center small">© 2025 nihongotext.com</div>
  </footer>
</body>
</html>
