<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    :root { --accent:#e74c3c; --border:#e9e9e9; --muted:#777; }
    body { margin:0; font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif; color:#222; background:#fff; }
    header, footer { padding:14px 16px; border-top:4px solid var(--accent); text-align:center; }
    main { max-width:720px; margin:28px auto 56px; padding:0 16px; }
    .card { border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 4px 14px rgba(0,0,0,.05); background:#fff; }
    h1 { margin:0 0 12px; text-align:center; }
    label { display:block; margin:12px 0 6px; color:var(--muted); font-size:14px; }
    input, textarea { width:100%; box-sizing:border-box; padding:12px; border:1px solid var(--border); border-radius:10px; font-size:16px; background:#fafafa; }
    textarea { min-height:150px; resize:vertical; }
    .actions { margin-top:14px; display:flex; align-items:center; gap:12px; }
    .btn { border:0; border-radius:999px; background:linear-gradient(180deg,#ff6b6b,#e74c3c); color:#fff; padding:10px 18px; font-weight:700; cursor:pointer; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .status { font-size:14px; }
    .ok { color:#2e7d32; } .err { color:#c62828; }
    .debug { margin-top:10px; font-size:12px; color:#555; background:#f7f7f7; padding:8px; border-radius:8px; user-select:all; }
  </style>
  <!-- 強制ノーキャッシュ（通常モードでの古いJS読込を防ぐ） -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script>
    // ページ読込時に SW/Cache を極力排除（通常モードでの差異対策）
    (async () => {
      try {
        if ('serviceWorker' in navigator) {
          for (const r of await navigator.serviceWorker.getRegistrations()) await r.unregister();
        }
        if (window.caches?.keys) {
          for (const k of await caches.keys()) await caches.delete(k);
        }
        console.log('[inquiry] cache & SW cleared');
      } catch(e){}
    })();
  </script>
</head>
<body>
  <header>
    <div class="brand">nihongotext.com<br><span style="font-size:12px;color:#777">== beta version ==</span></div>
  </header>

  <main>
    <section class="card">
      <h1>お問い合わせ</h1>

      <label for="name">お名前</label>
      <input id="name" type="text" autocomplete="name" />

      <label for="email">メールアドレス</label>
      <input id="email" type="email" autocomplete="email" />

      <label for="subject">件名</label>
      <input id="subject" type="text" />

      <label for="message">メッセージ</label>
      <textarea id="message"></textarea>

      <div id="recaptcha" style="margin-top:12px"></div>

      <div class="actions">
        <button id="sendBtn" class="btn" type="button" disabled>送信</button>
        <span id="status" class="status" aria-live="polite"></span>
      </div>

      <!-- 迅速な切り分け用デバッグ -->
      <div class="debug" id="dbg"></div>
    </section>
  </main>

  <footer>© <span id="yy"></span> nihongotext.com</footer>

  <script>
    // ★★★ 必ずこのサイトキーを使用（管理画面の v2 チェックボックス用）★★★
    const SITE_KEY = "6LcRkvArAAAAAFYmY2IyPo_hwTszHwzp3bgRXtBV";

    // GAS（既にご提示の本番URL）
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzyHV_NSyJU-hPwvJU5JJMMuPAa7V3vhmRuq6Clq7WBIErCx6A2xHgG1SXtSlfmR42OHw/exec";

    const $ = (id)=>document.getElementById(id);
    $("yy").textContent = new Date().getFullYear();

    // JSONP 固定コールバック（GASはJSONPで返す運用）
    const CB = "cb_x";
    window[CB] = function(res){
      console.log("[inquiry] JSONP response:", res);
      if (res && res.ok) {
        setStatus("送信しました。自動返信メールをご確認ください。", true);
        $("subject").value = ""; $("message").value = "";
      } else {
        const reason = res && res.reason ? ` (${res.reason})` : "";
        setStatus("送信に失敗しました。時間をおいて再度お試しください。" + reason, false);
      }
      $("sendBtn").disabled = false;
      try { if (typeof grecaptcha !== "undefined" && Number.isInteger(window.__wid)) grecaptcha.reset(window.__wid); } catch(e){}
    };

    function setStatus(msg, ok){
      const el = $("status"); el.textContent = msg; el.className = "status " + (ok ? "ok" : "err");
    }

    // 送信
    $("sendBtn").addEventListener("click", () => {
      $("sendBtn").disabled = true; setStatus("", true);
      const name = $("name").value.trim();
      const email = $("email").value.trim();
      const subject = $("subject").value.trim();
      const message = $("message").value.trim();
      if (!name || !email || !message){ setStatus("「お名前」「メール」「メッセージ」は必須です。", false); $("sendBtn").disabled=false; return; }

      if (!(typeof grecaptcha !== "undefined" && Number.isInteger(window.__wid))) {
        setStatus("reCAPTCHA を初期化できません。ページを再読み込みしてください。", false); $("sendBtn").disabled=false; return;
      }
      const token = grecaptcha.getResponse(window.__wid);
      if (!token){ setStatus("reCAPTCHA をチェックしてください。", false); $("sendBtn").disabled=false; return; }

      const qs = new URLSearchParams({
        mode: "contact_submit",
        name, email, subject, message,
        token,
        ["g-recaptcha-response"]: token, // 両対応
        v: "20251030"
      });
      const url = `${GAS_URL}?${qs.toString()}&callback=${encodeURIComponent(CB)}`;

      const sc = document.createElement("script");
      sc.src = url;
      sc.async = true; sc.defer = true;
      sc.onerror = ()=>{ setStatus("送信に失敗しました。ネットワークを確認してください。", false); $("sendBtn").disabled=false; };
      document.body.appendChild(sc);
    });

    // --- デバッグ表示 ---
    function debug(msg){
      try {
        const host = location.hostname;
        $("dbg").textContent =
`host: ${host}
sitekey: ${SITE_KEY}
wid: ${Number.isInteger(window.__wid)?window.__wid:"(not yet)"}
`;
        if (msg) $("dbg").textContent += String(msg);
      } catch(e){}
    }
    debug();
    // --- /デバッグ ---
  </script>

  <!-- reCAPTCHA を明示レンダリング（タイプ/サイトキー不一致を即時検出） -->
  <script>
    function onRecaptchaLoad(){
      try{
        window.__wid = grecaptcha.render("recaptcha", {
          sitekey: SITE_KEY,
          theme: "light",
          size: "normal",
        });
        console.log("[inquiry] reCAPTCHA initialized, wid:", window.__wid);
        document.getElementById("sendBtn").disabled = false;
        debug();
      } catch(e){
        console.error("[inquiry] reCAPTCHA render failed:", e);
        document.getElementById("sendBtn").disabled = true;
        document.getElementById("status").textContent = "reCAPTCHA の初期化に失敗しました（サイトキー/ドメイン設定を確認）。";
        document.getElementById("status").className = "status err";
        debug(String(e));
      }
    }
    // 念のため2回までリトライ
    let __retry = 0;
    function recaptchaReadyCheck(){
      if (typeof grecaptcha === "undefined") {
        if (__retry++ < 4) return setTimeout(recaptchaReadyCheck, 500);
        document.getElementById("status").textContent = "reCAPTCHA スクリプトの読み込みに失敗しました。";
        document.getElementById("status").className = "status err";
        return;
      }
      if (typeof grecaptcha.render === "function") onRecaptchaLoad();
    }
    window.addEventListener("load", recaptchaReadyCheck);
  </script>
  <!-- hl とキャッシュバスター付きで読み込み（通常モードの取り違え防止） -->
  <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoad&render=explicit&hl=ja&_cb=20251030" async defer></script>
</body>
</html>
