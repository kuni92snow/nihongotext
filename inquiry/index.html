<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    :root{--pri:#e74c3c;--bd:#e5e7eb;--tx:#111827;--mut:#6b7280;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;margin:0;background:#fff7f7;color:var(--tx)}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px}
    .brand{font-weight:800;color:#d92d20}
    .lang{gap:8px;display:flex}
    .lang button{border:1px solid var(--bd);background:#fff;border-radius:18px;padding:6px 10px;cursor:pointer}
    .lang .on{background:#111827;color:#fff;border-color:#111827}
    .wrap{max-width:880px;margin:0 auto;padding:8px 16px 48px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:22px}
    h1{font-size:1.25rem;margin:0 0 18px}
    .row{margin:12px 0}
    .row label{display:block;font-size:.88rem;color:var(--mut);margin:0 0 6px}
    input[type="text"],input[type="email"],select,textarea{
      width:100%;padding:12px;border:1px solid var(--bd);border-radius:8px;font-size:1rem;background:#fff}
    textarea{min-height:150px;resize:vertical}
    .actions{display:flex;align-items:center;gap:16px;margin-top:12px}
    .btn{background:var(--pri);color:#fff;border:none;border-radius:10px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .note{color:var(--mut);font-size:.85rem;margin-top:8px}
    .status{margin-top:12px;padding:12px;border-radius:10px;border:1px dashed var(--bd);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#fff}
    footer{padding:24px 16px;color:var(--mut);font-size:.85rem}
    .alert{color:#b91c1c}
    .ok{color:#065f46}
  </style>

  <!-- ✅ v2 checkbox を explicit で確実にレンダー -->
  <script src="https://www.google.com/recaptcha/api.js?render=explicit" async defer></script>
</head>
<body>
  <header>
    <div class="brand">nihongotext.com <small style="opacity:.6">== beta version ==</small></div>
    <div class="lang">
      <button id="btnJa" class="on">日本語</button>
      <button id="btnEn">English</button>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h1 id="t_title">お問い合わせ</h1>

      <form id="form" novalidate>
        <div class="row">
          <label for="name" id="t_nameL">お名前</label>
          <input id="name" type="text" autocomplete="name" />
        </div>

        <div class="row">
          <label for="email" id="t_emailL">メール</label>
          <input id="email" type="email" autocomplete="email" />
        </div>

        <div class="row">
          <label for="subject" id="t_subjectL">件名</label>
          <input id="subject" type="text" />
        </div>

        <div class="row">
          <label for="category" id="t_categoryL">カテゴリ</label>
          <select id="category">
            <option value="general">一般 / General</option>
            <option value="bug">不具合 / Bug</option>
            <option value="request">要望 / Request</option>
          </select>
        </div>

        <div class="row">
          <label for="message" id="t_messageL">内容</label>
          <textarea id="message" placeholder=""></textarea>
        </div>

        <!-- reCAPTCHA box（ここへ明示レンダー） -->
        <div class="row">
          <div id="recaptchaBox" style="transform:scale(1);transform-origin:0 0"></div>
          <div id="captchaWarn" class="note alert" style="display:none;"></div>
        </div>

        <div class="actions">
          <button id="sendBtn" type="submit" class="btn">送信</button>
          <div id="status" class="status" aria-live="polite"></div>
        </div>

        <div class="note" id="t_privacy">
          送信すると、<a href="/privacy.html" target="_blank" rel="noopener">プライバシーポリシー</a>と
          <a href="/terms.html" target="_blank" rel="noopener">利用規約</a>に同意したものとなります。
        </div>
      </form>
    </div>
  </main>

  <footer>© 2025 nihongotext.com</footer>

<script>
/* ===== 設定 ===== */
const ENDPOINT_EXEC = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLJQPMswlFZPXqg-vc0XbQ-A1ngHld0xSyXmtuWN4e4h2kIpI8AE34YGc9h9h-4hbU7dv7AnNfm1oR5rsuldpvQfvQUS7C0WwgSigIRfVLIffMexcztP1xe6doIO_h4qXq9lITX9YE5Lxy5j&lib=18XR7IRNeXE34SdO5uBMBPg5jelbJLVonMYDh0tLs5xGgdqq-4PrtECSR"; // ライブラリ/echo の JSONP
const SITE_KEY      = "6LcRKvArAAAAAFVmY21Py9o_hwTszHwzp3bgRXtBV"; // v2 checkbox のサイトキー

/* ===== 多言語 ===== */
const i18n = {
  ja: {
    title:"お問い合わせ", name:"お名前", email:"メール", subject:"件名", category:"カテゴリ", message:"内容",
    send:"送信", sending:"送信しています…", sent:"送信しました。", failed:"送信に失敗しました。",
    ownerError:"サイト所有者のエラー：サイトキーが無効です。reCAPTCHA のサイトキーが v2（チェックボックス）で、ドメインに nihongotext.com / www.nihongotext.com が登録されているか確認してください。",
    needCaptcha:"reCAPTCHA を完了してください。"
  },
  en: {
    title:"Contact us", name:"Name", email:"Email", subject:"Subject", category:"Category", message:"Message",
    send:"Send", sending:"Sending…", sent:"Sent.", failed:"Failed to send.",
    ownerError:"Site owner error: Invalid site key. Make sure you’re using a v2 checkbox key and the domain is registered.",
    needCaptcha:"Please complete reCAPTCHA."
  }
};
let LANG = "ja";
const $ = (q)=>document.querySelector(q);
function setLang(lang){
  LANG = lang;
  $("#btnJa").classList.toggle("on", lang==="ja");
  $("#btnEn").classList.toggle("on", lang==="en");
  const T=i18n[lang];
  $("#t_title").textContent=T.title;
  $("#t_nameL").textContent=T.name;
  $("#t_emailL").textContent=T.email;
  $("#t_subjectL").textContent=T.subject;
  $("#t_categoryL").textContent=T.category;
  $("#t_messageL").textContent=T.message;
  $("#sendBtn").textContent=T.send;
  $("#t_privacy").innerHTML = (lang==="ja")
    ? '送信すると、<a href="/privacy.html" target="_blank" rel="noopener">プライバシーポリシー</a>と <a href="/terms.html" target="_blank" rel="noopener">利用規約</a>に同意したものとなります。'
    : 'By submitting, you agree to our <a href="/privacy.html" target="_blank" rel="noopener">Privacy Policy</a> and <a href="/terms.html" target="_blank" rel="noopener">Terms</a>.';
}
$("#btnJa").onclick=()=>setLang("ja");
$("#btnEn").onclick=()=>setLang("en");
setLang("ja");

/* ===== reCAPTCHA explicit render ===== */
let recaptchaWidgetId = null;
window.onloadRecaptcha = function(){
  try{
    if (typeof grecaptcha !== "undefined" && recaptchaWidgetId === null){
      recaptchaWidgetId = grecaptcha.render("recaptchaBox", { sitekey: SITE_KEY });
    }
  }catch(e){
    console.warn("reCAPTCHA render skipped:", e);
  }
};
// api.js?render=explicit は onload コールバックがないため、少し待って render を試みる
(function waitGre(){
  if (window.grecaptcha && typeof grecaptcha.render==="function"){ onloadRecaptcha(); }
  else { setTimeout(waitGre, 200); }
})();

/* ===== JSONP 送信 ===== */
function setStatus(html, cls){ const s=$("#status"); s.className="status "+(cls||""); s.innerHTML=html; }

function jsonp(url, cbName, onError){
  return new Promise((resolve, reject)=>{
    const s = document.createElement("script");
    const timer = setTimeout(()=>{
      cleanup(); reject(new Error("jsonp_timeout"));
    }, 15000);
    function cleanup(){ try{ s.remove(); }catch{} window[cbName]=null; clearTimeout(timer); }
    window[cbName] = (payload)=>{ cleanup(); resolve(payload); };
    s.onerror = ()=>{ cleanup(); onError && onError(); reject(new Error("jsonp_load_failed")); };
    s.src = url;
    document.body.appendChild(s);
  });
}

function enc(x){ return encodeURIComponent(x||""); }

$("#form").addEventListener("submit", async (ev)=>{
  ev.preventDefault();
  const T=i18n[LANG];

  // reCAPTCHA トークン取得（checkbox は getResponse でOK）
  let token = "";
  try{
    token = grecaptcha.getResponse(recaptchaWidgetId);
  }catch(e){}
  if (!token){
    $("#captchaWarn").style.display="block";
    $("#captchaWarn").textContent = T.needCaptcha;
    setStatus('<span class="alert">'+T.failed+'</span>',"");
    return;
  }else{
    $("#captchaWarn").style.display="none";
  }

  const name = $("#name").value.trim();
  const email = $("#email").value.trim();
  const subject = $("#subject").value.trim();
  const category = $("#category").value;
  const message = $("#message").value.trim();

  $("#sendBtn").disabled = true;
  setStatus(T.sending+" / JSONP…","");

  // JSONP コールバック名は衝突回避でユニーク化
  const cb = "cb_x_"+Date.now();

  // GAS 側は mode=contact_submit で JSONP 返却
  const url = `${ENDPOINT_EXEC}&mode=contact_submit`
            + `&name=${enc(name)}`
            + `&email=${enc(email)}`
            + `&subject=${enc(subject ? `[${category}] ${subject}` : `[${category}]`)}`
            + `&message=${enc(message)}`
            + `&token=${enc(token)}`
            + `&callback=${enc(cb)}`;

  try{
    const res = await jsonp(url, cb, ()=>{
      setStatus('<div class="alert">スクリプトが読み込めません。広告ブロッカーをオフにするか、<code>script.google.com</code> / <code>script.googleusercontent.com</code> / <code>www.google.com/recaptcha/</code> を許可してください。</div>',"");
    });

    if (res && res.ok){
      setStatus('<span class="ok">'+T.sent+'</span>',"");
      $("#form").reset();
      try{ grecaptcha.reset(recaptchaWidgetId); }catch{}
    }else{
      // 代表的な理由表示
      if (res && res.reason === "captcha_failed"){
        setStatus('<div class="alert">reCAPTCHA 検証に失敗しました（token invalid/expired）。ページを更新してやり直してください。</div>',"");
      }else if (res && res.reason === "bad_request"){
        setStatus('<div class="alert">入力が不足しています。</div>',"");
      }else{
        setStatus('<span class="alert">'+T.failed+'</span>',"");
      }
      try{ grecaptcha.reset(recaptchaWidgetId); }catch{}
    }
  }catch(err){
    if (String(err.message||"").includes("jsonp_load_failed")){
      setStatus('<div class="alert">スクリプトが読み込めません。広告ブロッカーをオフにするか、<code>script.google.com</code> / <code>script.googleusercontent.com</code> / <code>www.google.com/recaptcha/</code> を許可してください。</div>',"");
    }else if (String(err.message||"").includes("jsonp_timeout")){
      setStatus('<div class="alert">タイムアウトしました。通信環境をご確認ください。</div>',"");
    }else{
      setStatus('<span class="alert">'+T.failed+'</span>',"");
    }
  }finally{
    $("#sendBtn").disabled = false;
  }
});
</script>
</body>
</html>
