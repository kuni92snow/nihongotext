<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    :root{--red:#e74c3c;--ink:#333;--ink2:#555;--bg:#fff7f7;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:#f8f8f8;color:var(--ink);margin:0}
    header{padding:14px 18px;border-bottom:3px solid var(--red);background:#fff}
    header b{color:var(--red)}
    main{max-width:920px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:10px;border:1px solid #eee;box-shadow:0 2px 10px rgba(0,0,0,.04);padding:18px}
    h1{font-size:22px;margin:0 0 12px}
    .row{margin:12px 0}
    label{display:block;font-size:13px;color:var(--ink2);margin-bottom:6px}
    input,select,textarea{width:100%;box-sizing:border-box;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:16px;background:#fff}
    textarea{min-height:160px;resize:vertical}
    .actions{display:flex;align-items:center;gap:12px;margin-top:14px}
    .btn{background:var(--red);color:#fff;border:none;border-radius:999px;padding:12px 20px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .status{min-height:20px;font-size:13px;color:#b00020}
    .ok{color:#0a7a27}
    .lang{float:right;display:flex;gap:8px}
    .lang button{border:1px solid #ddd;background:#fff;border-radius:99px;padding:6px 10px;cursor:pointer}
    .note{font-size:12px;color:#777;margin-top:10px}
    .alert{background:var(--bg);border:1px dashed var(--red);color:#b00020;padding:10px;border-radius:8px;margin-top:10px;font-size:13px}
    footer{padding:24px 16px;color:#888;text-align:left}
  </style>
  <!-- reCAPTCHA Enterprise (v2 checkbox) 明示レンダー -->
  <script>
    // ===== 設定 =====
    const ENDPOINT_EXEC = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";
    const SITE_KEY      = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV";

    // ===== i18n =====
    const I18N = {
      ja: {
        h1: "お問い合わせ",
        name:"お名前", email:"メール", subject:"件名", category:"カテゴリ", message:"内容",
        general:"一般 / General",
        send:"送信", sending:"送信しています…", sent:"送信しました。ありがとうございます！", failed:"送信に失敗しました。",
        pleaseCaptcha:"reCAPTCHA のチェックを完了してください。",
        privacy:"送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。",
        adblock: "スクリプトが読み込めません。広告ブロッカー等をオフにするか、以下のドメインを許可してください：script.google.com / script.googleapis.com / www.gstatic.com / www.google.com/recaptcha/",
      },
      en: {
        h1:"Contact us",
        name:"Name", email:"Email", subject:"Subject", category:"Category", message:"Message",
        general:"General",
        send:"Send", sending:"Sending…", sent:"Sent. Thank you!", failed:"Failed to send.",
        pleaseCaptcha:"Please complete reCAPTCHA.",
        privacy:"By submitting, you agree to our Privacy Policy and Terms.",
        adblock:"Couldn’t load scripts. Disable ad-blocker or allow: script.google.com / script.googleapis.com / www.gstatic.com / www.google.com/recaptcha/."
      }
    };
    let LANG = (new URL(location.href).searchParams.get("lang")==="en") ? "en" : "ja";

    // ===== reCAPTCHA explicit render =====
    let recaptchaWidgetId = null;
    function onloadRecaptcha(){
      try{
        if (typeof grecaptcha !== 'undefined' && recaptchaWidgetId === null){
          recaptchaWidgetId = grecaptcha.render("recaptchaBox", { sitekey: SITE_KEY });
        }
      }catch(e){ console.warn("reCAPTCHA render skipped:", e); }
    }

    // ===== JSONP 送信 =====
    function jsonp(url, cb){
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cbName;
      let cleaned = false;
      const cleanup = () => {
        if (cleaned) return;
        cleaned = true;
        delete window[cbName];
        s.remove();
      };
      const timer = setTimeout(()=>{
        cleanup();
        cb({ok:false, stage:"network", reason:"jsonp_load_failed"});
      }, 15000);
      window[cbName] = (data)=>{
        clearTimeout(timer);
        cleanup();
        cb(data);
      };
      s.onerror = ()=>{
        clearTimeout(timer);
        cleanup();
        cb({ok:false, stage:"network", reason:"jsonp_load_failed"});
      };
      document.head.appendChild(s);
    }

    // ===== 送信処理 =====
    function $(id){ return document.getElementById(id); }
    function setTexts(){
      const t = I18N[LANG];
      $("h1t").textContent = t.h1;
      $("lbl_name").textContent = t.name;
      $("lbl_email").textContent = t.email;
      $("lbl_subject").textContent = t.subject;
      $("lbl_category").textContent = t.category;
      $("lbl_message").textContent = t.message;
      $("opt_general").textContent = t.general;
      $("sendBtn").textContent = t.send;
      $("privacyNote").textContent = t.privacy;
      $("adblockHint").textContent = t.adblock;
      // URLクエリ ?lang=en 切替
      $("btnJa").disabled = (LANG==="ja");
      $("btnEn").disabled = (LANG==="en");
    }
    function switchLang(to){
      if (to===LANG) return;
      LANG = to;
      const url = new URL(location.href);
      if (LANG==="en") url.searchParams.set("lang","en"); else url.searchParams.delete("lang");
      location.replace(url.toString());
    }

    function sendForm(ev){
      ev.preventDefault();
      const t = I18N[LANG];
      const btn = $("sendBtn");
      const status = $("status");
      status.textContent = "";
      // reCAPTCHA
      try{
        const token = grecaptcha.getResponse(recaptchaWidgetId);
        if (!token){
          status.textContent = t.pleaseCaptcha;
          return;
        }
      }catch(e){
        status.textContent = t.adblock;
        return;
      }

      btn.disabled = true;
      btn.textContent = t.sending;

      const payload = {
        mode: "contact_submit",
        name: $("name").value.trim(),
        email: $("email").value.trim(),
        subject: $("subject").value.trim(),
        category: $("category").value,
        message: $("message").value.trim(),
        lang: LANG
      };

      const qs = Object.entries(payload)
        .map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");

      jsonp(`${ENDPOINT_EXEC}?${qs}`, (res)=>{
        // reCAPTCHAは毎回リセット
        try{ grecaptcha.reset(recaptchaWidgetId); }catch(e){}
        if (res && res.ok){
          status.className = "status ok";
          status.textContent = I18N[LANG].sent;
          $("form").reset();
        }else{
          status.className = "status";
          const reason = res && (res.reason||res.message) || "failed";
          status.textContent = `${I18N[LANG].failed} : ${reason}`;
        }
        btn.disabled = false;
        btn.textContent = I18N[LANG].send;
      });
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      setTexts();
      $("form").addEventListener("submit", sendForm);
    });
  </script>
  <!-- Enterprise v2 checkbox 明示レンダー用 -->
  <script src="https://www.google.com/recaptcha/enterprise.js?onload=onloadRecaptcha&render=explicit" async defer></script>
</head>
<body>
  <header>
    <b>nihongotext.com</b> <span style="color:#999">== beta version ==</span>
    <div class="lang">
      <button id="btnJa" onclick="switchLang('ja')">日本語</button>
      <button id="btnEn" onclick="switchLang('en')">English</button>
    </div>
  </header>

  <main>
    <div class="card">
      <h1 id="h1t">お問い合わせ</h1>

      <form id="form" novalidate>
        <div class="row">
          <label id="lbl_name" for="name">お名前</label>
          <input id="name" name="name" autocomplete="name" />
        </div>

        <div class="row">
          <label id="lbl_email" for="email">メール</label>
          <input id="email" name="email" type="email" autocomplete="email" />
        </div>

        <div class="row">
          <label id="lbl_subject" for="subject">件名</label>
          <input id="subject" name="subject" />
        </div>

        <div class="row">
          <label id="lbl_category" for="category">カテゴリ</label>
          <select id="category" name="category">
            <option id="opt_general" value="general">一般 / General</option>
          </select>
        </div>

        <div class="row">
          <label id="lbl_message" for="message">内容</label>
          <textarea id="message" name="message"></textarea>
        </div>

        <div class="row">
          <div id="recaptchaBox"></div>
          <div class="alert" id="adblockHint" style="display:block;margin-top:10px">
            <!-- JSで文言を入れます -->
          </div>
        </div>

        <div class="actions">
          <button id="sendBtn" class="btn" type="submit">送信</button>
          <div id="status" class="status" role="status" aria-live="polite"></div>
        </div>

        <div class="note" id="privacyNote">
          送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。
        </div>
      </form>
    </div>
  </main>

  <footer>© 2025 nihongotext.com</footer>
</body>
</html>
