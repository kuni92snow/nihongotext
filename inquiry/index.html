<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <meta name="robots" content="noindex">
  <style>
    :root{--bg:#f7f3f3;--card:#fff;--accent:#e74d4d;--ok:#0a7a0a;--ng:#c01818;--text:#222}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;color:var(--text);background:var(--bg)}
    header{padding:14px 16px;border-bottom:3px solid var(--accent);background:#fff}
    main{max-width:680px;margin:24px auto;padding:0 14px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:18px}
    h2{margin:0 0 12px;font-size:20px}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input[type="text"],input[type="email"],textarea,select{width:100%;border:1px solid #ddd;border-radius:10px;padding:12px;font-size:16px;background:#fff}
    textarea{resize:vertical;min-height:140px}
    .recap-wrap{margin:12px 0}
    .actions{margin-top:14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    button{appearance:none;border:none;border-radius:999px;padding:10px 20px;font-size:15px;color:#fff;background:var(--accent);cursor:pointer;font-weight:700;box-shadow:0 3px 10px rgba(231,77,77,.35)}
    button[disabled]{opacity:.6;cursor:not-allowed}
    #notice{margin-left:4px;font-size:14px}
    #notice.ok{color:var(--ok)} #notice.err{color:var(--ng)}
    footer{text-align:center;color:#6b6b6b;font-size:12px;padding:32px 0}
    /* 非表示要素 */
    .visually-hidden{position:absolute !important;clip:rect(1px,1px,1px,1px);clip-path:inset(50%);height:1px;width:1px;overflow:hidden;white-space:nowrap}
  </style>
  <!-- reCAPTCHA v2 (明示レンダリング) -->
  <script src="https://www.google.com/recaptcha/api.js?onload=initRecaptcha&render=explicit" async defer></script>
</head>
<body>
  <header>
    <div class="brand">nihongotext<span style="color:#999">.com</span> <small style="font-weight:400;color:#888">== beta version ==</small></div>
  </header>

  <main>
    <div class="card" role="form" aria-labelledby="form-title">
      <h2 id="form-title">お問い合わせ</h2>

      <label for="name">お名前</label>
      <input id="name" type="text" autocomplete="name" />

      <label for="email">メールアドレス</label>
      <input id="email" type="email" autocomplete="email" />

      <label for="subject">件名</label>
      <input id="subject" type="text" />

      <label for="message">メッセージ</label>
      <textarea id="message" aria-multiline="true"></textarea>

      <div class="recap-wrap">
        <div id="recaptcha-box" class="g-recaptcha" aria-label="私はロボットではありません"></div>
      </div>

      <div class="actions">
        <button id="sendBtn" type="button" onclick="submitContact()">送信</button>
        <span id="notice" aria-live="polite"></span>
      </div>
    </div>

    <!-- フォールバック用：非表示 iframe + 自動送信用フォーム -->
    <iframe name="gas_iframe" class="visually-hidden" title="送信結果" aria-hidden="true"></iframe>
    <form id="fallbackForm" class="visually-hidden" method="post" target="gas_iframe">
      <input name="mode" value="contact_submit">
      <input name="name">
      <input name="email">
      <input name="subject">
      <input name="message">
      <input name="token">
    </form>
  </main>

  <footer>© 2025 nihongotext.com</footer>

  <script>
    // ====== 環境設定（最新版） ======
    const SITE_KEY   = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVEBLYgKJe1T3IXfKgDNAiKIjJZcZNdNA/exec";
    // =================================

    let rcWidgetId = null;

    function initRecaptcha(){
      try{
        if (typeof grecaptcha==="undefined") return;
        if (rcWidgetId!==null) return;
        rcWidgetId = grecaptcha.render("recaptcha-box",{ sitekey:SITE_KEY });
      }catch(e){ console.warn("reCAPTCHA init error:", e); }
    }

    function setNotice(msg, ok=false){
      const el=document.getElementById("notice");
      el.textContent=msg;
      el.className= ok ? "ok" : "err";
    }
    function validateEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||"").trim()); }

    // JSONP（callback 付き）。失敗したら iframe POST に切替。
    function jsonp(url, params, cb){
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*1e6);
      params = {...params, callback: cbName, _: Date.now()};

      const qs = new URLSearchParams(params).toString();
      const s  = document.createElement("script");
      s.src    = url + "?" + qs;
      s.async  = true; s.defer = true;

      let done=false, timer=setTimeout(()=>{ if(done) return; done=true; cleanup(); cb({ok:false, reason:"jsonp_timeout", fallback:true}); }, 6000);

      window[cbName] = (res)=>{ if(done) return; done=true; cleanup(); cb(res); };
      s.onerror = ()=>{ if(done) return; done=true; cleanup(); cb({ok:false, reason:"jsonp_load_failed", fallback:true}); };

      function cleanup(){
        try{ delete window[cbName]; }catch(_){}
        if (timer){ clearTimeout(timer); timer=null; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      document.body.appendChild(s);
    }

    // フォールバック：非表示 iframe へ POST（ブロッカー・Drive ビューワ回避）
    function iframePost(url, payload){
      const f = document.getElementById("fallbackForm");
      f.action = url;
      for (const k of ["name","email","subject","message","token"]){
        f.elements[k].value = payload[k] || "";
      }
      f.submit();
    }

    function submitContact(){
      setNotice("");
      const name    = document.getElementById("name").value.trim();
      const email   = document.getElementById("email").value.trim();
      const subject = document.getElementById("subject").value.trim();
      const message = document.getElementById("message").value.trim();

      if (!message){ setNotice("メッセージを入力してください。"); return; }
      if (email && !validateEmail(email)){ setNotice("メールアドレスの形式が正しくありません。"); return; }

      const token = (typeof grecaptcha!=="undefined" && rcWidgetId!==null) ? grecaptcha.getResponse(rcWidgetId) : "";
      if (!token){ setNotice("「私はロボットではありません」にチェックしてください。"); return; }

      const params = { mode:"contact_submit", name, email, subject, message, token };

      const btn=document.getElementById("sendBtn"); btn.disabled=true;

      // 1) まず JSONP
      jsonp(SCRIPT_URL, params, (res)=>{
        btn.disabled=false;
        try{ grecaptcha.reset(rcWidgetId); }catch(_){}

        if (res && res.ok){
          setNotice("送信しました。自動返信メールをご確認ください。", true);
          document.getElementById("message").value="";
          return;
        }

        // 2) 失敗したら iframe POST に切替
        if (res && res.fallback){
          setNotice("通信がブロックされました。代替ルートで送信中…");
          iframePost(SCRIPT_URL, params);
          // Apps Script 側はサーバーでメール送信を行うので、数秒後に成功表示
          setTimeout(()=>{
            setNotice("送信を受け付けました。自動返信メールをご確認ください。", true);
            document.getElementById("message").value="";
          }, 2500);
          return;
        }

        const reason = (res && res.reason) || "unknown_error";
        if (reason==="captcha_failed"){
          setNotice("reCAPTCHA 認証に失敗しました。チェックをやり直してください。");
        } else if (reason==="bad_request"){
          setNotice("送信内容が不足しています。");
        } else {
          setNotice("送信に失敗しました: " + reason);
        }
      });
    }

    addEventListener("DOMContentLoaded", ()=>{ document.getElementById("name").focus({preventScroll:true}); });
  </script>
</body>
</html>
