<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>

  <style>
    :root { --accent:#e74c3c; --border:#e9e9e9; --muted:#777; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif; color:#222; background:#fff; }
    header, footer { padding:14px 16px; border-top:4px solid var(--accent); text-align:center; }
    main { max-width:720px; margin:28px auto 56px; padding:0 16px; }
    .card { border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 4px 14px rgba(0,0,0,.05); background:#fff; }
    h1 { margin:0 0 16px; text-align:center; }
    label { display:block; margin:12px 0 6px; color:var(--muted); font-size:14px; }
    input, textarea { width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; font-size:16px; background:#fafafa; }
    textarea { min-height:150px; resize:vertical; }
    .actions { margin-top:14px; display:flex; align-items:center; gap:12px; }
    .btn { border:0; border-radius:999px; background:linear-gradient(180deg,#ff6b6b,#e74c3c); color:#fff; padding:10px 18px; font-weight:700; cursor:pointer; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .status { font-size:14px; }
    .ok { color:#2e7d32; } .err { color:#c62828; }
    .debug { margin-top:10px; font-size:12px; color:#555; background:#f7f7f7; padding:8px; border-radius:8px; user-select:all; }
  </style>

  <!-- 通常モードの取り違えを防ぐための強制ノーキャッシュ -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <script>
    // 読み込み時に SW/Cache を掃除（通常/シークレット差異対策）
    (async () => {
      try {
        if ('serviceWorker' in navigator) {
          for (const r of await navigator.serviceWorker.getRegistrations()) await r.unregister();
        }
        if (window.caches?.keys) for (const k of await caches.keys()) await caches.delete(k);
        console.log('[inquiry] cache & SW cleared');
      } catch(e){}
    })();
  </script>
</head>
<body>
  <header>
    <div class="brand">nihongotext.com<br><span style="font-size:12px;color:#777">== beta version ==</span></div>
  </header>

  <main>
    <section class="card">
      <h1>お問い合わせ</h1>

      <label for="name">お名前</label>
      <input id="name" type="text" autocomplete="name" />

      <label for="email">メールアドレス</label>
      <input id="email" type="email" autocomplete="email" />

      <label for="subject">件名</label>
      <input id="subject" type="text" />

      <label for="message">メッセージ</label>
      <textarea id="message"></textarea>

      <!-- reCAPTCHA 埋め込み先 -->
      <div id="recaptcha" style="margin-top:12px"></div>

      <div class="actions">
        <button id="sendBtn" class="btn" type="button" disabled>送信</button>
        <span id="status" class="status" aria-live="polite"></span>
      </div>

      <!-- デバッグ（現場切り分け用。不要なら削除OK） -->
      <div class="debug" id="dbg"></div>
    </section>
  </main>

  <footer>© <span id="yy"></span> nihongotext.com</footer>

  <script>
    // ★サイトキー（管理画面の v2 チェックボックス）★
    const SITE_KEY = "6LcRkvArAAAAAFYmY2IyPo_hwTszHwzp3bgRXtBV";
    // GAS 本番（JSONP固定）
    const GAS_URL  = "https://script.google.com/macros/s/AKfycbzyHV_NSyJU-hPwvJU5JJMMuPAa7V3vhmRuq6Clq7WBIErCx6A2xHgG1SXtSlfmR42OHw/exec";

    const $ = (id)=>document.getElementById(id);
    $("yy").textContent = new Date().getFullYear();

    // JSONP コールバック（GAS は JSONP で返す）
    const CB = "cb_x";
    window[CB] = function(res){
      console.log("[inquiry] JSONP response:", res);
      if (res && res.ok) {
        setStatus("送信しました。自動返信メールをご確認ください。", true);
        $("subject").value = ""; $("message").value = "";
      } else {
        const reason = res && res.reason ? ` (${res.reason})` : "";
        setStatus("送信に失敗しました。時間をおいて再度お試しください。" + reason, false);
      }
      $("sendBtn").disabled = false;
      try { if (typeof grecaptcha !== "undefined" && Number.isInteger(window.__wid)) grecaptcha.reset(window.__wid); } catch(e){}
    };

    function setStatus(msg, ok){ const el=$("status"); el.textContent=msg; el.className="status "+(ok?"ok":"err"); }

    // 送信ボタン
    $("sendBtn").addEventListener("click", () => {
      $("sendBtn").disabled = true; setStatus("", true);
      const name = $("name").value.trim();
      const email = $("email").value.trim();
      const subject = $("subject").value.trim();
      const message = $("message").value.trim();
      if (!name || !email || !message){ setStatus("「お名前」「メール」「メッセージ」は必須です。", false); $("sendBtn").disabled=false; return; }

      if (!(typeof grecaptcha !== "undefined" && Number.isInteger(window.__wid))) {
        setStatus("reCAPTCHA を初期化できません。ページを再読み込みしてください。", false);
        $("sendBtn").disabled=false; return;
      }
      const token = grecaptcha.getResponse(window.__wid);
      if (!token){ setStatus("reCAPTCHA をチェックしてください。", false); $("sendBtn").disabled=false; return; }

      // JSONP（GET）で送信
      const qs = new URLSearchParams({
        mode: "contact_submit",
        name, email, subject, message,
        token,
        ["g-recaptcha-response"]: token, // 両取り
        v: "20251030"
      });
      const url = `${GAS_URL}?${qs.toString()}&callback=${encodeURIComponent(CB)}`;

      const sc = document.createElement("script");
      sc.src = url; sc.async = true; sc.defer = true;
      sc.onerror = ()=>{ setStatus("送信に失敗しました。ネットワークを確認してください。", false); $("sendBtn").disabled=false; };
      document.body.appendChild(sc);
    });

    // --- デバッグ表示 ---
    function debug(extra){
      const host = location.hostname;
      $("dbg").textContent =
`host: ${host}
sitekey: ${SITE_KEY}
wid: ${Number.isInteger(window.__wid)?window.__wid:"(not yet)"}`
      + (extra?`\n${extra}`:"");
    }
    debug();
  </script>

  <!-- reCAPTCHA：二重初期化を完全防止（1回だけ render） -->
  <script>
    function initRecaptchaOnce() {
      try {
        if (typeof grecaptcha === "undefined") {
          return setTimeout(initRecaptchaOnce, 300);
        }
        if (window.__recaptcha_done) {
          console.log("[inquiry] reCAPTCHA already rendered, skip.");
          return;
        }
        window.__recaptcha_done = true;
        window.__wid = grecaptcha.render("recaptcha", {
          sitekey: SITE_KEY,
          theme: "light",
          size: "normal"
        });
        console.log("[inquiry] reCAPTCHA rendered, wid:", window.__wid);
        $("sendBtn").disabled = false;
        debug();
      } catch (err) {
        console.error("[inquiry] render error:", err);
        $("status").textContent = "reCAPTCHA の初期化に失敗しました（サイトキー/ドメイン設定を確認）。";
        $("status").className = "status err";
        debug(String(err));
      }
    }
    window.addEventListener("load", () => {
      console.log("[inquiry] load → initRecaptchaOnce()");
      initRecaptchaOnce();
    });
  </script>
  <script src="https://www.google.com/recaptcha/api.js?render=explicit&hl=ja&_cb=20251030" async defer></script>
</body>
</html>
