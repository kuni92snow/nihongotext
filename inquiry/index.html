<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    :root{
      --brand:#e65141;
      --border:#f3cfc9;
      --bg:#fff;
      --panel:#fff7f6;
      --text:#333;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif;color:var(--text);background:#fff;}
    header{border-bottom:4px solid var(--brand); padding:14px 18px;}
    .brand{font-weight:800;color:var(--brand);font-size:22px}
    .sub{color:#c7c7c7;font-size:12px;margin-left:6px}
    .wrap{max-width:920px;margin:28px auto;padding:0 16px;}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:18px 18px 8px;}
    h2{margin:0 0 12px 0;font-size:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row + .row{margin-top:10px}
    .full{grid-column:1 / -1}
    label{font-size:12px;opacity:.8;display:block;margin:6px 0 4px}
    input,select,textarea{
      width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:8px;
      padding:12px;font-size:14px;background:#fff;outline:none
    }
    textarea{min-height:150px;resize:vertical}
    .actions{margin:14px 0 8px;display:flex;gap:8px;align-items:center}
    .btn{
      appearance:none;border:0;border-radius:22px;background:var(--brand);color:#fff;
      padding:10px 18px;font-weight:700;cursor:pointer
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .lang{margin-left:auto; display:flex; gap:6px}
    .lang button{border:1px solid var(--brand); background:#fff; color:var(--brand); border-radius:16px; padding:6px 10px; cursor:pointer}
    .lang .on{background:var(--brand); color:#fff}
    .note{font-size:12px;opacity:.7;margin-top:6px}
    .status{font-size:13px; margin-left:8px}
    footer{padding:22px 0 32px;text-align:center;color:#888}
    .captcha-box{margin-top:8px}
  </style>
</head>
<body>
  <header>
    <span class="brand">nihongotext.com</span><span class="sub">== beta version ==</span>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="actions" style="margin-top:0;margin-bottom:10px">
        <h2 id="ttl">お問い合わせ</h2>
        <div class="lang">
          <button type="button" id="btn-ja" class="on">日本語</button>
          <button type="button" id="btn-en">English</button>
        </div>
      </div>

      <form id="contactForm" novalidate>
        <div class="row">
          <div class="full">
            <label id="lb-name">お名前</label>
            <input id="name" name="name" autocomplete="name" />
          </div>
          <div class="full">
            <label id="lb-email">メール</label>
            <input id="email" name="email" type="email" autocomplete="email" />
          </div>
          <div class="full">
            <label id="lb-subject">件名</label>
            <input id="subject" name="subject" />
          </div>
          <div class="full">
            <label id="lb-message">内容</label>
            <textarea id="message" name="message"></textarea>
          </div>
          <div class="full captcha-box">
            <div id="recaptcha" style="transform:scale(1); transform-origin:0 0;"></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="sendBtn" type="submit">送信</button>
          <span class="status" id="statusArea"></span>
        </div>
        <div class="note" id="policyNote">
          送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。
        </div>
      </form>
    </div>
  </div>

  <footer>© 2025 nihongotext.com</footer>

  <script>
    // ====== 設定 ======
    const SITE_KEY = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV"; // v2 Checkbox
    const GAS_EXEC = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";

    // ====== 状態 ======
    let currentLang = "ja";
    let recaptchaId = null;      // grecaptcha widget id
    let apiScript   = null;      // <script id="recaptcha-api">
    let readyCalled = false;

    // ====== 多言語UI ======
    const dict = {
      ja:{
        title:"お問い合わせ",
        name:"お名前",
        email:"メール",
        subject:"件名",
        message:"内容",
        send:"送信",
        note:"送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。",
        sending:"送信しています…",
        done:"送信できました。ありがとうございます。",
        needCaptcha:"送信前に「私はロボットではありません」にチェックしてください。",
        needMsg:"内容を入力してください。"
      },
      en:{
        title:"Contact us",
        name:"Full name",
        email:"Email",
        subject:"Subject",
        message:"Message",
        send:"Send",
        note:"By submitting, you agree to our Privacy Policy and Terms.",
        sending:"Sending...",
        done:"Your message has been sent. Thank you!",
        needCaptcha:"Please check the reCAPTCHA box before sending.",
        needMsg:"Please enter your message."
      }
    };

    function $(q){ return document.querySelector(q); }

    function applyLang(lang){
      currentLang = (lang === "en") ? "en" : "ja";
      const t = dict[currentLang];
      $("#ttl").textContent       = t.title;
      $("#lb-name").textContent   = t.name;
      $("#lb-email").textContent  = t.email;
      $("#lb-subject").textContent= t.subject;
      $("#lb-message").textContent= t.message;
      $("#sendBtn").textContent   = t.send;
      $("#policyNote").textContent= t.note;

      // ボタンのON/OFF
      $("#btn-ja").classList.toggle("on", currentLang==="ja");
      $("#btn-en").classList.toggle("on", currentLang==="en");
    }

    // ====== reCAPTCHA 制御（※二重レンダー防止版） ======
    // API読み込み完了時に呼ばれる
    window.__recapReady = function(){
      // 連打対策：onloadが複数回入っても一度だけ実行
      if (readyCalled) return;
      readyCalled = true;
      // 既にwidgetがある場合は何もしない
      if (typeof grecaptcha !== "undefined" && recaptchaId === null){
        recaptchaId = grecaptcha.render("recaptcha", { sitekey: SITE_KEY });
      }
    };

    function loadRecaptcha(lang){
      // 既存のAPIスクリプトを除去
      if (apiScript) { apiScript.remove(); apiScript = null; }
      // 既存のウィジェットDOMを空にしてIDをクリア
      const box = document.getElementById("recaptcha");
      box.innerHTML = "";
      recaptchaId = null;
      readyCalled = false;

      // 言語に応じてAPIを再読込（明示レンダー）
      apiScript = document.createElement("script");
      apiScript.id = "recaptcha-api";
      apiScript.async = true;
      apiScript.defer = true;
      apiScript.src = "https://www.google.com/recaptcha/api.js?onload=__recapReady&render=explicit&hl=" + (lang==="en"?"en":"ja");
      document.body.appendChild(apiScript);
    }

    // ====== 送信(JSONP) ======
    function sendJSONP(url, cbName){
      return new Promise((resolve)=>{
        const s = document.createElement("script");
        s.src = url + "&callback=" + encodeURIComponent(cbName);
        s.onerror = ()=> resolve({ ok:false, reason:"network_error" });
        document.body.appendChild(s);
        // コールバックで resolve
        window[cbName] = function(res){
          resolve(res||{ ok:false }); 
          // 後片付け
          delete window[cbName];
          setTimeout(()=> s.remove(), 50);
        };
      });
    }

    async function handleSubmit(ev){
      ev.preventDefault();
      const t = dict[currentLang];

      const name    = $("#name").value.trim();
      const email   = $("#email").value.trim();
      const subject = $("#subject").value.trim();
      const message = $("#message").value.trim();

      if (!message){ $("#statusArea").textContent = t.needMsg; return; }

      // reCAPTCHA トークン取得
      if (recaptchaId === null || typeof grecaptcha === "undefined"){
        $("#statusArea").textContent = t.needCaptcha; return;
      }
      const token = grecaptcha.getResponse(recaptchaId);
      if (!token){ $("#statusArea").textContent = t.needCaptcha; return; }

      $("#sendBtn").disabled = true;
      $("#statusArea").textContent = t.sending;

      // JSONP（GET）でGASへ送信
      const qs = [
        "mode=contact_submit",
        "name="+encodeURIComponent(name),
        "email="+encodeURIComponent(email),
        "subject="+encodeURIComponent(subject),
        "message="+encodeURIComponent(message),
        "token="+encodeURIComponent(token)
      ].join("&");

      const res = await sendJSONP(GAS_EXEC + "?" + qs, "__cb"+Date.now());

      if (res && res.ok){
        $("#statusArea").textContent = t.done;
        // 送信後は念のためトークンをリセット
        try{ grecaptcha.reset(recaptchaId); }catch(_){}
        // 入力も軽くクリア
        $("#subject").value = ""; $("#message").value = "";
      }else{
        const reason = (res && res.reason) || "error";
        const msg = (reason==="captcha_failed") ? "reCAPTCHA verification failed." :
                    (reason==="bad_request")   ? "Bad request." :
                    "Failed to send.";
        $("#statusArea").textContent = (currentLang==="ja") ? "送信に失敗しました：" + msg : "Send failed: " + msg;
      }

      $("#sendBtn").disabled = false;
    }

    // ====== 初期化 ======
    document.getElementById("contactForm").addEventListener("submit", handleSubmit);
    document.getElementById("btn-ja").addEventListener("click", ()=>{
      applyLang("ja"); loadRecaptcha("ja");
    });
    document.getElementById("btn-en").addEventListener("click", ()=>{
      applyLang("en"); loadRecaptcha("en");
    });

    // 初期表示：日本語 + reCAPTCHA(ja) を一度だけ読み込み
    applyLang("ja");
    loadRecaptcha("ja");
  </script>
</body>
</html>
