<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inquiry | nihongotext.com</title>
  <style>
    :root{--brand:#e74b3b;--ink:#333;--ink2:#666;--bg:#fafafa;--card:#fff;--line:#eee;--ok:#2e7d32;--err:#c62828}
    *{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header{border-bottom:4px solid var(--brand);padding:10px 16px}.brand{font-weight:700;color:var(--brand)}.beta{opacity:.6;font-size:12px;margin-left:6px}
    .wrap{max-width:920px;margin:24px auto;padding:0 16px}.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:20px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    h1{font-size:18px;margin:0 0 16px}.row{display:flex;gap:8px;align-items:center}.lang-toggle{margin-left:auto;display:flex;gap:8px}
    .chip{border:1px solid #ddd;padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px}.chip.active{border-color:var(--brand);color:var(--brand)}
    label{display:block;font-size:12px;color:var(--ink2);margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:14px;background:#fff}
    textarea{min-height:160px;resize:vertical}.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}@media(max-width:640px){.grid-2{grid-template-columns:1fr}}
    .actions{display:flex;align-items:center;gap:12px;margin-top:12px}.btn{background:var(--brand);color:#fff;border:0;border-radius:999px;padding:10px 18px;font-weight:600;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}.note{font-size:12px;color:var(--ink2);margin-top:6px}
    .status{margin-top:12px;font-size:14px}.status.ok{color:var(--ok)}.status.err{color:var(--err)}
    footer{padding:24px 16px;text-align:center;color:var(--ink2);font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">nihongotext<span style="color:#222">.com</span><span class="beta">== beta version ==</span></div>
    <div class="lang-toggle" id="langToggle">
      <div class="chip active" data-lang="ja">日本語</div>
      <div class="chip" data-lang="en">English</div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <h1 id="ttl">お問い合わせ</h1>
    <form id="contactForm" autocomplete="on">
      <div class="grid-2">
        <div>
          <label id="lblName">お名前</label>
          <input id="name" name="name" autocomplete="name" />
        </div>
        <div>
          <label id="lblEmail">メール</label>
          <input id="email" name="email" type="email" autocomplete="email" />
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label id="lblSubject">件名</label>
          <input id="subject" name="subject" />
        </div>
        <div>
          <label id="lblCategory">カテゴリ</label>
          <select id="category" name="category">
            <option value="general">一般</option>
            <option value="bug">不具合</option>
            <option value="request">要望</option>
          </select>
        </div>
      </div>

      <div>
        <label id="lblMessage">内容</label>
        <textarea id="message" name="message"></textarea>
      </div>

      <div style="margin-top:10px">
        <div id="recaptchaBox" class="g-recaptcha" style="transform:scale(1);transform-origin:0 0"></div>
      </div>

      <div class="actions">
        <button class="btn" id="sendBtn" type="submit">送信</button>
        <div id="status" class="status" aria-live="polite"></div>
      </div>
      <div class="note" id="privacyNote">送信すると、プライバシーポリシーと利用規約に同意したものとなります。</div>
    </form>
  </div>
</main>

<footer>© 2025 nihongotext.com</footer>

<script>
/* ===== 設定 ===== */
const ENDPOINT_EXEC = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";
const SITE_KEY = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV";

/* ===== reCAPTCHA explicit render（重複レンダー防止） ===== */
let recaptchaWidgetId = null;
function onloadRecaptcha(){
  try{
    if (typeof grecaptcha !== "undefined" && recaptchaWidgetId === null){
      recaptchaWidgetId = grecaptcha.render("recaptchaBox",{ sitekey: SITE_KEY });
    }
  }catch(e){ console.warn("reCAPTCHA render skipped:", e); }
}

/* ===== i18n ===== */
const I18N = {
  ja:{ttl:"お問い合わせ",name:"お名前",email:"メール",subject:"件名",category:"カテゴリ",message:"内容",
      send:"送信",note:"送信すると、プライバシーポリシーと利用規約に同意したものとなります。",
      pleaseCaptcha:"reCAPTCHAをチェックしてください。",sending:"送信しています…",sent:"送信しました。ありがとうございます！",failed:"送信に失敗しました："},
  en:{ttl:"Contact us",name:"Name",email:"Email",subject:"Subject",category:"Category",message:"Message",
      send:"Send",note:"By submitting, you agree to our Privacy Policy and Terms.",
      pleaseCaptcha:"Please complete reCAPTCHA.",sending:"Sending…",sent:"Sent. Thank you!",failed:"Failed to send: "}
};
let currentLang = "ja";
function applyLang(lang){
  currentLang = lang;
  document.querySelectorAll(".chip").forEach(c=>c.classList.toggle("active", c.dataset.lang===lang));
  const t = I18N[lang];
  ttl.textContent=t.ttl; lblName.textContent=t.name; lblEmail.textContent=t.email;
  lblSubject.textContent=t.subject; lblCategory.textContent=t.category; lblMessage.textContent=t.message;
  sendBtn.textContent=t.send; privacyNote.textContent=t.note;
}
langToggle.addEventListener("click",(e)=>{ const lang=e.target?.dataset?.lang; if(lang) applyLang(lang); });
applyLang("ja");

/* ===== JSONP 送信 ===== */
const form = document.getElementById("contactForm");
const btn  = document.getElementById("sendBtn");
const statusEl = document.getElementById("status");
function setStatus(type,msg){ statusEl.className="status "+(type||""); statusEl.textContent=msg||""; }

form.addEventListener("submit",(ev)=>{
  ev.preventDefault();
  setStatus("","");

  let token="";
  try{ token = grecaptcha.getResponse(recaptchaWidgetId||0); }catch(_){}
  if(!token){ return setStatus("err", I18N[currentLang].pleaseCaptcha); }

  const q = new URLSearchParams({
    mode:"contact_submit",
    name: document.getElementById("name").value.trim(),
    email: document.getElementById("email").value.trim(),
    subject: document.getElementById("subject").value.trim(),
    message: document.getElementById("message").value.trim(),
    token
  });

  // JSONP コールバック名（一意）
  const cb = "cb_"+Date.now()+"_"+Math.floor(Math.random()*1e6);
  const src = ENDPOINT_EXEC + "?" + q.toString() + "&callback=" + cb;

  btn.disabled = true;
  setStatus("", I18N[currentLang].sending);

  // コールバック定義
  window[cb] = function(res){
    try{
      if(res && res.ok){
        setStatus("ok", I18N[currentLang].sent);
        form.reset();
      }else{
        const reason = (res && (res.reason || res.detail)) || "unknown_error";
        setStatus("err", I18N[currentLang].failed + reason);
      }
    }finally{
      try{ grecaptcha.reset(recaptchaWidgetId||0); }catch(_){}
      btn.disabled = false;
      // script要素とコールバックを掃除
      if(script && script.parentNode) script.parentNode.removeChild(script);
      delete window[cb];
    }
  };

  // script 挿入で送信（JSONP）
  const script = document.createElement("script");
  script.src = src;
  script.onerror = function(){
    setStatus("err", I18N[currentLang].failed + "jsonp_load_failed");
    btn.disabled=false;
    delete window[cb];
  };
  document.head.appendChild(script);
});
</script>
<script src="https://www.google.com/recaptcha/api.js?onload=onloadRecaptcha&render=explicit" async defer></script>
</body>
</html>
