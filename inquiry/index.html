<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    :root { --accent:#e74c3c; --border:#e9e9e9; --muted:#777; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Noto Sans JP", sans-serif; color:#222; background:#fff; }
    header, footer { padding:14px 16px; border-top:4px solid var(--accent); text-align:center; }
    main { max-width:720px; margin:28px auto 56px; padding:0 16px; }
    .card { border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 4px 14px rgba(0,0,0,.05); background:#fff; }
    h1 { margin:0 0 16px; text-align:center; }
    label { display:block; margin:12px 0 6px; color:var(--muted); font-size:14px; }
    input, textarea { width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; font-size:16px; background:#fafafa; }
    textarea { min-height:150px; resize:vertical; }
    .actions { margin-top:14px; display:flex; align-items:center; gap:12px; }
    .btn { border:0; border-radius:999px; background:linear-gradient(180deg,#ff6b6b,#e74c3c); color:#fff; padding:10px 18px; font-weight:700; cursor:pointer; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .status { font-size:14px; }
    .ok { color:#2e7d32; } .err { color:#c62828; }
    .debug { margin-top:10px; font-size:12px; color:#555; background:#f7f7f7; padding:8px; border-radius:8px; user-select:all; }
  </style>

  <!-- 強制ノーキャッシュ（通常/シークレット差異対策） -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <script>
    // 読み込み時に SW/Cache を掃除
    (async () => {
      try {
        if ('serviceWorker' in navigator) {
          for (const r of await navigator.serviceWorker.getRegistrations()) await r.unregister();
        }
        if (window.caches?.keys) for (const k of await caches.keys()) await caches.delete(k);
        console.log('[inquiry] cache & SW cleared');
      } catch(e){}
    })();
  </script>
</head>
<body>
<header>
  <div class="brand">nihongotext.com<br><span style="font-size:12px;color:#777">== beta version ==</span></div>
</header>

<main>
  <section class="card">
    <h1>お問い合わせ</h1>

    <label for="name">お名前</label>
    <input id="name" type="text" autocomplete="name" />

    <label for="email">メールアドレス</label>
    <input id="email" type="email" autocomplete="email" />

    <label for="subject">件名</label>
    <input id="subject" type="text" />

    <label for="message">メッセージ</label>
    <textarea id="message"></textarea>

    <!-- ★ reCAPTCHA（自動レンダリング方式） -->
    <div id="recaptchaWrap" style="margin-top:12px">
      <div class="g-recaptcha" data-sitekey="6LcRkvArAAAAAFYmY2IyPo_hwTszHwzp3bgRXtBV"></div>
    </div>

    <div class="actions">
      <button id="sendBtn" class="btn" type="button">送信</button>
      <span id="status" class="status" aria-live="polite"></span>
    </div>

    <div class="debug" id="dbg"></div>
  </section>
</main>

<footer>© <span id="yy"></span> nihongotext.com</footer>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzyHV_NSyJU-hPwvJU5JJMMuPAa7V3vhmRuq6Clq7WBIErCx6A2xHgG1SXtSlfmR42OHw/exec";
  const CB = "cb_x";
  const $ = (id)=>document.getElementById(id);
  $("yy").textContent = new Date().getFullYear();

  // JSONPコールバック（GAS側はJSONP固定）
  window[CB] = function(res){
    console.log("[inquiry] JSONP response:", res);
    if (res && res.ok) {
      setStatus("送信しました。自動返信メールをご確認ください。", true);
      $("subject").value = ""; $("message").value = "";
    } else {
      const reason = res && res.reason ? ` (${res.reason})` : "";
      setStatus("送信に失敗しました。時間をおいて再度お試しください。" + reason, false);
    }
    try { grecaptcha.reset(); } catch(e){}
    $("sendBtn").disabled = false;
  };

  function setStatus(msg, ok){ const el=$("status"); el.textContent=msg; el.className="status "+(ok?"ok":"err"); }
  function debug(extra){
    $("dbg").textContent =
`host: ${location.hostname}
sitekey: (inline)
grecaptcha: ${typeof grecaptcha !== "undefined" ? "loaded" : "not loaded"}`
    + (extra?`\n${extra}`:"");
  }

  // 送信
  $("sendBtn").addEventListener("click", () => {
    $("sendBtn").disabled = true; setStatus("", true);
    const name = $("name").value.trim();
    const email = $("email").value.trim();
    const subject = $("subject").value.trim();
    const message = $("message").value.trim();
    if (!name || !email || !message){ setStatus("「お名前」「メール」「メッセージ」は必須です。", false); $("sendBtn").disabled=false; return; }

    // reCAPTCHA トークン取得
    try{
      const token = grecaptcha.getResponse();
      if (!token){ setStatus("reCAPTCHA をチェックしてください。", false); $("sendBtn").disabled=false; return; }

      const qs = new URLSearchParams({
        mode: "contact_submit",
        name, email, subject, message,
        token,
        ["g-recaptcha-response"]: token,
        v: "20251030"
      });
      const url = `${GAS_URL}?${qs.toString()}&callback=${encodeURIComponent(CB)}`;
      const sc = document.createElement("script");
      sc.src = url; sc.async = true; sc.defer = true;
      sc.onerror = ()=>{ setStatus("送信に失敗しました。ネットワークを確認してください。", false); $("sendBtn").disabled=false; };
      document.body.appendChild(sc);
    }catch(err){
      setStatus("reCAPTCHA の初期化に失敗しました（サイトキー/ドメイン設定を確認）。", false);
      $("sendBtn").disabled=false;
      debug(String(err));
    }
  });

  // デバッグ表示を少し遅らせて reCAPTCHA ロード状態を反映
  window.addEventListener("load", ()=> setTimeout(()=>debug(), 500));
</script>

<!-- ★ v2（クラシック）用スクリプト。enterprise ではありません -->
<script src="https://www.google.com/recaptcha/api.js?hl=ja" async defer></script>
</body>
</html>
