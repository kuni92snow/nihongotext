<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <meta name="format-detection" content="telephone=no" />
  <style>
    :root{--brand:#e74c3c;--line:#f4d6d3;--bg:#fffaf9;}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","游ゴシック体",YuGothic,"Yu Gothic",Meiryo,sans-serif;color:#333;}
    header{border-bottom:4px solid var(--brand);padding:12px 16px;}
    header .brand{font-weight:800;color:var(--brand)}
    header .beta{color:#888;font-size:12px;margin-left:8px}
    main{max-width:880px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.05);padding:18px 18px 8px}
    h1{font-size:22px;margin:0 0 12px}
    .row{margin:10px 0}
    label{display:block;font-size:13px;margin-bottom:4px;color:#555}
    input[type="text"],input[type="email"],select,textarea{
      width:100%;box-sizing:border-box;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:15px;background:#fff
    }
    textarea{min-height:140px;resize:vertical}
    .actions{display:flex;align-items:center;gap:10px;margin-top:12px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:999px;padding:10px 18px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .status{font-size:13px;color:#a00;background:#fdecea;border:1px solid #f6c5c0;border-radius:8px;padding:10px;display:none}
    .note{font-size:12px;color:#666;margin-top:6px}
    .lang{display:flex;gap:8px;margin:8px 0 0}
    .chip{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
    .chip.active{background:#111;color:#fff;border-color:#111}
    footer{max-width:880px;margin:24px auto 40px;padding:0 16px;color:#777;font-size:12px}
    .recaptchaBox{transform:scale(1);transform-origin:0 0}
    @media (max-width:420px){.recaptchaBox{transform:scale(.92)}}
  </style>
  <!-- reCAPTCHA v2 checkbox -->
  <script src="https://www.google.com/recaptcha/api.js?onload=onloadRecaptcha&render=explicit" async defer></script>
</head>
<body>
  <header>
    <span class="brand">nihongotext.com</span>
    <span class="beta">== beta version ==</span>
    <div class="lang" style="float:right;margin-top:-2px">
      <button class="chip" id="btnJa">日本語</button>
      <button class="chip" id="btnEn">English</button>
    </div>
  </header>

  <main>
    <div class="card">
      <h1 id="tt1">お問い合わせ</h1>

      <form id="f">
        <div class="row">
          <label for="name" id="lbName">お名前</label>
          <input id="name" type="text" autocomplete="name" />
        </div>

        <div class="row">
          <label for="email" id="lbEmail">メール</label>
          <input id="email" type="email" autocomplete="email" />
        </div>

        <div class="row">
          <label for="subject" id="lbSubject">件名</label>
          <input id="subject" type="text" />
        </div>

        <div class="row">
          <label for="category" id="lbCategory">カテゴリ</label>
          <select id="category">
            <option value="general">一般 / General</option>
            <option value="bug">不具合 / Bug</option>
            <option value="request">要望 / Request</option>
          </select>
        </div>

        <div class="row">
          <label for="message" id="lbMessage">内容</label>
          <textarea id="message" placeholder=""></textarea>
        </div>

        <div class="row">
          <div id="recaptchaBox" class="recaptchaBox"></div>
        </div>

        <div class="actions">
          <button class="btn" id="sendBtn" type="submit">送信</button>
          <div id="status" class="status" role="status" aria-live="polite"></div>
        </div>

        <div class="note" id="privacyNote">
          送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。
        </div>
      </form>
    </div>
  </main>

  <footer>© 2025 nihongotext.com</footer>

  <script>
  /* ===== 設定 ===== */
  // Webアプリ（exec）…従来URL
  const ENDPOINT_EXEC = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";
  // ECHO（googleusercontent ライブラリ）…Chromebook等のブロック回避
  const ENDPOINT_ECHO = "https://script.googleusercontent.com/macros/library/d/18XR7IRNeXE34SdO5uBMBPg5jelbJLVonMYDh0tLs5xGgdqq-4PrtECSR/22";
  // reCAPTCHA v2 sitekey（チェックボックス）
  const SITE_KEY = "6LcRKvArAAAAAAWfY21y9o_hwTsZwzJpg3BKXBEv";

  /* ===== reCAPTCHA explicit render（重複レンダー防止） ===== */
  let recaptchaWidgetId = null;
  function onloadRecaptcha(){
    try{
      if (typeof grecaptcha !== "undefined" && recaptchaWidgetId === null){
        recaptchaWidgetId = grecaptcha.render("recaptchaBox", { sitekey: SITE_KEY });
      }
    }catch(e){ console.warn("reCAPTCHA render skipped:", e); }
  }

  /* ===== i18n ===== */
  const i18n = {
    ja:{tt1:"お問い合わせ", lbName:"お名前", lbEmail:"メール", lbSubject:"件名", lbCategory:"カテゴリ", lbMessage:"内容",
        send:"送信", note:"送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。",
        sending:"送信しています…", sent:"送信しました。", failed:"送信に失敗しました。",
        pleaseCaptcha:"reCAPTCHA のチェックを完了してください。",
        blocked:"送信に失敗しました（スクリプトが読み込めません）。広告ブロッカー等をオフにするか、\n- script.google.com\n- script.googleusercontent.com\n- www.google.com/recaptcha/\nを許可してください。"},
    en:{tt1:"Contact us", lbName:"Name", lbEmail:"Email", lbSubject:"Subject", lbCategory:"Category", lbMessage:"Message",
        send:"Send", note:"By submitting, you agree to our Privacy Policy and Terms.",
        sending:"Sending...", sent:"Sent.", failed:"Failed to send.",
        pleaseCaptcha:"Please complete the reCAPTCHA.",
        blocked:"Failed to send (scripts blocked). Disable ad blockers or allow:\n- script.google.com\n- script.googleusercontent.com\n- www.google.com/recaptcha/"}
  };
  let lang="ja";
  function applyLang(){
    const t=i18n[lang];
    document.documentElement.lang = (lang==="ja"?"ja":"en");
    document.getElementById("tt1").textContent=t.tt1;
    document.getElementById("lbName").textContent=t.lbName;
    document.getElementById("lbEmail").textContent=t.lbEmail;
    document.getElementById("lbSubject").textContent=t.lbSubject;
    document.getElementById("lbCategory").textContent=t.lbCategory;
    document.getElementById("lbMessage").textContent=t.lbMessage;
    document.getElementById("sendBtn").textContent=t.send;
    document.getElementById("privacyNote").textContent=t.note;
    document.getElementById("btnJa").classList.toggle("active", lang==="ja");
    document.getElementById("btnEn").classList.toggle("active", lang==="en");
  }
  document.getElementById("btnJa").addEventListener("click", ()=>{lang="ja";applyLang();});
  document.getElementById("btnEn").addEventListener("click", ()=>{lang="en";applyLang();});
  applyLang();

  /* ===== JSONP Utility ===== */
  function jsonp(url, timeoutMs=12000){
    return new Promise((resolve, reject)=>{
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const timer = setTimeout(()=>{
        cleanup(); reject(new Error("jsonp_timeout"));
      }, timeoutMs);
      function cleanup(){
        clearTimeout(timer);
        s.remove();
        delete window[cbName];
      }
      window[cbName] = (data)=>{ cleanup(); resolve(data); };
      s.onerror = ()=>{ cleanup(); reject(new Error("jsonp_load_failed")); };
      s.src = url + (url.includes("?")?"&":"?") + "callback=" + cbName;
      document.body.appendChild(s);
    });
  }

  /* ===== Submit ===== */
  const $ = (id)=>document.getElementById(id);
  const form = $("f");
  const statusBox = $("status");
  function setStatus(msg, show=true){
    statusBox.textContent = msg || "";
    statusBox.style.display = show ? "block" : "none";
  }

  form.addEventListener("submit", async (ev)=>{
    ev.preventDefault();
    const t = i18n[lang];
    setStatus(t.sending, true);
    $("sendBtn").disabled = true;

    try{
      const token = (typeof grecaptcha!=="undefined" && recaptchaWidgetId!==null) ? grecaptcha.getResponse(recaptchaWidgetId) : "";
      if (!token){
        setStatus(t.pleaseCaptcha,true);
        $("sendBtn").disabled = false;
        return;
      }

      const name    = encodeURIComponent($("name").value.trim());
      const email   = encodeURIComponent($("email").value.trim());
      const subject = encodeURIComponent($("subject").value.trim());
      const message = encodeURIComponent($("message").value.trim());

      const qs = `mode=contact_submit&name=${name}&email=${email}&subject=${subject}&message=${message}&token=${encodeURIComponent(token)}`;

      // 1) まず googleusercontent (ECHO) を試す
      try{
        const res1 = await jsonp(`${ENDPOINT_ECHO}?${qs}`);
        if (res1 && res1.ok){
          setStatus(t.sent,true);
          form.reset();
          if (typeof grecaptcha!=="undefined" && recaptchaWidgetId!==null) grecaptcha.reset(recaptchaWidgetId);
          $("sendBtn").disabled = false;
          return;
        }
        // reCAPTCHA失敗などの明示エラーはそのまま表示
        if (res1 && res1.reason === "captcha_failed"){
          setStatus("reCAPTCHA に失敗しました。ページを更新してやり直してください。", true);
          $("sendBtn").disabled = false;
          return;
        }
        // それ以外は exec にフォールバック
      }catch(e1){
        // ECHOがブロック/失敗 → 下でフォールバック
      }

      // 2) exec にフォールバック
      try{
        const res2 = await jsonp(`${ENDPOINT_EXEC}?${qs}`);
        if (res2 && res2.ok){
          setStatus(t.sent,true);
          form.reset();
          if (typeof grecaptcha!=="undefined" && recaptchaWidgetId!==null) grecaptcha.reset(recaptchaWidgetId);
          $("sendBtn").disabled = false;
          return;
        }
        // 明示エラー
        setStatus((res2 && res2.reason) ? `${t.failed}: ${res2.reason}` : t.failed, true);
      }catch(e2){
        // どちらもダメ → ブロックの可能性を案内
        setStatus(t.blocked,true);
      }
    }catch(err){
      setStatus(`${i18n[lang].failed}: ${String(err && err.message || err)}`, true);
    }finally{
      $("sendBtn").disabled = false;
    }
  });
  </script>
</body>
</html>
