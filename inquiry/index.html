<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>お問い合わせ | nihongotext.com</title>

<!-- キャッシュ無効化（しつこい残留対策） -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
  :root { --accent:#e74c3c; --bd:#e9e9e9; --muted:#666; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;color:#222;background:#fff}
  header,footer{padding:14px 16px;border-top:4px solid var(--accent);text-align:center}
  main{max-width:760px;margin:28px auto 56px;padding:0 16px}
  .card{border:1px solid var(--bd);border-radius:16px;padding:20px;background:#fff;box-shadow:0 4px 14px rgba(0,0,0,.05)}
  h1{margin:0 0 16px;text-align:center}
  label{display:block;margin:12px 0 6px;color:var(--muted);font-size:14px}
  input,textarea{width:100%;padding:12px;border:1px solid var(--bd);border-radius:10px;font-size:16px;background:#fafafa}
  textarea{min-height:150px;resize:vertical}
  .row{margin-top:14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .btn{border:0;border-radius:999px;background:linear-gradient(180deg,#ff6b6b,#e74c3c);color:#fff;padding:10px 18px;font-weight:700;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .status{font-size:14px}
  .ok{color:#2e7d32}.err{color:#c62828}.muted{color:#999}
</style>

<script>
/* 起動時：Service Worker / Cache を可能な範囲で掃除（通常モードの残骸対策） */
(async () => {
  try {
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      for (const r of regs) await r.unregister();
    }
    if (window.caches?.keys) {
      const keys = await caches.keys();
      for (const k of keys) await caches.delete(k);
    }
    console.log('[inquiry] SW & caches cleared');
  } catch (e) { console.warn(e); }
})();
</script>
</head>
<body>
<header>
  <div class="brand">nihongotext.com<br><span class="muted">== beta version ==</span></div>
</header>

<main>
  <section class="card">
    <h1>お問い合わせ</h1>

    <!-- 送信は hidden-iframe 経由の POST のみ -->
    <iframe name="submitFrame" style="display:none;width:0;height:0;border:0;"></iframe>

    <form id="contactForm"
          action="https://script.google.com/macros/s/AKfycbzyHV_NSyJU-hPwvJU5JJMMuPAa7V3vhmRuq6Clq7WBIErCx6A2xHgG1SXtSlfmR42OHw/exec"
          method="POST" target="submitFrame" novalidate>
      <input type="hidden" name="mode" value="contact_submit">
      <input type="hidden" name="token" id="token"><!-- reCAPTCHA トークン -->

      <label for="name">お名前</label>
      <input id="name" name="name" type="text" autocomplete="name" required />

      <label for="email">メールアドレス</label>
      <input id="email" name="email" type="email" autocomplete="email" required />

      <label for="subject">件名</label>
      <input id="subject" name="subject" type="text" />

      <label for="message">メッセージ</label>
      <textarea id="message" name="message" required></textarea>

      <div style="margin:12px 0">
        <!-- v2 チェックボックスを明示レンダリング。コールバックで token を格納 -->
        <div class="g-recaptcha"
             data-sitekey="6LcRKvArAAAAAFYmY2IyPo_hwTszHwzp3bgRXtBV"
             data-callback="onCaptcha"
             data-expired-callback="onExpire"></div>
        <div id="rc-msg" class="muted" style="font-size:12px"></div>
      </div>

      <div class="row">
        <button id="sendBtn" class="btn" type="submit">送信</button>
        <span id="status" class="status" aria-live="polite"></span>
      </div>
    </form>

    <div id="dbg" class="muted" style="margin-top:10px;font-size:12px;white-space:pre-wrap"></div>
  </section>
</main>

<footer>© <span id="yy"></span> nihongotext.com</footer>

<!-- reCAPTCHA を“直接”読み込む（タイムスタンプでキャッシュ回避） -->
<script
  src="https://www.google.com/recaptcha/api.js?hl=ja&cbts=<?php echo Date.now ? Date.now() : (new Date).getTime(); ?>"
  async defer crossorigin="anonymous" referrerpolicy="no-referrer">
</script>

<script>
const $ = (id)=>document.getElementById(id);
$("yy").textContent = new Date().getFullYear();

function setStatus(msg, ok){ const el=$("status"); el.textContent=msg; el.className="status "+(ok?"ok":"err"); }
function debug(){
  $("dbg").textContent =
`host: ${location.hostname}
grecaptcha: ${typeof grecaptcha !== "undefined" ? "loaded" : "not loaded"}`;
}
window.addEventListener("load", ()=> setTimeout(debug, 500));

/* reCAPTCHA v2 callbacks */
function onCaptcha(token){ $("token").value = token || ""; $("rc-msg").textContent = ""; }
function onExpire(){ $("token").value = ""; $("rc-msg").textContent = "reCAPTCHA の有効期限が切れました。再チェックしてください。"; }

/* 送信ハンドリング（iframe POSTのみ） */
const form = $("contactForm");
form.addEventListener("submit", (e)=>{
  e.preventDefault();
  const btn = $("sendBtn");
  const name = $("name").value.trim();
  const email= $("email").value.trim();
  const msg  = $("message").value.trim();
  const token= $("token").value.trim();

  if (!name || !email || !msg){
    setStatus("「お名前」「メール」「メッセージ」は必須です。", false);
    return;
  }
  if (!token){
    setStatus("reCAPTCHA をチェックしてください。", false);
    return;
  }

  btn.disabled = true;
  setStatus("送信中…", true);

  /* iframe onload で“送れた”と判断（GAS 側 doPost がメール送信） */
  const onld = () => {
    setStatus("送信しました。自動返信メールをご確認ください。", true);
    try { grecaptcha.reset(); } catch(e){}
    $("token").value = "";
    btn.disabled = false;
    submitFrame.removeEventListener("load", onld);
  };
  submitFrame.addEventListener("load", onld);
  form.submit();
});
</script>
</body>
</html>
