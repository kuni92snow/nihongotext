<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inquiry | nihongotext.com</title>
  <style>
    :root{
      --brand:#d62828; --accent:#ff6b6b; --bg:#fff5f5; --line:#eee;
      --okbg:#e8fff0; --okfg:#165b31; --okbd:#b9f3cf;
      --ngbg:#fff0f0; --ngfg:#7d1d1d; --ngbd:#f3b9b9;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:var(--bg);margin:0}
    header,footer{padding:12px 16px}
    header{border-bottom:3px solid var(--accent);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{color:var(--brand);font-weight:800;font-size:20px}
    .beta{font-weight:600;color:#999;margin-left:8px}
    .lang-toggle{display:flex;gap:8px}
    .pill{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .pill.active{border-color:var(--accent);color:#fff;background:var(--accent)}
    main{max-width:860px;margin:24px auto;padding:0 16px}
    .panel{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04);padding:20px}
    h2{margin:0 0 8px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:260px}
    label{display:block;color:#444;font-size:13px;margin:14px 0 6px}
    input,select,textarea{width:100%;border:1px solid #ddd;border-radius:10px;padding:12px 14px;font-size:15px;background:#fff}
    textarea{min-height:140px;resize:vertical}
    .actions{display:flex;align-items:center;gap:12px;margin-top:14px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:999px;padding:10px 18px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .note{font-size:12px;color:#666;margin-top:6px}
    .status{margin-top:8px;padding:10px 14px;border-radius:10px;font-size:14px;white-space:pre-wrap}
    .ok{background:var(--okbg);color:var(--okfg);border:1px solid var(--okbd)}
    .ng{background:var(--ngbg);color:var(--ngfg);border:1px solid var(--ngbd)}
    #recaptchaBox{transform:scale(1);transform-origin:0 0}
  </style>
</head>
<body>
  <header>
    <div class="brand">nihongotext.com <span class="beta">== beta version ==</span></div>
    <div class="lang-toggle">
      <button type="button" class="pill" id="btnJa">日本語</button>
      <button type="button" class="pill" id="btnEn">English</button>
    </div>
  </header>

  <main>
    <div class="panel">
      <h2 id="t-title">お問い合わせ</h2>

      <form id="f">
        <div class="row">
          <div class="col">
            <label id="t-name">お名前</label>
            <input id="name" autocomplete="name" />
          </div>
          <div class="col">
            <label id="t-email">メール</label>
            <input id="email" type="email" autocomplete="email" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label id="t-subject">件名</label>
            <input id="subject" />
          </div>
          <div class="col">
            <label id="t-category">カテゴリ</label>
            <select id="category">
              <option value="general">一般 / General</option>
              <option value="bug">不具合 / Bug</option>
              <option value="request">要望 / Request</option>
            </select>
          </div>
        </div>

        <label id="t-message">内容</label>
        <textarea id="message"></textarea>

        <div id="recaptchaBox" style="margin-top:12px"></div>

        <div class="actions">
          <button id="sendBtn" class="btn" type="submit">送信</button>
          <div id="status" class="status" aria-live="polite"></div>
        </div>

        <div class="note" id="t-note">
          送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。
        </div>
      </form>
    </div>
  </main>

  <footer>© 2025 nihongotext.com</footer>

  <script>
    /* ====== エンドポイント設定 ====== */
    const ENDPOINT_EXEC = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";
    // pingで開けた googleusercontent の完全URL（?user_content_key=...&lib=... を含む全部）を入れると
    // ブロッカー環境での成功率が上がります。未指定でもOK。
    const ENDPOINT_ECHO = ""; 

    // reCAPTCHA v2（チェックボックス）
    const SITE_KEY = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV";

    /* ====== i18n ====== */
    const I18N = {
      ja:{
        title:"お問い合わせ", name:"お名前", email:"メール", subject:"件名", category:"カテゴリ", message:"内容",
        send:"送信", note:"送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。",
        pleaseCaptcha:"reCAPTCHA を完了してください。", sending:"送信しています…", sent:"送信しました。ありがとうございます！",
        failed:"送信に失敗しました。", blocked:"送信に失敗しました（スクリプトが読み込めません）。広告ブロッカー等をオフにするか、\n・script.google.com\n・script.googleusercontent.com\n・www.google.com/recaptcha/\nを許可してください。"
      },
      en:{
        title:"Contact us", name:"Name", email:"Email", subject:"Subject", category:"Category", message:"Message",
        send:"Send", note:"By submitting, you agree to our Privacy Policy and Terms.",
        pleaseCaptcha:"Please complete the reCAPTCHA.", sending:"Sending...", sent:"Sent. Thank you!",
        failed:"Failed to send.", blocked:"Failed to send (script blocked). Please allow:\n• script.google.com\n• script.googleusercontent.com\n• www.google.com/recaptcha/"
      }
    };
    const $ = (id)=>document.getElementById(id);

    function getLangFromURL(){
      const p = new URL(location.href).searchParams.get("lang");
      return (p||"ja").toLowerCase()==="en" ? "en" : "ja";
    }
    let currentLang = getLangFromURL();

    function applyLang(){
      const L = I18N[currentLang];
      $("t-title").textContent   = L.title;
      $("t-name").textContent    = L.name;
      $("t-email").textContent   = L.email;
      $("t-subject").textContent = L.subject;
      $("t-category").textContent= L.category;
      $("t-message").textContent = L.message;
      $("sendBtn").textContent   = L.send;
      $("t-note").textContent    = L.note;

      // 見た目のアクティブ状態
      $("btnJa").classList.toggle("active", currentLang==="ja");
      $("btnEn").classList.toggle("active", currentLang==="en");

      // <html lang> の更新
      document.documentElement.setAttribute("lang", currentLang);
    }

    $("btnJa").addEventListener("click", ()=>switchLang("ja"));
    $("btnEn").addEventListener("click", ()=>switchLang("en"));
    function switchLang(lang){
      if (lang===currentLang) return;
      const u = new URL(location.href);
      u.searchParams.set("lang", lang);
      location.assign(u.toString()); // 明示リロード（reCAPTCHAのため）
    }

    /* ====== reCAPTCHA explicit render ====== */
    let recaptchaWidgetId = null;
    function onloadRecaptcha(){
      try{
        if (typeof grecaptcha !== "undefined" && recaptchaWidgetId === null) {
          recaptchaWidgetId = grecaptcha.render("recaptchaBox", { sitekey: SITE_KEY });
        }
      }catch(e){ console.warn("reCAPTCHA render skipped:", e); }
    }

    /* ====== JSONP loader（堅牢版） ====== */
    function jsonp(urlWithParams, timeoutMs=15000){
      return new Promise((resolve,reject)=>{
        const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
        const u  = new URL(urlWithParams);
        u.searchParams.set("callback", cb);

        const s  = document.createElement("script");
        s.async = true;
        let finished = false;

        function cleanup(err){
          if (finished) return;
          finished = true;
          try{ delete window[cb]; }catch(_){}
          try{ s.remove(); }catch(_){}
          if (err) reject(err);
        }
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=> cleanup(new Error("jsonp_load_failed"));
        s.src = u.toString();
        (document.head || document.body).appendChild(s);
        setTimeout(()=> cleanup(new Error("jsonp_timeout")), timeoutMs);
      });
    }

    function setStatus(kind, msg){
      const el = $("status");
      el.className = "status " + (kind==="ok" ? "ok" : "ng");
      el.textContent = msg;
    }

    /* ====== Submit ====== */
    $("f").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      const L = I18N[currentLang];

      const name     = $("name").value.trim();
      const email    = $("email").value.trim();
      const subject  = $("subject").value.trim();
      const category = $("category").value.trim();
      const message  = $("message").value.trim();

      // reCAPTCHA token
      let token = "";
      try { token = grecaptcha.getResponse(recaptchaWidgetId || 0) || ""; } catch(_){}
      if (!token){ setStatus("ng", L.pleaseCaptcha); return; }

      const btn = $("sendBtn");
      btn.disabled = true;
      setStatus("ng", L.sending);

      const q = new URLSearchParams({
        mode: "contact_submit",
        name, email,
        subject: subject || category,
        message, token
      });

      const urlExec = ENDPOINT_EXEC + "?" + q.toString();
      const useEcho = ENDPOINT_ECHO && ENDPOINT_ECHO.startsWith("https://script.googleusercontent.com/");
      const urlEcho = useEcho ? (ENDPOINT_ECHO + "&" + q.toString()) : null;

      try{
        let res = await jsonp(urlExec, 15000);
        if (!res || !res.ok) throw new Error(res?.reason || res?.detail || "server_error");

        setStatus("ok", L.sent);
        $("f").reset();
        try { grecaptcha.reset(recaptchaWidgetId || 0); } catch(_){}
      }catch(err1){
        try{
          if (!urlEcho) throw err1;
          let res2 = await jsonp(urlEcho, 15000);
          if (!res2 || !res2.ok) throw new Error(res2?.reason || res2?.detail || "server_error");

          setStatus("ok", L.sent);
          $("f").reset();
          try { grecaptcha.reset(recaptchaWidgetId || 0); } catch(_){}
        }catch(err2){
          const msg = (""+err2).includes("jsonp_load_failed") ? L.blocked
                    : L.failed + " : " + (err2?.message || "unknown");
          setStatus("ng", msg);
        }
      }finally{
        btn.disabled = false;
      }
    });

    // 初期化
    applyLang();
  </script>

  <!-- reCAPTCHA v2 (checkbox) — onload=onloadRecaptcha で明示レンダリング -->
  <script src="https://www.google.com/recaptcha/api.js?onload=onloadRecaptcha&render=explicit" async defer></script>
</body>
</html>
