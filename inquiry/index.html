<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";margin:0;background:#f7eaea}
    header{padding:12px 16px;border-bottom:3px solid #e55}
    .brand{color:#d22;font-weight:700}
    .wrap{max-width:760px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    h1{font-size:20px;margin:0 0 16px}
    label{display:block;font-size:12px;color:#555;margin:12px 0 6px}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:8px;padding:12px;background:#f9fafb}
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:12px}
    .row>div{flex:1}
    .actions{display:flex;align-items:center;gap:12px;margin-top:14px}
    .btn{border:0;background:#e33;color:#fff;padding:10px 18px;border-radius:999px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .status{margin-top:10px;font-size:13px;color:#b22}
    .ok{color:#0a7}
    .note{font-size:11px;color:#666;margin-top:6px}
    .lang{position:fixed;top:10px;right:10px;display:flex;gap:8px}
    .pill{border:1px solid #ccc;background:#fff;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer}
    .pill.active{background:#222;color:#fff;border-color:#222}
    #recaptchaBox{transform:scale(1);transform-origin:0 0}
  </style>
</head>
<body>
  <header>
    <span class="brand">nihongotext.com</span> <span style="color:#999">== beta version ==</span>
    <div class="lang">
      <button id="btnJa" class="pill active">日本語</button>
      <button id="btnEn" class="pill">English</button>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h1 id="t_title">お問い合わせ</h1>

      <div class="row">
        <div>
          <label id="t_name">お名前</label>
          <input id="name" type="text" autocomplete="name" />
        </div>
        <div>
          <label id="t_email">メール</label>
          <input id="email" type="email" autocomplete="email" />
        </div>
      </div>

      <label id="t_subject">件名</label>
      <input id="subject" type="text" />

      <label id="t_category">カテゴリ</label>
      <select id="category">
        <option value="general">一般 / General</option>
        <option value="bug">不具合 / Bug</option>
        <option value="request">要望 / Request</option>
      </select>

      <label id="t_message">内容</label>
      <textarea id="message"></textarea>

      <div style="margin-top:10px">
        <div id="recaptchaBox" class="g-recaptcha" data-sitekey="6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV"></div>
      </div>

      <div class="actions">
        <button id="sendBtn" class="btn">送信</button>
        <span id="status" class="status" role="status" aria-live="polite"></span>
      </div>

      <div class="note" id="privacyNote">
        送信すると、プライバシーポリシーと利用規約に同意したものとなります。
      </div>
    </div>
  </main>

  <script>
    // ===== 設定 =====
    const ENDPOINT_EXEC =
      "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";
    const SITE_KEY = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV";

    // ===== i18n =====
    const i18n = {
      ja: { t1:"お問い合わせ", name:"お名前", email:"メール", subject:"件名", category:"カテゴリ", message:"内容",
            send:"送信", sending:"送信しています…", sent:"送信しました。ありがとうございました！",
            failed:"送信に失敗しました。", captchaOwner:"サイト所有者のエラー: サイトキーが無効です" },
      en: { t1:"Contact us", name:"Name", email:"Email", subject:"Subject", category:"Category", message:"Message",
            send:"Send", sending:"Sending…", sent:"Sent. Thank you!", failed:"Failed to send.",
            captchaOwner:"Site owner error: invalid site key" }
    };
    let lang = (new URL(location.href).searchParams.get("lang") || "ja");

    function applyLang(){
      const T = i18n[lang];
      document.getElementById("t_title").textContent = T.t1;
      document.getElementById("t_name").textContent = T.name;
      document.getElementById("t_email").textContent = T.email;
      document.getElementById("t_subject").textContent = T.subject;
      document.getElementById("t_category").textContent = T.category;
      document.getElementById("t_message").textContent = T.message;
      document.getElementById("sendBtn").textContent = T.send;
      document.getElementById("btnJa").classList.toggle("active", lang==="ja");
      document.getElementById("btnEn").classList.toggle("active", lang==="en");
      const url = new URL(location.href);
      url.searchParams.set("lang", lang);
      history.replaceState(null, "", url.toString());
    }

    document.getElementById("btnJa").onclick = ()=>{ lang="ja"; applyLang(); };
    document.getElementById("btnEn").onclick = ()=>{ lang="en"; applyLang(); };
    applyLang();

    // ===== reCAPTCHA explicit render（確実に render する）=====
    let recaptchaWidgetId = null;
    function onloadRecaptcha(){
      try{
        if (typeof grecaptcha !== "undefined" && recaptchaWidgetId === null) {
          recaptchaWidgetId = grecaptcha.render("recaptchaBox", { sitekey: SITE_KEY });
        }
      }catch(e){ console.warn("reCAPTCHA render skipped:", e); }
    }

    // ===== JSONP コールバック（Apps Script 側は cb クエリで呼ぶ）=====
    window.cb_x = function(payload){
      // 後始末（読み込み済みタグを除去）
      if (window.__jsonpTag && window.__jsonpTag.parentNode) {
        window.__jsonpTag.parentNode.removeChild(window.__jsonpTag);
      }
      clearTimeout(window.__jsonpTimeout);

      const st = document.getElementById("status");
      if (payload && payload.ok) {
        st.textContent = i18n[lang].sent;
        st.classList.remove("status"); st.classList.add("ok");
        // フォームをリセット & reCAPTCHA をリセット
        document.getElementById("name").value = "";
        document.getElementById("email").value = "";
        document.getElementById("subject").value = "";
        document.getElementById("message").value = "";
        if (typeof grecaptcha !== "undefined" && recaptchaWidgetId !== null) grecaptcha.reset(recaptchaWidgetId);
        return;
      }
      // 失敗理由を表示
      const reason = (payload && payload.reason) || "failed";
      const msgMap = {
        "captcha_failed": "reCAPTCHA 検証に失敗しました。",
        "bad_param": "送信データが正しくありません。",
        "rate_limited": "しばらくしてから再度お試しください。",
        "denied": "送信が拒否されました。",
        "failed": i18n[lang].failed
      };
      st.textContent = (msgMap[reason] || i18n[lang].failed) + " : " + reason;
    };

    // ===== 送信処理（JSONP）=====
    document.getElementById("sendBtn").addEventListener("click", async function(){
      const st = document.getElementById("status");
      st.textContent = i18n[lang].sending; st.classList.remove("ok");

      // reCAPTCHA トークン
      try{
        if (typeof grecaptcha === "undefined"){
          st.textContent = i18n[lang].failed + " : recaptcha_not_loaded";
          return;
        }
        const token = grecaptcha.getResponse(recaptchaWidgetId);
        if (!token){
          st.textContent = i18n[lang].failed + " : captcha_required";
          return;
        }

        const q = new URLSearchParams({
          mode: "contact_submit",
          name: document.getElementById("name").value.trim(),
          email: document.getElementById("email").value.trim(),
          subject: document.getElementById("subject").value.trim(),
          category: document.getElementById("category").value,
          message: document.getElementById("message").value.trim(),
          lang,                    // 参考情報
          "g-recaptcha-response": token,
          cb: "cb_x",
          _: Date.now().toString() // キャッシュ回避
        });

        // 既存タグのクリーンアップ
        if (window.__jsonpTag && __jsonpTag.parentNode) __jsonpTag.parentNode.removeChild(__jsonpTag);

        const s = document.createElement("script");
        s.src = ENDPOINT_EXEC + "?" + q.toString();
        s.async = true;
        s.onerror = function(){
          st.textContent = i18n[lang].failed + " : jsonp_load_failed";
        };
        document.body.appendChild(s);
        window.__jsonpTag = s;

        // タイムアウト（スクリプトが戻らない場合）
        window.__jsonpTimeout = setTimeout(()=>{
          try{ if (window.__jsonpTag && __jsonpTag.parentNode) __jsonpTag.parentNode.removeChild(__jsonpTag);}catch(_){}
          st.textContent = i18n[lang].failed + " : jsonp_load_failed";
        }, 12000);

      }catch(err){
        st.textContent = i18n[lang].failed + " : " + (err && err.message || "error");
      }
    });
  </script>

  <!-- reCAPTCHA v2（明示レンダリング）-->
  <script src="https://www.google.com/recaptcha/api.js?onload=onloadRecaptcha&render=explicit" async defer></script>
</body>
</html>
