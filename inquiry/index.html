<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inquiry | nihongotext.com</title>
  <link rel="icon" href="/favicon.ico" />
  <base href="/" />

  <!-- Icons -->
  <link rel="icon" type="image/png" href="/icon-512.png" sizes="512x512">
  <link rel="apple-touch-icon" href="/icon-512.png" sizes="512x512">

  <!-- Fonts/Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{--ink:#132c3a;--muted:#6b7280;--brand:#e6462d;--border:#e5e7eb}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;color:var(--ink);line-height:1.7;background:#fff}
    main .wrap{max-width:1100px;margin:auto;padding:16px}
    .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:14px;padding:18px 16px;box-shadow:0 2px 10px rgba(0,0,0,.03);background:#fff}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    h1{margin:0 0 8px}
    h2{margin:.2rem 0 .5rem}
    .fa-fw{width:1.1em;text-align:center}
    input,textarea{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:15px}
    textarea{min-height:140px;resize:vertical}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .btn{border:1px solid var(--border);border-radius:10px;background:#fff;padding:10px 14px;cursor:pointer}
    .btn.primary{border-color:var(--brand);background:var(--brand);color:#fff}
    .note{font-size:.9rem;color:var(--muted)}
  </style>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js',new Date());
    gtag('config','G-9QSHWJE0HZ',{send_page_view:false});
  </script>
</head>
<body>
  <!-- Header / Footer placeholders -->
  <div id="header"></div>

  <main>
    <div class="wrap" id="page" data-i18n data-lang="en">
      <div class="en">
        <h1 class="row"><i class="fa-solid fa-envelope fa-fw" style="color:#e6462d"></i> Inquiry</h1>
        <p class="muted">Feel free to contact us. Required fields are marked with *</p>
      </div>
      <div class="ja">
        <h1 class="row"><i class="fa-solid fa-envelope fa-fw" style="color:#e6462d"></i> お問い合わせ</h1>
        <p class="muted">ご自由にお問い合わせください。* は必須項目です。</p>
      </div>

      <section class="card" aria-labelledby="inq-title">
        <h2 id="inq-title" class="en">Contact Form</h2>
        <h2 class="ja">お問い合わせフォーム</h2>

        <form id="inqForm" novalidate>
          <label class="en">Your Name *</label>
          <label class="ja">お名前 *</label>
          <input id="name" name="name" required placeholder="John Doe">

          <label class="en">Email *</label>
          <label class="ja">メールアドレス *</label>
          <input id="email" name="email" type="email" required placeholder="you@example.com">

          <label class="en">Message *</label>
          <label class="ja">メッセージ *</label>
          <textarea id="message" name="message" required placeholder="Write your message..."></textarea>

          <!-- reCAPTCHA v2 -->
          <div id="recaptcha-box" style="margin:10px 0;"></div>
          <div class="note en">This site is protected by reCAPTCHA and the Google Privacy Policy and Terms of Service apply.</div>
          <div class="note ja">このサイトは reCAPTCHA によって保護されています。</div>

          <div class="actions">
            <button type="button" id="btnReset" class="btn">Reset</button>
            <button type="submit" id="btnSubmit" class="btn primary">Send</button>
          </div>
        </form>

        <p id="result" class="note" role="status" aria-live="polite" style="margin-top:10px;"></p>
      </section>
    </div>
  </main>

  <div id="footer"></div>

  <!-- reCAPTCHA v2 -->
  <script src="https://www.google.com/recaptcha/api.js?onload=onReCaptchaLoad&render=explicit" async defer></script>

  <script>
    /***********************
     * Lang helpers
     ***********************/
    const currentLang = ()=> localStorage.getItem('nt_lang') || ((navigator.language||'en').startsWith('ja')?'ja':'en');
    function applyLang(lang){
      const page=document.getElementById('page');
      page.setAttribute('data-lang',lang);
      document.documentElement.lang=(lang==='ja'?'ja':'en');
      localStorage.setItem('nt_lang',lang);
      const btnHeader=document.getElementById('langBtn');
      if(btnHeader) btnHeader.textContent = (lang==='ja' ? 'English' : '日本語');
      if(window.gtag) gtag('event','language_change',{language:lang});
    }

    /***********************
     * Partials loader + header wire-up
     ***********************/
    async function loadPartials(){
      const [h,f]=await Promise.all([
        fetch('/partials/header.html',{cache:'no-store'}),
        fetch('/partials/footer.html',{cache:'no-store'})
      ]);
      document.getElementById('header').innerHTML=await h.text();
      document.getElementById('footer').innerHTML=await f.text();

      // Lang toggle (keep)
      const btnHeader=document.getElementById('langBtn');
      if(btnHeader){
        const sync=()=> btnHeader.textContent=(currentLang()==='ja'?'English':'日本語');
        btnHeader.addEventListener('click', ()=>{
          const next = currentLang()==='ja' ? 'en' : 'ja';
          applyLang(next);
        });
        sync();
      }

      // Header buttons (Learning / Learned)
      const openLearnBtn   = document.getElementById('learnBtn');
      const openLearnedBtn = document.getElementById('learnedBtn');
      if(openLearnBtn)   openLearnBtn.addEventListener('click', ()=> window._ntxOpenLearning());
      if(openLearnedBtn) openLearnedBtn.addEventListener('click', ()=> window._ntxOpenLearned());

      // Badges初期表示
      updateBadges();
    }

    /***********************
     * Storage helpers（index.htmlと互換）
     ***********************/
    const LEARN_KEY = 'ntx_learning_v3';
    function getLearning(){ try{return JSON.parse(localStorage.getItem(LEARN_KEY)||'[]')}catch(_){return[]} }
    function setLearning(arr){ try{localStorage.setItem(LEARN_KEY,JSON.stringify(arr));}catch(_){ } }

    const LEARNED_STORE = 'ntx_learned_items_v1';   // id->item
    const LEARNED_DATE_KEY = 'ntx_learned_dates_v1';// id->YYYY-MM-DD

    function getLearnedMap(){ try{return JSON.parse(localStorage.getItem(LEARNED_STORE)||'{}')}catch(_){return{}} }
    function setLearnedMap(m){ localStorage.setItem(LEARNED_STORE, JSON.stringify(m)); }
    function getLearnedDates(){ try{return JSON.parse(localStorage.getItem(LEARNED_DATE_KEY)||'{}')}catch(_){return{}} }
    function setLearnedDate(id, d){ const k=getLearnedDates(); k[id]=d; localStorage.setItem(LEARNED_DATE_KEY, JSON.stringify(k)); }
    function learnedIds(){ return Object.keys(getLearnedMap()); }

    function updateBadges(){
      const bLrn  = document.getElementById('badge-learning');
      const bLrnd = document.getElementById('badge-learned');
      if (bLrn)  bLrn.textContent  = String(getLearning().length);
      if (bLrnd) bLrnd.textContent = String(learnedIds().length);
    }

    /***********************
     * Header drawers renderer (Learning / Learned)
     * - header.html 側に用意されている:
     *   #learning-overlay, #learning-drawer, #learned-drawer
     *   #learning-list（Learningの中身）
     ***********************/
    function openOverlay(){ const o=document.getElementById('learning-overlay'); if(o){o.style.display='block';} }
    function closeOverlay(){ const o=document.getElementById('learning-overlay'); if(o){o.style.display='none';} }

    function _renderLearningDrawer(){
      const box = document.getElementById('learning-list');
      if(!box){ return; }
      const arr = getLearning();
      box.innerHTML = '';

      if(!arr.length){
        box.innerHTML = '<div style="color:#6b7280">No items yet.</div>';
        return;
      }

      arr.forEach((x,i)=>{
        const line = document.createElement('div');
        line.style.cssText='display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px dashed #eee;padding:8px 0';

        const left = document.createElement('div');
        left.innerHTML = `<strong>${i+1}. ${x.ja||''}</strong> / ${x.kana||''} / ${x.ro||''} — ${x.en||''}${x.movedAt?` <span style="color:#888">(${x.movedAt})</span>`:''}`;

        const right = document.createElement('div');
        const toLearned = document.createElement('button');
        toLearned.className='btn';
        toLearned.textContent='Move to Learned';
        toLearned.onclick = ()=> {
          // add to learned
          const m=getLearnedMap();
          if(!m[x.id]){
            m[x.id]=x;
            setLearnedMap(m);
            const d=new Date(); const z=n=>String(n).padStart(2,'0');
            const today=`${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
            setLearnedDate(x.id, today);
          }
          // remove from learning
          const rest=getLearning().filter(y=>y.id!==x.id);
          setLearning(rest);
          _renderLearningDrawer();
          updateBadges();
        };
        right.appendChild(toLearned);

        line.append(left,right);
        box.appendChild(line);
      });
    }

    function _renderLearnedDrawer(){
      const box = document.getElementById('learned-list');
      if(!box){ return; }
      box.innerHTML='';

      const m = getLearnedMap();
      const d = getLearnedDates();
      const ids = Object.keys(m);
      if(!ids.length){
        box.innerHTML = '<div style="color:#6b7280">No items yet.</div>';
        return;
      }

      ids.forEach((id, i)=>{
        const x = m[id];
        const line = document.createElement('div');
        line.style.cssText='display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px dashed #eee;padding:8px 0';

        const left = document.createElement('div');
        const movedAt = d[id] ? ` <span style="color:#888">(${d[id]})</span>` : '';
        left.innerHTML = `<strong>${i+1}. ${x.ja||''}</strong> / ${x.kana||''} / ${x.ro||''} — ${x.en||''}${movedAt}`;

        const right = document.createElement('div');
        const backBtn = document.createElement('button');
        backBtn.className='btn';
        backBtn.textContent='Back to Learning';
        backBtn.onclick = ()=>{
          // remove from learned
          const map = getLearnedMap(); delete map[id]; setLearnedMap(map);
          const dates = getLearnedDates(); delete dates[id]; localStorage.setItem(LEARNED_DATE_KEY, JSON.stringify(dates));
          // add to learning if absent
          const arr = getLearning();
          if(!arr.find(y=>y.id===id)){
            const now=new Date(); const z=n=>String(n).padStart(2,'0');
            arr.push({...x, movedAt: `${now.getFullYear()}-${z(now.getMonth()+1)}-${z(now.getDate())}`});
            setLearning(arr);
          }
          _renderLearnedDrawer();
          updateBadges();
        };
        right.appendChild(backBtn);

        line.append(left,right);
        box.appendChild(line);
      });
    }

    // グローバル公開（header の onclick フォールバックからも呼べる）
    window._ntxOpenLearning = function(){
      const d=document.getElementById('learning-drawer');
      if(!d) return;
      _renderLearningDrawer();
      openOverlay();
      setTimeout(()=>{ d.style.right='0'; },10);
      // 閉じる処理（×ボタン or オーバーレイ）
      const closeBtn = document.getElementById('btn-close-learning');
      if(closeBtn){
        closeBtn.onclick=()=>{ d.style.right='-560px'; setTimeout(closeOverlay,250); };
      }
      const overlay=document.getElementById('learning-overlay');
      if(overlay){
        overlay.onclick=(e)=>{ if(e.target.id==='learning-overlay'){ d.style.right='-560px'; setTimeout(closeOverlay,250);} };
      }
    };

    window._ntxOpenLearned = function(){
      const d=document.getElementById('learned-drawer');
      if(!d) return;
      _renderLearnedDrawer();
      openOverlay();
      setTimeout(()=>{ d.style.right='0'; },10);
      // 閉じる
      const overlay=document.getElementById('learning-overlay');
      if(overlay){
        overlay.onclick=(e)=>{ if(e.target.id==='learning-overlay'){ d.style.right='-560px'; setTimeout(closeOverlay,250);} };
      }
      const closeBtn = document.getElementById('btn-close-learned');
      if(closeBtn){
        closeBtn.onclick=()=>{ d.style.right='-560px'; setTimeout(closeOverlay,250); };
      }
    };

    /***********************
     * reCAPTCHA v2
     ***********************/
    let recaptchaWidgetId = null;
    function onReCaptchaLoad(){
      const el = document.getElementById('recaptcha-box');
      if(el){
        // ★必須：サイトキーを本番の key に置き換えてください
        recaptchaWidgetId = grecaptcha.render(el, { sitekey: 'YOUR_RECAPTCHA_V2_SITE_KEY' });
      }
    }
    window.onReCaptchaLoad = onReCaptchaLoad; // global

    /***********************
     * Form submit (JSONP例/GASなどに合わせて適宜置換)
     ***********************/
    document.getElementById('btnReset').addEventListener('click',()=>{
      document.getElementById('inqForm').reset();
      if(typeof grecaptcha!=='undefined' && recaptchaWidgetId!=null){
        grecaptcha.reset(recaptchaWidgetId);
      }
      document.getElementById('result').textContent='';
    });

    document.getElementById('inqForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name=document.getElementById('name').value.trim();
      const email=document.getElementById('email').value.trim();
      const message=document.getElementById('message').value.trim();
      const resEl=document.getElementById('result');

      if(!name || !email || !message){
        resEl.textContent = (currentLang()==='ja') ? '未入力の必須項目があります。' : 'Please fill all required fields.';
        return;
      }
      let token='';
      try{ token = grecaptcha.getResponse(recaptchaWidgetId)||''; }catch(_){}
      if(!token){
        resEl.textContent = (currentLang()==='ja') ? 'reCAPTCHA を完了してください。' : 'Please complete reCAPTCHA.';
        return;
      }

      // ここでGAS等に送信（ダミー）
      try{
        // 実運用：fetch(JSONP/GET/POST) に置換
        await new Promise(r=>setTimeout(r,600));
        resEl.textContent = (currentLang()==='ja') ? '送信しました。ありがとうございます。' : 'Sent. Thank you!';
        document.getElementById('inqForm').reset();
        grecaptcha.reset(recaptchaWidgetId);
      }catch(err){
        resEl.textContent = (currentLang()==='ja') ? '送信でエラーが発生しました。' : 'Failed to send. Please try again.';
      }
    });

    /***********************
     * Init
     ***********************/
    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadPartials();
      applyLang(currentLang());
      // ページ間維持（LocalStorage）のバッジ同期
      updateBadges();
      window.addEventListener('storage', updateBadges);
      try{ gtag('event','page_view',{page_title:'inquiry'}); }catch(_){}
    });
  </script>
</body>
</html>
