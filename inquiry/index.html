<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Contact | nihongotext.com</title>
<meta name="color-scheme" content="light only"/>

<!-- ここは既存のヘッダー/スタイル（前回お渡し分）そのまま。省略可 -->
<style>
:root{--shu:#e6462d;--shu-deep:#c13727;--border:#efdfdc;--ink:#1f2937;--muted:#6b7280}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,"Noto Sans JP",sans-serif;color:var(--ink)}
header,footer{border-top:3px solid var(--shu);border-bottom:3px solid var(--shu)}
main{max-width:980px;margin:24px auto;padding:0 16px}
label{display:block;margin:10px 0 4px;font-size:13px;color:var(--muted)}
input,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font:inherit}
textarea{min-height:160px;resize:vertical}
.row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.btn{padding:10px 16px;border-radius:8px;cursor:pointer}
.btn.primary{background:var(--shu);border:1px solid var(--shu);color:#fff}
.btn.secondary{background:#fff;border:1px solid var(--shu);color:var(--shu)}
.note{font-size:12px;color:#6b7280;margin-top:6px}
#recaptcha{min-height:78px} /* v2 box 高さ確保 */
.debug{font-size:11px;color:#9ca3af;border:1px dashed #e5e7eb;padding:6px;border-radius:8px;margin-top:10px;display:none;word-break:break-all}
</style>
</head>
<body>
<header>
  <!-- 既存のヘッダー（ロゴ／ナビ／言語ボタン等）をここに置く -->
</header>

<main>
  <h1>Contact</h1>

  <form id="contactForm"
        action="https://script.google.com/macros/s/AKfycbzHvm3JmrYzJChzIPJJIR7PsAMmMOaPBKXVEyBXLeLQ_7mMrhCOJ_DdWxE75TVxWwWZvQ/exec"
        method="POST" target="hidden_iframe" novalidate>
    <label>Name</label>
    <input name="name" required placeholder="Your name"/>

    <label style="margin-top:10px">Email</label>
    <input name="email" type="email" required placeholder="your@email.com"/>

    <label style="margin-top:10px">Subject</label>
    <input name="subject" required placeholder="What is this about?"/>

    <label style="margin-top:10px">Message</label>
    <textarea name="message" required placeholder="Write your message..."></textarea>

    <!-- reCAPTCHA v2 -->
    <div style="margin-top:12px">
      <div id="recaptcha"></div>
      <input type="hidden" name="token" id="token">
      <div class="note" id="recapNote"></div>
      <div class="debug" id="debugLine"></div>
      <noscript>
        <div style="margin-top:8px;color:#b91c1c;font-size:12px">
          JavaScript を有効にしてください。reCAPTCHA が表示できません。
        </div>
      </noscript>
    </div>

    <div class="row">
      <button type="reset" class="btn secondary">Cancel</button>
      <button type="submit" class="btn primary">Send</button>
    </div>
    <div class="note" id="resultMsg"></div>
  </form>
  <iframe name="hidden_iframe" style="display:none"></iframe>
</main>

<footer>
  <!-- 既存のフッター（アイコン列など）をここに置く -->
</footer>

<script>
/* ===== reCAPTCHA robust loader (recaptcha.net を既定に) ===== */
const SITE_KEY = "6LcRKvArAAAAAFYmY2IyP9o_hwTszHwzp3bgRXtBV";
let wid = null, tries = 0, sEl = null;
const dbg = (m)=>{ const el=document.getElementById('debugLine'); el.style.display='block'; el.textContent=m; console.info('[reCAPTCHA]',m); };
const note = (t)=>{ document.getElementById('recapNote').textContent=t; };

function cleanup(){
  try{ if(wid!==null && window.grecaptcha){ grecaptcha.reset(wid); } }catch(e){}
  wid=null; tries=0;
  const box=document.getElementById('recaptcha'); box.innerHTML='';
  if(sEl){ sEl.remove(); sEl=null; }
  // 既存グローバルを削除して再評価させる
  try{ delete window.grecaptcha; }catch(e){}
  try{ delete window.___grecaptcha_cfg; }catch(e){}
}

function loadRecaptcha(){
  cleanup();
  note('Loading reCAPTCHA…');
  const src = `https://www.recaptcha.net/recaptcha/api.js?render=explicit&onload=__ntOnReady&_=${Date.now()}`;
  window.__ntOnReady = function(){
    try{
      wid = grecaptcha.render('recaptcha',{sitekey:SITE_KEY});
      note('');
      dbg('rendered wid='+wid+' via recaptcha.net');
    }catch(e){
      dbg('render error: '+e);
      retry();
    }
  };
  sEl = document.createElement('script');
  sEl.src = src; sEl.async = true; sEl.defer = true;
  sEl.onerror = ()=>{ dbg('script error (recaptcha.net)'); retry(true); };
  document.body.appendChild(sEl);
  // セーフティ: onload未発火や CSP で止まるケース
  setTimeout(()=>{ if(!window.grecaptcha || wid===null){ dbg('timeout -> retry'); retry(); } }, 3500);
}

function retry(forceGoogle){
  if(tries>=3){ note('Failed to load reCAPTCHA.'); return; }
  tries++;
  // 2回目は google.com を試す（ネットワークによっては逆に通るため）
  const useGoogle = forceGoogle || tries===2;
  if(sEl){ sEl.remove(); sEl=null; }
  note('Retrying… ('+tries+')');
  const host = useGoogle ? 'https://www.google.com' : 'https://www.recaptcha.net';
  const src  = `${host}/recaptcha/api.js?render=explicit&onload=__ntOnReady&_=${Date.now()}`;
  dbg('retry with '+host);
  const s = document.createElement('script');
  s.src=src; s.async=true; s.defer=true;
  s.onerror=()=>{ dbg('retry load error'); retry(!useGoogle); };
  document.body.appendChild(s);
}
loadRecaptcha();

/* ===== Submit guard ===== */
document.getElementById('contactForm').addEventListener('submit', function(ev){
  try{
    const token = (window.grecaptcha && wid!==null) ? grecaptcha.getResponse(wid) : '';
    if(!token){
      ev.preventDefault();
      document.getElementById('resultMsg').textContent = 'Please complete the reCAPTCHA first.';
      return;
    }
    document.getElementById('token').value = token;
  }catch(e){
    ev.preventDefault();
    document.getElementById('resultMsg').textContent = 'Could not send. Please reload and try again.';
  }
});
</script>
</body>
</html>
