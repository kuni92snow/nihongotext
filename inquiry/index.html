<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    :root { --accent:#e74c3c; --fg:#222; --muted:#777; --bd:#e9e9e9; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif; color:var(--fg); }
    header, footer { padding:14px 16px; border-top:4px solid var(--accent); }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brand { font-weight:700; font-size:18px; cursor:pointer; }
    .beta  { color:var(--muted); margin-left:8px; font-size:12px; }
    .lang  { border:1px solid var(--bd); background:#fff; border-radius:999px; padding:6px 10px; cursor:pointer; }
    main { max-width:860px; margin:22px auto 48px; padding:0 16px; }
    .card { border:1px solid var(--bd); border-radius:16px; padding:18px; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.04); }
    h1 { margin:0 0 12px; font-size:20px; }
    label { display:block; margin:12px 0 6px; color:var(--muted); font-size:14px; }
    input[type="text"], input[type="email"], textarea {
      width:100%; box-sizing:border-box; padding:12px; border:1px solid var(--bd); border-radius:10px; font-size:16px; background:#fafafa;
    }
    textarea { min-height:160px; resize:vertical; }
    .actions { margin-top:14px; display:flex; align-items:center; gap:12px; }
    .btn { border:0; border-radius:999px; background:linear-gradient(180deg,#ff6b6b,#e74c3c); color:#fff; padding:10px 18px; font-weight:700; cursor:pointer; box-shadow:0 6px 16px rgba(231,76,60,.35); }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .status { font-size:14px; }
    .ok { color:#2e7d32; } .err { color:#c62828; }
    footer { text-align:center; color:var(--muted); font-size:12px; }
  </style>

  <!-- reCAPTCHA v2（checkbox） -->
  <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaReady&render=explicit&hl=ja" async defer></script>
</head>
<body>
<header>
  <div class="row">
    <div>
      <span class="brand" onclick="location.href='/'">nihongotext.com</span>
      <span class="beta">== beta version ==</span>
    </div>
    <button id="langBtn" class="lang" type="button">日本語 / English</button>
  </div>
</header>

<main>
  <section class="card">
    <h1 id="ttl">お問い合わせ</h1>

    <label for="name" id="l_name">お名前</label>
    <input id="name" type="text" autocomplete="name" />

    <label for="email" id="l_email">メールアドレス</label>
    <input id="email" type="email" autocomplete="email" />

    <label for="subject" id="l_subject">件名</label>
    <input id="subject" type="text" />

    <label for="message" id="l_message">メッセージ</label>
    <textarea id="message"></textarea>

    <div style="margin-top:12px">
      <div id="recaptcha"></div>
    </div>

    <div class="actions">
      <button class="btn" id="sendBtn" type="button">送信</button>
      <span id="status" class="status" role="status" aria-live="polite"></span>
    </div>
  </section>
</main>

<footer>© <span id="yy"></span> nihongotext.com</footer>

<script>
(() => {
  "use strict";

  // ========= 設定 =========
  // ※ site key は「添付で動いていたもの」をそのまま使用してください
  const SITE_KEY = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV";      // ←動作実績のあるキー
  const GAS_URL  = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";
  const CALLBACK = "cb_x"; // ★GAS側の固定コールバック名に合わせる（ここが肝）
  const VER = "20251029b";

  // ========= 多言語 =========
  const T = {
    ja:{ ttl:"お問い合わせ", name:"お名前", email:"メールアドレス", subject:"件名", message:"メッセージ", send:"送信",
         ok:"送信しました。自動返信メールをご確認ください。",
         need:"「お名前」「メール」「メッセージ」は必須です。",
         cap:"reCAPTCHA をチェックしてください。",
         ng:"送信できませんでした。時間をおいて再度お試しください。"
    },
    en:{ ttl:"Contact", name:"Name", email:"Email", subject:"Subject", message:"Message", send:"Send",
         ok:"Your message has been sent. Please check the auto-reply email.",
         need:"Name, email, and message are required.",
         cap:"Please complete reCAPTCHA.",
         ng:"Failed to send. Please try again later."
    }
  };
  let lang = "ja";
  const $ = (id)=>document.getElementById(id);
  function applyLang(){
    const d=T[lang];
    $("ttl").textContent=d.ttl; $("l_name").textContent=d.name; $("l_email").textContent=d.email;
    $("l_subject").textContent=d.subject; $("l_message").textContent=d.message;
    $("sendBtn").textContent=d.send; document.documentElement.lang = lang;
  }

  // ========= reCAPTCHA =========
  let wid = null;
  window.onRecaptchaReady = function(){
    wid = grecaptcha.render("recaptcha", { sitekey:SITE_KEY, theme:"light", size:"normal" });
  };

  // ========= 送信 =========
  function setStatus(msg, ok){ const el=$("status"); el.textContent=msg; el.className="status "+(ok?"ok":"err"); }
  function enc(s){ return encodeURIComponent(String(s??"").trim()); }

  // ★固定の cb_x にハンドラを定義（GASの戻りに合わせる）
  window[CALLBACK] = function(res){
    try{
      if(res && res.ok){ setStatus(T[lang].ok,true); $("message").value=""; $("subject").value=""; }
      else{ setStatus(T[lang].ng,false); }
    } finally {
      try{ grecaptcha.reset(wid); }catch(e){}
      $("sendBtn").disabled = false;
    }
  };

  $("sendBtn").addEventListener("click", () => {
    $("sendBtn").disabled = true; setStatus("", true);

    const name=$("name").value, email=$("email").value, subject=$("subject").value, message=$("message").value;
    if(!name || !email || !message){ setStatus(T[lang].need,false); $("sendBtn").disabled=false; return; }

    const token = (typeof grecaptcha!=="undefined" && wid!==null) ? grecaptcha.getResponse(wid) : "";
    if(!token){ setStatus(T[lang].cap,false); $("sendBtn").disabled=false; return; }

    // パラメータ名は GAS 仕様に合わせて「g-recaptcha-response」
    const url =
      GAS_URL
      + "?mode=contact_submit"
      + "&name="+enc(name)
      + "&email="+enc(email)
      + "&subject="+enc(subject)
      + "&message="+enc(message)
      + "&g-recaptcha-response="+enc(token)
      + "&callback="+enc(CALLBACK)
      + "&v="+enc(VER);

    // JSONP：script タグで読み込む
    const sc = document.createElement("script");
    sc.src = url; sc.async = true; sc.defer = true;
    sc.onerror = ()=>{ setStatus(T[lang].ng,false); $("sendBtn").disabled=false; try{grecaptcha.reset(wid);}catch(e){} };
    document.body.appendChild(sc);
  });

  // ========= 言語切替 & 年号 =========
  $("langBtn").addEventListener("click", ()=>{ lang = (lang==="ja")?"en":"ja"; applyLang(); });
  $("yy").textContent = String(new Date().getFullYear());
  applyLang();
})();
</script>
</body>
</html>
