<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:#fff5f5;margin:0}
    header,footer{padding:12px 16px}
    header{border-bottom:3px solid #ff6b6b}
    .brand{color:#d62828;font-weight:800;font-size:20px}
    main{max-width:860px;margin:24px auto;padding:0 16px}
    .panel{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04);padding:20px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    label{display:block;color:#444;font-size:13px;margin:14px 0 6px}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:10px;padding:12px 14px;font-size:15px;background:#fff}
    textarea{min-height:140px;resize:vertical}
    .actions{display:flex;align-items:center;gap:12px;margin-top:14px}
    .btn{background:#ff6b6b;color:#fff;border:none;border-radius:999px;padding:10px 18px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .status{font-size:13px}
    .status.ok{color:#2e7d32}
    .status.ng{color:#c62828}
    .note{font-size:12px;color:#666;margin-top:10px}
    .lang{display:flex;gap:8px;justify-content:flex-end;margin:8px 0}
    .pill{border:1px solid #ddd;border-radius:999px;padding:5px 10px;font-size:12px;cursor:pointer;background:#fff}
    .pill.active{background:#222;color:#fff;border-color:#222}
    .recaptcha-wrap{transform:scale(1);transform-origin:0 0}
    @media (max-width:560px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <header>
    <div class="brand">nihongotext.com <span style="font-weight:600;color:#999">== beta version ==</span></div>
  </header>

  <main>
    <div class="lang">
      <button id="btnJa" class="pill active">日本語</button>
      <button id="btnEn" class="pill">English</button>
    </div>

    <section class="panel">
      <h2 id="title">お問い合わせ</h2>
      <form id="form">
        <div class="row">
          <div class="col">
            <label id="lblName" for="name">お名前</label>
            <input id="name" type="text" autocomplete="name" />
          </div>
          <div class="col">
            <label id="lblEmail" for="email">メール</label>
            <input id="email" type="email" autocomplete="email" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label id="lblSubject" for="subject">件名</label>
            <input id="subject" type="text" />
          </div>
          <div class="col">
            <label id="lblCategory" for="category">カテゴリ</label>
            <select id="category">
              <option value="general">一般 / General</option>
              <option value="bug">不具合 / Bug</option>
              <option value="request">要望 / Request</option>
            </select>
          </div>
        </div>

        <label id="lblMessage" for="message">内容</label>
        <textarea id="message" placeholder=""></textarea>

        <div class="recaptcha-wrap" id="recaptchaBox"></div>

        <div class="actions">
          <button class="btn" id="sendBtn" type="submit">送信</button>
          <div id="status" class="status" aria-live="polite"></div>
        </div>

        <div class="note" id="privacyNote">送信すると、プライバシーポリシーと利用規約に同意したものとなります。</div>
      </form>
    </section>
  </main>

  <footer>© 2025 nihongotext.com</footer>

  <script>
    /* ===== 設定 ===== */
    const ENDPOINT_EXEC = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFfMkKsgm0feGWxgFypjpPbhVEBLYgKJe1T3lXfK9bDNAikIjJzcZNdnA/exec"; // 既存の Web アプリURL
    const SITE_KEY       = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV"; // reCAPTCHA Enterprise のサイトキー

    /* ===== i18n ===== */
    const I18N = {
      ja:{t1:"お問い合わせ",name:"お名前",email:"メール",subject:"件名",category:"カテゴリ",message:"内容",
          send:"送信",note:"送信すると、プライバシーポリシーと利用規約に同意したものとなります。",
          pleaseCaptcha:"reCAPTCHA を完了してください。",sending:"送信処理中…",sent:"送信しました。ありがとうございました！",
          failed:"送信に失敗しました。"},
      en:{t1:"Contact us",name:"Name",email:"Email",subject:"Subject",category:"Category",message:"Message",
          send:"Send",note:"By submitting, you agree to our Privacy Policy and Terms.",
          pleaseCaptcha:"Please complete the reCAPTCHA.",sending:"Sending...",sent:"Sent. Thank you!",
          failed:"Failed to send."}
    };
    let currentLang = "ja";
    const $ = id => document.getElementById(id);
    const setStatus = (cls, msg) => { const s=$("status"); s.className="status "+cls; s.textContent=msg; };

    // 言語切替
    function applyLang(){
      const t=I18N[currentLang];
      $("title").textContent=t.t1;
      $("lblName").textContent=t.name;
      $("lblEmail").textContent=t.email;
      $("lblSubject").textContent=t.subject;
      $("lblCategory").textContent=t.category;
      $("lblMessage").textContent=t.message;
      $("sendBtn").textContent=t.send;
      $("privacyNote").textContent=t.note;
      document.documentElement.lang = currentLang;
      $("btnJa").classList.toggle("active", currentLang==="ja");
      $("btnEn").classList.toggle("active", currentLang==="en");
    }
    $("btnJa").onclick=()=>{currentLang="ja";applyLang();};
    $("btnEn").onclick=()=>{currentLang="en";applyLang();};
    applyLang();

    /* ===== reCAPTCHA Enterprise explicit render ===== */
    let recaptchaWidgetId = null;
    function onloadRecaptcha(){
      try{
        if (typeof grecaptcha === "undefined" || !grecaptcha.enterprise) {
          console.warn("reCAPTCHA Enterprise not loaded yet; retrying…");
          setTimeout(onloadRecaptcha, 400);
          return;
        }
        recaptchaWidgetId = grecaptcha.enterprise.render("recaptchaBox", { sitekey: SITE_KEY });
      }catch(e){ console.warn("reCAPTCHA render skipped:", e); }
    }

    /* ===== JSONP ヘルパ ===== */
    function jsonp(url, params={}, cbName="cb_"+Math.random().toString(36).slice(2)){
      return new Promise((resolve, reject)=>{
        const s=document.createElement("script");
        const u=new URL(url);
        Object.entries(params).forEach(([k,v])=>u.searchParams.set(k, v));
        u.searchParams.set("callback", cbName);
        window[cbName]=data=>{ resolve(data); cleanup(); };
        s.src=u.toString();
        s.onerror=()=>{ reject(new Error("jsonp_load_failed")); cleanup(); };
        document.body.appendChild(s);
        function cleanup(){ try{ delete window[cbName]; s.remove(); }catch(_){} }
      });
    }

    /* ===== 送信処理 ===== */
    $("form").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      const name = $("name").value.trim();
      const email = $("email").value.trim();
      const subject = $("subject").value.trim();
      const category = $("category").value.trim();
      const message = $("message").value.trim();

      // reCAPTCHA Enterprise のトークン取得（v2 checkbox）
      let token = "";
      try { token = grecaptcha.enterprise.getResponse(recaptchaWidgetId || 0) || ""; } catch(_){}
      if (!token){
        setStatus("ng", I18N[currentLang].pleaseCaptcha);
        return;
      }

      const btn = $("sendBtn");
      btn.disabled = true;
      setStatus("ng", I18N[currentLang].sending);

      try{
        const res = await jsonp(ENDPOINT_EXEC, {
          mode: "contact_submit",
          name, email, subject, category, message,
          "g-recaptcha-response": token,
          lang: currentLang
        });

        if (res && (res.ok === true || res.ok === "true")){
          setStatus("ok", I18N[currentLang].sent);
          try{ grecaptcha.enterprise.reset(recaptchaWidgetId || 0); }catch(_){}
          $("form").reset();
        }else{
          setStatus("ng", (res && (res.reason || res.detail)) || I18N[currentLang].failed);
        }
      }catch(err){
        setStatus("ng", I18N[currentLang].failed + " : " + err.message);
      }finally{
        btn.disabled = false;
      }
    });
  </script>

  <!-- reCAPTCHA Enterprise（明示レンダリング）-->
  <script src="https://www.google.com/recaptcha/enterprise.js?onload=onloadRecaptcha&render=explicit" async defer></script>
</body>
</html>
