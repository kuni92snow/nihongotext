<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contact | nihongotext.com</title>
  <link rel="icon" href="/favicon.ico" />
  <base href="/" />
  <meta name="color-scheme" content="light only" />

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- reCAPTCHA v2 -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <style>
    :root{
      --shu:#e6462d; --border:#e5e7eb; --ink:#132c3a; --muted:#6b7280;
    }
    *{box-sizing:border-box}
    body{margin:0;background:#fff;color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;line-height:1.7}
    a{color:inherit}
    ruby{ruby-position:over} rt{font-size:.65em;color:#6b7280;letter-spacing:0}

    /* layout */
    main .wrap{max-width:960px;margin:auto;padding:12px}
    h1{font-size:28px;margin:16px 0}
    .card{border:1px solid var(--border);border-radius:12px;background:#fff;padding:16px 18px 14px}
    label{display:block;font-size:13px;color:var(--muted);margin:12px 0 6px}
    input,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;font:inherit}
    textarea{min-height:180px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .btn{padding:10px 16px;border-radius:10px;background:var(--shu);color:#fff;border:none;cursor:pointer}
    .btn.secondary{background:#fff;color:#111827;border:1px solid var(--border)}
    .note{font-size:12px;color:var(--muted);margin-top:8px}
    .msg-ok{color:#10b981;font-weight:700}
    .msg-ng{color:#ef4444;font-weight:700}
  </style>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js',new Date());
    gtag('config','G-9QSHWJE0HZ');
  </script>
</head>
<body>

  <!-- ====== Header (partials) ====== -->
  <div id="header"></div>

  <!-- ====== Page ====== -->
  <main>
    <div class="wrap">
      <h1 id="title" data-i18n="contact">Contact</h1>

      <section class="card" aria-labelledby="title">
        <iframe name="submit_iframe" id="submit_iframe" style="display:none"></iframe>

        <!-- 最新の Apps Script Web App URL に差し替える場合は action を更新 -->
        <form id="contactForm" target="submit_iframe" method="POST"
              action="https://script.google.com/macros/s/AKfycbwclbSxz7fRO9PQwLIpbhFGVzhocuSNBx2Y8ITm0LkuJU1HCZz38vQYmyOlC1kY9Nrzcg/exec">

          <label for="name" id="lbName" data-i18n="name">Name</label>
          <input id="name" name="name" autocomplete="name" placeholder="Your name" />

          <label for="email" id="lbEmail" data-i18n="email">Email</label>
          <input id="email" name="email" type="email" autocomplete="email" placeholder="your@email.com" />

          <label for="subject" id="lbSubject" data-i18n="subject">Subject</label>
          <input id="subject" name="subject" placeholder="What is this about?" />

          <label for="message" id="lbMessage" data-i18n="message">Message</label>
          <textarea id="message" name="message" placeholder="Write your message..."></textarea>

          <input type="hidden" id="token" name="token" />

          <div class="row">
            <div class="g-recaptcha" data-sitekey="6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV"></div>
            <button type="button" class="btn secondary" id="btnCancel" data-i18n="cancel">Cancel</button>
            <button type="submit" class="btn" id="btnSend" data-i18n="send">Send</button>
          </div>

          <div class="note" id="rcNote">
            reCAPTCHA and Google’s
            <a href="https://policies.google.com/privacy?hl=en" target="_blank" rel="noopener">Privacy Policy</a> and
            <a href="https://policies.google.com/terms?hl=en" target="_blank" rel="noopener">Terms of Service</a> apply.
          </div>
          <div class="note" id="msg" aria-live="polite"></div>
        </form>
      </section>
    </div>
  </main>

  <!-- ====== Footer (partials) ====== -->
  <div id="footer"></div>

  <!-- ====== Lang / Submit / Partials / Learning hooks ====== -->
  <script>
    // ---------- 1) ヘッダー / フッターの読み込み ----------
    async function loadPartials(){
      const [h,f] = await Promise.all([
        fetch('/partials/header.html',{cache:'no-store'}),
        fetch('/partials/footer.html',{cache:'no-store'})
      ]);
      document.getElementById('header').innerHTML = await h.text();
      document.getElementById('footer').innerHTML = await f.text();

      // Learning / Learned ボタンをフォールバックで動かす
      hookLearningButtons();
      // 言語トグル（ヘッダー側の #langBtn を利用）
      setupLangToggle();
    }

    // ---------- 2) 日本語トグル（ページ内辞書は維持） ----------
    const dict = {
      en: {
        contact:"Contact",name:"Name",email:"Email",subject:"Subject",message:"Message",
        cancel:"Cancel",send:"Send",btn:"日本語",
        placeholders:{name:"Your name",email:"your@email.com",subject:"What is this about?",message:"Write your message..."},
        sentok:"Your message has been sent. Thank you!",
        sentng:"Failed to send. Please try again later.",
        need:"Please check the reCAPTCHA box."
      },
      ja:{
        contact:"<ruby><rb>お問い合わせ</rb><rt>おといあわせ</rt></ruby>",
        name:"<ruby><rb>お名前</rb><rt>おなまえ</rt></ruby> / Name",
        email:"<ruby><rb>メール</rb><rt>めーる</rt></ruby> / Email",
        subject:"<ruby><rb>件名</rb><rt>けんめい</rt></ruby> / Subject",
        message:"<ruby><rb>メッセージ</rb><rt>めっせーじ</rt></ruby> / Message",
        cancel:"<ruby><rb>キャンセル</rb><rt>きゃんせる</rt></ruby>",
        send:"<ruby><rb>送信</rb><rt>そうしん</rt></ruby>",
        btn:"English",
        placeholders:{name:"おなまえ",email:"your@email.com",subject:"ご用件",message:"メッセージを入力してください"},
        sentok:"<ruby><rb>送信</rb><rt>そうしん</rt></ruby>しました。ありがとうございます。",
        sentng:"<ruby><rb>送信</rb><rt>そうしん</rt></ruby>に<ruby><rb>失敗</rb><rt>しっぱい</rt></ruby>しました。時間をおいてお試しください。",
        need:"reCAPTCHA をチェックしてください。"
      }
    };
    let lang = (localStorage.getItem('nt_lang') || ((navigator.language||'en').startsWith('ja')?'ja':'en'));

    const els = {
      title: document.getElementById('title'),
      lbName: document.getElementById('lbName'),
      lbEmail: document.getElementById('lbEmail'),
      lbSubject: document.getElementById('lbSubject'),
      lbMessage: document.getElementById('lbMessage'),
      btnCancel: document.getElementById('btnCancel'),
      btnSend: document.getElementById('btnSend'),
      name: document.getElementById('name'),
      email: document.getElementById('email'),
      subject: document.getElementById('subject'),
      message: document.getElementById('message'),
      msg: document.getElementById('msg')
    };

    function applyLang(){
      const t = dict[lang];
      document.documentElement.lang = (lang==='ja')?'ja':'en';
      els.title.innerHTML = t.contact;
      els.lbName.innerHTML = t.name;
      els.lbEmail.innerHTML = t.email;
      els.lbSubject.innerHTML = t.subject;
      els.lbMessage.innerHTML = t.message;
      els.btnCancel.innerHTML = t.cancel;
      els.btnSend.innerHTML = t.send;
      els.name.placeholder = t.placeholders.name;
      els.email.placeholder = t.placeholders.email;
      els.subject.placeholder = t.placeholders.subject;
      els.message.placeholder = t.placeholders.message;
      const btnHeader = document.getElementById('langBtn');
      if (btnHeader) btnHeader.textContent = t.btn;
      localStorage.setItem('nt_lang', lang);
    }

    function setupLangToggle(){
      const btnHeader = document.getElementById('langBtn');
      if (!btnHeader) return;
      btnHeader.addEventListener('click', ()=>{
        lang = (lang==='en')?'ja':'en';
        applyLang();
      });
      // 初期同期
      applyLang();
    }

    // ---------- 3) Learning / Learned をヘッダーから開くフォールバック ----------
    function openOverlay(selectorDrawer){
      const overlay = document.getElementById('learning-overlay');
      const drawer  = document.querySelector(selectorDrawer);
      if (overlay && drawer){
        overlay.style.display = 'block';
        // slide-in
        setTimeout(()=>{ drawer.style.right = '0'; }, 10);
      }
    }
    function hookLearningButtons(){
      const openLearningBtn = document.querySelector('[data-open="learning"], #learnBtn');
      const openLearnedBtn  = document.querySelector('[data-open="learned"],  #learnedBtn');
      if (openLearningBtn){
        openLearningBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          if (window._ntxOpenLearning) { window._ntxOpenLearning(); }
          else { openOverlay('#learning-drawer'); }
        });
      }
      if (openLearnedBtn){
        openLearnedBtn.addEventListener('click', (e)=>{
          e.preventDefault();
          if (window._ntxOpenLearned) { window._ntxOpenLearned(); }
          else { openOverlay('#learned-drawer'); }
        });
      }
    }

    // ---------- 4) 送信処理（reCAPTCHA 必須） ----------
    const form = document.getElementById('contactForm');
    const iframe = document.getElementById('submit_iframe');
    iframe.addEventListener('load', ()=>{
      const t = dict[lang];
      const msg = document.getElementById('msg');
      msg.innerHTML = t.sentok;
      msg.className = 'note msg-ok';
      form.reset();
      if (window.grecaptcha) grecaptcha.reset();
    });

    form.addEventListener('submit', (ev)=>{
      const t = dict[lang];
      const token = window.grecaptcha ? grecaptcha.getResponse() : '';
      const msg = document.getElementById('msg');
      if (!token){
        ev.preventDefault();
        msg.innerHTML = t.need;
        msg.className = 'note msg-ng';
        return;
      }
      document.getElementById('token').value = token;
      msg.textContent=''; msg.className='note';
    });

    document.getElementById('btnCancel').addEventListener('click', ()=>{
      form.reset();
      const msg = document.getElementById('msg');
      msg.textContent=''; msg.className='note';
      if (window.grecaptcha) grecaptcha.reset();
    });

    // 初期化
    (async function(){
      await loadPartials();
      // 言語適用は loadPartials 内で setupLangToggle() → applyLang() 済み
    })();
  </script>
</body>
</html>
