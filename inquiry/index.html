<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    :root{--base:#ef4444;--bg:#f8f0ee}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;background:#f7f7f7;margin:0}
    header{padding:10px 16px;border-top:5px solid var(--base);background:#fff}
    header .brand{color:#222;font-weight:700}
    main{max-width:860px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.05);padding:20px}
    h1{font-size:20px;margin:0 0 12px}
    label{display:block;color:#333;font-size:13px;margin:14px 0 6px}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:8px;padding:12px;font-size:14px;background:#f9fafb}
    textarea{min-height:160px;resize:vertical}
    .row{display:flex;gap:12px}
    .row .col{flex:1}
    .actions{display:flex;align-items:center;gap:12px;margin-top:14px}
    .btn{appearance:none;border:none;background:var(--base);color:#fff;border-radius:999px;padding:10px 20px;font-weight:700;cursor:pointer}
    .note{font-size:12px;color:#555;margin-top:6px}
    .flag{display:inline-block;font-size:12px;background:#fde2e2;color:#b91c1c;border:1px solid #fecaca;border-radius:8px;padding:8px 10px;margin-top:10px}
    .ok{display:inline-block;font-size:13px;background:#ecfdf5;color:#047857;border:1px solid #a7f3d0;border-radius:8px;padding:8px 10px;margin-top:10px}
    .muted{color:#666}
    .lang{float:right;display:flex;gap:8px}
    .lang button{border:1px solid #ddd;background:#fff;border-radius:16px;padding:4px 10px;cursor:pointer}
    .hide{display:none!important}
  </style>
</head>
<body>
  <header>
    <div class="brand">nihongotext.com <span class="muted">== beta version ==</span>
      <span class="lang">
        <button id="btnJa">日本語</button>
        <button id="btnEn">English</button>
      </span>
    </div>
  </header>

  <main>
    <div class="card">
      <h1 data-i="title">お問い合わせ</h1>

      <div class="row">
        <div class="col">
          <label data-i="label_name">お名前</label>
          <input id="name" autocomplete="name" />
        </div>
        <div class="col">
          <label data-i="label_email">メール</label>
          <input id="email" type="email" autocomplete="email" />
        </div>
      </div>

      <label data-i="label_subject">件名</label>
      <input id="subject" />

      <label data-i="label_category">カテゴリ</label>
      <select id="category">
        <option value="general">一般 / General</option>
        <option value="bug">不具合 / Bug</option>
        <option value="request">要望 / Request</option>
      </select>

      <label data-i="label_message">内容</label>
      <textarea id="message" placeholder=""></textarea>

      <!-- reCAPTCHA v2 (explicit render) -->
      <div style="margin-top:12px">
        <div id="recaptcha"></div>
      </div>

      <div class="actions">
        <button class="btn" id="sendBtn" data-i="btn_send">送信</button>
        <span class="muted" id="tos" data-i="tos">送信すると、プライバシーポリシーと利用規約に同意したものとなります。</span>
      </div>

      <!-- result / error area -->
      <div id="msgArea" class="hide"></div>
    </div>
  </main>

  <script>
    // ======= 言語切替（簡易） =======
    const i18n = {
      ja:{
        title:"お問い合わせ",label_name:"お名前",label_email:"メール",label_subject:"件名",
        label_category:"カテゴリ",label_message:"内容",btn_send:"送信",
        tos:"送信すると、プライバシーポリシーと利用規約に同意したものとなります。",
        ok_sent:"送信に成功しました。ありがとうございました。",
        err_bad_request:"送信に失敗しました（入力または認証に問題があります）。チェックボックスをもう一度クリックしてください。",
        err_captcha:"送信に失敗しました（reCAPTCHA 認証に失敗）。",
        err_jsonp:"送信に失敗しました（通信エラー）。",
      },
      en:{
        title:"Contact us",label_name:"Name",label_email:"Email",label_subject:"Subject",
        label_category:"Category",label_message:"Message",btn_send:"Send",
        tos:"By sending, you agree to our Privacy Policy and Terms.",
        ok_sent:"Your message has been sent. Thank you!",
        err_bad_request:"Send failed (missing input or captcha token). Please solve the checkbox again.",
        err_captcha:"Send failed (reCAPTCHA verification failed).",
        err_jsonp:"Send failed (network/JSONP error).",
      }
    };
    let LANG='ja';
    function applyLang(){
      const t=i18n[LANG];
      document.querySelectorAll("[data-i]").forEach(el=>{
        const k=el.getAttribute("data-i");
        if(t[k]) el.textContent=t[k];
      });
      document.getElementById('message').placeholder = (LANG==='ja'?'できるだけ詳細にご記入ください。':'Please provide as many details as possible.');
    }
    document.getElementById('btnJa').onclick=()=>{LANG='ja';applyLang();}
    document.getElementById('btnEn').onclick=()=>{LANG='en';applyLang();}
    applyLang();

    // ======= 設定 =======
    // Apps Script（v22）JSONP エンドポイント
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwOZY52HD-rvYVGFMkKsgm0feGWxgFypjpPbhVEBLYgKe1T3IKf9gDNAiKIjJZcZNdNA/exec";
    // reCAPTCHA v2 site key（チェックボックス）
    const RECAPTCHA_SITE_KEY = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV";

    // ======= reCAPTCHA (explicit render) =======
    let recaptchaWidgetId = null;
    window.onRecaptchaReady = function(){
      recaptchaWidgetId = grecaptcha.render("recaptcha", { sitekey: RECAPTCHA_SITE_KEY, theme: "light" });
    };

    // ======= UI helpers =======
    const msgArea = document.getElementById('msgArea');
    function showMsg(html, ok=false){
      msgArea.className = ok ? "ok" : "flag";
      msgArea.innerHTML = html;
      msgArea.classList.remove("hide");
    }
    function hideMsg(){ msgArea.classList.add("hide"); }

    // ======= JSONP 呼び出し =======
    function jsonp(url, cb){
      const name = "cb_" + Math.random().toString(36).slice(2);
      window[name] = (data)=>{ try{ cb(null, data); } finally { delete window[name]; s.remove(); } };
      const s = document.createElement('script');
      s.src = url + (url.includes("?")?"&":"?") + "callback=" + name;
      s.onerror = ()=>{ cb(new Error("jsonp_load_failed")); s.remove(); delete window[name]; };
      document.body.appendChild(s);
    }

    // ======= 送信 =======
    document.getElementById('sendBtn').addEventListener('click', function(){
      hideMsg();

      const name    = document.getElementById('name').value.trim();
      const email   = document.getElementById('email').value.trim();
      const subject = document.getElementById('subject').value.trim();
      const category= document.getElementById('category').value;
      const message = document.getElementById('message').value.trim();

      // reCAPTCHA token を取得（v2 checkbox）
      const token = grecaptcha.getResponse(recaptchaWidgetId);

      if(!message || !token){
        showMsg(i18n[LANG].err_bad_request);
        return;
      }

      const params = new URLSearchParams({
        mode: "contact_submit",
        name, email,
        subject: subject ? `[${category}] ${subject}` : `[${category}]`,
        message,
        token
      });

      jsonp(`${SCRIPT_URL}?${params.toString()}`, (err, res)=>{
        if(err){ showMsg(i18n[LANG].err_jsonp); return; }
        if(!res || res.ok!==true){
          if(res && res.reason==='captcha_failed'){ showMsg(i18n[LANG].err_captcha); }
          else { showMsg(i18n[LANG].err_bad_request); }
          // 失敗時はトークンをリセット
          grecaptcha.reset(recaptchaWidgetId);
          return;
        }
        // 成功
        showMsg(i18n[LANG].ok_sent, true);
        document.getElementById('name').value="";
        document.getElementById('email').value="";
        document.getElementById('subject').value="";
        document.getElementById('message').value="";
        grecaptcha.reset(recaptchaWidgetId);
      });
    });
  </script>

  <!-- v2 Checkbox 用 API（explicit render）-->
  <script src="https://www.google.com/recaptcha/api.js?onload=onRecaptchaReady&render=explicit" async defer></script>
</body>
</html>
