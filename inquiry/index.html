<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>お問い合わせ | nihongotext.com</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;background:#fff5f5;margin:0}
    header,footer{padding:12px 16px}
    header{border-bottom:3px solid #ff6b6b}
    .brand{color:#d62828;font-weight:800;font-size:20px}
    main{max-width:860px;margin:24px auto;padding:0 16px}
    .panel{background:#fff;border:1px solid #eee;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.04);padding:20px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    label{display:block;color:#444;font-size:13px;margin:14px 0 6px}
    input,select,textarea{width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:10px;padding:12px 14px;font-size:15px;background:#fff}
    textarea{min-height:140px;resize:vertical}
    .actions{display:flex;align-items:center;gap:12px;margin-top:14px}
    .btn{background:#ff6b6b;color:#fff;border:none;border-radius:999px;padding:10px 18px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .note{font-size:12px;color:#666;margin-top:6px}
    .status{margin-top:14px;padding:10px 14px;border-radius:10px;font-size:14px;white-space:pre-wrap}
    .ok{background:#e8fff0;color:#165b31;border:1px solid #b9f3cf}
    .ng{background:#fff0f0;color:#7d1d1d;border:1px solid #f3b9b9}
    #recaptchaBox{transform:scale(1);transform-origin:0 0}
  </style>
</head>
<body>
  <header>
    <div class="brand">nihongotext.com <span style="font-weight:600;color:#999">== beta version ==</span></div>
  </header>

  <main>
    <div class="panel">
      <h2 style="margin:0 0 8px">お問い合わせ</h2>

      <form id="f">
        <div class="row">
          <div class="col">
            <label>お名前</label>
            <input id="name" autocomplete="name" />
          </div>
          <div class="col">
            <label>メール</label>
            <input id="email" type="email" autocomplete="email" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>件名</label>
            <input id="subject" />
          </div>
          <div class="col">
            <label>カテゴリ</label>
            <select id="category">
              <option value="一般">一般</option>
              <option value="不具合">不具合</option>
              <option value="要望">要望</option>
            </select>
          </div>
        </div>

        <label>内容</label>
        <textarea id="message"></textarea>

        <div id="recaptchaBox" style="margin-top:12px"></div>

        <div class="actions">
          <button id="sendBtn" class="btn" type="submit">送信</button>
          <div id="status" class="status" aria-live="polite"></div>
        </div>

        <div class="note">送信すると、プライバシーポリシー と 利用規約 に同意したものとなります。</div>
      </form>
    </div>
  </main>

  <footer>© 2025 nihongotext.com</footer>

  <script>
    // ===== 設定 =====
    // あなたの exec URL（/exec で終わる）
    const ENDPOINT_EXEC = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec";
    // あなたの reCAPTCHA v2 (checkbox) site key
    const SITE_KEY = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV";

    // ===== reCAPTCHA explicit render（重複レンダー防止） =====
    let recaptchaWidgetId = null;
    function onloadRecaptcha(){
      try{
        if (typeof grecaptcha !== "undefined" && recaptchaWidgetId === null) {
          recaptchaWidgetId = grecaptcha.render("recaptchaBox", { sitekey: SITE_KEY });
        }
      }catch(e){ console.warn("reCAPTCHA render skipped:", e); }
    }

    // ===== i18n（必要最低限） =====
    const I18N = {
      ja: { t1:"お問い合わせ", name:"お名前", email:"メール", subject:"件名", category:"カテゴリ", message:"内容",
            pleaseCaptcha:"reCAPTCHA を完了してください。", sending:"送信しています…", sent:"送信しました。ありがとうございます！",
            failed:"送信に失敗しました。" },
      en: { t1:"Contact us", name:"Name", email:"Email", subject:"Subject", category:"Category", message:"Message",
            pleaseCaptcha:"Please complete the reCAPTCHA.", sending:"Sending...", sent:"Sent. Thank you!", failed:"Failed to send." }
    };
    let currentLang = (new URL(location.href).searchParams.get("lang") || "ja").toLowerCase();

    // ===== JSONP helper =====
    function jsonp(url, params, timeoutMs=15000){
      return new Promise((resolve,reject)=>{
        const cb = "cb_" + Date.now() + "_" + Math.random().toString(36).slice(2);
        const sp = new URLSearchParams({...params, callback: cb});
        const s  = document.createElement("script");
        let done = false;
        function cleanup(){
          if (done) return;
          done = true;
          delete window[cb];
          s.remove();
        }
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=>{ cleanup(); reject(new Error("jsonp_load_failed")); };
        s.src = url + "?" + sp.toString();
        document.body.appendChild(s);
        setTimeout(()=>{ cleanup(); reject(new Error("jsonp_timeout")); }, timeoutMs);
      });
    }

    // ===== UI helpers =====
    const $ = (id)=>document.getElementById(id);
    function setStatus(kind, msg){
      const el = $("status");
      el.className = "status " + (kind==="ok" ? "ok" : "ng");
      el.textContent = msg;
    }

    // ===== Submit =====
    $("f").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      const name = $("name").value.trim();
      const email = $("email").value.trim();
      const subject = $("subject").value.trim();
      const category = $("category").value.trim();
      const message = $("message").value.trim();

      // reCAPTCHA v2 checkbox のトークン取得
      let token = "";
      try { token = grecaptcha.getResponse(recaptchaWidgetId || 0) || ""; } catch(_){}
      if (!token){
        setStatus("ng", I18N[currentLang].pleaseCaptcha);
        return;
      }

      const btn = $("sendBtn");
      btn.disabled = true;
      setStatus("ng", I18N[currentLang].sending);

      try{
        const res = await jsonp(ENDPOINT_EXEC, {
          mode: "contact_submit",
          name, email,
          subject: subject || category, // どちらか空でも一応入るように
          message,
          token
        });

        if (res && res.ok){
          setStatus("ok", I18N[currentLang].sent);
          $("f").reset();
          try { grecaptcha.reset(recaptchaWidgetId || 0); } catch(_){}
        }else{
          setStatus("ng", (res && (res.reason || res.detail)) || I18N[currentLang].failed);
        }
      }catch(err){
        setStatus("ng", I18N[currentLang].failed + " : " + err.message);
      }finally{
        btn.disabled = false;
      }
    });
  </script>

  <!-- reCAPTCHA v2 (checkbox) — onload=onloadRecaptcha で明示レンダリング -->
  <script src="https://www.google.com/recaptcha/api.js?onload=onloadRecaptcha&render=explicit" async defer></script>
</body>
</html>
