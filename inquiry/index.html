<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>お問い合わせ | nihongotext.com</title>
<style>
  :root{
    --red:#e74c3c; --bg:#f6f2f1; --card:#ffffff; --text:#333; --muted:#777; --ok:#2e7d32; --err:#c62828;
    --radius:16px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI",sans-serif;}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-top:4px solid var(--red)}
  .brand{font-weight:700}
  .brand a{color:inherit;text-decoration:none}
  .beta{color:var(--muted);font-size:12px;margin-left:8px}
  .lang-switch{display:flex;gap:8px}
  .lang-switch button{border:1px solid #ddd;background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
  .lang-switch .active{border-color:var(--red);color:var(--red);font-weight:700}
  main{display:flex;justify-content:center;padding:26px 14px}
  .card{width:min(720px,100%);background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.06);padding:18px}
  h1{font-size:20px;margin:4px 0 14px}
  label{display:block;font-size:12px;margin:12px 0 6px}
  input,textarea{width:100%;box-sizing:border-box;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:16px;background:#fafafa}
  textarea{min-height:160px;resize:vertical}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .row .col{flex:1 1 260px}
  .captcha-row{display:flex;align-items:center;gap:14px;margin-top:10px}
  .note{font-size:12px;color:var(--muted)}
  .actions{margin-top:16px;display:flex;align-items:center;gap:12px}
  .btn{appearance:none;border:none;border-radius:999px;background:linear-gradient(180deg,#ff6b6b,#e74c3c);color:#fff;padding:10px 18px;font-size:15px;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(231,76,60,.35)}
  .status{font-size:14px}
  .ok{color:var(--ok)}
  .err{color:var(--err)}
  footer{padding:24px 0 40px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <a href="/" id="homeLink">nihongotext.com</a>
    <span class="beta">== beta version ==</span>
  </div>
  <div class="lang-switch">
    <button type="button" id="btnJa" class="active">日本語</button>
    <button type="button" id="btnEn">English</button>
  </div>
</header>

<main>
  <div class="card" role="form" aria-labelledby="title">
    <h1 id="title">お問い合わせ</h1>

    <div class="row">
      <div class="col">
        <label for="name" id="lblName">お名前</label>
        <input id="name" type="text" autocomplete="name" />
      </div>
      <div class="col">
        <label for="email" id="lblEmail">メールアドレス</label>
        <input id="email" type="email" autocomplete="email" />
      </div>
    </div>

    <label for="subject" id="lblSubject">件名</label>
    <input id="subject" type="text" />

    <label for="message" id="lblMessage">メッセージ</label>
    <textarea id="message"></textarea>

    <div class="captcha-row">
      <div id="recaptcha" class="g-recaptcha" data-sitekey="6LeLRe4rAAAAAG9bnqf-BeU8rI3EM8k8F5plub25"></div>
      <div class="note" id="captchaNote">私はロボットではありません</div>
    </div>

    <div class="actions">
      <button class="btn" id="sendBtn">送信</button>
      <div class="status" id="statusArea"></div>
    </div>
  </div>
</main>

<footer>© 2025 nihongotext.com</footer>

<!-- reCAPTCHA v2 -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<script>
(() => {
  "use strict";

  // ====== Config ======
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwOZYS2HD-rvYVGFMkKsgm0feGWxgFypjpPbhVE8LYgKJe1T3lXfkgDNAiKIjJZcZNdNA/exec"; // ←ご指定のexec URL
  const DEFAULT_CALLBACK = "cb_x"; // GAS から JSONP で返すコールバック名

  // ====== i18n ======
  const t = {
    ja: {
      title: "お問い合わせ",
      name: "お名前",
      email: "メールアドレス",
      subject: "件名",
      message: "メッセージ",
      captchaNote: "私はロボットではありません",
      send: "送信",
      ok: "送信を受け付けました。自動返信メールをご確認ください。",
      errCaptcha: "reCAPTCHA の認証に失敗しました。チェックを入れてから再送信してください。",
      errBlank: "未入力の項目があります。",
      errNet: "サーバーに接続できません（404/ネットワーク）。時間をおいて再度お試しください。",
      errPopup: "ポップアップがブロックされました。サイトのポップアップを一時的に許可して再試行してください。"
    },
    en: {
      title: "Contact",
      name: "Name",
      email: "Email",
      subject: "Subject",
      message: "Message",
      captchaNote: "I'm not a robot",
      send: "Send",
      ok: "Your message has been received. Please check the auto-reply email.",
      errCaptcha: "reCAPTCHA verification failed. Check the box and try again.",
      errBlank: "Some required fields are empty.",
      errNet: "Cannot reach the server (404/network). Please try again later.",
      errPopup: "Pop-ups were blocked. Allow pop-ups temporarily and try again."
    }
  };

  const qs = new URLSearchParams(location.search);
  const lang = (qs.get("lang") === "en") ? "en" : "ja";
  let dict = t[lang];

  function applyLang(l){
    dict = t[l];
    document.documentElement.lang = l === "en" ? "en" : "ja";
    document.getElementById("title").textContent = dict.title;
    document.getElementById("lblName").textContent = dict.name;
    document.getElementById("lblEmail").textContent = dict.email;
    document.getElementById("lblSubject").textContent = dict.subject;
    document.getElementById("lblMessage").textContent = dict.message;
    document.getElementById("captchaNote").textContent = dict.captchaNote;
    document.getElementById("sendBtn").textContent = dict.send;
    document.getElementById("btnJa").classList.toggle("active", l==="ja");
    document.getElementById("btnEn").classList.toggle("active", l==="en");
    // URL の lang を更新（履歴は汚さない）
    const url = new URL(location.href);
    url.searchParams.set("lang", l);
    history.replaceState(null, "", url);
  }
  applyLang(lang);

  document.getElementById("btnJa").onclick = () => applyLang("ja");
  document.getElementById("btnEn").onclick = () => applyLang("en");

  // ====== Utilities ======
  const $ = (id)=>document.getElementById(id);
  const setStatus=(msg,ok=false)=>{ const el=$("statusArea"); el.textContent=msg; el.className="status "+(ok?"ok":"err"); };
  const encode = (s)=>encodeURIComponent(String(s ?? "").trim());

  // ====== JSONP submit ======
  function submitJSONP(){
    const name = $("name").value;
    const email = $("email").value;
    const subject = $("subject").value;
    const message = $("message").value;

    if(!name || !email || !message){
      setStatus(dict.errBlank,false);
      return;
    }

    // reCAPTCHA
    const token = (window.grecaptcha && grecaptcha.getResponse()) || "";
    if(!token){
      setStatus(dict.errCaptcha,false);
      return;
    }

    // 既存の script を掃除
    const old = document.querySelector('script[data-jsonp="req"]');
    if(old) old.remove();

    // タイムアウト対策
    let done = false;
    const timeout = setTimeout(() => {
      if(done) return;
      done = true;
      window[DEFAULT_CALLBACK] = ()=>{};
      setStatus(dict.errNet,false);
    }, 15000);

    // コールバック
    window[DEFAULT_CALLBACK] = function (res){
      if(done) return;
      done = true;
      clearTimeout(timeout);
      try{
        if(res && res.ok){
          setStatus(dict.ok,true);
          // 成功したらフォームと reCAPTCHA をリセット
          $("message").value = "";
          $("subject").value = "";
          grecaptcha.reset();
        }else{
          const reason = (res && res.reason) || "";
          if(reason === "captcha_failed"){
            setStatus(dict.errCaptcha,false);
          }else if(reason === "popup_blocked"){
            setStatus(dict.errPopup,false);
          }else{
            setStatus(dict.errNet,false);
          }
        }
      }catch(e){
        setStatus(dict.errNet,false);
      }finally{
        // JSONP スクリプトを削除
        const sc = document.querySelector('script[data-jsonp="req"]'); if(sc) sc.remove();
      }
    };

    // JSONP リクエスト生成
    const url =
      GAS_URL
      + "?mode=contact_submit"
      + "&lang="+encode(document.documentElement.lang || "ja")
      + "&name="+encode(name)
      + "&email="+encode(email)
      + "&subject="+encode(subject)
      + "&message="+encode(message)
      + "&g-recaptcha-response="+encode(token)
      + "&callback="+encode(DEFAULT_CALLBACK);

    const sc = document.createElement("script");
    sc.src = url;
    sc.async = true;
    sc.defer = true;
    sc.dataset.jsonp = "req";
    sc.onerror = () => {
      if(done) return;
      done = true;
      clearTimeout(timeout);
      setStatus(dict.errNet,false);
    };
    document.body.appendChild(sc);
  }

  $("sendBtn").addEventListener("click", (e)=>{ e.preventDefault(); setStatus(""); submitJSONP(); });
})();
</script>
</body>
</html>
