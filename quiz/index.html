<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quiz | nihongotext.com</title>
<link rel="icon" href="/favicon.ico" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-9QSHWJE0HZ', { send_page_view:false });
</script>

<style>
/* --- Design Tokens --- */
:root{ --shu:#e6462d; --shu-tint:#fff2ef; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; --card:#fff7f6; }
*{ box-sizing:border-box }

/* Font Stack */
html,body{
  margin:0; background:#fff; color:var(--ink);
  font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,
        "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif;
}
a{ color:inherit; text-decoration:none }
button{ cursor:pointer; font-family:inherit; }
.wrap{ max-width:1100px; margin:0 auto; padding:0 16px; }

/* --- Unified Header --- */
.site-header { background:#fff; border-bottom:1px solid #eee; position:relative; z-index:30; }
.site-header-inner { max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; flex-direction:column; align-items:center; gap:8px; position:relative; }
.logo-text { font-weight:800; font-size:32px; color:var(--shu); }
.beta-text { font-size:20px; color:#98a1a8; margin-bottom: 5px; }
.nav-links { display:flex; gap:14px; flex-wrap:wrap; justify-content:center; }
.nav-links a { color:#333; font-weight:600; font-size:15px; }
.nav-links a:hover { color:var(--shu); }
.sns-nav { display:flex; align-items:center; gap:14px; font-size:20px; justify-content:center; margin-top: 5px; }
.sns-nav a { color:var(--shu); }

/* --- Quiz Controls --- */
.controls { background:#f9fafb; padding:20px; border-radius:15px; margin:20px 0; border:1px solid var(--line); display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
.controls label { font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:4px; font-weight:bold; }
select, input[type="number"] { height:40px; border:1px solid var(--line); border-radius:10px; padding:0 10px; background:#fff; }

.btn { border:1px solid var(--shu); color:var(--shu); background:#fff; border-radius:10px; padding:10px 20px; font-weight:700; transition:0.2s; }
.btn:hover { background:var(--shu-tint); }
.btn.primary { background:var(--shu); color:#fff; }

/* --- Quiz Stage --- */
.card { background:var(--card); border:1px solid #f1cbc6; border-radius:14px; padding:25px; margin-bottom:30px; }
.badge { display:inline-block; background:#fff; border:1px solid #f1cbc6; padding:4px 12px; border-radius:999px; font-size:13px; font-weight:700; color:var(--muted); }

/* 問題文と英語翻訳のスタイル */
.q-sentence { font-size:24px; font-weight:800; margin:20px 0 5px 0; line-height:1.4; color:var(--ink); }
.q-translation { font-size:16px; color:var(--muted); margin-bottom:20px; font-style: italic; }

.choice { width:100%; text-align:left; padding:15px; border:1px solid var(--line); border-radius:12px; background:#fff; margin-bottom:10px; font-size:16px; transition:0.2s; }
.choice:hover:not(:disabled) { border-color:var(--shu); background:var(--shu-tint); }
.choice.correct { border-color:#10b981; background:#ecfdf5; color:#065f46; font-weight:bold; }
.choice.wrong { border-color:#ef4444; background:#fef2f2; color:#991b1b; }

.ex-panel { margin-top:20px; padding-top:15px; border-top:1px dashed #f1cbc6; font-size:14px; }
.ex-label { font-weight:bold; color:var(--shu); display:block; margin-bottom:4px; }

/* --- Footer --- */
.site-footer { background:#fff5f4; border-top:1px solid #f0c8c3; padding:25px 0; margin-top:40px; }
.footer-inner { max-width:1100px; margin:0 auto; padding:0 16px; display:flex; flex-direction:column; gap:14px; align-items:center; text-align:center; }
.footer-copy { color:var(--shu); font-size:14px; font-weight:600; }
</style>
</head>
<body>

<header class="site-header">
  <div class="site-header-inner">
    <a href="/" style="text-decoration:none;display:flex;align-items:center;gap:2px;">
      <span class="logo-text">nihongotext</span><span style="font-weight:800;font-size:32px;color:#333;">.com</span>
    </a>
    <div class="beta-text">== beta version ==</div>
    <nav class="nav-links">
      <a href="/dictionary.html">Vocabulary Tool</a>
      <a href="/quiz/index.html" style="color:var(--shu)">Quiz</a>
      <a href="/blog/index.html">Blog</a>
      <a href="/inquiry/index.html">Inquiry</a>
    </nav>
    <nav class="sns-nav">
      <a href="https://x.com/nihongotext_com" target="_blank"><i class="fa-brands fa-x-twitter"></i></a>
      <a href="https://ko-fi.com/nihongotext" target="_blank"><i class="fa-solid fa-mug-hot"></i></a>
    </nav>
  </div>
</header>

<main class="wrap">
  <div class="controls">
    <label>Level
      <select id="levelSel">
        <option value="N5">N5</option><option value="N4">N4</option><option value="N3">N3</option><option value="N2">N2</option><option value="N1">N1</option>
      </select>
    </label>
    <label>Category
      <select id="posSel">
        <option value="verbs">Verbs</option>
        <option value="nouns">Nouns</option>
        <option value="adjectives-i">i-Adjectives</option>
        <option value="adjectives-na">na-Adjectives</option>
      </select>
    </label>
    <label>Count
      <input id="qCount" type="number" value="10" min="5" max="30">
    </label>
    <button id="startBtn" class="btn primary">Start Quiz</button>
  </div>

  <section id="stage" class="card">
    <div id="intro">
      <h2>JLPT Vocabulary Quiz</h2>
      <p style="color:var(--muted)">Choose the best word to fill in the blank （　　）.</p>
    </div>

    <div id="quizArea" style="display:none">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div id="qCrumbs" class="badge">1 / 10</div>
        <div id="qScore" class="badge">Score: 0</div>
      </div>
      <div id="qText" class="q-sentence"></div>
      <div id="qEnText" class="q-translation"></div>

      <div id="qChoices"></div>
      <div id="qExplain" class="ex-panel" style="display:none"></div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
        <button id="stopBtn" class="btn">Stop</button>
        <button id="nextBtn" class="btn primary" disabled>Next</button>
      </div>
    </div>

    <div id="resultArea" style="display:none; text-align:center;">
      <h3>Result</h3>
      <div id="resultSummary" style="font-size:24px; font-weight:800; margin:20px 0;"></div>
      <button onclick="location.reload()" class="btn primary">Try Again</button>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="footer-inner">
    <div class="footer-copy">© <span id="ft-year"></span> nihongotext.com</div>
    <nav style="display:flex; gap:15px; margin-bottom:10px;">
      <a href="/legal.html" style="color:var(--shu); font-weight:600;">Legal</a>
      <a href="/privacy.html" style="color:var(--shu); font-weight:600;">Privacy</a>
    </nav>
  </div>
</footer>

<script>
let bank = [], quiz = [], idx = 0, score = 0;

function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

// 動的置換ロジック
function makeBlankSentence(exText, targetWord) {
  if (exText.includes(targetWord)) return exText.replace(targetWord, "（　　）");
  const kanjiStem = targetWord.replace(/[ぁ-んァ-ン]/g, '');
  if (kanjiStem && exText.includes(kanjiStem)) {
    const regex = new RegExp(kanjiStem + "[ぁ-ん]*", "g");
    return exText.replace(regex, "（　　）");
  }
  return "（　　） " + exText;
}

async function startQuiz() {
  const lv = document.getElementById('levelSel').value;
  const pos = document.getElementById('posSel').value;
  const count = parseInt(document.getElementById('qCount').value);

  try {
    const res = await fetch(`/data/json/${lv}/${pos}.json`);
    const data = await res.json();
    bank = Array.isArray(data) ? data : (data.entries || []);
    
    if (bank.length < 4) return alert("Not enough data.");
    
    quiz = shuffle([...bank]).slice(0, count).map(item => {
      const correct = item.ja;
      const distractors = shuffle(bank.filter(x => x.ja !== correct)).slice(0, 3).map(x => x.ja);
      const options = shuffle([correct, ...distractors]);
      
      let sentence = "（　　）";
      let enSentence = ""; 
      if (item.examples && item.examples.length > 0) {
        const ex = item.examples[0];
        sentence = makeBlankSentence(ex.ja, correct);
        enSentence = ex.en; // 英語翻訳を取得
      }

      return { item, sentence, enSentence, options, answer: options.indexOf(correct) };
    });

    idx = 0; score = 0;
    document.getElementById('intro').style.display = 'none';
    document.getElementById('quizArea').style.display = 'block';
    renderQuestion();
  } catch (e) { alert("Failed to load data."); }
}

function renderQuestion() {
  const q = quiz[idx];
  document.getElementById('qCrumbs').textContent = `${idx + 1} / ${quiz.length}`;
  document.getElementById('qScore').textContent = `Score: ${score}`;
  
  // 日本語と英語をセット
  document.getElementById('qText').textContent = q.sentence;
  document.getElementById('qEnText').textContent = q.enSentence; 

  document.getElementById('qExplain').style.display = 'none';
  document.getElementById('nextBtn').disabled = true;

  const box = document.getElementById('qChoices');
  box.innerHTML = '';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'choice';
    btn.textContent = `${i + 1}. ${opt}`;
    btn.onclick = () => handleAnswer(i);
    box.appendChild(btn);
  });
}

function handleAnswer(i) {
  const q = quiz[idx];
  const btns = document.querySelectorAll('.choice');
  btns.forEach((b, j) => {
    b.disabled = true;
    if (j === q.answer) b.classList.add('correct');
    if (i === j && i !== q.answer) b.classList.add('wrong');
  });

  if (i === q.answer) score++;
  
  const exp = document.getElementById('qExplain');
  if (q.item.examples && q.item.examples.length > 0) {
    const e = q.item.examples[0];
    exp.innerHTML = `<div class="ex-row"><span class="ex-label">Answer:</span>${e.ja}<br><small>${e.en}</small></div>`;
    exp.style.display = 'block';
  }

  document.getElementById('nextBtn').disabled = false;
  if (idx === quiz.length - 1) document.getElementById('nextBtn').textContent = 'Finish';
}

document.getElementById('nextBtn').onclick = () => {
  idx++;
  if (idx < quiz.length) renderQuestion();
  else showResult();
};

function showResult() {
  document.getElementById('quizArea').style.display = 'none';
  document.getElementById('resultArea').style.display = 'block';
  document.getElementById('resultSummary').textContent = `${score} / ${quiz.length} Correct!`;
}

document.getElementById('startBtn').onclick = startQuiz;
document.getElementById('stopBtn').onclick = () => location.reload();

// コピーライト年の自動更新
(function(){
  const el = document.getElementById('ft-year');
  if (el) el.textContent = new Date().getFullYear();
})();
</script>
</body>
</html>
