<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog Updates | nihongotext.com</title>
  <link rel="icon" href="/favicon.ico" />
  <base href="/" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="/common/style.css" rel="stylesheet" />
  <style>
    body { font-family: system-ui, sans-serif; background: #fafafa; color: #1f2937; }
    .container { max-width: 880px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 1rem; color: #e6462d; }
    .post { background: #fff; border: 1px solid #e5e7eb; padding: 16px 20px; border-radius: 10px; margin-bottom: 16px; }
    .post .post-date { font-size: 0.9rem; color: #6b7280; }
    .post h2 { font-size: 1.2rem; margin: 6px 0 10px; }
    .muted{color:#6b7280}
    [data-lang="en"] .ja{display:none}
    [data-lang="ja"] .en{display:none}
  </style>
</head>
<body>

  <header id="site-header"></header>

  <main class="container" id="page" data-lang="en">
    <h1 class="en">Blog Updates</h1>
    <h1 class="ja">ブログ更新一覧</h1>
    <div id="list"></div>
  </main>

  <footer id="site-footer"></footer>

  <script>
    // 言語状態
    const currentLang = ()=> localStorage.getItem('nt_lang') || ((navigator.language||'en').startsWith('ja')?'ja':'en');
    function applyLang(lang){
      const page=document.getElementById('page');
      page.setAttribute('data-lang',lang);
      document.documentElement.lang=(lang==='ja'?'ja':'en');
      localStorage.setItem('nt_lang',lang);
      // ヘッダーのボタン表示も更新
      const btn = document.getElementById('langBtn');
      if(btn) btn.textContent = (lang==='ja' ? 'English' : '日本語');
      if(window.__posts) render(window.__posts);
    }

    // 共通パーツ（ヘッダー/フッター）読み込み + 言語ボタンセットアップ ←★追加
    async function injectPartials(){
      const hdr = document.getElementById('site-header');
      const ftr = document.getElementById('site-footer');
      try{
        hdr.innerHTML = await fetch('/partials/header.html',{cache:'no-store'}).then(r=>r.text());
        ftr.innerHTML = await fetch('/partials/footer.html',{cache:'no-store'}).then(r=>r.text());
      }catch(_){
        hdr.innerHTML = '<div style="padding:14px;">nihongotext.com (header load failed)</div>';
        ftr.innerHTML = '<div style="padding:14px;">(footer load failed)</div>';
      }
      // ヘッダーの言語ボタンにイベントを付与
      const btn = document.getElementById('langBtn');
      if(btn){
        const sync=()=> btn.textContent = (currentLang()==='ja' ? 'English' : '日本語');
        btn.addEventListener('click', ()=>{
          const next = (currentLang()==='ja' ? 'en' : 'ja');
          applyLang(next);
          sync();
        });
        sync();
      }
    }

    // スキーマ互換
    function pick(obj, paths){
      for(const p of paths){
        const v = p.split('.').reduce((o,k)=> (o||{})[k], obj);
        if(typeof v === 'string' && v.trim()) return v;
      }
      return '';
    }
    function getTitle(p, lang){ return pick(p,[`${lang}.title`,`title_${lang}`,`title`]); }
    function getSummary(p, lang){ return pick(p,[`${lang}.summary`,`summary_${lang}`]); }
    function getHtml(p, lang){
      const html = pick(p,[`${lang}.html`]);
      if(html) return html;
      const s = getSummary(p, lang);
      return s ? `<p>${s}</p>` : '';
    }

    // レンダリング
    function render(items){
      const lang=currentLang();
      const list = document.getElementById('list');
      items.sort((a,b)=> new Date(b.date)-new Date(a.date));
      list.innerHTML = items.map(p=>{
        const title=getTitle(p,lang)||'(no title)';
        const html=getHtml(p,lang);
        const slug=p.slug||'';
        const date=p.date||'';
        return `
          <article class="post" id="${slug}">
            <div class="post-date"><i class="fa-regular fa-calendar"></i> <time datetime="${date}">${date}</time></div>
            <h2>${title}</h2>
            <div>${html}</div>
            <div style="margin-top:8px;">
              <a href="#${slug}" title="Permalink"><i class="fa-solid fa-link"></i> Permalink</a>
              <span class="muted"> / </span>
              <a href="/blog/" title="Back to Blog"><i class="fa-solid fa-arrow-left"></i> Back</a>
            </div>
          </article>
        `;
      }).join('');
      // ハッシュがあればスクロール
      if(location.hash){
        const t = document.getElementById(location.hash.slice(1));
        if(t) t.scrollIntoView({behavior:'smooth',block:'start'});
      }
    }

    // posts.json 読み込み
    async function loadPosts(){
      try{
        const json = await fetch('/blog/posts.json',{cache:'no-store'}).then(r=>r.json());
        window.__posts = Array.isArray(json)? json : [];
        render(window.__posts);
      }catch(e){
        document.getElementById('list').innerHTML = '<p style="color:#b91c1c;">Failed to load posts.</p>';
      }
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', async ()=>{
      await injectPartials();
      applyLang(currentLang());
      loadPosts();
    });
  </script>
</body>
</html>
