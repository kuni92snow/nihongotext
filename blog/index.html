<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog | nihongotext.com</title>
  <link rel="icon" href="/favicon.ico" />
  <base href="/" />

  <style>
    :root{--ink:#132c3a;--muted:#6b7280;--brand:#e6462d;--border:#e5e7eb}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;color:var(--ink);line-height:1.7}
    main .wrap{max-width:1100px;margin:auto;padding:16px}
    .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:14px;padding:18px 16px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .lang-switch .btn{border:1px solid var(--border);padding:6px 10px;border-radius:10px;background:#fff;cursor:pointer}
    .lang-switch .btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    h1{margin:0 0 8px}
    h2{margin:.2rem 0 .5rem}
    time{color:var(--muted);font-size:.9rem}
    .tools{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 16px}
    .search{display:flex;gap:8px;align-items:center;flex:1}
    .search input{flex:1;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:15px}
    .results{margin-top:10px}
    .result-item{padding:8px 10px;border-bottom:1px dashed var(--border)}
    .result-item a{text-decoration:none;color:var(--ink)}
    .result-item small{color:var(--muted)}
    .more{margin-top:8px}
    /* 言語切替 */
    [data-i18n][data-lang="en"] .ja{display:none}
    [data-i18n][data-lang="en"] .en{display:block}
    [data-i18n][data-lang="ja"] .en{display:none}
    [data-i18n][data-lang="ja"] .ja{display:block}
    /* ふりがな */
    ruby{ruby-position:over;ruby-align:start}
    rt{font-size:.6em;color:#666;letter-spacing:.03em}
    /* SVGアイコンのサイズ調整用 */
    .ico{width:18px;height:18px;display:inline-block}
    .ico-lg{width:28px;height:28px}
  </style>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-9QSHWJE0HZ');</script>
</head>
<body>
  <!-- 共通ヘッダー -->
  <div id="header"></div>

  <main>
    <div class="wrap" id="page" data-i18n data-lang="en">
      <!-- 見出し（ロゴSVG） -->
      <div class="en">
        <h1 class="row">
          <!-- ロゴ -->
          <svg class="ico-lg" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="#e6462d" stroke-width="2"/><circle cx="12" cy="12" r="5" fill="#e6462d"/></svg>
          Blog
        </h1>
        <p class="muted">Latest update from nihongotext.com</p>
      </div>
      <div class="ja">
        <h1 class="row">
          <svg class="ico-lg" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="12" cy="12" r="10" stroke="#e6462d" stroke-width="2"/><circle cx="12" cy="12" r="5" fill="#e6462d"/></svg>
          ブログ
        </h1>
        <p class="muted">nihongotext.com からのお知らせ</p>
      </div>

      <!-- ツールバー -->
      <div class="tools">
        <div class="lang-switch row">
          <button id="btn-en" class="btn">English</button>
          <button id="btn-ja" class="btn">日本語</button>
        </div>
        <div class="search">
          <!-- 検索アイコン -->
          <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke="#6b7280" stroke-width="2"/><path d="M20 20l-4.2-4.2" stroke="#6b7280" stroke-width="2" stroke-linecap="round"/></svg>
          <input id="q" type="search" placeholder="Search posts..." aria-label="Search posts">
        </div>
        <a class="row" href="/blog/updates.html" title="All updates">
          <!-- 履歴アイコン -->
          <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 4v6h6" stroke="#132c3a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.7 20A8 8 0 1 0 6 6" stroke="#132c3a" stroke-width="2" fill="none"/><path d="M12 8v5l3 2" stroke="#132c3a" stroke-width="2" stroke-linecap="round"/></svg>
          <span>Updates</span>
        </a>
      </div>

      <!-- 最新記事 -->
      <section id="latest" class="card"></section>

      <!-- 検索結果 -->
      <div id="searchResults" class="results" hidden></div>

      <div class="more">
        <a href="/blog/updates.html" class="row">
          <!-- 矢印 -->
          <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 5l7 7-7 7" stroke="#132c3a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          View full update history
        </a>
      </div>
    </div>
  </main>

  <!-- 共通フッター -->
  <div id="footer"></div>

  <script>
    // ===== 共通パーツ =====
    async function loadPartials(){
      const [h,f]=await Promise.all([fetch('/partials/header.html'),fetch('/partials/footer.html')]);
      document.getElementById('header').innerHTML=await h.text();
      document.getElementById('footer').innerHTML=await f.text();
      document.querySelector('#btn-en')?.addEventListener('click',()=>applyLang('en'));
      document.querySelector('#btn-ja')?.addEventListener('click',()=>applyLang('ja'));
    }

    // ===== 言語切替 =====
    function applyLang(lang){
      const page=document.getElementById('page');
      page.setAttribute('data-lang',lang);
      document.documentElement.lang=(lang==='ja'?'ja':'en');
      localStorage.setItem('nt_lang',lang);
      document.getElementById('btn-en')?.classList.toggle('active',lang==='en');
      document.getElementById('btn-ja')?.classList.toggle('active',lang==='ja');
      if(window.__posts){ renderLatest(window.__posts); if(!document.getElementById('searchResults').hidden) doSearch(); }
      if(window.gtag) gtag('event','language_change',{language:lang});
    }

    // ===== 投稿取得 =====
    async function fetchPosts(){
      const res=await fetch('/blog/posts.json',{cache:'no-store'});
      const data=await res.json();
      data.sort((a,b)=> new Date(b.date)-new Date(a.date));
      window.__posts=data; return data;
    }

    // ===== 最新記事描画 =====
    function renderLatest(posts){
      const latest=posts[0]; const lang=localStorage.getItem('nt_lang')||'en';
      const el=document.getElementById('latest');
      if(!latest){ el.innerHTML='<p class="muted">No posts yet.</p>'; return; }
      const head=`
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <!-- ノート -->
            <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><rect x="4" y="3" width="16" height="18" rx="2" stroke="#132c3a" stroke-width="2"/><path d="M8 7h8M8 11h8M8 15h5" stroke="#132c3a" stroke-width="2" stroke-linecap="round"/></svg>
            <time datetime="${latest.date}">${latest.date}</time>
          </div>
          <a class="row" href="/blog/updates.html#${latest.slug}" title="Permalink">
            <!-- リンク -->
            <svg class="ico" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M10 13a5 5 0 0 1 0-7l2-2a5 5 0 0 1 7 7l-1 1" stroke="#132c3a" stroke-width="2" stroke-linecap="round"/><path d="M14 11a5 5 0 0 1 0 7l-2 2a5 5 0 0 1-7-7l1-1" stroke="#132c3a" stroke-width="2" stroke-linecap="round"/></svg>
            <span>Permalink</span>
          </a>
        </div>`;
      const bodyEn=`<h2>${latest.en.title}</h2>${latest.en.html}`;
      const bodyJa=`<h2>${latest.ja.title}</h2>${latest.ja.html}`;
      el.innerHTML=head+(lang==='ja'?bodyJa:bodyEn);
    }

    // ===== 検索 =====
    function stripHtml(s){return String(s||'').replace(/<[^>]+>/g,' ');}
    function doSearch(){
      const q=document.getElementById('q').value.trim().toLowerCase();
      const box=document.getElementById('searchResults');
      const lang=localStorage.getItem('nt_lang')||'en';
      if(!q){ box.hidden=true; box.innerHTML=''; return; }
      const hits=window.__posts.filter(p=>{
        const t=(lang==='ja'?(p.ja.title+' '+stripHtml(p.ja.html)):(p.en.title+' '+stripHtml(p.en.html)));
        return t.toLowerCase().includes(q);
      }).slice(0,20);
      box.hidden=false;
      box.innerHTML = hits.length
        ? hits.map(p=>`<div class="result-item"><a href="/blog/updates.html#${p.slug}"><strong>${lang==='ja'?p.ja.title:p.en.title}</strong></a><br><small>${p.date}</small></div>`).join('')
        : '<div class="muted">No results.</div>';
    }

    // ===== 初期化 =====
    document.addEventListener('DOMContentLoaded',async()=>{
      await loadPartials();
      const saved=localStorage.getItem('nt_lang');
      applyLang(saved || ((navigator.language||'en').startsWith('ja')?'ja':'en'));
      const posts=await fetchPosts();
      renderLatest(posts);
      document.getElementById('q').addEventListener('input',doSearch);
    });
  </script>
</body>
</html>
