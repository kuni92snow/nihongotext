<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog | nihongotext.com</title>
  <link rel="icon" href="/favicon.ico" />
  <base href="/" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root{--ink:#132c3a;--muted:#6b7280;--brand:#e6462d;--border:#e5e7eb}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;color:var(--ink);line-height:1.7}
    main .wrap{max-width:1100px;margin:auto;padding:16px}
    .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:14px;padding:18px 16px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    h1{margin:0 0 8px}
    h2{margin:.2rem 0 .5rem}
    time{color:var(--muted);font-size:.9rem}
    .tools{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 16px}
    .search{display:flex;gap:8px;align-items:center;flex:1}
    .search input{flex:1;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:15px}
    .results{margin-top:10px}
    .result-item{padding:8px 10px;border-bottom:1px dashed var(--border)}
    .result-item a{text-decoration:none;color:var(--ink)}
    .result-item small{color:var(--muted)}
    .more{margin-top:8px}
    [data-i18n][data-lang="en"] .ja{display:none}
    [data-i18n][data-lang="ja"] .en{display:none}
    ruby{ruby-position:over;ruby-align:start}
    rt{font-size:.6em;color:#666;letter-spacing:.03em}
    .fa-fw{width:1.1em;text-align:center}
  </style>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-9QSHWJE0HZ');</script>
</head>
<body>
  <div id="header"></div>

  <main>
    <div class="wrap" id="page" data-i18n data-lang="en">
      <div class="en">
        <h1 class="row"><i class="fa-solid fa-record-vinyl fa-fw" style="color:#e6462d"></i> Blog</h1>
        <p class="muted">Latest update from nihongotext.com</p>
      </div>
      <div class="ja">
        <h1 class="row"><i class="fa-solid fa-record-vinyl fa-fw" style="color:#e6462d"></i> ブログ</h1>
        <p class="muted">nihongotext.com からのお知らせ</p>
      </div>

      <div class="tools">
        <div class="search">
          <i class="fa-solid fa-magnifying-glass fa-fw" aria-hidden="true"></i>
          <input id="q" type="search" placeholder="Search posts..." aria-label="Search posts">
        </div>
        <a class="row" href="/blog/updates.html" title="All updates">
          <i class="fa-solid fa-rotate-left fa-fw" aria-hidden="true"></i>
          <span>Updates</span>
        </a>
      </div>

      <section id="latest" class="card"></section>
      <div id="searchResults" class="results" hidden></div>

      <div class="more">
        <a href="/blog/updates.html" class="row">
          <i class="fa-solid fa-angles-right fa-fw" aria-hidden="true"></i>
          View full update history
        </a>
      </div>
    </div>
  </main>

  <div id="footer"></div>

  <script>
    // -------- 共通: ヘッダー/フッター読込（inquiryと同系） --------
    async function loadPartials(){
      const [h,f]=await Promise.all([fetch('/partials/header.html'),fetch('/partials/footer.html')]);
      document.getElementById('header').innerHTML=await h.text();
      document.getElementById('footer').innerHTML=await f.text();

      const btnHeader = document.getElementById('langBtn');
      if(btnHeader){
        const sync = ()=> btnHeader.textContent = (currentLang()==='ja' ? 'English' : '日本語');
        btnHeader.addEventListener('click', ()=>{
          const next = currentLang()==='ja' ? 'en' : 'ja';
          applyLang(next);
        });
        sync();
      }
    }

    // -------- 言語状態 --------
    const currentLang = ()=> localStorage.getItem('nt_lang') || ((navigator.language||'en').startsWith('ja')?'ja':'en');
    function applyLang(lang){
      const page=document.getElementById('page');
      page.setAttribute('data-lang',lang);
      document.documentElement.lang=(lang==='ja'?'ja':'en');
      localStorage.setItem('nt_lang',lang);
      const btnHeader=document.getElementById('langBtn');
      if(btnHeader) btnHeader.textContent = (lang==='ja' ? 'English' : '日本語');
      if(window.__posts){
        renderLatest(window.__posts);
        if(!document.getElementById('searchResults').hidden) doSearch();
      }
      if(window.gtag) gtag('event','language_change',{language:lang});
    }

    // -------- posts.json 読み込み --------
    async function fetchPosts(){
      const res=await fetch('/blog/posts.json',{cache:'no-store'});
      const data=await res.json();
      data.sort((a,b)=> new Date(b.date)-new Date(a.date));
      window.__posts=data; return data;
    }

    // -------- スキーマ互換ヘルパ --------
    function pick(obj, paths){
      for(const p of paths){
        const v = p.split('.').reduce((o,k)=> (o||{})[k], obj);
        if(typeof v === 'string' && v.trim()) return v;
      }
      return '';
    }
    function getTitle(p, lang){
      return pick(p, [
        `${lang}.title`,           // 未来のネスト型 {ja:{title},en:{title}}
        `title_${lang}`,           // 現行のフラット型
        `title${lang==='ja'?'_ja':'_en'}`, // 念のため
        `title`                    // 予備
      ]);
    }
    function getSummary(p, lang){
      return pick(p, [
        `${lang}.summary`, `summary_${lang}`, `summary${lang==='ja'?'_ja':'_en'}`
      ]);
    }
    function getHtml(p, lang){
      // HTML本文がない場合は summary を段落化して代用
      const html = pick(p, [`${lang}.html`]);
      if(html) return html;
      const s = getSummary(p, lang);
      return s ? `<p>${s}</p>` : '';
    }

    // -------- 最新記事描画 --------
    function renderLatest(posts){
      const latest=posts[0]; const lang=currentLang();
      const el=document.getElementById('latest');
      if(!latest){ el.innerHTML='<p class="muted">No posts yet.</p>'; return; }
      const title = getTitle(latest, lang) || '(no title)';
      const html  = getHtml(latest, lang);
      const head=`
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <i class="fa-regular fa-note-sticky fa-fw" aria-hidden="true"></i>
            <time datetime="${latest.date||''}">${latest.date||''}</time>
          </div>
          <a class="row" href="/blog/updates.html#${latest.slug||''}" title="Permalink">
            <i class="fa-solid fa-link fa-fw" aria-hidden="true"></i><span>Permalink</span>
          </a>
        </div>`;
      el.innerHTML=head+`<h2>${title}</h2>${html}`;
    }

    // -------- 検索 --------
    function stripHtml(s){return String(s||'').replace(/<[^>]+>/g,' ');}
    function doSearch(){
      const q=document.getElementById('q').value.trim().toLowerCase();
      const box=document.getElementById('searchResults');
      const lang=currentLang();
      if(!q){ box.hidden=true; box.innerHTML=''; return; }
      const hits=window.__posts.filter(p=>{
        const t=getTitle(p, lang)+' '+stripHtml(getHtml(p, lang));
        return t.toLowerCase().includes(q);
      }).slice(0,20);
      box.hidden=false;
      box.innerHTML = hits.length
        ? hits.map(p=>`<div class="result-item"><a href="/blog/updates.html#${p.slug}"><strong>${getTitle(p, lang)}</strong></a><br><small>${p.date||''}</small></div>`).join('')
        : '<div class="muted">No results.</div>';
    }

    // -------- 初期化 --------
    document.addEventListener('DOMContentLoaded',async()=>{
      await loadPartials();
      applyLang(currentLang());
      const posts=await fetchPosts();
      renderLatest(posts);
      document.getElementById('q').addEventListener('input',doSearch);
    });
  </script>
</body>
</html>
