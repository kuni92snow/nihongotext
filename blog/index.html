<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blog | nihongotext.com</title>
<link rel="icon" href="/favicon.ico" />
<!-- /blog/配下でも全ての相対パスをサイトルート基準にする -->
<base href="/" />

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-9QSHWJE0HZ', { send_page_view: false });
</script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<style>
:root{
  --shu:#e6462d;
  --shu-tint:#fff2ef;
  --ink:#1f2937;
  --muted:#6b7280;
  --line:#e5e7eb;
}

/* 全体 */
*{box-sizing:border-box}
html,body{
  margin:0;
  background:#fff;
  color:var(--ink);
  font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif;
}
a{color:inherit;text-decoration:none}

/* コンテナ */
.container{
  max-width:1100px;
  margin:0 auto;
  padding:0 16px;
}

/* メイン */
main{
  padding:20px 0 40px;
}

/* タイトル行 */
.page-title-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  margin-bottom:12px;
}
.page-title-text{
  font-size:24px;
  font-weight:800;
  color:var(--ink);
}

/* 検索ボックス */
.search-row{
  display:flex;
  justify-content:flex-end;
  margin-bottom:16px;
}
.search-row input[type="search"]{
  width:260px;
  max-width:100%;
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 12px;
  font-size:14px;
}

/* タグ */
.tag-list{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:16px;
  font-size:13px;
}
.tag-pill{
  border-radius:999px;
  border:1px solid var(--line);
  padding:4px 10px;
  cursor:pointer;
  background:#fff;
}
.tag-pill.active{
  border-color:var(--shu);
  color:var(--shu);
  background:#fff7f6;
}

/* 記事リスト */
.post-list{
  display:flex;
  flex-direction:column;
  gap:16px;
}
.post-card{
  border-radius:14px;
  border:1px solid #f1cbc6;
  background:#fff7f6;
  padding:12px 14px;
}
.post-title{
  font-size:18px;
  font-weight:700;
  margin:0 0 4px;
}
.post-meta{
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}
.post-summary{
  font-size:14px;
}

/* タグ表示 */
.post-tags{
  margin-top:6px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  font-size:11px;
}
.post-tag{
  border-radius:999px;
  border:1px solid #f5c4ba;
  padding:2px 8px;
}

/* レスポンシブ */
@media (max-width:640px){
  .page-title-row{
    flex-direction:column;
    align-items:flex-start;
  }
  .search-row{
    justify-content:flex-start;
  }
}

/* Learning ナビは blog では非表示 */
.site-header nav[aria-label="Learning navigation"]{
  display:none !important;
}
</style>
</head>
<body>
  <!-- 共通ヘッダー（partials.js が header.html を読み込み） -->
  <div id="header"></div>

  <main class="container">
    <div class="page-title-row">
      <div>
        <h1 class="page-title-text" data-en="Blog" data-ja="ブログ">Blog</h1>
      </div>
    </div>

    <div class="search-row">
      <input
        id="blog-search"
        type="search"
        placeholder="Search posts…"
        aria-label="Search blog posts"
      />
    </div>

    <div id="blog-tags" class="tag-list"></div>

    <section id="blog-list" class="post-list" aria-live="polite"></section>
  </main>

  <!-- 共通フッター（footer.html を読み込むためのプレースホルダ） -->
  <div id="site-footer"></div>

<script>
(function(){
  // blog JSON をロード
  const BLOG_JSON = '/data/blog/index.json';

  let allPosts = [];
  let currentLang = 'en'; // 'en' or 'ja'
  let activeTag = '';

  function getLang(){
    try{
      return localStorage.getItem('nt_lang') || 'en';
    }catch(e){
      return 'en';
    }
  }
  function setLang(lang){
    currentLang = lang;
    try{
      localStorage.setItem('nt_lang', lang);
    }catch(e){}
    applyLangToPage();
  }

  // タイトルと本文の切り替え
  function applyLangToPage(){
    const lang = currentLang;
    // ページタイトル
    document.querySelectorAll('[data-en][data-ja]').forEach(el=>{
      el.textContent = (lang === 'ja') ? el.getAttribute('data-ja') : el.getAttribute('data-en');
    });
    // 記事リスト再描画
    render(allPosts);
  }

  // タグ描画
  function renderTags(posts){
    const tagBox = document.getElementById('blog-tags');
    if(!tagBox) return;
    const tagSet = new Set();
    posts.forEach(p=>{
      (p.tags || []).forEach(t => tagSet.add(t));
    });
    const tags = Array.from(tagSet).sort();
    tagBox.innerHTML = '';
    if(!tags.length) return;

    const allBtn = document.createElement('button');
    allBtn.className = 'tag-pill' + (!activeTag ? ' active' : '');
    allBtn.textContent = 'All';
    allBtn.addEventListener('click', ()=>{
      activeTag = '';
      render(allPosts);
      renderTags(allPosts);
    });
    tagBox.appendChild(allBtn);

    tags.forEach(tag=>{
      const btn = document.createElement('button');
      btn.className = 'tag-pill' + (activeTag === tag ? ' active' : '');
      btn.textContent = tag;
      btn.addEventListener('click', ()=>{
        activeTag = tag;
        render(allPosts);
        renderTags(allPosts);
      });
      tagBox.appendChild(btn);
    });
  }

  // 記事描画
  function render(posts){
    const list = document.getElementById('blog-list');
    if(!list) return;
    let items = posts.slice();

    // タグフィルタ
    if(activeTag){
      items = items.filter(p => (p.tags || []).includes(activeTag));
    }

    const term = (document.getElementById('blog-search')?.value || '').trim().toLowerCase();
    if(term){
      items = items.filter(p=>{
        const blob = [
          p.slug, p.title, p.title_en, p.title_ja, p.summary_en, p.summary_ja,
          ...(p.tags||[])
        ].join(' ').toLowerCase();
        return blob.includes(term);
      });
    }

    // 日付降順
    items.sort((a,b)=>{
      const da = (a.date||'').replace(/-/g,'');
      const db = (b.date||'').replace(/-/g,'');
      return db.localeCompare(da);
    });

    list.innerHTML = '';

    if(!items.length){
      const div = document.createElement('div');
      div.style.color = '#6b7280';
      div.textContent = (currentLang === 'ja')
        ? '該当するブログ記事がありません。'
        : 'No blog posts found.';
      list.appendChild(div);
      return;
    }

    items.forEach(p=>{
      const card = document.createElement('article');
      card.className = 'post-card';

      const title = document.createElement('h2');
      title.className = 'post-title';
      title.textContent = (currentLang === 'ja'
        ? (p.title_ja || p.title_en || p.title)
        : (p.title_en || p.title || p.title_ja)
      );
      card.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'post-meta';
      meta.textContent = p.date || '';
      card.appendChild(meta);

      const summary = document.createElement('p');
      summary.className = 'post-summary';
      summary.textContent = (currentLang === 'ja'
        ? (p.summary_ja || p.summary_en)
        : (p.summary_en || p.summary_ja)
      );
      card.appendChild(summary);

      if(p.tags && p.tags.length){
        const tagsRow = document.createElement('div');
        tagsRow.className = 'post-tags';
        p.tags.forEach(t=>{
          const span = document.createElement('span');
          span.className = 'post-tag';
          span.textContent = t;
          tagsRow.appendChild(span);
        });
        card.appendChild(tagsRow);
      }

      list.appendChild(card);
    });
  }

  // 初期化
  async function init(){
    currentLang = getLang();

    // JSONロード
    try{
      const res = await fetch(BLOG_JSON,{cache:'no-store'});
      if(res.ok){
        const json = await res.json();
        if(Array.isArray(json)){
          allPosts = json;
        }else if(Array.isArray(json.posts)){
          allPosts = json.posts;
        }
      }
    }catch(e){
      allPosts = [];
    }

    renderTags(allPosts);
    render(allPosts);

    // 検索イベント
    const searchInput = document.getElementById('blog-search');
    if(searchInput){
      searchInput.addEventListener('input', ()=>{
        render(allPosts);
      });
    }

    // ページロード後、共通の言語設定を反映
    applyLangToPage();

    try{ gtag('event','page_view',{page_title:'blog/index'}); }catch(_){}
  }

  document.addEventListener('DOMContentLoaded', init);
})();
</script>

<!-- 共通ヘッダー・フッター読込 -->
<script src="/assets/partials.js" defer></script>
</body>
</html>
