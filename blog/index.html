<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog | nihongotext.com</title>
  <link rel="icon" href="/favicon.ico" />
  <base href="/" />

  <style>
    :root{--ink:#132c3a;--muted:#6b7280;--brand:#e6462d;--border:#e5e7eb}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;color:var(--ink);line-height:1.7}
    main .wrap{max-width:1100px;margin:auto;padding:16px}
    .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:14px;padding:18px 16px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .lang-switch .btn{border:1px solid var(--border);padding:6px 10px;border-radius:10px;background:#fff;cursor:pointer}
    .lang-switch .btn.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    h1{margin:0 0 8px}
    h2{margin:.2rem 0 .5rem}
    time{color:var(--muted);font-size:.9rem}
    .tools{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 16px}
    .search{display:flex;gap:8px;align-items:center;flex:1}
    .search input{flex:1;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:15px}
    .results{margin-top:10px}
    .result-item{padding:8px 10px;border-bottom:1px dashed var(--border)}
    .result-item a{text-decoration:none;color:var(--ink)}
    .result-item small{color:var(--muted)}
    .more{margin-top:8px}
    /* 言語切替 */
    [data-i18n][data-lang="en"] .ja{display:none}
    [data-i18n][data-lang="en"] .en{display:block}
    [data-i18n][data-lang="ja"] .en{display:none}
    [data-i18n][data-lang="ja"] .ja{display:block}
    /* ふりがな */
    ruby{ruby-position:over;ruby-align:start}
    rt{font-size:.6em;color:#666;letter-spacing:.03em}
  </style>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date()); gtag('config', 'G-9QSHWJE0HZ');
  </script>
</head>
<body>
  <!-- 共通ヘッダー -->
  <div id="header"></div>

  <main>
    <div class="wrap" id="page" data-i18n data-lang="en">
      <!-- 見出し -->
      <div class="en"><h1 class="row"><img src="/icons/nt-logo-32.png" alt="" width="28" height="28"> Blog</h1><p class="muted">Latest update from nihongotext.com</p></div>
      <div class="ja"><h1 class="row"><img src="/icons/nt-logo-32.png" alt="" width="28" height="28"> ブログ</h1><p class="muted">nihongotext.com からのお知らせ</p></div>

      <!-- ツールバー（言語/検索/リンク） -->
      <div class="tools">
        <div class="lang-switch row">
          <button id="btn-en" class="btn">English</button>
          <button id="btn-ja" class="btn">日本語</button>
        </div>
        <div class="search">
          <img src="/icons/search.svg" alt="" width="18" height="18">
          <input id="q" type="search" placeholder="Search posts..." aria-label="Search posts">
        </div>
        <a class="row" href="/blog/updates.html" title="All updates">
          <img src="/icons/history.svg" alt="" width="18" height="18"><span>Updates</span>
        </a>
      </div>

      <!-- 最新記事だけ表示 -->
      <section id="latest" class="card"></section>

      <!-- 検索結果（一覧のみ表示） -->
      <div id="searchResults" class="results" hidden></div>

      <div class="more">
        <a href="/blog/updates.html" class="row"><img src="/icons/chevron-right.svg" width="18" height="18" alt="">View full update history</a>
      </div>
    </div>
  </main>

  <!-- 共通フッター -->
  <div id="footer"></div>

  <script>
    // ====== 共通ヘッダー/フッター読込 ======
    async function loadPartials(){
      const [h,f] = await Promise.all([
        fetch('/partials/header.html'),
        fetch('/partials/footer.html')
      ]);
      document.getElementById('header').innerHTML = await h.text();
      document.getElementById('footer').innerHTML = await f.text();

      // ヘッダー内の言語ボタン(IDは header.html に用意しておくとより自然)
      const headerBtnEn = document.querySelector('#btn-en');
      const headerBtnJa = document.querySelector('#btn-ja');
      if (headerBtnEn) headerBtnEn.addEventListener('click', ()=>applyLang('en'));
      if (headerBtnJa) headerBtnJa.addEventListener('click', ()=>applyLang('ja'));
    }

    // ====== 言語切替 ======
    function applyLang(lang){
      const page = document.getElementById('page');
      page.setAttribute('data-lang', lang);
      document.documentElement.lang = (lang==='ja'?'ja':'en');
      localStorage.setItem('nt_lang', lang);
      // トグルの見た目
      document.getElementById('btn-en')?.classList.toggle('active', lang==='en');
      document.getElementById('btn-ja')?.classList.toggle('active', lang==='ja');
      // 再レンダリング（検索表示中/最新表示ともに言語に合わせて中身を描写）
      if (window.__posts) {
        renderLatest(window.__posts);
        if (document.getElementById('searchResults').hidden === false) {
          doSearch();
        }
      }
      if (window.gtag) gtag('event','language_change',{language:lang});
    }

    // ====== 記事データ取得（JSON） ======
    async function fetchPosts(){
      // /blog/posts.json から配列を取得
      const res = await fetch('/blog/posts.json', {cache:'no-store'});
      const data = await res.json(); // [{id,date,slug,en:{title,html},ja:{title,html}}, ...]
      // 日付で降順
      data.sort((a,b)=> new Date(b.date) - new Date(a.date));
      window.__posts = data;
      return data;
    }

    // ====== 最新記事を描画（英語ベース、日本語はふりがな入り） ======
    function renderLatest(posts){
      const latest = posts[0];
      const lang = localStorage.getItem('nt_lang') || 'en';
      const el = document.getElementById('latest');
      if (!latest) { el.innerHTML = '<p class="muted">No posts yet.</p>'; return; }
      const head = `
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <img src="/icons/note.svg" width="18" height="18" alt="">
            <time datetime="${latest.date}">${latest.date}</time>
          </div>
          <a class="row" href="/blog/updates.html#${latest.slug}" title="Open in updates">
            <img src="/icons/link.svg" width="18" height="18" alt=""><span>Permalink</span>
          </a>
        </div>`;
      const bodyEn = `<h2>${latest.en.title}</h2>${latest.en.html}`;
      const bodyJa = `<h2>${latest.ja.title}</h2>${latest.ja.html}`;
      el.innerHTML = head + (lang==='ja' ? bodyJa : bodyEn);
    }

    // ====== 検索（タイトル＆本文、結果は一覧リンク） ======
    function doSearch(){
      const q = document.getElementById('q').value.trim().toLowerCase();
      const box = document.getElementById('searchResults');
      const lang = localStorage.getItem('nt_lang') || 'en';
      if (!q) { box.hidden = true; box.innerHTML=''; return; }
      const hits = window.__posts.filter(p=>{
        const t = (lang==='ja' ? (p.ja.title + ' ' + stripHtml(p.ja.html)) 
                               : (p.en.title + ' ' + stripHtml(p.en.html)));
        return t.toLowerCase().includes(q);
      }).slice(0,20);
      if (!hits.length){ box.hidden=false; box.innerHTML='<div class="muted">No results.</div>'; return; }
      box.hidden=false;
      box.innerHTML = hits.map(p=>(
        `<div class="result-item">
           <a href="/blog/updates.html#${p.slug}">
             <strong>${lang==='ja'?p.ja.title:p.en.title}</strong>
           </a><br>
           <small>${p.date}</small>
         </div>`
      )).join('');
    }
    function stripHtml(s){ return String(s||'').replace(/<[^>]+>/g,' '); }

    // ====== 初期化 ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadPartials();
      const saved = localStorage.getItem('nt_lang');
      applyLang(saved || ((navigator.language||'en').startsWith('ja')?'ja':'en'));
      const posts = await fetchPosts();
      renderLatest(posts);
      document.getElementById('q').addEventListener('input', doSearch);
    });
  </script>
</body>
</html>
