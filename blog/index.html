<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog | nihongotext.com</title>
  <link rel="icon" href="/favicon.ico" />
  <base href="/" />

  <!-- Font Awesome（inquiryと同じ系統の代替アイコンとして使用） -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{--ink:#132c3a;--muted:#6b7280;--brand:#e6462d;--border:#e5e7eb}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;color:var(--ink);line-height:1.7}
    main .wrap{max-width:1100px;margin:auto;padding:16px}
    .muted{color:var(--muted)}
    .card{border:1px solid var(--border);border-radius:14px;padding:18px 16px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    h1{margin:0 0 8px}
    h2{margin:.2rem 0 .5rem}
    time{color:var(--muted);font-size:.9rem}
    .tools{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:8px 0 16px}
    .search{display:flex;gap:8px;align-items:center;flex:1}
    .search input{flex:1;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:15px}
    .results{margin-top:10px}
    .result-item{padding:8px 10px;border-bottom:1px dashed var(--border)}
    .result-item a{text-decoration:none;color:var(--ink)}
    .result-item small{color:var(--muted)}
    .more{margin-top:8px}
    /* 言語切替 */
    [data-i18n][data-lang="en"] .ja{display:none}
    [data-i18n][data-lang="ja"] .en{display:none}
    /* ふりがな */
    ruby{ruby-position:over;ruby-align:start}
    rt{font-size:.6em;color:#666;letter-spacing:.03em}
    .fa-fw{width:1.1em;text-align:center}
  </style>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-9QSHWJE0HZ');</script>
</head>
<body>
  <!-- 共通ヘッダー（partials） -->
  <div id="header"></div>

  <main>
    <div class="wrap" id="page" data-i18n data-lang="en">
      <!-- 見出し -->
      <div class="en">
        <h1 class="row"><i class="fa-solid fa-record-vinyl fa-fw" style="color:#e6462d"></i> Blog</h1>
        <p class="muted">Latest update from nihongotext.com</p>
      </div>
      <div class="ja">
        <h1 class="row"><i class="fa-solid fa-record-vinyl fa-fw" style="color:#e6462d"></i> ブログ</h1>
        <p class="muted">nihongotext.com からのお知らせ</p>
      </div>

      <!-- ツールバー（ページ内の言語ボタンは削除） -->
      <div class="tools">
        <div class="search">
          <i class="fa-solid fa-magnifying-glass fa-fw" aria-hidden="true"></i>
          <input id="q" type="search" placeholder="Search posts..." aria-label="Search posts">
        </div>
        <a class="row" href="/blog/updates.html" title="All updates">
          <i class="fa-solid fa-rotate-left fa-fw" aria-hidden="true"></i>
          <span>Updates</span>
        </a>
      </div>

      <!-- 最新記事 -->
      <section id="latest" class="card"></section>

      <!-- 検索結果 -->
      <div id="searchResults" class="results" hidden></div>

      <div class="more">
        <a href="/blog/updates.html" class="row">
          <i class="fa-solid fa-angles-right fa-fw" aria-hidden="true"></i>
          View full update history
        </a>
      </div>
    </div>
  </main>

  <!-- 共通フッター（partials） -->
  <div id="footer"></div>

  <script>
    // === ヘッダー／フッター読込 + アイコン自動補修 ===
    async function loadPartials(){
      const [h,f]=await Promise.all([fetch('/partials/header.html'),fetch('/partials/footer.html')]);
      document.getElementById('header').innerHTML=await h.text();
      document.getElementById('footer').innerHTML=await f.text();

      // 画像が壊れたらFont Awesomeに置換
      const map = [
        {key:'home', cls:'fa-house'},
        {key:'print', cls:'fa-print'},
        {key:'blog', cls:'fa-pen-to-square'},
        {key:'sitemap', cls:'fa-sitemap'},
        {key:'contact', cls:'fa-envelope'},
        {key:'x', cls:'fa-x-twitter'},
        {key:'twitter', cls:'fa-x-twitter'},
        {key:'facebook', cls:'fa-facebook'},
        {key:'instagram', cls:'fa-instagram'},
        {key:'github', cls:'fa-github'},
        {key:'rss', cls:'fa-rss'}
      ];
      const fallback = (img)=>{
        const src = (img.getAttribute('src')||'').toLowerCase();
        const hit = map.find(m=> src.includes(m.key));
        const i = document.createElement('i');
        i.className = 'fa-brands fa-fw';
        if(hit){
          i.className = `fa-solid ${hit.cls} fa-fw`;
        }else{
          i.className = 'fa-regular fa-circle-question fa-fw';
        }
        i.style.color = '#e6462d';
        i.title = img.alt || '';
        img.replaceWith(i);
      };
      document.querySelectorAll('#header img, #footer img').forEach(img=>{
        img.addEventListener('error', ()=> fallback(img), {once:true});
        // すでに壊れている可能性にも対応
        if (img.complete && img.naturalWidth === 0) fallback(img);
      });

      // ヘッダーの言語ボタンと連動
      const btnHeader = document.getElementById('langBtn');
      if(btnHeader){
        const syncHeader = ()=> btnHeader.textContent = (currentLang()==='ja' ? 'English' : '日本語');
        btnHeader.addEventListener('click', ()=>{
          const next = currentLang()==='ja' ? 'en' : 'ja';
          applyLang(next);
        });
        syncHeader();
      }
    }

    // === 言語状態 ===
    const currentLang = ()=> localStorage.getItem('nt_lang') || ((navigator.language||'en').startsWith('ja')?'ja':'en');

    function applyLang(lang){
      const page=document.getElementById('page');
      page.setAttribute('data-lang',lang);
      document.documentElement.lang=(lang==='ja'?'ja':'en');
      localStorage.setItem('nt_lang',lang);
      // ヘッダーボタンの表記も同期
      const btnHeader=document.getElementById('langBtn');
      if(btnHeader) btnHeader.textContent = (lang==='ja' ? 'English' : '日本語');

      if(window.__posts){
        renderLatest(window.__posts);
        if(!document.getElementById('searchResults').hidden) doSearch();
      }
      if(window.gtag) gtag('event','language_change',{language:lang});
    }

    // === 投稿取得 ===
    async function fetchPosts(){
      const res=await fetch('/blog/posts.json',{cache:'no-store'});
      const data=await res.json();
      data.sort((a,b)=> new Date(b.date)-new Date(a.date));
      window.__posts=data; return data;
    }

    // === 最新記事 ===
    function renderLatest(posts){
      const latest=posts[0]; const lang=currentLang();
      const el=document.getElementById('latest');
      if(!latest){ el.innerHTML='<p class="muted">No posts yet.</p>'; return; }
      const head=`
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <i class="fa-regular fa-note-sticky fa-fw" aria-hidden="true"></i>
            <time datetime="${latest.date}">${latest.date}</time>
          </div>
          <a class="row" href="/blog/updates.html#${latest.slug}" title="Permalink">
            <i class="fa-solid fa-link fa-fw" aria-hidden="true"></i><span>Permalink</span>
          </a>
        </div>`;
      const bodyEn=`<h2>${latest.en.title}</h2>${latest.en.html}`;
      const bodyJa=`<h2>${latest.ja.title}</h2>${latest.ja.html}`;
      el.innerHTML=head+(lang==='ja'?bodyJa:bodyEn);
    }

    // === 検索 ===
    function stripHtml(s){return String(s||'').replace(/<[^>]+>/g,' ');}
    function doSearch(){
      const q=document.getElementById('q').value.trim().toLowerCase();
      const box=document.getElementById('searchResults');
      const lang=currentLang();
      if(!q){ box.hidden=true; box.innerHTML=''; return; }
      const hits=window.__posts.filter(p=>{
        const t=(lang==='ja'?(p.ja.title+' '+stripHtml(p.ja.html)):(p.en.title+' '+stripHtml(p.en.html)));
        return t.toLowerCase().includes(q);
      }).slice(0,20);
      box.hidden=false;
      box.innerHTML = hits.length
        ? hits.map(p=>`<div class="result-item"><a href="/blog/updates.html#${p.slug}"><strong>${lang==='ja'?p.ja.title:p.en.title}</strong></a><br><small>${p.date}</small></div>`).join('')
        : '<div class="muted">No results.</div>';
    }

    // === 初期化 ===
    document.addEventListener('DOMContentLoaded',async()=>{
      await loadPartials();
      applyLang(currentLang());
      const posts=await fetchPosts();
      renderLatest(posts);
      document.getElementById('q').addEventListener('input',doSearch);
    });
  </script>
</body>
</html>
