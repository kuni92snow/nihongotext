<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blog | nihongotext.com</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --accent:#e74c3c; --accent-2:#ff6b6b;
      --ink:#222; --muted:#777; --bg:#fff; --card:#fff; --line:#f0f0f0;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}

    .site-header{position:sticky;top:0;z-index:20;background:#fff;
      border-top:4px solid var(--accent);border-bottom:1px solid var(--line)}
    .head-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:12px;padding:12px 16px}
    .brand{font-weight:800;font-size:20px;line-height:1;cursor:pointer}
    .beta{font-size:12px;color:#777;margin-left:8px}
    nav{margin-left:auto;display:flex;gap:14px;flex-wrap:wrap}
    nav a{color:var(--ink);font-weight:600} nav a.active{color:var(--accent)}

    .site-footer{border-top:1px solid var(--line);padding:16px 0;margin-top:40px}
    .foot-inner{max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;padding:0 16px}
    .copy{color:#555}

    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px 60px}
    .breadcrumbs{font-size:14px;color:var(--muted);margin:6px 0 14px}
    .breadcrumbs a{color:var(--muted)}
    .page-title{font-size:28px;font-weight:800;margin:18px 0 10px}
    .desc{color:var(--muted);margin:0 0 22px}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:640px){ .grid{grid-template-columns:1fr;} }

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;
      box-shadow:0 4px 14px rgba(0,0,0,.05);display:flex;flex-direction:column;gap:10px}
    .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px}
    .title{font-size:18px;font-weight:800;line-height:1.4;margin:2px 0}
    .body{color:#333;line-height:1.9}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .more{margin-top:auto}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="head-inner">
      <div class="brand" onclick="location.href='/'">nihongotext.com</div>
      <div class="beta">== beta version ==</div>
      <nav aria-label="Site">
        <a href="/index.html">Home</a>
        <a href="/blog/" class="active">Blog</a>
        <a href="/inquiry/">Contact</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="breadcrumbs"><a href="/index.html">Home</a> / Blog</div>
    <h1 class="page-title">Blog</h1>
    <p class="desc">Updates, tips, and behind-the-scenes notes from the nihongotext.com team.</p>
    <section id="post-grid" class="grid" aria-live="polite"></section>
  </main>

  <footer class="site-footer">
    <div class="foot-inner">
      <div class="copy">© <span id="yy"></span> nihongotext.com</div>
      <div><a href="/blog/news.html">News</a> / <a href="/inquiry/index.html">Contact</a></div>
    </div>
  </footer>

  <script>
    // 年号
    document.getElementById("yy").textContent = String(new Date().getFullYear());

    // --- キャッシュ/古いSWの影響を極力バイパス ---
    (async () => {
      try{
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const r of regs) { if (r.scope.startsWith(location.origin)) { /*必要なら解除*/ } }
        }
        if ('caches' in window) {
          const keys = await caches.keys();
          for (const k of keys) { if (k.includes('nihongotext')) { await caches.delete(k); } }
        }
      }catch(_e){}
    })();

    const root = document.getElementById("post-grid");
    const BUSTER = `v=${encodeURIComponent(new Date().toISOString().slice(0,19))}`;

    // フォールバック記事（JSONが404でも真っ白にしない）
    const FALLBACK = [{
      id:"hello-nihongotext",
      date:"2025-10-30",
      title:"サイト更新(こうしん)のお知らせ",
      summary:"Blog の初期化中です。しばらくしてから再読み込みしてください。",
      href:"/index.html"
    }];

    fetch(`/blog/blogPosts.json?${BUSTER}`, { cache: 'no-store' })
      .then(r => r.ok ? r.json() : Promise.reject(new Error(r.statusText)))
      .then(json => {
        const items = Array.isArray(json) ? json : [];
        render(items.length ? items : FALLBACK);
        injectLDJson(items.length ? items : FALLBACK);
      })
      .catch(() => {
        render(FALLBACK);
        injectLDJson(FALLBACK);
      });

    function cardTemplate(p){
      const titleHtml  = ruby(p.title || '');
      const summaryHtml= p.summary ? ruby(p.summary) : '';
      const jaNoteHtml = p.jaNote  ? ruby(p.jaNote)  : '';
      return `
        <article class="card" data-id="${esc(p.id)}" aria-labelledby="${esc(p.id)}-title">
          <div class="meta"><time datetime="${esc(p.date)}">${fmtEn(p.date)}</time></div>
          <h2 id="${esc(p.id)}-title" class="title">${titleHtml}</h2>
          <div class="hr"></div>
          ${summaryHtml ? `<p class="body">${summaryHtml}</p>` : ""}
          ${jaNoteHtml ? `<p class="body">${jaNoteHtml}</p>` : ""}
          ${p.href ? `<p class="more"><a href="${p.href}">Read more</a></p>` : ""}
        </article>`;
    }
    function render(items){ root.innerHTML = items.map(cardTemplate).join(""); }
    function ruby(s){
      return esc(String(s)).replace(/([^\s()（）]+)\(([^()]+)\)/g,
        (_m,kan,rt)=>`<ruby>${kan}<rt>${rt}</rt></ruby>`);
    }
    function fmtEn(iso){
      const d = new Date(iso+"T00:00:00");
      return d.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"});
    }
    function esc(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
    }
    function injectLDJson(items){
      const data = {
        "@context":"https://schema.org",
        "@type":"Blog",
        "name":"nihongotext.com Blog",
        "blogPost": items.map(p=>({
          "@type":"BlogPosting",
          "headline": p.title || "",
          "datePublished": p.date,
          "dateModified": p.date,
          "description": p.summary || "",
          "mainEntityOfPage": {"@type":"WebPage","@id": location.href}
        }))
      };
      let el = document.getElementById("ld-json");
      if(!el){ el = document.createElement("script"); el.id="ld-json"; el.type="application/ld+json"; document.body.appendChild(el); }
      el.textContent = JSON.stringify(data);
    }
  </script>
</body>
</html>
