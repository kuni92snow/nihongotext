<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>News & Blog | nihongotext.com</title>
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --ink:#222; --weak:#666; --accent:#e74c3c; --line:#eee;
      --btn:#e74c3c; --btn-ink:#fff; --btn-weak:#f2f2f2;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,ui-sans-serif;
         background:var(--bg);color:var(--ink)}
    header{max-width:1060px;margin:24px auto 0;padding:0 16px}
    h1{font-size:28px;margin:0 0 8px}
    .lang-switch{display:flex;gap:8px}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:var(--card);cursor:pointer}
    .chip.active{background:var(--btn);color:var(--btn-ink);border-color:var(--btn)}
    main{max-width:1060px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width:900px){main{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
    .card h2{margin:0 0 12px}
    label{font-size:12px;color:var(--weak)}
    input,textarea{width:100%;padding:12px 12px;border:1px solid #ddd;border-radius:10px;font-size:15px;color:var(--ink);background:#fff}
    textarea{min-height:140px;resize:vertical}
    .row{display:flex;gap:10px;margin-top:14px}
    .row .grow{flex:1}
    .actions{display:flex;gap:10px;margin-top:14px;align-items:center}
    button{border:0;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:600}
    .btn-ghost{background:var(--btn-weak)}
    .btn{background:var(--btn);color:var(--btn-ink)}
    small.helper{display:block;color:var(--weak);margin-top:8px}
    .qa-empty{color:var(--accent)}
    .qa-list{display:flex;flex-direction:column;gap:12px;margin-top:6px}
    .qa{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
    .qa h3{font-size:16px;margin:0 0 6px}
    .qa .meta{color:#999;font-size:12px}
    .qa p{margin:8px 0}
    .error{color:var(--accent);margin-top:8px}
    .success{color:#2e7d32;margin-top:8px}
  </style>
  <!-- reCAPTCHA v2 -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
  <header>
    <h1>News & Blog</h1>
    <div class="lang-switch">
      <button id="btn-ja" class="chip">日本語</button>
      <button id="btn-en" class="chip">English</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2 id="h-form">お問い合わせ</h2>

      <div class="row">
        <div class="grow">
          <label id="l-name" for="name">お名前 / Name</label>
          <input id="name" autocomplete="name" />
        </div>
      </div>

      <div class="row">
        <div class="grow">
          <label id="l-email" for="email">メール / Email</label>
          <input id="email" type="email" autocomplete="email" />
        </div>
      </div>

      <div class="row">
        <div class="grow">
          <label id="l-subject" for="subject">件名 / Subject</label>
          <input id="subject" />
        </div>
      </div>

      <div class="row">
        <div class="grow">
          <label id="l-message" for="message">メッセージ / Message</label>
          <textarea id="message"></textarea>
        </div>
      </div>

      <div class="row">
        <div class="g-recaptcha" data-sitekey="6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV"></div>
      </div>

      <div class="actions">
        <button id="btn-cancel" class="btn-ghost">キャンセル</button>
        <button id="btn-send" class="btn">送信</button>
        <small class="helper" id="rca-note">
          reCAPTCHA と Google の <a href="https://policies.google.com/privacy" target="_blank">プライバシーポリシー</a> と
          <a href="https://policies.google.com/terms" target="_blank">利用規約</a> が適用されます。
        </small>
      </div>

      <div id="msg" aria-live="polite"></div>
    </section>

    <section class="card">
      <h2 id="h-qa">Q&amp;A</h2>
      <div id="qa-container">
        <p class="qa-empty" id="qa-empty">Loading…</p>
        <div class="qa-list" id="qa-list" hidden></div>
      </div>
    </section>
  </main>

  <script>
    // ======== 固定設定（あなたの環境に合わせて置換済み） ========
    const EXEC_BASE = "https://script.google.com/macros/s/AKfycbx4xEjA43o2oovNbuvAvZQgqw2HfYt-ZVnrHr8WOT0bI2hJ8SpfXSYKYCRS97z_IcNF/exec";
    const ECHO_JSONP_BASE = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLg3PkTl7rr-5DTZsB5wzWMnQjQjdQS-2enSrUBS_wfyBSFBlFw58v4aNArEgtDb1H_P-aFINTLIxJaCQPIMd4SQhChxOX4XfTDx3ZsGBa1fQXL-niHi-WeEnPUeJ7QLsZrApjCHFgSc8gIHMyCBbZ7JHbHhFx_ng8hK4Gd_pJI3mXV_A4_udrcQSM1GejQEoU3D4OmZMNR7C1HgCfGEbLkZd8XlcleqWcK1MJxWJPM6Y4zPAo0ianCWHQekSdfJvq8OYKG-e296WAr152Zncem_xzOCuA&lib=MPYC9R4b-H3qOZfI-E6xqCCVZPe5PzjmL";
    const SITE = "https://nihongotext.com"; // CORS の許可オリジン

    // ======== 言語切替（?lang=ja / en） ========
    const t = {
      ja: {
        form: "お問い合わせ", name: "お名前 / Name", email: "メール / Email",
        subject:"件名 / Subject", message:"メッセージ / Message",
        cancel:"キャンセル", send:"送信",
        qa:"Q&A", loading:"読み込み中…", failed:"Failed to load."
      },
      en: {
        form: "Contact", name: "Name", email: "Email",
        subject:"Subject", message:"Message",
        cancel:"Cancel", send:"Send",
        qa:"Q&A", loading:"Loading…", failed:"Failed to load."
      }
    };
    const params = new URLSearchParams(location.search);
    const lang = (params.get("lang") === "en") ? "en" : "ja";

    function applyLang(){
      const dict = t[lang];
      document.documentElement.lang = lang;
      document.getElementById("btn-ja").classList.toggle("active", lang==="ja");
      document.getElementById("btn-en").classList.toggle("active", lang==="en");
      document.getElementById("h-form").textContent = dict.form;
      document.getElementById("l-name").textContent = dict.name;
      document.getElementById("l-email").textContent = dict.email;
      document.getElementById("l-subject").textContent = dict.subject;
      document.getElementById("l-message").textContent = dict.message;
      document.getElementById("btn-cancel").textContent = dict.cancel;
      document.getElementById("btn-send").textContent = dict.send;
      document.getElementById("h-qa").textContent = dict.qa;
      document.getElementById("qa-empty").textContent = dict.loading;
    }
    applyLang();

    document.getElementById("btn-ja").onclick = ()=> { params.set("lang","ja"); location.search = params.toString(); };
    document.getElementById("btn-en").onclick = ()=> { params.set("lang","en"); location.search = params.toString(); };

    // ======== Q&A 読み込み（JSONP via echo） ========
    function onQALoad(json){
      try{
        const box = document.getElementById("qa-list");
        const empty = document.getElementById("qa-empty");
        box.innerHTML = "";
        if (!json || !json.ok || !Array.isArray(json.items) || json.items.length===0){
          empty.hidden = false;
          empty.textContent = t[lang].failed;
          box.hidden = true;
          return;
        }
        empty.hidden = true;
        box.hidden = false;
        json.items.forEach(it=>{
          const el = document.createElement("div");
          el.className = "qa";
          el.innerHTML = `
            <h3>${escapeHtml(it.title || it.question?.slice(0,60) || "Q")}</h3>
            <div class="meta">${escapeHtml(it.createdAt || "")} · ${escapeHtml(it.nameMasked || "")}</div>
            ${it.question ? `<p><strong>Q.</strong> ${escapeHtml(it.question)}</p>` : ""}
            ${it.answer   ? `<p><strong>A.</strong> ${escapeHtml(it.answer)}</p>`   : ""}
          `;
          box.appendChild(el);
        });
      }catch(e){
        console.error(e);
        const empty = document.getElementById("qa-empty");
        empty.hidden = false;
        empty.textContent = t[lang].failed;
      }
    }

    function loadQA(){
      // JSONP: &mode=qa&callback=onQALoad
      const src = `${ECHO_JSONP_BASE}&mode=qa&callback=onQALoad&_=${Date.now()}`;
      const s = document.createElement("script");
      s.src = src;
      s.onerror = ()=>{
        const empty = document.getElementById("qa-empty");
        empty.hidden = false;
        empty.textContent = t[lang].failed;
      };
      document.body.appendChild(s);
    }
    loadQA();

    // ======== 送信 ========
    const $ = id => document.getElementById(id);
    function setMsg(text, ok=false){
      const m = $("msg");
      m.className = ok ? "success" : "error";
      m.textContent = text || "";
    }

    $("btn-cancel").onclick = ()=>{
      $("name").value = "";
      $("email").value = "";
      $("subject").value = "";
      $("message").value = "";
      setMsg("");
      if (window.grecaptcha) grecaptcha.reset();
    };

    $("btn-send").onclick = async ()=>{
      try{
        setMsg("");
        if (!window.grecaptcha){
          setMsg("reCAPTCHA not loaded.");
          return;
        }
        const token = grecaptcha.getResponse();
        if (!token){ setMsg(lang==="ja"?"reCAPTCHA を完了してください。":"Please complete reCAPTCHA."); return; }

        const payload = {
          name: $("name").value.trim(),
          email: $("email").value.trim(),
          subject: $("subject").value.trim(),
          message: $("message").value.trim(),
          token
        };
        if (!payload.message){
          setMsg(lang==="ja"?"メッセージを入力してください。":"Message is required.");
          return;
        }

        const res = await fetch(EXEC_BASE, {
          method: "POST",
          mode: "cors",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload),
        });

        const json = await res.json().catch(()=> ({}));
        if (json && json.ok){
          setMsg(lang==="ja"?"送信しました。返信までお待ちください。":"Sent. We will reply soon.", true);
          $("btn-cancel").click();
        }else{
          setMsg((json && json.reason) ? `Error: ${json.reason}` : "Failed to send.");
        }
      }catch(err){
        console.error(err);
        setMsg("Network error.");
      }
    };

    // ======== utils ========
    function escapeHtml(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }
  </script>
</body>
</html>
