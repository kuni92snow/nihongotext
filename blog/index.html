<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>お知らせ・ブログ | nihongotext.com</title>
  <style>
    :root{--brand:#e4573d;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.6;margin:0;background:#fff;}
    header,footer{border-top:4px solid var(--brand);border-bottom:1px solid #eee;}
    header .wrap,main .wrap,footer .wrap{max-width:920px;margin:auto;padding:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{appearance:none;background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:wait}
    .btn-ghost{background:#fff;color:var(--brand);border:1px solid var(--brand)}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
    label{display:block;margin:.4rem 0 .2rem}
    input,textarea{width:100%;box-sizing:border-box;border:1px solid #ccc;border-radius:8px;padding:10px;font:inherit}
    textarea{min-height:120px;resize:vertical}
    .muted{color:#777;font-size:.92rem}
    .ok{color:#0a8754}
    .err{color:#b00020}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){ .grid-2{grid-template-columns:1fr 1fr} }
    .lang-toggle{margin-left:auto}
    .qa-item{border:1px solid #eee;border-radius:10px;padding:12px;margin:10px 0}
    .qa-q{font-weight:700;margin-bottom:4px}
    .spinner{display:inline-block;width:18px;height:18px;border:3px solid #ddd;border-top-color:var(--brand);border-radius:50%;animation:spin 1s linear infinite;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>

  <script>
    // ====== 設定 ======
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbw3ddHZ7NvYY5-MRsK7npZpdyLJnmoqV1j2tcJjApxAWRTL2YWpk2NsEod0jnFnIFtgvQ/exec";
    const RECAPTCHA_SITE_KEY = "6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV";

    // ====== 言語制御（URL ?lang=ja|en） ======
    const url = new URL(location.href);
    const lang = (url.searchParams.get("lang") || "ja").toLowerCase();
    const t = {
      ja: {
        title:"お知らせ・ブログ",
        contact:"お問い合わせ / Contact",
        name:"お名前 / Name",
        email:"メール / Email",
        message:"メッセージ / Message",
        send:"送信 / Send",
        cancel:"キャンセル",
        recaptcha:"私はロボットではありません",
        sent_ok:"送信しました。ありがとうございます！",
        sent_ng:"送信に失敗しました。しばらくしてから再度お試しください。",
        qa_title:"Q&A",
        qa_empty:"公開中のQ&Aはまだありません。",
        loading:"読み込み中…"
      },
      en: {
        title:"News & Blog",
        contact:"Contact",
        name:"Name",
        email:"Email",
        message:"Message",
        send:"Send",
        cancel:"Cancel",
        recaptcha:"I'm not a robot",
        sent_ok:"Your message has been sent. Thank you!",
        sent_ng:"Failed to send. Please try again later.",
        qa_title:"Q&A",
        qa_empty:"No published Q&A yet.",
        loading:"Loading…"
      }
    }[lang];

    // reCAPTCHA の言語は API に hl= で反映。切替はページ再読み込みで実施。
    function switchLang(next){
      const u = new URL(location.href);
      u.searchParams.set("lang", next);
      location.href = u.toString();
    }
  </script>
  <!-- 選択中の言語で reCAPTCHA v2 を読み込み -->
  <script src="" id="recaptcha-api" async defer></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("recaptcha-api").src =
        "https://www.google.com/recaptcha/api.js?hl=" + lang;
      document.getElementById("title").textContent = t.title;
      // ラベル翻訳
      for (const [id, val] of Object.entries({
        contactTitle: t.contact,
        labelName: t.name,
        labelEmail: t.email,
        labelMessage: t.message,
        btnSend: t.send,
        btnCancel: t.cancel,
        qaTitle: t.qa_title
      })){
        const el = document.getElementById(id);
        if (el) el.textContent = val;
      }
      // Q&A 取得
      loadQA();
    });

    async function loadQA(){
      const box = document.getElementById("qa-list");
      box.innerHTML = '<span class="spinner"></span> ' + t.loading;
      try{
        const res = await fetch(GAS_ENDPOINT + "?action=qa_list", { method:"GET" });
        const json = await res.json();
        if (!json.ok || !Array.isArray(json.items)) throw new Error("bad");
        if (json.items.length === 0){
          box.textContent = t.qa_empty;
          return;
        }
        box.innerHTML = "";
        json.items.forEach(item=>{
          const div = document.createElement("div");
          div.className = "qa-item";
          div.innerHTML =
            `<div class="qa-q">Q. ${escapeHtml(item.question || "")}</div>` +
            `<div class="qa-a">A. ${escapeHtml(item.answer || "")}</div>`;
          box.appendChild(div);
        });
      }catch(_){
        box.textContent = t.qa_empty;
      }
    }

    // 送信処理
    async function submitForm(ev){
      ev.preventDefault();
      const btn = document.getElementById("btnSend");
      const msg = document.getElementById("sendMsg");
      msg.textContent = "";
      btn.disabled = true;

      // reCAPTCHA トークン
      const token = grecaptcha.getResponse();
      if (!token){
        msg.className = "err";
        msg.textContent = t.recaptcha;
        btn.disabled = false;
        return;
      }

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const message = document.getElementById("message").value.trim();

      const body = new URLSearchParams({
        name, email, message, token
      });

      try{
        const res = await fetch(GAS_ENDPOINT, {
          method: "POST",
          headers: {"Content-Type":"application/x-www-form-urlencoded"},
          body
        });
        const json = await res.json();
        if (json && json.ok){
          msg.className = "ok";
          msg.textContent = t.sent_ok;
          (document.getElementById("form")).reset();
          grecaptcha.reset();
        }else{
          throw new Error("send failed");
        }
      }catch(e){
        msg.className = "err";
        msg.textContent = t.sent_ng;
      }finally{
        btn.disabled = false;
      }
    }

    function escapeHtml(s){
      return String(s||"")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }
  </script>
</head>
<body>
  <header>
    <div class="wrap row" style="align-items:center">
      <h1 id="title" style="margin:0;font-size:1.4rem"></h1>
      <div class="lang-toggle">
        <button class="btn-ghost btn" onclick="switchLang('ja')">日本語</button>
        <button class="btn-ghost btn" onclick="switchLang('en')">English</button>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap grid grid-2">
      <!-- 左：お知らせカード（任意で既存のブログ記事を入れてください） -->
      <section class="card">
        <h2 id="contactTitle" style="margin-top:0"></h2>
        <form id="form" onsubmit="submitForm(event)" class="grid">
          <div>
            <label for="name" id="labelName"></label>
            <input id="name" name="name" required />
          </div>
          <div>
            <label for="email" id="labelEmail"></label>
            <input id="email" name="email" type="email" />
          </div>
          <div class="grid" style="grid-column:1/-1">
            <label for="message" id="labelMessage"></label>
            <textarea id="message" name="message" required></textarea>
          </div>
          <div style="grid-column:1/-1">
            <div class="g-recaptcha" data-sitekey="6LcRKvArAAAAAFVmY21y9o_hwTszHwzp3bgRXtBV"></div>
            <div id="sendMsg" class="muted" style="margin-top:6px"></div>
          </div>
          <div class="row" style="grid-column:1/-1;justify-content:flex-end">
            <button type="reset" class="btn-ghost btn" id="btnCancel"></button>
            <button type="submit" class="btn" id="btnSend"></button>
          </div>
        </form>
        <p class="muted" style="margin:10px 0 0">
          reCAPTCHA と Google の <a href="https://policies.google.com/privacy" target="_blank" rel="noopener">プライバシーポリシー</a> と
          <a href="https://policies.google.com/terms" target="_blank" rel="noopener">利用規約</a> が適用されます。
        </p>
      </section>

      <!-- 右：Q&A -->
      <section class="card">
        <h2 id="qaTitle" style="margin-top:0"></h2>
        <div id="qa-list" class="muted"></div>
      </section>
    </div>
  </main>

  <footer>
    <div class="wrap muted">© 2025 nihongotext.com</div>
  </footer>
</body>
</html>
