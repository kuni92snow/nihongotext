<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blog | nihongotext.com</title>

<base href="/" />

<link rel="icon" href="/favicon.ico" />
<link rel="icon" type="image/png" href="/icon-512.png" sizes="512x512" />
<link rel="apple-touch-icon" href="/icon-512.png" sizes="512x512" />
<link rel="manifest" href="/manifest.webmanifest" />
<meta name="theme-color" content="#b22222" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-9QSHWJE0HZ', { send_page_view:false });
</script>

<style>
:root{ --shu:#e6462d; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; }
*{ box-sizing:border-box }
html,body{ margin:0; background:#fff; color:var(--ink);
  font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif }
a{ color:inherit; text-decoration:none }
.wrap{ max-width:1100px; margin:0 auto; padding:0 16px }

/* ヘッダー/フッターの見た目 */
.topbar{
  border-top:4px solid var(--shu);
  border-bottom:1px solid #fee2e2;
  background:#fff;
}
.site-footer{
  border-top:1px solid #fee2e2;
  background:#fff;
}
.site-footer .wrap{
  padding:16px 0;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  color:#98a1a8;
  font-size:12px;
}

/* ブログでは Learning/Learned 非表示（言語トグルは表示） */
.site-header nav[aria-label="Learning navigation"]{ display:none !important; }

/* ページUI */
.page-title{ display:flex; align-items:center; gap:10px; margin:18px 0 10px }
.page-title i{ color:var(--shu) }
.searchbar{ display:flex; align-items:center; gap:8px; margin:10px 0 16px }
.searchbar input{ flex:1; height:40px; border:1px solid var(--line); border-radius:10px; padding:0 12px }

/* カード */
.list{ display:grid; gap:12px }
.card{ border:1px solid #f0d7d4; border-radius:14px; background:#fff7f6; overflow:hidden }
.card .head{ display:flex; flex-direction:column; gap:6px; padding:12px; border-bottom:1px dashed #f0d7d4; background:#fff }
.card .date{ color:#888; font-size:13px }
.card .title{ font-weight:800; font-size:18px; display:flex; align-items:center; gap:8px }
.card .body{ padding:12px }
.card .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px }
.card .tag{ font-size:12px; border:1px solid #f0d7d4; border-radius:999px; padding:3px 8px; background:#fff }
</style>
</head>
<body>

<header class="topbar">
  <div id="site-header" class="wrap site-header" style="padding:12px 0;"></div>
</header>

<main class="wrap" style="padding-bottom:24px">
  <h1 id="pageTitle" class="page-title"><i class="fa-solid fa-rss"></i> <span>Blog</span></h1>
  <div id="subLead" style="color:var(--muted); font-size:13px; margin-bottom:6px">
    Latest update from nihongotext.com
  </div>

  <div class="searchbar">
    <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
    <input id="kw" type="text" placeholder="Search posts..." />
    <a id="updatesLink" href="/blog/index.html#all" style="white-space:nowrap; color:var(--shu)">
      <i class="fa-solid fa-rotate"></i> Updates
    </a>
    <a id="permalinkLink" href="/blog/index.html" style="white-space:nowrap; color:var(--shu)">
      <i class="fa-solid fa-link"></i> Permalink
    </a>
  </div>

  <section id="list" class="list" aria-live="polite"></section>
</main>

<footer class="site-footer">
  <div id="site-footer" class="wrap" style="padding-bottom:16px"></div>
</footer>

<!-- 共通パーシャル -->
<script src="/assets/partials.js"></script>

<script>
(() => {
  // === 言語取得（partials.js が無くても動くように） ===
  const blogGetLang = () =>
    (window.getLang ? window.getLang() : (localStorage.getItem('lang') || 'en'));

  function applyLangBlog(lang){
    const kw = document.getElementById('kw');
    if(kw){
      kw.placeholder = (lang === 'en') ? 'Search posts...' : '記事を検索…';
    }
    const sub = document.getElementById('subLead');
    if(sub){
      sub.textContent = (lang === 'en')
        ? 'Latest update from nihongotext.com'
        : 'nihongotext.com からの最新更新情報';
    }
    const titleSpan = document.querySelector('#pageTitle span');
    if(titleSpan){
      titleSpan.textContent = (lang === 'en') ? 'Blog' : 'ブログ';
    }
    // <title> も切り替え
    const t = document.querySelector('title');
    if(t){
      t.textContent = (lang === 'en')
        ? 'Blog | nihongotext.com'
        : 'ブログ | nihongotext.com';
    }
  }

  // posts.json / news.json どちらか
  const endpoints = ['/blog/posts.json', '/blog/news.json'];
  async function loadPosts(){
    for(const url of endpoints){
      try{
        const r = await fetch(url,{cache:'no-store'});
        if(!r.ok) continue;
        const data = await r.json();
        if(Array.isArray(data) && data.length) return data;
      }catch(_){}
    }
    return [];
  }

  function render(posts){
    const list = document.getElementById('list');
    list.innerHTML = '';
    if(!posts.length){
      list.innerHTML = '<div style="color:#6b7280">No posts yet.</div>';
      return;
    }
    const lang = blogGetLang();

    posts
      .slice()
      .sort((a,b)=>(b.date||'').localeCompare(a.date||''))
      .forEach(p=>{
        const card = document.createElement('article');
        card.className = 'card';

        const head = document.createElement('div');
        head.className = 'head';

        const titleText = (lang==='ja')
          ? (p.title_ja || p.title || p.title_en || '(untitled)')
          : (p.title_en || p.title || p.title_ja || '(untitled)');

        const dateHtml = `<div class="date"><i class="fa-regular fa-calendar-days"></i> ${p.date||''}</div>`;
        const titleHtml = `<div class="title"><a href="/blog/${(p.slug||'').trim()}.html">${titleText}</a></div>`;
        head.innerHTML = dateHtml + titleHtml;

        const body = document.createElement('div');
        body.className = 'body';
        const sum = (lang==='ja' ? (p.summary_ja||p.summary_en) : (p.summary_en||p.summary_ja)) || '';
        body.innerHTML = `<div>${sum}</div>`;

        const tags = document.createElement('div');
        tags.className = 'tags';
        (p.tags||[]).forEach(t=>{
          const s = document.createElement('span');
          s.className = 'tag';
          s.textContent = t;
          tags.appendChild(s);
        });
        body.appendChild(tags);

        card.appendChild(head);
        card.appendChild(body);
        list.appendChild(card);
      });
  }

  // 初期化
  (async function init(){
    // ヘッダー/フッター注入
    if (window.injectPartials){
      window.injectPartials({
        hideLearningNav: true,
        titleTargets: [
          { el: document.querySelector('#pageTitle span'), en: 'Blog', ja: 'ブログ' }
        ],
        titleDoc: { en: 'Blog | nihongotext.com', ja: 'ブログ | nihongotext.com' },
        onLangApply(lang){
          applyLangBlog(lang);
          render(window.__ALL_POSTS__||[]);
        }
      });
    } else {
      // フォールバック：partials.js が無い場合でも表示させる
      const headerEl = document.getElementById('site-header');
      if(headerEl){
        fetch('/partials/header.html',{cache:'no-store'})
          .then(r=>r.ok?r.text():'')
          .then(html=>{ headerEl.innerHTML = html; })
          .catch(()=>{});
      }
      const footerEl = document.getElementById('site-footer');
      if(footerEl){
        fetch('/partials/footer.html',{cache:'no-store'})
          .then(r=>r.ok?r.text():'')
          .then(html=>{ footerEl.innerHTML = html; })
          .catch(()=>{
            footerEl.textContent = '© 2025 nihongotext.com';
          });
      }
      applyLangBlog(blogGetLang());
    }

    const all = await loadPosts();
    window.__ALL_POSTS__ = all;
    render(all);

    // 検索
    const kw = document.getElementById('kw');
    kw.addEventListener('input', ()=>{
      const term = kw.value.trim().toLowerCase();
      const base = window.__ALL_POSTS__ || [];
      if(!term){ render(base); return; }
      const filtered = base.filter(p=>{
        const blob = [
          p.slug, p.title, p.title_en, p.title_ja, p.summary_en, p.summary_ja,
          ...(p.tags||[])
        ].join(' ').toLowerCase();
        return blob.includes(term);
      });
      render(filtered);
    });

    try{ gtag('event','page_view',{page_title:'blog/index'}); }catch(_){}
  })();
})();
</script>
</body>
</html>
