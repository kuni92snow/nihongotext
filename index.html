<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>nihongotext.com</title>

<link rel="icon" href="/favicon.ico" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-9QSHWJE0HZ', { send_page_view:false });
</script>

<!-- AdSense（審査用/実表示はポップアップのみ） -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2358198194205084" crossorigin="anonymous"></script>

<style>
:root{
  --shu:#e6462d; --shu-tint:#fff2ef;
  --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb;
  --card:#fff7f6;
}
*{box-sizing:border-box}
html,body{
  margin:0;background:#fff;color:var(--ink);
  font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif
}
a{color:inherit;text-decoration:none}
button{cursor:pointer}

/* Header */
.topbar{border-top:4px solid var(--shu);border-bottom:1px solid var(--shu-tint);background:#fff}
.wrap{max-width:1100px;margin:0 auto;padding:0 16px}
.brandbar{display:flex;gap:14px;align-items:center;padding:14px 0}
.brand{font-weight:900;font-size:40px;color:var(--shu);}
.small-dot{color:#222}
.beta{color:var(--muted);font-size:12px}
.header-right{margin-left:auto;display:flex;gap:10px;align-items:center}
.btn{border:1px solid var(--shu);color:var(--shu);background:#fff;border-radius:10px;padding:8px 12px;font-weight:700}

/* Controls */
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:18px 0}
select,input[type="text"]{height:40px;border:1px solid var(--line);border-radius:10px;padding:0 12px;background:#fff}
.grow{flex:1}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid var(--line);background:#f8fafc;border-radius:999px;padding:8px 12px;font-weight:700}
.chip.active{border-color:var(--shu);background:#fde3df}
.toggle-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.toggle-row label{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);padding:6px 10px;border-radius:10px;background:#fff}

/* Cards */
.grid{display:grid;grid-template-columns:1fr;gap:12px}
.card{background:var(--card);border:1px solid #f1cbc6;border-radius:14px;overflow:hidden}
.card.learned{background:#eefbf1;border-color:#cceedd}
.head{display:flex;gap:10px;align-items:center;padding:10px 12px;background:#fff;border-bottom:1px dashed #f0d7d4}
.num{font-weight:800;color:var(--shu)}
.tags{display:flex;gap:6px;flex-wrap:wrap}
.tag{font-size:13px;background:#fff;border:1px solid #f0d7d4;border-radius:8px;padding:3px 8px}
.content{padding:12px 14px}
.line{margin:6px 0}
.ja{font-weight:800}
.kana,.ro,.en{opacity:.95}
.en{font-weight:700}

/* ▼/▲ トグルボタン */
.toggle-btn{
  border:none;background:none;color:var(--shu);cursor:pointer;
  width:22px;height:22px;font-size:16px;line-height:1;
  display:inline-flex;align-items:center;justify-content:center;
}
.toggle-btn:hover{opacity:.8}

/* Pager */
.pager{display:flex;gap:8px;align-items:center;justify-content:center;margin:16px 0 10px}
.pagebtn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px}
.pagebtn.active{border-color:var(--shu);color:var(--shu);font-weight:800}

/* Footer */
.footer{border-top:1px solid var(--shu-tint);background:#fff}
.footer-inner{padding:16px 0;display:flex;gap:10px;align-items:center;justify-content:center;color:var(--muted);font-size:12px}

/* Popup */
.admask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:90}
.admask.show{display:flex}
.ad{background:#fff;border-radius:12px;max-width:560px;width:min(96vw,560px);
     padding:12px;border:2px solid var(--shu)}
.ad h3{margin:2px 0 8px;font-size:16px;line-height:1.2}
.ad .x{float:right;border:1px solid var(--shu);color:var(--shu);background:#fff;border-radius:8px;padding:4px 9px}
#adFallback{display:none;border:1px dashed #e5e7eb;border-radius:10px;padding:8px;margin-top:6px}
#adMask small{display:none}
#amznAdBox{min-height:220px}

/* ===== Search highlight (words only) ===== */
.head .tag mark.search-hit{
  background:#fff59d;           /* やさしい黄色 */
  padding:0 2px; border-radius:3px;
}
</style>
</head>
<body>

<!-- Header -->
<div class="topbar">
  <div id="site-header" class="wrap brandbar">
    <a href="/" class="brand">nihongotext<span class="small-dot">.com</span></a>
    <span class="beta">== beta version ==</span>
    <div class="header-right">
      <button id="langBtn" class="btn" type="button">日本語</button>
    </div>
  </div>
</div>

<main class="wrap">
  <div class="controls">
    <label>Level
      <select id="levelSel">
        <option>N5</option><option>N4</option><option>N3</option><option>N2</option><option>N1</option>
      </select>
    </label>

    <div class="chips" id="posChips" role="tablist" aria-label="Parts of Speech"></div>

    <input id="kw" class="grow" type="text" placeholder="Search across all levels & parts…" />
    <button id="printBtn" class="btn" type="button">Print Learned</button>

    <div class="toggle-row" role="group" aria-label="Field toggles">
      <label><input type="checkbox" id="toggleEN" checked> English</label>
      <label><input type="checkbox" id="toggleJA" checked> Kanji</label>
      <label><input type="checkbox" id="toggleKANA" checked> Hiragana</label>
      <label><input type="checkbox" id="toggleRO" checked> Romaji</label>
    </div>
  </div>

  <div id="meta" style="color:var(--muted);font-size:13px;margin:4px 0 10px"></div>
  <div id="list" class="grid" aria-live="polite"></div>
  <div id="pager" class="pager"></div>
</main>

<!-- Footer -->
<div class="footer">
  <div id="site-footer" class="wrap footer-inner">© 2025 nihongotext.com</div>
</div>

<!-- Learned モーダル -->
<div id="learnedModal" class="admask" style="background:rgba(0,0,0,.35)">
  <div class="ad" style="max-width:820px">
    <button class="x" id="closeLearned" aria-label="Close">×</button>
    <h3 id="learnedTitle" style="margin:0 0 10px">Learned</h3>

    <div class="toggle-row" id="learnedToggles" style="margin-bottom:8px">
      <label><input type="checkbox" id="L_EN" checked> English</label>
      <label><input type="checkbox" id="L_JA" checked> Kanji</label>
      <label><input type="checkbox" id="L_KANA" checked> Hiragana</label>
      <label><input type="checkbox" id="L_RO" checked> Romaji</label>
    </div>

    <div id="learnedBody" style="border-top:1px dashed #ddd;margin-top:8px"></div>

    <div class="tools" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="clearLearned" class="btn">Clear</button>
      <button id="printLearned" class="btn" style="background:var(--shu);color:#fff;border-color:var(--shu)">Print</button>
    </div>
  </div>
</div>

<!-- Recommended popup（AdSense + Preply） -->
<div id="adMask" class="admask" aria-hidden="true">
  <div class="ad" role="dialog" aria-label="Affiliate Promotion">
    <button class="x" id="adClose" aria-label="Close">×</button>
    <h3><i class="fa-solid fa-graduation-cap"></i> Recommended</h3>

    <!-- === Google AdSense === -->
    <div id="amznAdBox" style="margin: 12px 0;">
      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2358198194205084"
              crossorigin="anonymous"></script>
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-2358198194205084"
           data-ad-slot="3714541070"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>
        (window.adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>
    <!-- === /Google AdSense === -->

    <div id="adFallback">
      <div style="font-weight:700;margin-bottom:10px">Recommended Service</div>

      <a href="https://preply.com/ja/?pref=MTE2MDM4MjQ=&id=1762247032.777052&ep=w1" 
         target="_blank" rel="sponsored noopener"
         style="display:block;padding:12px 14px;border:2px solid #e6462d;border-radius:6px;
                text-align:center;font-weight:700;color:#e6462d;text-decoration:none;
                background:#fff2ef;">
         ✅ Learn Japanese Online with Preply
      </a>

      <small style="display:block;margin-top:6px;">Affiliate link (Preply)</small>
    </div>
  </div>
</div>

<script>
/* ========= 基本設定 ========= */
const LEVELS = ['N5','N4','N3','N2','N1'];
const POS = [
  {k:'nouns', file:'nouns.json',          ja:'名詞',        enLabel:'Nouns'},
  {k:'verbs', file:'verbs.json',          ja:'動詞',        enLabel:'Verbs'},
  {k:'iadj',  file:'adjectives-i.json',   ja:'い形容詞',    enLabel:'i-Adjectives'},
  {k:'naadj', file:'adjectives-na.json',  ja:'な形容詞',    enLabel:'na-Adjectives'},
  {k:'advs',  file:'adverbs.json',        ja:'副詞',        enLabel:'Adverbs'},
  {k:'prt',   file:'particles.json',      ja:'助詞',        enLabel:'Particles'},
  {k:'conj',  file:'conjunctions.json',   ja:'接続詞',      enLabel:'Conjunctions'},
  {k:'interj',file:'interjections.json',  ja:'感動詞',      enLabel:'Interjections'},
  {k:'nums',  file:'numerals.json',       ja:'数詞',        enLabel:'Numerals'},
  {k:'pat',   file:'patterns.json',       ja:'文型',        enLabel:'Patterns'},
];
let level='N5', posKey='verbs', page=1;
const PAGE_SIZE=5, MAX_TOTAL=30;
let lastData=[];

const getLang = () => localStorage.getItem('lang') || 'en';
const setLang = (v) => localStorage.setItem('lang', v);
let uiLang = getLang();

const LS_KEY = ()=>`nt_learned_${level}_${posKey}`;
function learnedSet(){return new Set(JSON.parse(localStorage.getItem(LS_KEY())||'[]'));}
function setLearned(s){localStorage.setItem(LS_KEY(),JSON.stringify([...s]));}

function buildPath(lvl=level, pk=posKey){ return `data/json/${lvl}/${POS.find(p=>p.k===pk).file}`; }
function coerceArray(json){
  if (Array.isArray(json)) return json;
  const keys=['items','data','entries','list','rows','result','results'];
  for(const k of keys){ if(json && Array.isArray(json[k])) return json[k]; }
  if(json && typeof json==='object'){
    const vals=Object.values(json);
    if(vals.length && vals.every(v=>typeof v==='object')) return vals;
  }
  return [];
}

/* ========= ヘッダー/フッターの読込 ========= */
function applyLangToUI(){
  const btn = document.getElementById('langBtn');
  if(btn){ btn.textContent = (uiLang==='en') ? '日本語' : 'English'; }
  const kw=document.getElementById('kw');
  if(kw){ kw.placeholder = (uiLang==='en') ? 'Search across all levels & parts…' : 'レベル・品詞を横断して検索…'; }
  const lt=document.getElementById('learnedTitle');
  if(lt){ lt.textContent = (uiLang==='en') ? 'Learned' : '覚えた一覧'; }
  const pb=document.getElementById('printBtn');
  if(pb){ pb.textContent = (uiLang==='en') ? 'Print Learned' : '覚えた一覧を印刷'; }
}
function attachLangToggle(){
  const btn = document.getElementById('langBtn');
  if(!btn) return;
  btn.addEventListener('click',(e)=>{
    e.preventDefault();
    uiLang = (uiLang==='en') ? 'ja' : 'en';
    setLang(uiLang);
    applyLangToUI();
    buildChips();
    renderList(lastData);
  });
}
async function injectPartials(){
  const hdr=document.getElementById('site-header');
  const ftr=document.getElementById('site-footer');
  try{
    const h=await fetch('partials/header.html',{cache:'no-store'}).then(r=>r.ok?r.text():Promise.reject());
    hdr.innerHTML=h;
  }catch(_){
    hdr.innerHTML =
      `<div style="padding:14px 0;display:flex;gap:14px;align-items:center">
         <a href="/" style="font-weight:800;font-size:28px;color:#e6462d">nihongotext<span style="color:#333">.com</span></a>
         <span style="color:#98a1a8;font-size:12px">== beta version ==</span>
         <button id="langBtn" type="button" class="btn" style="margin-left:auto">日本語</button>
       </div>`;
  }
  try{
    const f=await fetch('partials/footer.html',{cache:'no-store'}).then(r=>r.ok?r.text():Promise.reject());
    ftr.innerHTML=f;
  }catch(_){
    ftr.innerHTML =
      `<div style="padding:16px 0;display:flex;gap:10px;align-items:center;justify-content:center;color:#98a1a8;font-size:12px">
         © 2025 nihongotext.com
       </div>`;
  }

  attachLangToggle();
  applyLangToUI();
}

/* ========= UI構築 ========= */
function buildChips(){
  const chips=document.getElementById('posChips');
  chips.innerHTML='';
  POS.forEach(p=>{
    const b=document.createElement('button');
    b.className='chip'+(p.k===posKey?' active':'');
    b.textContent=(uiLang==='en') ? p.enLabel : `${p.ja} / ${p.enLabel}`;
    b.onclick=()=>{posKey=p.k;page=1; if(!kw.value.trim()) loadSingleAndRender(); else onSearchInput(); buildChips();};
    chips.appendChild(b);
  });
}
const SAMPLE=[{"id":"demo-001","ja":"会う","kana":"あう","ro":"au","en":"meet","examples":[
  {"ja":"毎週友達に会います。","kana":"まいしゅう ともだち に あいます。","ro":"maishuu tomodachi ni aimasu.","en":"I meet my friends every week."}
]}];
async function fetchJsonSafe(path){
  try{
    const r=await fetch(path,{cache:'no-store'});
    if(!r.ok) return [];
    return coerceArray(await r.json());
  }catch(_){ return []; }
}
async function loadSingleAndRender(){
  document.getElementById('meta').textContent=`Level: ${level} • Part: ${POS.find(p=>p.k===posKey).enLabel}`;
  let arr=await fetchJsonSafe(buildPath());
  lastData = arr.length ? arr.slice(0,MAX_TOTAL) : SAMPLE;
  renderList(lastData);
  try{ gtag('event','page_view',{page_title:`${level}/${posKey}`}); }catch(_){}
}

/* ========= 横断検索 ========= */
const kw=document.getElementById('kw');
let searchAbort=0;
kw.addEventListener('input', onSearchInput, {passive:true});
async function onSearchInput(){
  const t=kw.value.trim().toLowerCase();
  if(!t){ page=1; loadSingleAndRender(); return; }
  const myId=++searchAbort;
  document.getElementById('meta').textContent = (uiLang==='en') ? 'Searching across all levels and parts…' : '全レベル・全品詞を横断して検索中…';

  const tasks=[];
  for(const lv of LEVELS){
    for(const p of POS){
      tasks.push(fetchJsonSafe(buildPath(lv,p.k)).then(arr=>arr.map(x=>({...x,_level:lv,_pos:p.enLabel,_posJa:p.ja}))));
    }
  }
  const chunks=await Promise.all(tasks);
  if(myId!==searchAbort) return;

  const joined=chunks.flat();
  const filtered=joined.filter(x=>{
    const hay=[
      x.en||'', x.ja||'', x.kana||'', x.ro||'',
      x._level||'', x._pos||'', x._posJa||'',
      ...(x.examples||[]).flatMap(e=>[e.en||'',e.ja||'',e.kana||'',e.ro||''])
    ].join(' ').toLowerCase();
    return hay.includes(t);
  });

  lastData=filtered.slice(0,MAX_TOTAL);
  page=1;
  document.getElementById('meta').textContent=(uiLang==='en')
    ? `Results: ${lastData.length} item(s) (showing up to ${MAX_TOTAL}).`
    : `検索結果: ${lastData.length} 件（最大 ${MAX_TOTAL} 件を表示）`;
  renderList(lastData);
}

/* ========= ページング＆描画 ========= */
const list=document.getElementById('list');
const pager=document.getElementById('pager');
const toggleEN   = document.getElementById('toggleEN');
const toggleJA   = document.getElementById('toggleJA');
const toggleKANA = document.getElementById('toggleKANA');
const toggleRO   = document.getElementById('toggleRO');
[toggleEN,toggleJA,toggleKANA,toggleRO].forEach(el=>el.addEventListener('change',()=>renderList(lastData)));

document.getElementById('levelSel').addEventListener('change', e=>{
  level=e.target.value; page=1; if(!kw.value.trim()) loadSingleAndRender(); else onSearchInput();
});
document.getElementById('printBtn').addEventListener('click', ()=>openLearned());

function pageBtn(t,fn){const b=document.createElement('button');b.className='pagebtn';b.textContent=t;b.onclick=fn;return b;}
function paginate(data){
  const total=Math.max(1,Math.ceil(data.length/PAGE_SIZE));
  if(page>total)page=total;
  const start=(page-1)*PAGE_SIZE;
  const rows=data.slice(start,start+PAGE_SIZE);
  pager.innerHTML='';
  const prev=pageBtn('Prev',()=>{page--;renderList(lastData,true);showAdPopup();});
  prev.disabled=page<=1; pager.appendChild(prev);
  for(let i=1;i<=total;i++){
    const b=pageBtn(String(i),()=>{page=i;renderList(lastData,true);showAdPopup();});
    if(i===page) b.classList.add('active');
    pager.appendChild(b);
  }
  const next=pageBtn('Next',()=>{page++;renderList(lastData,true);showAdPopup();});
  next.disabled=page>=total; pager.appendChild(next);
  return rows;
}
function div(cls,txt){const d=document.createElement('div');d.className=cls;if(txt!=null)d.textContent=txt;return d;}

function renderList(data){
  list.innerHTML='';
  const base=Array.isArray(data)?data:[];
  const rows=paginate(base);
  if(!rows.length){
    pager.innerHTML='';
    list.innerHTML=`<div style="color:#6b7280; padding:12px 0;">${uiLang==='en'?'No items to show.':'表示できる項目がありません。'}</div>`;
    return;
  }
  let idx=(page-1)*PAGE_SIZE;
  rows.forEach(item=>{
    idx++;
    const card=document.createElement('article'); card.className='card';

    // ==== ヘッダー（番号の左にトグル） ====
    const head=document.createElement('div'); head.className='head';

    // ▼/▲ トグル（初期は開いた状態＝▲）
    const tog=document.createElement('button');
    tog.className='toggle-btn';
    tog.setAttribute('aria-expanded','true');
    tog.textContent='▲';

    const num=div('num',idx+'.');
    const tags=div('tags','');

    const tagMap={en:item.en, ja:item.ja, kana:item.kana, ro:item.ro};
    ['en','ja','kana','ro'].forEach(k=>{
      const v=tagMap[k]; if(v && String(v).trim()){
        const s=document.createElement('span'); s.className='tag '+k; s.textContent=v; tags.appendChild(s);
      }
    });

    const act=document.createElement('button');
    act.className='btn';

    head.append(tog,num,tags,act); // トグルを先頭に

    // ==== 本文（例文） ====
    const body=div('content',''); body.dataset.examples='1';
    (item.examples||[]).forEach(ex=>{
      const parts=[];
      if(toggleEN.checked   && ex.en   ) parts.push(`<div class="en">${ex.en}</div>`);
      if(toggleJA.checked   && ex.ja   ) parts.push(`<div class="ja">${ex.ja}</div>`);
      if(toggleKANA.checked && ex.kana ) parts.push(`<div class="kana">${ex.kana}</div>`);
      if(toggleRO.checked   && ex.ro   ) parts.push(`<div class="ro">${ex.ro}</div>`);
      if(parts.length){ const block=div('line',''); block.innerHTML=parts.join(''); body.appendChild(block); }
    });

    // ==== Learned 状態反映 ====
    const isLearned = learnedSet().has(item.id);
    if(isLearned){
      card.classList.add('learned');
      body.style.display='none';
      tog.textContent='▼';
      tog.setAttribute('aria-expanded','false');
    }else{
      body.style.display='';
      tog.textContent='▲';
      tog.setAttribute('aria-expanded','true');
    }

    // ==== Learn ボタン（Learning へ移動）====
act.textContent = (uiLang==='en'?'Learn':'覚える');
act.onclick = () => {
  const posLabel = POS.find(p=>p.k===posKey)?.enLabel || posKey;
  const payload = {
    id: item.id, ja: item.ja, en: item.en,
    level, part: posLabel,
    examples: item.examples || [],
    quiz: {taken:0, correct:0}
  };
  window.ntxToLearning(payload);
};

    // ==== トグル ====
    tog.addEventListener('click',()=>{
      const open = body.style.display!=='none';
      if(open){
        body.style.display='none'; tog.textContent='▼'; tog.setAttribute('aria-expanded','false');
      }else{
        body.style.display='';    tog.textContent='▲'; tog.setAttribute('aria-expanded','true');
      }
    });

    // ==== DOM へ追加 ====
    card.append(head,body); list.appendChild(card);
  });

  const posLabel=POS.find(p=>p.k===posKey);
  document.getElementById('meta').textContent=(uiLang==='en')
    ? `Level: ${level} • Part: ${posLabel.enLabel}`
    : `レベル: ${level} • 品詞: ${posLabel.ja}`;
}

/* Learned トグル */
function toggleLearned(item,card,btnEl,togBtn,bodyEl){
  const s=learnedSet();
  const has=s.has(item.id);
  if(has){
    s.delete(item.id);
    card.classList.remove('learned');
    if(btnEl) btnEl.textContent=(uiLang==='en'?'Learned':'覚えた');
    if(bodyEl){ bodyEl.style.display=''; }
    if(togBtn){ togBtn.textContent='▲'; togBtn.setAttribute('aria-expanded','true'); }
  }else{
    s.add(item.id);
    card.classList.add('learned');
    if(btnEl) btnEl.textContent=(uiLang==='en'?'Unlearn':'覚えたを戻す');
    if(bodyEl){ bodyEl.style.display='none'; }
    if(togBtn){ togBtn.textContent='▼'; togBtn.setAttribute('aria-expanded','false'); }
  }
  setLearned(s);
}

/* ========= Learned モーダル ========= */
function openLearned(){
  const modal=document.getElementById('learnedModal');
  modal.classList.add('show');
  renderLearnedModal();
}
document.getElementById('closeLearned').onclick=()=>document.getElementById('learnedModal').classList.remove('show');
document.getElementById('learnedModal').addEventListener('click',e=>{ if(e.target.id==='learnedModal') e.currentTarget.classList.remove('show'); });
document.getElementById('clearLearned').onclick=()=>{ localStorage.setItem(LS_KEY(),'[]'); renderLearnedModal(); };
document.getElementById('printLearned').onclick=()=>{
  const s=learnedSet(); if(!s.size){ alert('No learned items.'); return; }
  const w=open('','_blank'); const rows=(lastData||[]).filter(x=>s.has(x.id));
  w.document.write('<!doctype html><meta charset="utf-8"><title>Learned</title><style>body{font:14px system-ui;padding:20px}.row{border-bottom:1px dashed #ccc;padding:6px 0}</style><h1>Learned</h1>');
  rows.forEach((x,i)=>w.document.write(`<div class="row">${i+1}. <strong>${x.ja||''}</strong> / ${x.kana||''} / ${x.ro||''} — ${x.en||''}</div>`));
  w.document.close(); w.print();
};
['L_EN','L_JA','L_KANA','L_RO'].forEach(id=>{
  document.getElementById(id).addEventListener('change',renderLearnedModal);
});
function renderLearnedModal(){
  const body=document.getElementById('learnedBody');
  const s=learnedSet();
  body.innerHTML='';
  const rows=(lastData||[]).filter(x=>s.has(x.id));
  if(rows.length===0){ body.innerHTML='<div style="color:#6b7280;padding-top:6px">No items yet.</div>'; return; }

  const showEN=document.getElementById('L_EN').checked;
  const showJA=document.getElementById('L_JA').checked;
  const showKA=document.getElementById('L_KANA').checked;
  const showRO=document.getElementById('L_RO').checked;

  rows.forEach((x,i)=>{
    const wrap=document.createElement('div');
    wrap.style.cssText='padding:8px 0;border-bottom:1px dashed #eee';

    const tags=[];
    if(showEN && x.en) tags.push(x.en);
    if(showJA && x.ja) tags.push(x.ja);
    if(showKA && x.kana) tags.push(x.kana);
    if(showRO && x.ro) tags.push(x.ro);
    const lineTop=document.createElement('div');
    lineTop.style.fontWeight='700';
    lineTop.textContent=`${i+1}. ${tags.join(' / ')}`;
    wrap.appendChild(lineTop);

    const ex = (x.examples && x.examples.length) ? x.examples[0] : null;
    if(ex){
      const bits=[];
      if(showEN && ex.en)   bits.push(`<div class="en">${ex.en}</div>`);
      if(showJA && ex.ja)   bits.push(`<div class="ja">${ex.ja}</div>`);
      if(showKA && ex.kana) bits.push(`<div class="kana">${ex.kana}</div>`);
      if(showRO && ex.ro)   bits.push(`<div class="ro">${ex.ro}</div>`);
      if(bits.length){
        const block=document.createElement('div');
        block.style.margin='4px 0 0 18px';
        block.innerHTML=bits.join('');
        wrap.appendChild(block);
      }
    }
    body.appendChild(wrap);
  });
}

/* ========= Search highlight (words + examples) — loop-safe ========= */
let HL_LOCK = false;  // 再入防止ロック

function escapeRegExp(s){ return (s||'').replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

// 1) data-text を付与（単語タグ + 例文の各行）
function ensureDatasets(root){
  const scope = root || document;
  // 単語タグ（ヘッダーのバッジ）
  const wordTags = scope.querySelectorAll('#list .head .tag');
  wordTags.forEach(t=>{ if(!t.dataset.text){ t.dataset.text = t.textContent || ''; }});
  // 例文（本文の各行）
  const exNodes = scope.querySelectorAll('#list .content .en, #list .content .ja, #list .content .kana, #list .content .ro');
  exNodes.forEach(n=>{ if(!n.dataset.text){ n.dataset.text = n.textContent || ''; }});
}

// 2) 単語タグ + 例文の両方をハイライト（空文字→解除）
function highlightCurrentTerm(){
  if (HL_LOCK) return;

  const kwEl  = document.getElementById('kw');
  const term  = (kwEl && kwEl.value ? kwEl.value.trim() : '');
  const listEl= document.getElementById('list');
  if(!listEl) return;

  const targets = listEl.querySelectorAll(
    '.head .tag, .content .en, .content .ja, .content .kana, .content .ro'
  );
  const re = term ? new RegExp(escapeRegExp(term), 'gi') : null;

  HL_LOCK = true;  // 内部変更での再発火を抑止
  targets.forEach(el=>{
    const raw = el.dataset && el.dataset.text ? el.dataset.text : (el.textContent || '');
    el.innerHTML = !term ? raw : raw.replace(re, m=>`<mark class="search-hit">${m}</mark>`);
  });
  HL_LOCK = false;
}

// 3) 入力に追従（既存の検索フィルタ描画後にハイライト）
function bindSearchHighlight(){
  const kwEl = document.getElementById('kw');
  if(!kwEl) return;
  kwEl.addEventListener('input', ()=>{
    requestAnimationFrame(()=>{
      ensureDatasets();
      highlightCurrentTerm();
    });
  }, {passive:true});
}

// 4) #list の直下の子入れ替え時にだけ再ハイライト（<mark> には反応しない）
function attachListObserver(){
  const listEl = document.getElementById('list');
  if(!listEl || typeof MutationObserver==='undefined') return;

  const mo = new MutationObserver(muts=>{
    const changed = muts.some(m => m.type==='childList' && (m.addedNodes.length || m.removedNodes.length));
    if(changed){
      muts.forEach(m=>{
        m.addedNodes.forEach(n=>{
          if(n.nodeType===1) ensureDatasets(n);
        });
      });
      requestAnimationFrame(highlightCurrentTerm);
    }
  });
  mo.observe(listEl, {childList:true, subtree:false}); // subtree:false がループ防止の肝
}

// 5) 初期化フック（既存 init の後でも前でもOK）
document.addEventListener('DOMContentLoaded', ()=>{
  ensureDatasets();
  bindSearchHighlight();
  attachListObserver();
  highlightCurrentTerm();
});

/* ========= Popup & 初期化 ========= */
const adMask=document.getElementById('adMask'), adClose=document.getElementById('adClose');
adClose.onclick=()=>adMask.classList.remove('show');
adMask.addEventListener('click',e=>{ if(e.target===adMask) adMask.classList.remove('show'); });

(async function init(){
  await injectPartials();
  buildChips();
  await loadSingleAndRender();

  ensureWordTagDatasets();
  bindSearchHighlight();
  attachListObserver();
  highlightCurrentTermInWords();
})();
</script>

<!-- ===== BEGIN: Learning / Learned UI injection ===== -->
<style>
  .ntx-modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:9998}
  .ntx-modal{position:fixed;top:8vh;left:50%;transform:translateX(-50%);width:min(980px,96vw);
             background:#fff;border:2px solid #e6462d;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);
             display:none;z-index:9999}
  .ntx-modal.show,.ntx-modal-mask.show{display:block}
  .ntx-m-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #f2c9c2}
  .ntx-m-title{font-weight:800}
  .ntx-m-body{padding:12px 14px;max-height:70vh;overflow:auto}
  .ntx-table{width:100%;border-collapse:collapse}
  .ntx-table th,.ntx-table td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left;vertical-align:top}
  .ntx-ctl{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:2px solid #e6462d;color:#e6462d;background:#fff2ef;padding:.35rem .7rem;border-radius:8px;cursor:pointer;font-weight:700}
  .btn.secondary{border-color:#c4c4c4;color:#333;background:#fff}
  .btn.danger{border-color:#b91c1c;color:#b91c1c;background:#fff5f5}
  .xbtn{border:none;background:transparent;font-size:20px;line-height:1;cursor:pointer}
  details.example{margin:.2rem 0;border:1px dashed #f1c4bc;padding:.3rem .5rem;border-radius:6px;background:#fff9f8}
  summary{cursor:pointer;font-weight:600}
  .quizstat{font-variant-numeric:tabular-nums}
  @media print{
    .ntx-modal,.ntx-modal-mask{position:static;transform:none;width:100%;border:none;box-shadow:none;display:block}
    .xbtn,.ntx-ctl,button{display:none}
  }
  /* ヘッダー赤線の途切れ防止（全幅の擬似線） */
  .ntx-header{position:relative;z-index:10}
  .ntx-header::after{
    content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-1px;width:100vw;height:0;border-bottom:2px solid #e6462d;pointer-events:none;
  }
</style>

<div id="ntxModalMask" class="ntx-modal-mask"></div>

<!-- learning（学習中） -->
<div id="learningModal" class="ntx-modal" role="dialog" aria-label="learning">
  <div class="ntx-m-head">
    <div class="ntx-m-title" data-i18n="learning_title">learning</div>
    <div class="ntx-ctl">
      <button class="btn" id="printLearning" data-i18n="print">Print</button>
      <button class="btn secondary" id="goToLearned" data-i18n="goto_learned">go to learned</button>
      <button class="xbtn" data-close="learningModal" aria-label="Close">×</button>
    </div>
  </div>
  <div class="ntx-m-body">
    <table class="ntx-table" id="learningTable">
      <thead>
        <tr>
          <th>#</th><th data-i18n="word">Word</th><th>Level/Part</th>
          <th data-i18n="moved">Moved on</th>
          <th data-i18n="examples">Examples</th>
          <th class="quizstat" data-i18n="quiz">Quiz</th>
          <th data-i18n="action">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- learned（覚えた） -->
<div id="learnedModal" class="ntx-modal" role="dialog" aria-label="learned">
  <div class="ntx-m-head">
    <div class="ntx-m-title" data-i18n="learned_title">learned</div>
    <div class="ntx-ctl">
      <button class="btn" id="printLearned" data-i18n="print">Print</button>
      <button class="btn secondary" id="goToLearning" data-i18n="goto_learning">go to learning</button>
      <button class="xbtn" data-close="learnedModal" aria-label="Close">×</button>
    </div>
  </div>
  <div class="ntx-m-body">
    <table class="ntx-table" id="learnedTable">
      <thead>
        <tr>
          <th>#</th><th data-i18n="word">Word</th><th>Level/Part</th>
          <th data-i18n="moved">Moved on</th>
          <th data-i18n="examples">Examples</th>
          <th class="quizstat" data-i18n="quiz">Quiz</th>
          <th data-i18n="action">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ========= i18n ========= */
function ntxLang(){ try{return localStorage.getItem('lang')||'en'}catch(_){return'en'} }
function i18n(tk){
  const ja={learning_title:'学習中（learning）', learned_title:'覚えた（learned）', print:'印刷', goto_learned:'覚えたへ', goto_learning:'学習中へ', word:'単語', moved:'移動日', examples:'例文', quiz:'クイズ', action:'操作', learn:'覚える'};
  const en={learning_title:'learning', learned_title:'learned', print:'Print', goto_learned:'go to learned', goto_learning:'go to learning', word:'Word', moved:'Moved on', examples:'Examples', quiz:'Quiz', action:'Action', learn:'Learn'};
  return (ntxLang()==='ja'?ja:en)[tk]||tk;
}
function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent=i18n(el.getAttribute('data-i18n')); });
  const lb=document.getElementById('learnBtn'); if(lb) lb.textContent=i18n('learn').toLowerCase();
}

/* ========= ストレージ ========= */
const NTX_KEYS={learning:'ntx_learning_v2', learned:'ntx_learned_v2'};
function ntxLoad(k){ try{return JSON.parse(localStorage.getItem(k)||'[]')}catch(_){return[]} }
function ntxSave(k,v){ try{localStorage.setItem(k,JSON.stringify(v))}catch(_){} }
function today(){ const d=new Date(),z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
function upsert(k,item){ const a=ntxLoad(k); const i=a.findIndex(x=>x.id===item.id); if(i>=0)a[i]=item; else a.push(item); ntxSave(k,a); }
function removeFrom(k,id){ ntxSave(k, ntxLoad(k).filter(x=>x.id!==id)); }

/* ========= 公開 API =========
  item: { id, ja, en, level, part, movedAt?, examples?:[{en,ja,kana,ro}], quiz?:{taken,correct} }
*/
window.ntxToLearning=function(item){ if(!item||!item.id)return; item.movedAt=item.movedAt||today(); item.quiz=item.quiz||{taken:0,correct:0}; upsert(NTX_KEYS.learning,item); removeFrom(NTX_KEYS.learned,item.id); renderLearning(); };
window.ntxToLearned=function(item){ if(!item||!item.id)return; item.movedAt=item.movedAt||today(); item.quiz=item.quiz||{taken:0,correct:0}; upsert(NTX_KEYS.learned,item); removeFrom(NTX_KEYS.learning,item.id); renderLearned(); };
window.ntxQuizAddResult=function(id,correct){
  [NTX_KEYS.learning,NTX_KEYS.learned].forEach(k=>{
    const a=ntxLoad(k), i=a.findIndex(x=>x.id===id);
    if(i>=0){ a[i].quiz=a[i].quiz||{taken:0,correct:0}; a[i].quiz.taken++; if(!!correct) a[i].quiz.correct++; ntxSave(k,a); }
  });
  renderLearning(); renderLearned();
};

/* ========= 行レンダリング ========= */
function exBlock(ex, idx){
  if(!ex) return '';
  const rows=[];
  if(ex.en)   rows.push(`<div><b>EN:</b> ${escapeHtml(ex.en)}</div>`);
  if(ex.ja)   rows.push(`<div><b>JA:</b> ${escapeHtml(ex.ja)}</div>`);
  if(ex.kana) rows.push(`<div><b>KANA:</b> ${escapeHtml(ex.kana)}</div>`);
  if(ex.ro)   rows.push(`<div><b>RO:</b> ${escapeHtml(ex.ro)}</div>`);
  return `<details class="example"><summary>Example ${idx+1}</summary>${rows.join('')||'<div>—</div>'}</details>`;
}
function quizText(q){ q=q||{taken:0,correct:0}; return `${q.correct||0}/${q.taken||0}`; }
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

function rowHTML(idx, it, toKey){
  const meta=[it.level||'',it.part||''].filter(Boolean).join(' / ');
  const payload=encodeURIComponent(JSON.stringify({id:it.id,ja:it.ja,en:it.en,level:it.level,part:it.part,examples:it.examples||[],quiz:it.quiz||{taken:0,correct:0}}));
  const to=(toKey===NTX_KEYS.learned)?'learned':'learning';
  const fn=(toKey===NTX_KEYS.learned)?'ntxToLearned':'ntxToLearning';
  const examples=(it.examples||[]).map((e,i)=>exBlock(e,i)).join('') || '<div>—</div>';
  return `<tr data-id="${it.id}">
    <td>${idx}</td>
    <td>${(it.en||'')}${it.ja?` / ${escapeHtml(it.ja)}`:''}</td>
    <td>${meta||'-'}</td>
    <td>${it.movedAt||'-'}</td>
    <td>${examples}</td>
    <td class="quizstat">${quizText(it.quiz)}</td>
    <td>
      <button class="btn" onclick="(function(){ ${fn}(JSON.parse(decodeURIComponent('${payload}'))); })()">move to ${to}</button>
      <button class="btn danger" onclick="(function(){ removeFrom('${toKey}','${it.id}'); renderLearning(); renderLearned(); })()">remove</button>
    </td>
  </tr>`;
}
function renderLearning(){ const tb=document.querySelector('#learningTable tbody'); if(!tb)return; const arr=ntxLoad(NTX_KEYS.learning); tb.innerHTML=arr.map((it,i)=>rowHTML(i+1,it,NTX_KEYS.learned)).join('')||`<tr><td colspan="7">No items</td></tr>`; applyI18n(); }
function renderLearned(){ const tb=document.querySelector('#learnedTable tbody'); if(!tb)return; const arr=ntxLoad(NTX_KEYS.learned); tb.innerHTML=arr.map((it,i)=>rowHTML(i+1,it,NTX_KEYS.learning)).join('')||`<tr><td colspan="7">No items</td></tr>`; applyI18n(); }

/* ========= 開閉・印刷 ========= */
function openModal(id){ document.getElementById('ntxModalMask')?.classList.add('show'); const el=document.getElementById(id); if(!el)return; el.classList.add('show'); if(id==='learningModal')renderLearning(); if(id==='learnedModal')renderLearned(); }
function closeModal(id){ document.getElementById(id)?.classList.remove('show'); const anyOpen=document.querySelector('.ntx-modal.show'); if(!anyOpen) document.getElementById('ntxModalMask')?.classList.remove('show'); }
function printTable(id){
  const box=document.querySelector('#'+id+' .ntx-m-body'); if(!box)return;
  const w=window.open('','_blank');
  w.document.write('<meta charset="utf-8"><title>Print</title><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.5;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:6px 8px;text-align:left} details{margin:.2rem 0} summary{font-weight:700}</style>'+box.innerHTML);
  w.document.close(); w.focus(); w.print(); w.close();
}

/* ========= ヘッダー統合（learn ボタンを右端に） ========= */
document.addEventListener('DOMContentLoaded', function(){
  // ヘッダー右側コンテナが無い場合は作る
  let right=document.querySelector('.ntx-header .ntx-right'); const wrap=document.querySelector('.ntx-header .ntx-wrap');
  if(!right && wrap){ right=document.createElement('div'); right.className='ntx-right'; wrap.appendChild(right); }
  // learn ボタン（学習中を開く）
  if(right && !document.getElementById('learnBtn')){
    const btn=document.createElement('button'); btn.id='learnBtn'; btn.className='ntx-langbtn'; btn.type='button'; btn.textContent=i18n('learn').toLowerCase(); btn.setAttribute('aria-label','learn'); right.prepend(btn);
  }
  document.getElementById('learnBtn')?.addEventListener('click', ()=>openModal('learningModal'));

  // モーダル内ナビ
  document.getElementById('goToLearned') ?.addEventListener('click', ()=>{ closeModal('learningModal'); openModal('learnedModal'); });
  document.getElementById('goToLearning')?.addEventListener('click', ()=>{ closeModal('learnedModal');  openModal('learningModal'); });
  // 閉じる
  document.querySelectorAll('.xbtn[data-close]').forEach(b=>b.addEventListener('click', ()=>closeModal(b.getAttribute('data-close'))));
  document.getElementById('ntxModalMask')?.addEventListener('click', ()=>{ closeModal('learningModal'); closeModal('learnedModal'); });
  // 印刷
  document.getElementById('printLearning')?.addEventListener('click', ()=>printTable('learningModal'));
  document.getElementById('printLearned') ?.addEventListener('click', ()=>printTable('learnedModal'));

  applyI18n();
});
</script>
<!-- ===== END: Learning / Learned UI injection ===== -->

</body>
</html>
