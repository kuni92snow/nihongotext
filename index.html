<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JLPT — Words | nihongotext.com</title>
  <base href="/" />
  <link rel="icon" href="/icon-512.png" />
  <meta name="description" content="Browse JLPT vocabulary by level and part of speech. Add items to Learning and move to Learned. Toggle kanji with furigana, hiragana, romaji, and English." />

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date()); gtag('config', 'G-9QSHWJE0HZ');
  </script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root { --brand:#e6462d; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji'; color:#222; background:#fff; }
    main{ max-width:1100px; margin:20px auto 60px; padding:0 16px; }
    h1{ color:#d33; font-size:20px; margin:10px 0 16px; }
    .toolbar{ display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin:10px 0 14px; }
    .toolbar .grp{ display:flex; align-items:center; gap:8px; }
    select, button, input[type="checkbox"]{ font-size:14px; }
    .row{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
    .cards{ display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:14px; }
    .card{ border:1px solid #eee; border-radius:10px; padding:12px; background:#fff; }
    .muted{ color:#666; }
    .topline{ display:flex; justify-content:space-between; gap:8px; align-items:center; margin-bottom:6px; }
    .badges{ display:flex; gap:6px; align-items:center; }
    .badge{ font-size:12px; padding:2px 6px; border:1px solid #eee; border-radius:999px; color:#555; background:#fafafa; }
    .btn{ border:1px solid #ddd; background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .btn:hover{ border-color:#ccc; }
    .btn-red{ border-color:var(--brand); color:var(--brand); }
    .lines{ line-height:1.8; }
    .line{ margin:2px 0; }
    ruby rt{ font-size:.72em; color:#666; }
    details summary{ cursor:pointer; list-style:none; }
    details summary::-webkit-details-marker{ display:none; }
    .pager{ display:flex; gap:8px; align-items:center; margin:16px 0 4px; }
    .pager .btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .error{ border:1px dashed #f2b; padding:10px; border-radius:8px; color:#a00; background:#fff7f9; }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <h1>JLPT — Words</h1>

    <!-- Controls -->
    <div class="toolbar">
      <div class="grp">
        <label for="sel-level">Level</label>
        <select id="sel-level">
          <option>N5</option><option>N4</option><option>N3</option><option>N2</option><option>N1</option>
        </select>
      </div>
      <div class="grp">
        <label for="sel-part">Part</label>
        <select id="sel-part">
          <option value="verbs">verbs</option>
          <option value="nouns">nouns</option>
          <option value="adjectives-i">adjectives-i</option>
          <option value="adjectives-na">adjectives-na</option>
          <option value="adverbs">adverbs</option>
          <option value="numerals">numerals</option>
          <option value="particles">particles</option>
          <option value="conjunctions">conjunctions</option>
          <option value="interjections">interjections</option>
        </select>
      </div>
    </div>

    <!-- Toggle (2 rows) -->
    <div class="toolbar" style="flex-direction:column; align-items:flex-start;">
      <div class="row">
        <label><input type="checkbox" id="chk-ja" checked> Nihongo（漢字+ふりがな）</label>
        <label><input type="checkbox" id="chk-kana" checked> Hiragana</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="chk-ro" checked> Alphabet（romaji）</label>
        <label><input type="checkbox" id="chk-en" checked> English</label>
      </div>
    </div>

    <!-- Pager -->
    <div class="pager">
      <button class="btn" id="btn-prev">&lt; Prev</button>
      <div id="page-numbers" class="muted"></div>
      <button class="btn" id="btn-next">Next &gt;</button>
    </div>

    <div id="list"></div>

    <div class="pager">
      <button class="btn" id="btn-prev-b">&lt; Prev</button>
      <div id="page-numbers-b" class="muted"></div>
      <button class="btn" id="btn-next-b">Next &gt;</button>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    /* ====== partials ====== */
    (async function injectPartials(){
      try{
        const [h,f] = await Promise.all([
          fetch('/partials/header.html',{cache:'no-store'}).then(r=>r.text()),
          fetch('/partials/footer.html',{cache:'no-store'}).then(r=>r.text())
        ]);
        document.getElementById('header-placeholder').innerHTML = h;
        document.getElementById('footer-placeholder').innerHTML = f;
      }catch(e){ console.warn('partials load failed', e); }
    })();
  </script>

  <script>
  /* ====== data layer & UI ====== */
  (function(){
    const MAX_ITEMS = 30;      // 各品詞の上限
    const PAGE_SIZE = 5;       // 1ページ表示数
    const KEY_LEARNING = 'nihongo_learning';
    const KEY_LEARNED  = 'nihongo_learned';

    /* -------- state -------- */
    const state = {
      level: 'N5',
      part: 'verbs',
      items: [],
      segments: {},  // { id: [{kanji:'...', kana:'...'}, ...] } などを想定
      page: 1
    };

    /* -------- helpers -------- */
    function getParams(){
      const sp = new URLSearchParams(location.search);
      const level = sp.get('level') || 'N5';
      const part  = sp.get('part')  || 'verbs';
      const page  = Math.max(1, parseInt(sp.get('page')||'1',10));
      return {level, part, page};
    }
    function setParams(obj){
      const sp = new URLSearchParams(location.search);
      for (const [k,v] of Object.entries(obj)) sp.set(k,String(v));
      history.replaceState(null,'','?'+sp.toString());
    }

    function readLS(k){ try{return JSON.parse(localStorage.getItem(k)||'[]');}catch{return [];} }
    function writeLS(k,v){ try{localStorage.setItem(k,JSON.stringify(v));}catch{} }

    function mergeUnique(a,b){
      const m = new Map();
      [...a,...b].forEach(x=>{ if(x && x.id!=null) m.set(String(x.id), x); });
      return [...m.values()];
    }

    function inLearning(id){
      return readLS(KEY_LEARNING).some(x=>String(x.id)===String(id));
    }
    function inLearned(id){
      return readLS(KEY_LEARNED).some(x=>String(x.id)===String(id));
    }

    function addToLearning(item){
      const cur = mergeUnique(readLS(KEY_LEARNING), [item]);
      writeLS(KEY_LEARNING, cur);
      // ヘッダーのバッジ更新
      if (window._ntxRenderLearning) window._ntxRenderLearning();
      const badge = document.getElementById('learning-count-badge');
      if (badge) badge.textContent = String(cur.length);
    }
    function removeFromLearning(id){
      const cur = readLS(KEY_LEARNING).filter(x=>String(x.id)!==String(id));
      writeLS(KEY_LEARNING, cur);
      if (window._ntxRenderLearning) window._ntxRenderLearning();
      const badge = document.getElementById('learning-count-badge');
      if (badge) badge.textContent = String(cur.length);
    }
    function addToLearned(item){
      const cur = mergeUnique(readLS(KEY_LEARNED), [Object.assign({}, item, {learnedAt: Date.now()})]);
      writeLS(KEY_LEARNED, cur);
      if (window._ntxRenderLearning) window._ntxRenderLearning();
    }

    // ふりがな：segments があれば厳密に ruby を組み立て、なければフォールバック
    function toRuby(id, ja, kana){
      const seg = state.segments && state.segments[id];
      if (Array.isArray(seg) && seg.length){
        // seg = [{kanji:'学校', kana:'がっこう'}, ...]
        return seg.map(s=>{
          const k = (s.kanji ?? '').trim();
          const r = (s.kana ?? '').trim();
          if(!k) return '';
          if(!r || k===r) return k; // かなのみ
          return `<ruby>${escapeHtml(k)}<rt>${escapeHtml(r)}</rt></ruby>`;
        }).join('');
      }
      // フォールバック：全体にルビ
      if (!ja) return '';
      if (!kana || kana === ja) return escapeHtml(ja);
      return `<ruby>${escapeHtml(ja)}<rt>${escapeHtml(kana)}</rt></ruby>`;
    }

    function escapeHtml(s){ return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    /* -------- fetchers -------- */
    async function fetchJsonStrict(url){
      const res = await fetch(url, {cache:'no-store'});
      const text = await res.text();
      if (!res.ok || /^\s*</.test(text)) {
        const err = new Error(`Fetch failed: ${url} (status ${res.status})`);
        err._body = text.slice(0,200);
        throw err;
      }
      return JSON.parse(text);
    }

    async function loadData(){
      const {level, part} = state;

      // /data と /dada の両方を試す（大文字小文字も）
      const bases = ['/data/json','/dada/json'];
      const lv = [level, level.toUpperCase(), level.toLowerCase()];
      const candidates = [];
      for (const b of bases){
        for (const L of lv){
          candidates.push(`${b}/${L}/${part}.json`);
        }
      }
      // 重複削除
      const uniq = candidates.filter((v,i,a)=>a.indexOf(v)===i);

      let data=null, lastErr=null;
      for (const url of uniq){
        try{ data = await fetchJsonStrict(url); console.info('[data]', url); break; }
        catch(e){ lastErr=e; console.warn('[miss]', url, e); }
      }

      const list = document.getElementById('list');
      if(!Array.isArray(data)){
        list.innerHTML = `<div class="error">Failed to load dataset.<br/>Checked:<br/>${uniq.map(u=>`<code>${u}</code>`).join('<br/>')}
          <div class="muted" style="margin-top:6px">${lastErr?escapeHtml(String(lastErr)):'unknown error'}</div></div>`;
        state.items = []; state.page = 1; updatePager(); return;
      }

      // 上限 30
      state.items = data.slice(0, MAX_ITEMS);

      // segments（任意）
      state.segments = {};
      const segBases = ['/data/segments','/dada/segments'];
      const segCandidates = [];
      for (const b of segBases){
        for (const L of lv){
          segCandidates.push(`${b}/${L}/${part}.json`);
        }
      }
      for (const s of segCandidates){
        try{
          const seg = await fetchJsonStrict(s);
          if (seg && typeof seg==='object') { state.segments = seg; console.info('[segments]', s); break; }
        }catch(e){}
      }

      // URL ?page= を尊重
      const qsPage = parseInt(new URLSearchParams(location.search).get('page')||'1',10);
      state.page = Math.max(1, isNaN(qsPage)?1:qsPage);

      renderList();
      updatePager();
    }

    /* -------- render -------- */
    function renderList(){
      const list = document.getElementById('list');
      const start = (state.page-1)*PAGE_SIZE;
      const slice = state.items.slice(start, start+PAGE_SIZE);

      const show = {
        ja:   document.getElementById('chk-ja').checked,
        kana: document.getElementById('chk-kana').checked,
        ro:   document.getElementById('chk-ro').checked,
        en:   document.getElementById('chk-en').checked,
      };

      if (!slice.length){
        list.innerHTML = `<div class="muted">No items.</div>`;
        return;
      }

      list.innerHTML = `<div class="cards">${
        slice.map(item=>{
          const id = item.id ?? '';
          const ja = toRuby(id, item.ja, item.kana);
          const kana = escapeHtml(item.kana||'');
          const ro = escapeHtml(item.ro||'');
          const en = escapeHtml(item.en||'');

          const examples = Array.isArray(item.examples)?item.examples:[];
          const exHtml = examples.map(e=>{
            const l1 = e.ja ? `<div class="line">${toRuby(id, e.ja, e.kana||'')}</div>` : '';
            const l2 = e.kana ? `<div class="line">${escapeHtml(e.kana)}</div>` : '';
            const l3 = e.ro ? `<div class="line">${escapeHtml(e.ro)}</div>` : '';
            const l4 = e.en ? `<div class="line">${escapeHtml(e.en)}</div>` : '';
            return `<div class="lines" style="margin:4px 0 8px 0;">${l1}${l2}${l3}${l4}</div>`;
          }).join('');

          const topRight = `
            <div class="badges">
              <button class="btn" data-action="to-learning" data-id="${id}"><i class="fa-solid fa-rotate-left"></i> Learn</button>
              <button class="btn btn-red" data-action="to-learned"  data-id="${id}"><i class="fa-solid fa-check"></i> Learned</button>
            </div>`;

          const line1 = `<div class="line"><span class="badge">${escapeHtml(state.level)}</span> <span class="badge">${escapeHtml(state.part)}</span></div>`;
          const line2 = show.ja   ? `<div class="line" style="font-size:18px">${ja}</div>`   : '';
          const line3 = show.kana ? `<div class="line">${kana}</div>` : '';
          const line4 = show.ro   ? `<div class="line">${ro}</div>`   : '';
          const line5 = show.en   ? `<div class="line">${en}</div>`   : '';

          return `<article class="card" data-id="${id}">
            <div class="topline">
              <div class="muted"><i class="fa-solid fa-book-open" style="color:var(--brand)"></i></div>
              ${topRight}
            </div>
            ${line1}${line2}${line3}${line4}${line5}
            ${examples.length ? `
              <details style="margin-top:8px;">
                <summary class="muted"><i class="fa-solid fa-caret-down"></i> Examples</summary>
                <div style="margin-top:6px;">${exHtml}</div>
              </details>` : ``}
          </article>`;
        }).join('')
      }</div>`;
    }

    function updatePager(){
      const pages = Math.max(1, Math.ceil(state.items.length / PAGE_SIZE));
      state.page = Math.min(Math.max(1,state.page), pages);

      const nums = document.getElementById('page-numbers');
      const numsB= document.getElementById('page-numbers-b');
      const html = Array.from({length:pages}, (_,i)=>{
        const p = i+1;
        return `<button class="btn" data-gop="${p}" ${p===state.page?'disabled':''}>${p}</button>`;
      }).join(' ');
      if (nums) nums.innerHTML = html;
      if (numsB) numsB.innerHTML = html;

      const prevs = [document.getElementById('btn-prev'), document.getElementById('btn-prev-b')];
      const nexts = [document.getElementById('btn-next'), document.getElementById('btn-next-b')];
      prevs.forEach(b=>{ if(b){ b.disabled = (state.page<=1); }});
      nexts.forEach(b=>{ if(b){ b.disabled = (state.page>=pages); }});
    }

    /* -------- events -------- */
    document.addEventListener('click', (ev)=>{
      const t = ev.target;
      if (!t) return;

      // ページャー
      const btn = t.closest('button');
      if (btn && btn.dataset.gop){
        state.page = parseInt(btn.dataset.gop,10);
        setParams({page: state.page});
        renderList(); updatePager(); return;
      }
      if (btn && btn.id==='btn-prev' || btn && btn.id==='btn-prev-b'){
        state.page = Math.max(1, state.page-1);
        setParams({page: state.page});
        renderList(); updatePager(); return;
      }
      if (btn && btn.id==='btn-next' || btn && btn.id==='btn-next-b'){
        const pages = Math.max(1, Math.ceil(state.items.length / PAGE_SIZE));
        state.page = Math.min(pages, state.page+1);
        setParams({page: state.page});
        renderList(); updatePager(); return;
      }

      // Learn/Learned 動作
      const act = btn && btn.dataset.action;
      if (act === 'to-learning'){
        const id = btn.dataset.id;
        const item = state.items.find(x=>String(x.id)===String(id));
        if (item){
          addToLearning(item);
          // Learned からは外す
          writeLS(KEY_LEARNED, readLS(KEY_LEARNED).filter(x=>String(x.id)!==String(id)));
          if (window._ntxRenderLearning) window._ntxRenderLearning();
        }
        return;
      }
      if (act === 'to-learned'){
        const id = btn.dataset.id;
        const item = state.items.find(x=>String(x.id)===String(id));
        if (item){
          addToLearned(item);
          removeFromLearning(id);
        }
        return;
      }
    });

    // トグル変更
    ['chk-ja','chk-kana','chk-ro','chk-en'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', ()=> renderList());
    });

    // セレクト変更
    const selLevel = document.getElementById('sel-level');
    const selPart  = document.getElementById('sel-part');
    selLevel.addEventListener('change', ()=>{
      state.level = selLevel.value; state.page=1;
      setParams({level: state.level, page:1, part: state.part});
      loadData();
    });
    selPart.addEventListener('change', ()=>{
      state.part  = selPart.value; state.page=1;
      setParams({level: state.level, page:1, part: state.part});
      loadData();
    });

    // 初期化
    (function init(){
      const {level, part, page} = getParams();
      state.level = level; state.part = part; state.page = page;
      document.getElementById('sel-level').value = level;
      document.getElementById('sel-part').value  = part;
      loadData();
    })();

    // Learning ドロワー側の更新に追随
    window.addEventListener('storage', (ev)=>{
      if ([KEY_LEARNING, KEY_LEARNED].includes(ev.key)) {
        if (window._ntxRenderLearning) window._ntxRenderLearning();
      }
    });
  })();
  </script>
</body>
</html>
