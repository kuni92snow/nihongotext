<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>nihongotext.com　==beta version==</title>

<link rel="icon" href="/favicon.ico" />
<link rel="icon" type="image/png" href="/icon-512.png" sizes="512x512">
<link rel="apple-touch-icon" href="/icon-512.png" sizes="512x512">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#b22222">

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-9QSHWJE0HZ', { send_page_view:false });
</script>

<style>
:root{ --shu:#e6462d; --shu-tint:#fff2ef; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; --card:#fff7f6; }
*{box-sizing:border-box}
html,body{ margin:0;background:#fff;color:var(--ink);
  font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif }
a{color:inherit;text-decoration:none} button{cursor:pointer}

/* Header */
.topbar{border-top:4px solid var(--shu);border-bottom:1px solid var(--shu-tint);background:#fff}
.wrap{max-width:1100px;margin:0 auto;padding:0 16px}

/* ヘッダーを縦方向レイアウト＆センター揃え */
.brandbar{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:14px 0;
  text-align:center;
}
.brand{font-weight:900;font-size:40px;color:var(--shu);}
.small-dot{color:var(--ink)}
.beta{color:var(--muted);font-size:12px;margin-top:4px}

/* Learning / Learned ボタン用 */
.learning-buttons{
  margin-top:8px;
  display:flex;
  gap:8px;
  justify-content:center;
}

.btn{border:1px solid var(--shu);color:var(--shu);background:#fff;border-radius:10px;padding:8px 12px;font-weight:700}

/* Controls */
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:18px 0}
select,input[type="text"]{height:40px;border:1px solid var(--line);border-radius:10px;padding:0 12px;background:#fff}
.grow{flex:1}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid var(--line);background:#f8fafc;border-radius:999px;padding:8px 12px;font-weight:700}
.chip.active{border-color:var(--shu);background:#fde3df}
.toggle-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.toggle-row label{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);padding:6px 10px;border-radius:10px;background:#fff}

/* Cards */
.grid{display:grid;grid-template-columns:1fr;gap:12px}
.card{background:var(--card);border:1px solid #f1cbc6;border-radius:14px;overflow:hidden}
.card.learned{background:#eefbf1;border-color:#cceedd}
.card.learning{background:#f0fff4;border-color:#34d399}

.head{display:flex;gap:10px;align-items:center;padding:10px 12px;background:#fff;border-bottom:1px dashed #f0d7d4}
.num{font-weight:800;color:var(--shu)}
.tags{display:flex;gap:6px;flex-wrap:wrap}
.tag{font-size:13px;background:#fff;border:1px solid #f0d7d4;border-radius:8px;padding:3px 8px}
.content{padding:12px 14px}
.line{margin:6px 0}
.ja{font-weight:800}

/* ▼/▲ トグルボタン */
.toggle-btn{border:none;background:none;color:var(--shu);cursor:pointer;width:22px;height:22px;font-size:16px;line-height:1;display:inline-flex;align-items:center;justify-content:center}

/* Pager */
.pager{display:flex;gap:8px;align-items:center;justify-content:center;margin:16px 0 10px}
.pagebtn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px}
.pagebtn.active{border-color:var(--shu);color:var(--shu);font-weight:800}

/* Footer */
.footer{border-top:1px solid var(--shu-tint);background:#fff}
.footer-inner{padding:16px 0;display:flex;gap:10px;align-items:center;justify-content:center;color:#98a1a8;font-size:12px}

/* Popup base */
.mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:90}
.mask.show{display:flex}
.win{
  background:#fff;
  border-radius:12px;
  max-width:820px;
  width:min(96vw,820px);
  padding:12px;
  border:2px solid var(--shu);
  max-height:80vh;      /* 追加：画面の80%までに制限 */
  overflow-y:auto;      /* 追加：縦スクロールを有効化 */
}
.win .x{float:right;border:1px solid var(--shu);color:var(--shu);background:#fff;border-radius:8px;padding:4px 9px}

/* Learning 行の例文用 */
.exwrap{margin:6px 0 0 18px;border-left:3px solid #f3c6bd;padding-left:10px}
.exhdr{display:inline-flex;gap:6px;align-items:center;font-size:13px;color:#555;cursor:pointer}
</style>
</head>
<body>

<!-- Header（index.html 専用） -->
<div class="topbar">
  <div id="site-header" class="wrap brandbar">
    <a href="/" class="brand">nihongotext<span class="small-dot">.com</span></a>
    <span class="beta">== beta version ==</span>

    <div class="learning-buttons">
      <button id="learningBtn" class="btn" type="button">Learning</button>
      <button id="learnedBtn" class="btn" type="button">Learned</button>
    </div>

    <!-- 下部ナビ -->
    <nav style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;justify-content:center;margin-top:8px;">
      <a href="/blog/index.html" style="color:#333;text-decoration:none;">Blog</a>
      <a href="/inquiry/index.html" style="color:#333;text-decoration:none;">Inquiry</a>
      <a href="/legal.html" style="color:#333;text-decoration:none;">Legal</a>
      <a href="/privacy.html" style="color:#333;text-decoration:none;">Privacy</a>
    </nav>

    <!-- SNS アイコン -->
    <nav style="display:flex;align-items:center;gap:14px;font-size:20px;justify-content:center;margin-top:4px;">
      <a href="https://x.com/nihongotext" target="_blank" style="color:#e6462d;">
        <i class="fa-brands fa-x-twitter"></i>
      </a>
      <a href="https://www.reddit.com/user/nihongotext" target="_blank" style="color:#e6462d;">
        <i class="fa-brands fa-reddit-alien"></i>
      </a>
      <a href="https://medium.com/@nihongotext" target="_blank" style="color:#e6462d;">
        <i class="fa-brands fa-medium"></i>
      </a>
      <a href="https://ko-fi.com/nihongotext" target="_blank" style="color:#e6462d;">
        <i class="fa-solid fa-mug-hot"></i>
      </a>
      <a href="https://nihongotext.substack.com/" target="_blank" style="color:#e6462d;">
        <i class="fa-solid fa-newspaper"></i>
      </a>
    </nav>
  </div>
</div>

<main class="wrap">
  <div class="controls">
    <label>Level
      <select id="levelSel">
        <option>N5</option><option>N4</option><option>N3</option><option>N2</option><option>N1</option>
      </select>
    </label>

    <div class="chips" id="posChips" role="tablist" aria-label="Parts of Speech"></div>

    <input id="kw" class="grow" type="text" placeholder="Search across all levels & parts…" />

    <!-- 表示トグル -->
    <div class="toggle-row" id="viewToggles" aria-label="View toggles">
      <label><input type="checkbox" id="toggleJA" checked> Nihongo（漢字＋ふりがな）</label>
      <label><input type="checkbox" id="toggleKANA" checked> Hiragana</label>
      <label><input type="checkbox" id="toggleRO" checked> Alphabet（romaji）</label>
      <label><input type="checkbox" id="toggleEN" checked> English</label>
    </div>
  </div>

  <div id="meta" style="color:var(--muted);font-size:13px;margin:4px 0 10px"></div>
  <div id="list" class="grid" aria-live="polite"></div>
  <div id="pager" class="pager"></div>
</main>

<!-- Footer -->
<div class="footer">
  <div id="site-footer" class="wrap footer-inner">© 2025 nihongotext.com</div>
</div>

<!-- Learned モーダル -->
<div id="learnedModal" class="mask">
  <div class="win">
    <button class="x" id="closeLearned" aria-label="Close">×</button>
    <h3 id="learnedTitle" style="margin:0 0 10px">Learned</h3>
    <div class="toggle-row" style="margin-bottom:8px">
      <label><input type="checkbox" id="L_JA" checked> Nihongo</label>
      <label><input type="checkbox" id="L_KANA" checked> Hiragana</label>
      <label><input type="checkbox" id="L_RO" checked> Alphabet</label>
      <label><input type="checkbox" id="L_EN" checked> English</label>
    </div>
    <div id="learnedBody" style="border-top:1px dashed #ddd;margin-top:8px"></div>
    <div id="learnedPager" class="pager"></div>
    <div class="tools" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="printLearned" class="btn" style="background:var(--shu);color:#fff;border-color:var(--shu)">Print</button>
    </div>
  </div>
</div>

<!-- Learning モーダル -->
<div id="learningModal" class="mask">
  <div class="win">
    <button class="x" id="closeLearning" aria-label="Close">×</button>
    <h3 style="margin:0 0 10px">Learning</h3>
    <div class="toggle-row" style="margin-bottom:8px">
      <label><input type="checkbox" id="LG_JA" checked> Nihongo</label>
      <label><input type="checkbox" id="LG_KANA" checked> Hiragana</label>
      <label><input type="checkbox" id="LG_RO" checked> Alphabet</label>
      <label><input type="checkbox" id="LG_EN" checked> English</label>
    </div>
    <div class="tools" style="display:flex;gap:8px;justify-content:flex-end;margin:10px 0">
      <button id="toLearnedViewTop" class="btn">Open Learned</button>
      <button id="printLearningTop" class="btn" style="background:var(--shu);color:#fff;border-color:var(--shu)">Print</button>
    </div>
    <div id="learningBody" style="border-top:1px dashed #ddd;margin-top:8px"></div>
    <div id="learningPager" class="pager"></div>
    <div class="tools" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="toLearnedView" class="btn">Open Learned</button>
      <button id="printLearning" class="btn" style="background:var(--shu);color:#fff;border-color:var(--shu)">Print</button>
    </div>
  </div>
</div>

<!-- 広告ポップアップ（英語表記） -->
<div id="adModal" class="mask" aria-hidden="true">
  <div class="win" style="max-width:560px">
    <button class="x" id="adClose" aria-label="Close">×</button>
    <h3 style="margin:6px 0 8px">Sponsored</h3>
    <p style="margin:0 0 10px">Take 1-on-1 online Japanese lessons. Check it out!</p>
    <p style="margin:0">
      <a id="adLink" href="https://preply.com/ja/?pref=MTE2MDM4MjQ=&id=1762934766.097797&ep=w1" target="_blank" rel="noopener"
         class="btn" style="display:inline-block;background:var(--shu);border-color:var(--shu);color:#fff">Explore Preply</a>
    </p>
  </div>
</div>

<script>
/* ===== Learning / Learned 用ストレージのバージョン管理 ===== */
(function () {
  try {
    const STORAGE_VERSION = '2025-11-14-1'; // 変更したらここだけ更新

    const current = localStorage.getItem('ntx_storage_version');
    if (current !== STORAGE_VERSION) {
      // 旧バージョンのデータを掃除してから、新バージョンを書き込む
      Object.keys(localStorage).forEach((k) => {
        if (
          k.startsWith('nt_learned_') ||
          k.startsWith('ntx_learning_v') ||
          k === 'ntx_learned_items_v1' ||
          k === 'ntx_learned_dates_v1'
        ) {
          localStorage.removeItem(k);
        }
      });
      localStorage.setItem('ntx_storage_version', STORAGE_VERSION);
    }
  } catch (e) {
    // localStorage が使えない場合は何もしない
    console.warn('storage version check failed', e);
  }
})();

/* ========= 設定 ========= */
const LEVELS = ['N5','N4','N3','N2','N1'];
const POS = [
  {k:'nouns', file:'nouns.json',          ja:'名詞',        enLabel:'Nouns'},
  {k:'verbs', file:'verbs.json',          ja:'動詞',        enLabel:'Verbs'},
  {k:'iadj',  file:'adjectives-i.json',   ja:'い形容詞',    enLabel:'i-Adjectives'},
  {k:'naadj', file:'adjectives-na.json',  ja:'な形容詞',    enLabel:'na-Adjectives'},
  {k:'advs',  file:'adverbs.json',        ja:'副詞',        enLabel:'Adverbs'},
  {k:'prt',   file:'particles.json',      ja:'助詞',        enLabel:'Particles'},
  {k:'conj',  file:'conjunctions.json',   ja:'接続詞',      enLabel:'Conjunctions'},
  {k:'interj',file:'interjections.json',  ja:'感動詞',      enLabel:'Interjections'},
  {k:'nums',  file:'numerals.json',       ja:'数詞',        enLabel:'Numerals'},
  {k:'pat',   file:'patterns.json',       ja:'文型',        enLabel:'Patterns'},
];

let level='N5', posKey='verbs', page=1;
const PAGE_SIZE=5, MAX_TOTAL=30;
let lastData=[];

const getLang = () => localStorage.getItem('lang') || 'en';
const setLang = (v) => localStorage.setItem('lang', v);
let uiLang = getLang();

/* ====== Learned の保存（詳細保持） ====== */
const LS_KEY = ()=>`nt_learned_${level}_${posKey}`;            // id セット（互換）
const LEARNED_STORE = 'ntx_learned_items_v1';                   // 明細本体
const LEARNED_DATE_KEY = 'ntx_learned_dates_v1';                // 日付

const learnedSet   = () => new Set(JSON.parse(localStorage.getItem(LS_KEY())||'[]'));
const setLearned   = (set)=>localStorage.setItem(LS_KEY(),JSON.stringify([...set]));
const getLearnedMap= ()=>{ try{return JSON.parse(localStorage.getItem(LEARNED_STORE)||'{}')}catch(_){return{}} };
const setLearnedMap= (m)=> localStorage.setItem(LEARNED_STORE, JSON.stringify(m));
const getLearnedDates = ()=>{ try{return JSON.parse(localStorage.getItem(LEARNED_DATE_KEY)||'{}')}catch(_){return {}} };
const setLearnedDate  = (id,d)=>{ const m=getLearnedDates(); m[id]=d; localStorage.setItem(LEARNED_DATE_KEY,JSON.stringify(m)); };
const getLearnedDateStr = (id)=> getLearnedDates()[id]||'';

/* ====== Learning 保存 ====== */
const LEARN_KEY = 'ntx_learning_v3';
const getLearning = ()=>{ try{return JSON.parse(localStorage.getItem(LEARN_KEY)||'[]')}catch(_){return[]} };
const setLearning = (arr)=>{ try{localStorage.setItem(LEARN_KEY,JSON.stringify(arr));}catch(_){ } };

/* ====== ヘッダーのバッジ更新 ====== */
function updateBadges(){
  const bLrn  = document.querySelector('#badge-learning');
  const bLrnd = document.querySelector('#badge-learned');
  if (bLrn)  bLrn.textContent  = String(getLearning().length);
  if (bLrnd) bLrnd.textContent = String(learnedSet().size);
}

/* ====== パス・読込 ====== */
function buildPath(lvl=level, pk=posKey){ return `data/json/${lvl}/${POS.find(p=>p.k===pk).file}`; }
function coerceArray(json){
  if (Array.isArray(json)) return json;
  const keys=['items','data','entries','list','rows','result','results'];
  for(const k of keys){ if(json && Array.isArray(json[k])) return json[k]; }
  if(json && typeof json==='object'){
    const vals=Object.values(json);
    if(vals.length && vals.every(v=>typeof v==='object')) return vals;
  }
  return [];
}
async function fetchJsonSafe(path){
  try{
    const r=await fetch(path,{cache:'no-store'});
    if(!r.ok) return [];
    return coerceArray(await r.json());
  }catch(_){ return []; }
}

/* ====== 画面初期化（部分） ====== */
function applyLangToUI(){
  const kw=document.getElementById('kw');
  if(kw){ kw.placeholder = (uiLang==='en') ? 'Search across all levels & parts…' : 'レベル・品詞を横断して検索…'; }
  const lt=document.getElementById('learnedTitle');
  if(lt){ lt.textContent = 'Learned'; }
}

/* index.html ではヘッダーに言語トグルを置かないので attachLangToggle は実質何もしない */
function attachLangToggle(){
  const btn = document.getElementById('langBtn');
  if(!btn) return;
  btn.addEventListener('click',(e)=>{
    e.preventDefault();
    uiLang = (uiLang==='en') ? 'ja' : 'en';
    setLang(uiLang);
    applyLangToUI(); buildChips(); renderList(lastData);
  });
}

/* index.html ではヘッダーは部分テンプレートを使わず、フッターだけ読み込む */
async function injectPartials(){
  const ftr=document.getElementById('site-footer');
  try{
    const f=await fetch('partials/footer.html',{cache:'no-store'}).then(r=>r.ok?r.text():Promise.reject());
    ftr.innerHTML=f;
  }catch(_){
    ftr.innerHTML = `<div style="padding:16px 0;display:flex;gap:10px;align-items:center;justify-content:center;color:#98a1a8;font-size:12px">© 2025 nihongotext.com</div>`;
  }
}

/* ====== UI構築（品詞チップ） ====== */
function buildChips(){
  const chips=document.getElementById('posChips');
  if(!chips) return;
  chips.innerHTML='';
  POS.forEach(p=>{
    const b=document.createElement('button');
    b.className='chip'+(p.k===posKey?' active':'');
    b.textContent=p.enLabel;
    b.onclick=()=>{posKey=p.k;page=1; if(!kw.value.trim()) loadSingleAndRender(); else onSearchInput(); buildChips(); updateBadges();};
    chips.appendChild(b);
  });
}

/* ====== データロードと描画 ====== */
const SAMPLE=[{"id":"demo-001","ja":"会う","kana":"あう","ro":"au","en":"meet","examples":[{"ja":"毎週友達に会います。","kana":"まいしゅう ともだち に あいます。","ro":"maishuu tomodachi ni aimasu.","en":"I meet my friends every week."}]}];
async function loadSingleAndRender(){
  const label = POS.find(p=>p.k===posKey)?.enLabel || posKey;
  const meta=document.getElementById('meta');
  if(meta) meta.textContent=`Level: ${level} • Part: ${label}`;
  let arr=await fetchJsonSafe(buildPath());
  lastData = arr.length ? arr.slice(0,MAX_TOTAL) : SAMPLE;
  renderList(lastData);
  updateBadges();
  try{ gtag('event','page_view',{page_title:`${level}/${posKey}`}); }catch(_){}
}

/* ====== 横断検索 ====== */
const kw=document.getElementById('kw');
let searchAbort=0;
if(kw){ kw.addEventListener('input', onSearchInput, {passive:true}); }
async function onSearchInput(){
  const t=(kw?.value||'').trim().toLowerCase();
  if(!t){ page=1; loadSingleAndRender(); return; }
  const myId=++searchAbort;
  const meta=document.getElementById('meta');
  if(meta) meta.textContent = 'Searching across all levels and parts…';

  const tasks=[];
  for(const lv of LEVELS){ for(const p of POS){
    tasks.push(fetchJsonSafe(`data/json/${lv}/${p.file}`).then(arr=>arr.map(x=>({...x,_level:lv,_pos:p.enLabel,_posJa:p.ja}))));
  }}
  const chunks=await Promise.all(tasks);
  if(myId!==searchAbort) return;

  const joined=chunks.flat();
  const filtered=joined.filter(x=>{
    const hay=[x.en||'',x.ja||'',x.kana||'',x.ro||'',x._level||'',x._pos||'',x._posJa||'',...(x.examples||[]).flatMap(e=>[e.en||'',e.ja||'',e.kana||'',e.ro||''])].join(' ').toLowerCase();
    return hay.includes(t);
  });

  lastData=filtered.slice(0,MAX_TOTAL);
  page=1;
  if(meta) meta.textContent = `Results: ${lastData.length} item(s) (showing up to ${MAX_TOTAL}).`;
  renderList(lastData);
  updateBadges();
}

/* ====== ページング＆描画（一覧） ====== */
const list=document.getElementById('list');
const pager=document.getElementById('pager');

['toggleEN','toggleJA','toggleKANA','toggleRO'].forEach(id=>{
  const el=document.getElementById(id);
  if(el){ el.addEventListener('change', ()=>renderList(lastData)); }
});

document.getElementById('levelSel').addEventListener('change', e=>{
  level=e.target.value; page=1; if(!kw?.value.trim()) loadSingleAndRender(); else onSearchInput();
});

// showAdThen を通してページ遷移する版
function pageBtn(t,fn){const b=document.createElement('button');b.className='pagebtn';b.textContent=t;b.onclick=()=>showAdThen(fn);return b;}
function paginate(data){
  const total=Math.max(1,Math.ceil(data.length/PAGE_SIZE));
  if(page>total)page=total;
  const start=(page-1)*PAGE_SIZE;
  const rows=data.slice(start,start+PAGE_SIZE);
  pager.innerHTML='';
  const prev=pageBtn('Prev',()=>{page--;renderList(lastData,true);}); prev.disabled=page<=1; pager.appendChild(prev);
  for(let i=1;i<=total;i++){
    const b=pageBtn(String(i),()=>{page=i;renderList(lastData,true);});
    if(i===page) b.classList.add('active');
    pager.appendChild(b);
  }
  const next=pageBtn('Next',()=>{page++;renderList(lastData,true);}); next.disabled=page>=total; pager.appendChild(next);
  return rows;
}
function div(cls,txt){const d=document.createElement('div');d.className=cls;if(txt!=null)d.textContent=txt;return d;}

function renderList(data){
  if(!list) return;
  list.innerHTML='';
  const base=Array.isArray(data)?data:[];
  const rows=paginate(base);
  if(!rows.length){
    pager.innerHTML='';
    list.innerHTML=`<div style="color:#6b7280; padding:12px 0;">No items to show.</div>`;
    return;
  }

  const showEN   = document.getElementById('toggleEN')?.checked !== false;
  const showJA   = document.getElementById('toggleJA')?.checked !== false;
  const showKANA = document.getElementById('toggleKANA')?.checked !== false;
  const showRO   = document.getElementById('toggleRO')?.checked !== false;

  // ★ ここで Learned / Learning の状態をまとめて取得
  const learnedIdsSet = learnedSet();
  const learningIdSet = new Set(getLearning().map(x => x.id));

  let idx=(page-1)*PAGE_SIZE;
  rows.forEach(item=>{
    idx++;
    const card=document.createElement('article'); card.className='card';

    const head=document.createElement('div'); head.className='head';
    const tog=document.createElement('button'); tog.className='toggle-btn'; tog.setAttribute('aria-expanded','true'); tog.textContent='▲';
    const num=div('num',idx+'.');
    const tags=div('tags','');

    const tagMap={ja:item.ja, kana:item.kana, ro:item.ro, en:item.en};
    ['ja','kana','ro','en'].forEach(k=>{
      const v=tagMap[k]; if(v && String(v).trim()){
        const s=document.createElement('span'); s.className='tag '+k; s.textContent=v; tags.appendChild(s);
      }
    });

    const act=document.createElement('button'); act.className='btn learn';
    act.style.marginLeft='auto'; /* 右寄せ */
    head.append(tog,num,tags,act);

    const body=div('content',''); body.dataset.examples='1';
    (item.examples||[]).forEach(ex=>{
      const parts=[];
      if(showEN   && ex.en   ) parts.push(`<div class="en">${ex.en}</div>`);
      if(showJA   && ex.ja   ) parts.push(`<div class="ja">${ex.ja}</div>`);
      if(showKANA && ex.kana ) parts.push(`<div class="kana">${ex.kana}</div>`);
      if(showRO   && ex.ro   ) parts.push(`<div class="ro">${ex.ro}</div>`);
      if(parts.length){ const block=div('line',''); block.innerHTML=parts.join(''); body.appendChild(block); }
    });

    // Learned 状態
    const isLearned = learnedIdsSet.has(item.id);
    if (isLearned){
      card.classList.add('learned');
      body.style.display='none';
      tog.textContent='▼';
      tog.setAttribute('aria-expanded','false');
    }

    // デフォルトは Learn
    act.textContent = 'Learn';

    // Learning 状態ならボタン表示と色も復元
    if (!isLearned && learningIdSet.has(item.id)){
      card.classList.add('learning');
      act.textContent = 'Learning';
      body.style.display='none';
      tog.textContent='▼';
      tog.setAttribute('aria-expanded','false');
    }

    act.onclick = () => {
      const posLabel = POS.find(p=>p.k===posKey)?.enLabel || posKey;
      const payload = {
        id:item.id,
        ja:item.ja,
        en:item.en,
        kana:item.kana,
        ro:item.ro,
        level,
        part:posLabel,
        examples:item.examples||[],
        quiz:{taken:0,correct:0}
      };
      ntxToLearning(payload);
      card.classList.add('learning');
      act.textContent = 'Learning';
      body.style.display='none'; tog.textContent='▼'; tog.setAttribute('aria-expanded','false');
      updateBadges();
    };

    tog.addEventListener('click',()=>{
      const open = body.style.display!=='none';
      if(open){ body.style.display='none'; tog.textContent='▼'; tog.setAttribute('aria-expanded','false'); }
      else    { body.style.display='';    tog.textContent='▲'; tog.setAttribute('aria-expanded','true'); }
    });

    card.append(head,body); list.appendChild(card);
  });

  const posLabel=POS.find(p=>p.k===posKey);
  const meta=document.getElementById('meta');
  if(meta) meta.textContent = `Level: ${level} • Part: ${posLabel.enLabel}`;
}

/* ====== Learned モーダル：描画 ====== */
let learnedPage = 1;

function openLearned(){ const m=document.getElementById('learnedModal'); m.classList.add('show'); learnedPage=1; renderLearnedModal(); }
document.getElementById('closeLearned').onclick=()=>document.getElementById('learnedModal').classList.remove('show');
document.getElementById('learnedModal').addEventListener('click',e=>{ if(e.target.id==='learnedModal') e.currentTarget.classList.remove('show'); });
['L_JA','L_KANA','L_RO','L_EN'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('change',()=>renderLearnedModal()); });

function getLearnedRows(){
  const ids = [...learnedSet()];
  const map = getLearnedMap();
  const dates = getLearnedDates();
  return ids.map(id=>{
    const m = map[id] || (lastData||[]).find(x=>x.id===id) || {id};
    return {...m, movedAt: dates[id] || m.movedAt || ''};
  });
}

function renderLearnedModal(){
  const body=document.getElementById('learnedBody');
  const pager=document.getElementById('learnedPager');
  const rowsAll = getLearnedRows();
  body.innerHTML=''; pager.innerHTML='';

  if(!rowsAll.length){ body.innerHTML='<div style="color:#6b7280;padding-top:6px">No items yet.</div>'; return; }

  const total = Math.max(1, Math.ceil(rowsAll.length/5));
  if(learnedPage>total) learnedPage=total;
  const start=(learnedPage-1)*5;
  const rows = rowsAll.slice(start, start+5);

  const showEN=document.getElementById('L_EN')?.checked!==false;
  const showJA=document.getElementById('L_JA')?.checked!==false;
  const showKA=document.getElementById('L_KANA')?.checked!==false;
  const showRO=document.getElementById('L_RO')?.checked!==false;

  rows.forEach((x,i)=>{
    const block=document.createElement('div');
    block.style.cssText='padding:8px 0;border-bottom:1px dashed #eee';

    const line=document.createElement('div');
    line.style.display='flex'; line.style.alignItems='center'; line.style.gap='10px'; line.style.flexWrap='wrap';

    const parts=[];
    if(showJA&&x.ja)parts.push(x.ja);
    if(showKA&&x.kana)parts.push(x.kana);
    if(showRO&&x.ro)parts.push(x.ro);
    if(showEN&&x.en)parts.push(x.en);

    const dateStr = x.movedAt ? ` <span style="color:#888">(${x.movedAt})</span>` : '';
    line.innerHTML = `${start+i+1}. <strong>${parts.join(' / ')}</strong>${dateStr}`;

    const backBtn=document.createElement('button');
    backBtn.className='btn';
    backBtn.textContent='Back to Learning';
    backBtn.style.marginLeft='auto';
    backBtn.addEventListener('click', ()=> moveBackToLearning(x));

    line.appendChild(backBtn);
    block.appendChild(line);
    body.appendChild(block);
  });

  const mk=(t,fn,active)=>{ const b=document.createElement('button'); b.className='pagebtn'; if(active) b.classList.add('active'); b.textContent=t; b.onclick=()=>showAdThen(fn); return b; };
  const prev = mk('Prev', ()=>{ learnedPage=Math.max(1, learnedPage-1); renderLearnedModal(); }, learnedPage===1); prev.disabled=learnedPage===1; pager.appendChild(prev);
  for(let i=1;i<=total;i++){ pager.appendChild(mk(String(i), ()=>{ learnedPage=i; renderLearnedModal(); }, i===learnedPage)); }
  const next = mk('Next', ()=>{ learnedPage=Math.min(total, learnedPage+1); renderLearnedModal(); }, learnedPage===total); next.disabled=learnedPage===total; pager.appendChild(next);
}

function moveBackToLearning(item){
  const set = learnedSet(); set.delete(item.id); setLearned(set);
  const map = getLearnedMap(); delete map[item.id]; setLearnedMap(map);

  const arr = getLearning();
  if(!arr.find(x=>x.id===item.id)){
    const d=new Date(); const z=n=>String(n).padStart(2,'0');
    const today=`${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
    arr.push({...item, movedAt: today});
  }
  setLearning(arr);

  renderLearnedModal();
  updateBadges();
}

/* ====== Learning モーダル：例文・ページング ====== */
let learningPage = 1;

function openLearning(){ const m=document.getElementById('learningModal'); if(!m) return; m.classList.add('show'); learningPage=1; renderLearningModal(learningPage); }
document.getElementById('closeLearning').onclick=()=>document.getElementById('learningModal')?.classList.remove('show');
document.getElementById('learningModal').addEventListener('click',e=>{ if(e.target.id==='learningModal') e.currentTarget.classList.remove('show'); });

document.getElementById('toLearnedViewTop')?.addEventListener('click', ()=>{ document.getElementById('learningModal')?.classList.remove('show'); openLearned(); });
document.getElementById('toLearnedView')?.addEventListener('click',   ()=>{ document.getElementById('learningModal')?.classList.remove('show'); openLearned(); });

['LG_JA','LG_KANA','LG_RO','LG_EN'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.addEventListener('change', ()=>renderLearningModal(learningPage));
});

function renderLearningModal(page=1){
  const wrap = document.getElementById('learningBody');
  const pag = document.getElementById('learningPager');
  if(!wrap){ return; }
  const showEN = document.getElementById('LG_EN')?.checked !== false;
  const showJA = document.getElementById('LG_JA')?.checked !== false;
  const showKA = document.getElementById('LG_KANA')?.checked !== false;
  const showRO = document.getElementById('LG_RO')?.checked !== false;

  const all = getLearning();
  wrap.innerHTML = ''; pag.innerHTML='';

  if(!all.length){ wrap.innerHTML = '<div style="color:#6b7280;padding-top:6px">No items yet.</div>'; return; }

  const total = Math.max(1, Math.ceil(all.length/5));
  learningPage = Math.min(Math.max(1,page), total);
  const start = (learningPage-1)*5;
  const rows = all.slice(start, start+5);

  rows.forEach((x,i)=>{
    const block = document.createElement('div');
    block.style.cssText='padding:8px 0;border-bottom:1px dashed #eee';
    const line = document.createElement('div');
    line.style.display='flex'; line.style.alignItems='center'; line.style.gap='10px'; line.style.flexWrap='wrap';

    const tags=[];
    if(showJA&&x.ja)tags.push(x.ja);
    if(showKA&&x.kana)tags.push(x.kana);
    if(showRO&&x.ro)tags.push(x.ro);
    if(showEN&&x.en)tags.push(x.en);
    const d = x.movedAt ? ` <span style="color:#888">(${x.movedAt})</span>` : '';
    line.innerHTML = `${start+i+1}. <strong>${tags.join(' / ')}</strong>${d}`;

    const exBtn = document.createElement('button');
    exBtn.className='toggle-btn'; exBtn.textContent='▼'; exBtn.setAttribute('aria-expanded','false');
    line.prepend(exBtn);

    const toLearnedBtn = document.createElement('button');
    toLearnedBtn.className='btn'; toLearnedBtn.textContent = 'Move to Learned';
    toLearnedBtn.style.marginLeft='auto';
    toLearnedBtn.addEventListener('click', ()=>{
      const s = learnedSet();
      if (!s.has(x.id)) {
        s.add(x.id);
        setLearned(s);
        const d = new Date(); const z = n => String(n).padStart(2,'0');
        const today = `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
        setLearnedDate(x.id, today);
        const m = getLearnedMap(); m[x.id] = x; setLearnedMap(m);
      }
      const rest = getLearning().filter(y=>y.id!==x.id);
      setLearning(rest);
      renderLearningModal(learningPage);
      updateBadges();
    });
    line.appendChild(toLearnedBtn);

    const exWrap = document.createElement('div');
    exWrap.className='exwrap'; exWrap.style.display='none';
    const examples = x.examples || [];
    if(examples.length){
      examples.forEach((ex,ei)=>{
        const one = document.createElement('div'); one.style.margin='6px 0';
        const bits=[];
        if(showEN&&ex.en)bits.push(`<div class="en">${ex.en}</div>`);
        if(showJA&&ex.ja)bits.push(`<div class="ja">${ex.ja}</div>`);
        if(showKA&&ex.kana)bits.push(`<div class="kana">${ex.kana}</div>`);
        if(showRO&&ex.ro)bits.push(`<div class="ro">${ex.ro}</div>`);
        one.innerHTML = `<div class="exhdr">Example ${ei+1}</div>` + bits.join('');
        exWrap.appendChild(one);
      });
    }else{
      exWrap.innerHTML = '<div class="exhdr">No examples</div>';
    }

    exBtn.addEventListener('click', ()=>{
      const open = exWrap.style.display !== 'none';
      exWrap.style.display = open ? 'none' : '';
      exBtn.textContent = open ? '▼' : '▲';
      exBtn.setAttribute('aria-expanded', String(!open));
    });

    block.append(line, exWrap);
    wrap.appendChild(block);
  });

  const mk = (t,fn,active)=>{ const b=document.createElement('button'); b.className='pagebtn'; if(active) b.classList.add('active'); b.textContent=t; b.onclick=()=>{ showAdThen(()=>fn()); }; return b; };
  const prev = mk('Prev', ()=>renderLearningModal(learningPage-1), learningPage===1); prev.disabled = learningPage<=1; pag.appendChild(prev);
  for(let i=1;i<=total;i++){ pag.appendChild(mk(String(i), ()=>renderLearningModal(i), i===learningPage)); }
  const next = mk('Next', ()=>renderLearningModal(learningPage+1), learningPage===total); next.disabled = learningPage>=total; pag.appendChild(next);
}

/* ====== 広告（英語） ====== */
function showAdThen(next){
  const mask = document.getElementById('adModal');
  const close = document.getElementById('adClose');
  const link  = document.getElementById('adLink');
  const finish = ()=>{ mask.classList.remove('show'); next(); };
  mask.classList.add('show');
  close.onclick = finish;
  mask.addEventListener('click', e=>{ if(e.target.id==='adModal') finish(); }, {once:true});
  link.addEventListener('click', ()=>finish(), {once:true});
}

/* ====== Learning へ追加 ====== */
window.ntxToLearning = function(item){
  const arr = getLearning();
  if (!arr.find(x => x.id === item.id)) {
    const d = new Date(); const z = n => String(n).padStart(2,'0');
    const today = `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
    arr.push({ ...item, movedAt: item.movedAt || today });
  }
  setLearning(arr);
  renderLearningModal(learningPage);
  updateBadges();
};

/* ====== Print（Learning / Learned） ====== */
document.getElementById('printLearningTop')?.addEventListener('click', printLearning);
document.getElementById('printLearning')?.addEventListener('click', printLearning);

function printLearning(){
  const arr = getLearning();
  if (!arr.length){
    alert('No learning items.');
    return;
  }
  const w = open('', '_blank');
  w.document.write(
    '<!doctype html><html><head><meta charset="utf-8">' +
    '<title>Learning</title>' +
    '<style>' +
    'body{font:14px system-ui;padding:20px}' +
    'h1{margin-top:0}' +
    '.row{border-bottom:1px dashed #ccc;padding:6px 0}' +
    '.word-line{font-weight:600}' +
    '.examples{margin:4px 0 0 1.5em;font-size:13px;color:#333}' +
    '.examples-title{font-weight:600;margin-bottom:2px}' +
    '.ex-item{margin-bottom:4px}' +
    '</style></head><body><h1>Learning</h1>'
  );

  arr.forEach((x,i)=>{
    const head =
      (i+1) + '. <strong>' + (x.ja||'') + '</strong> / ' +
      (x.kana||'') + ' / ' + (x.ro||'') + ' — ' + (x.en||'') +
      (x.movedAt ? ' (' + x.movedAt + ')' : '');
    w.document.write('<div class="row">');
    w.document.write('<div class="word-line">' + head + '</div>');

    const exs = x.examples || [];
    if (exs.length){
      w.document.write('<div class="examples"><div class="examples-title">Examples:</div>');
      exs.forEach((ex,idx)=>{
        w.document.write(
          '<div class="ex-item">' +
            '[' + (idx+1) + '] ' + (ex.en || '') + '<br>' +
            (ex.ja   || '') + '<br>' +
            (ex.kana || '') + '<br>' +
            (ex.ro   || '') +
          '</div>'
        );
      });
      w.document.write('</div>');
    }

    w.document.write('</div>');
  });

  w.document.write('</body></html>');
  w.document.close();
  w.print();
}

document.getElementById('printLearned').onclick = () => {
  const rows = getLearnedRows();
  if(!rows.length){
    alert('No learned items.');
    return;
  }
  const w = open('','_blank');
  w.document.write(
    '<!doctype html><html><head><meta charset="utf-8">' +
    '<title>Learned</title>' +
    '<style>' +
    'body{font:14px system-ui;padding:20px}' +
    'h1{margin-top:0}' +
    '.row{border-bottom:1px dashed #ccc;padding:6px 0}' +
    '.word-line{font-weight:600}' +
    '.examples{margin:4px 0 0 1.5em;font-size:13px;color:#333}' +
    '.examples-title{font-weight:600;margin-bottom:2px}' +
    '.ex-item{margin-bottom:4px}' +
    '</style></head><body><h1>Learned</h1>'
  );

  rows.forEach((x,i)=>{
    const head =
      (i+1) + '. <strong>' + (x.ja||'') + '</strong> / ' +
      (x.kana||'') + ' / ' + (x.ro||'') + ' — ' + (x.en||'') +
      (x.movedAt ? ' (' + x.movedAt + ')' : '');
    w.document.write('<div class="row">');
    w.document.write('<div class="word-line">' + head + '</div>');

    const exs = x.examples || [];
    if (exs.length){
      w.document.write('<div class="examples"><div class="examples-title">Examples:</div>');
      exs.forEach((ex,idx)=>{
        w.document.write(
          '<div class="ex-item">' +
            '[' + (idx+1) + '] ' + (ex.en || '') + '<br>' +
            (ex.ja   || '') + '<br>' +
            (ex.kana || '') + '<br>' +
            (ex.ro   || '') +
          '</div>'
        );
      });
      w.document.write('</div>');
    }

    w.document.write('</div>');
  });

  w.document.write('</body></html>');
  w.document.close();
  w.print();
};

/* ====== 初期化 ====== */
(async function init(){
  await injectPartials();
  applyLangToUI();
  attachLangToggle(); // index では基本何もしない

  buildChips();
  await loadSingleAndRender();

  // Learning / Learned ボタンの動作
  document.getElementById('learningBtn')?.addEventListener('click', openLearning);
  document.getElementById('learnedBtn')?.addEventListener('click', openLearned);

  // 検索語のハイライト
  const kwEl = document.getElementById('kw');
  if(kwEl){
    kwEl.addEventListener('input', ()=>{
      const term = kwEl.value.trim();
      const listEl = document.getElementById('list');
      const targets = listEl.querySelectorAll('.head .tag, .content .en, .content .ja, .content .kana, .content .ro');
      const re = term ? new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi') : null;
      targets.forEach(el=>{
        const raw = el.textContent || '';
        el.innerHTML = !term ? raw : raw.replace(re, m=>`<mark class="search-hit">${m}</mark>`);
      });
    }, {passive:true});
  }
})();
</script>
</body>
</html>
