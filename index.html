<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JLPT — Words | nihongotext.com</title>
  <base href="/" />
  <link rel="icon" href="/favicon.ico" />
  <meta name="description" content="Browse JLPT words by level and part of speech. Add items to Learning, track progress, and study with examples.">
  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-9QSHWJE0HZ');
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root { --brand:#e6462d; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; color:#333; background:#fff; }
    .container { max-width:1100px; margin:0 auto; padding:20px 16px; }
    h1 { margin:12px 0 16px; font-size:22px; }
    /* toolbar */
    .toolbar { display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:14px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .row label { font-size:14px; display:flex; align-items:center; gap:6px; }
    select { padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#fff; }
    input[type="checkbox"] { width:16px; height:16px; }
    /* cards */
    .word-card { border:1px solid #eee; border-radius:12px; background:#fff; padding:14px; margin-bottom:12px; }
    .meta { color:#666; font-size:12px; margin-bottom:6px; }
    .line { margin:2px 0; }
    .line strong { font-weight:700; }
    ruby rt { font-size:.65em; color:#666; }
    .word-actions { margin-top:8px; display:flex; gap:8px; align-items:center; }
    .btn { border:1px solid #ddd; background:#fff; border-radius:8px; padding:4px 10px; cursor:pointer; }
    .btn:hover { background:#f8f8f8; }
    .toggle { color:var(--brand); cursor:pointer; font-size:14px; }
    .examples { display:none; padding-left:10px; margin-top:6px; }
    .examples .ex { margin:6px 0; }
    .notice { padding:10px; border:1px dashed #eee; border-radius:8px; color:#666; }
    /* pager */
    .pager { display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin:12px 0 24px; }
    .pager button { padding:6px 10px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer; }
    .pager button[disabled] { opacity:.5; cursor:not-allowed; }
    .pager .current { background:#e6462d; color:#fff; border-color:#e6462d; }
  </style>
</head>
<body>
  <!-- Header (partials) -->
  <div id="header-placeholder"></div>

  <main class="container">
    <h1>JLPT — Words</h1>

    <!-- Filters -->
    <section class="toolbar" aria-label="Filters">
      <div class="row">
        <label>Level
          <select id="level">
            <option>N5</option><option>N4</option><option>N3</option><option>N2</option><option>N1</option>
          </select>
        </label>
        <label>Part
          <select id="part">
            <option value="verbs">verbs</option>
            <option value="nouns">nouns</option>
            <option value="adjectives-i">adjectives-i</option>
            <option value="adjectives-na">adjectives-na</option>
            <option value="adverbs">adverbs</option>
            <option value="particles">particles</option>
            <option value="conjunctions">conjunctions</option>
          </select>
        </label>
      </div>
      <!-- 2-line toggles -->
      <div class="row">
        <label><input type="checkbox" id="show-ja" checked> Nihongo（漢字＋ふりがな）</label>
        <label><input type="checkbox" id="show-kana" checked> Hiragana</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="show-ro" checked> Alphabet（romaji）</label>
        <label><input type="checkbox" id="show-en" checked> English</label>
      </div>
    </section>

    <div id="word-list"></div>
    <div id="pager" class="pager" aria-label="Pagination"></div>
    <p class="notice" id="limit-note" style="display:none;">Showing up to 30 items for this part. More will be added later.</p>
  </main>

  <!-- Footer (partials) -->
  <div id="footer-placeholder"></div>

  <script>
    /* ========= Load header/footer ========= */
    Promise.all([
      fetch('/partials/header.html').then(r=>r.text()),
      fetch('/partials/footer.html').then(r=>r.text())
    ]).then(([h,f])=>{
      document.getElementById('header-placeholder').innerHTML = h;
      document.getElementById('footer-placeholder').innerHTML = f;
    });

    /* ========= Constants & helpers ========= */
    const PAGE_SIZE = 5;      // per-page
    const MAX_ITEMS_CAP = 30; // per part cap

    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // Furigana helpers
    const RE_KANJI=/[\u4E00-\u9FFF\u3400-\u4DBF]/, RE_HIRA=/[\u3040-\u309F]/, RE_KATA=/[\u30A0-\u30FF]/;
    const isKanji = ch=>RE_KANJI.test(ch), isKana = ch=>RE_HIRA.test(ch)||RE_KATA.test(ch);

    function rubyFromSegments(segs){
      return segs.map(s=>{
        const rb = esc(s.rb ?? ''), rt = esc(s.rt ?? '');
        if(!rb) return '';
        return rt ? `<ruby>${rb}<rt>${rt}</rt></ruby>` : rb;
      }).join('');
    }
    function rubyAutoAlign(ja, kana){
      if(!ja)   return '';
      if(!kana) return esc(ja);
      const kanaOnly = Array.from(kana).filter(isKana).join('');
      const blocks=[]; let cur='', tp=null;
      for(const ch of Array.from(ja)){
        const t = isKanji(ch)?'K':(isKana(ch)?'A':'O');
        if(tp===t) cur+=ch; else { if(cur) blocks.push({t:tp,s:cur}); cur=ch; tp=t; }
      }
      if(cur) blocks.push({t:tp,s:cur});
      let kp=0; const K=[...kanaOnly]; const out=[];
      blocks.forEach((b,i)=>{
        if(b.t==='K'){
          const nextA = (blocks[i+1] && blocks[i+1].t==='A') ? [...blocks[i+1].s].length : 0;
          const take = Math.max(1, K.length - kp - nextA);
          const read = K.slice(kp, kp+take).join(''); kp+=take;
          out.push(`<ruby>${esc(b.s)}<rt>${esc(read)}</rt></ruby>`);
        } else out.push(esc(b.s));
      });
      return out.join('');
    }
    // apply strict ruby from external segments if present
    function jaWithStrictRuby(item, segMap){
      const segForItem = segMap && segMap[item.id] && segMap[item.id].word;
      if(Array.isArray(segForItem) && segForItem.length) return rubyFromSegments(segForItem);
      if(Array.isArray(item.segments) && item.segments.length) return rubyFromSegments(item.segments);
      return rubyAutoAlign(item.ja, item.kana);
    }
    function exRuby(ex, segForItem, exIndex){
      const custom = segForItem && segForItem.examples && (segForItem.examples[exIndex] ?? segForItem.examples[String(exIndex)]);
      if(Array.isArray(custom) && custom.length) return rubyFromSegments(custom);
      if(Array.isArray(ex.segments) && ex.segments.length) return rubyFromSegments(ex.segments);
      return rubyAutoAlign(ex.ja || '', ex.kana || '');
    }

    /* ========= LocalStorage ========= */
    const LS_LEARNING = 'nihongo_learning';
    const LS_LEARNED  = 'nihongo_learned';
    const LS_ALT      = 'ntx_learning_v2'; // compat

    const lsRead  = key => { try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch{return [];} };
    const lsWrite = (key, arr) => localStorage.setItem(key, JSON.stringify(arr));
    const pick = (item)=>({
      id:item.id, ja:item.ja, kana:item.kana, ro:item.ro, en:item.en,
      segments: Array.isArray(item.segments)?item.segments:undefined,
      examples: Array.isArray(item.examples)? item.examples.map(e=>({
        en:e.en, ja:e.ja, kana:e.kana, ro:e.ro, segments:e.segments
      })) : undefined
    });
    function upsertTo(key, item){
      const arr = lsRead(key);
      const id  = String(item.id);
      const idx = arr.findIndex(x=>String(x?.id)===id);
      const obj = pick(item);
      if(idx>=0) arr[idx]=obj; else arr.push(obj);
      lsWrite(key, arr);
    }
    function upsertLearning(item){
      upsertTo(LS_LEARNING, item);
      upsertTo(LS_ALT, item); // keep legacy in sync
      if(window._ntxRenderLearning) window._ntxRenderLearning();
    }
    function moveToLearned(item){
      const r = lsRead(LS_LEARNING).filter(x=>String(x?.id)!==String(item.id));
      lsWrite(LS_LEARNING, r);
      upsertTo(LS_LEARNED, item);
      if(window._ntxRenderLearning) window._ntxRenderLearning();
    }

    /* ========= Data & UI ========= */
    const levelSel = document.getElementById('level');
    const partSel  = document.getElementById('part');
    const listEl   = document.getElementById('word-list');
    const pagerEl  = document.getElementById('pager');

    // restore URL params
    const q = new URLSearchParams(location.search);
    if(q.get('level')) levelSel.value = q.get('level');
    if(q.get('part'))  partSel.value  = q.get('part');

    let DATA = [];
    let SEGMENTS_MAP = {};
    let currentPage = Math.max(1, parseInt(q.get('page')||'1',10));

    levelSel.addEventListener('change', ()=>{ currentPage=1; syncAndLoad(); });
    partSel .addEventListener('change', ()=>{ currentPage=1; syncAndLoad(); });
    ['show-ja','show-kana','show-ro','show-en'].forEach(id=>{
      document.getElementById(id).addEventListener('change', render);
    });

    async function syncAndLoad(){
      const level = levelSel.value;
      const part  = partSel.value;
      const dataUrl = `/data/json/${level}/${part}.json`;
      const segUrl  = `/data/segments/${level}/${part}.segments.json`; // optional

      const u = new URL(location.href);
      u.searchParams.set('level', level);
      u.searchParams.set('part',  part);
      u.searchParams.set('page',  String(currentPage));
      history.replaceState(null, '', u);

      try{
        const [resData, resSeg] = await Promise.all([
          fetch(dataUrl, {cache:'no-cache'}),
          fetch(segUrl,  {cache:'no-cache'}).catch(()=>null)
        ]);
        if(!resData.ok) throw new Error(resData.status + ' ' + resData.statusText);
        DATA = await resData.json();

        if(resSeg && resSeg.ok){
          SEGMENTS_MAP = await resSeg.json();
        }else{
          SEGMENTS_MAP = {};
        }
        render();
      }catch(e){
        console.error(e);
        listEl.innerHTML = `<p class="notice" style="color:#c00;">Failed to load dataset. Check <code>${dataUrl}</code>.</p>`;
        pagerEl.innerHTML = '';
      }
    }

    function renderPager(total, page, perPage){
      const totalPages = Math.max(1, Math.ceil(total / perPage));
      const btn = (p, label, disabled=false, current=false)=>(
        `<button ${disabled?'disabled':''} data-page="${p}" ${current?'class="current"':''}>${label}</button>`
      );
      let html = '';
      html += btn(Math.max(1, page-1), 'Prev', page<=1);
      for(let i=1;i<=totalPages;i++){
        html += btn(i, i, false, i===page);
      }
      html += btn(Math.min(totalPages, page+1), 'Next', page>=totalPages);
      pagerEl.innerHTML = html;
    }

    function render(){
      if(!Array.isArray(DATA)){ listEl.innerHTML=''; pagerEl.innerHTML=''; return; }

      const showJa   = document.getElementById('show-ja').checked;
      const showKana = document.getElementById('show-kana').checked;
      const showRo   = document.getElementById('show-ro').checked;
      const showEn   = document.getElementById('show-en').checked;

      // cap to 30, then page by 5
      const capped = DATA.slice(0, MAX_ITEMS_CAP);
      const total  = capped.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if(currentPage>totalPages) currentPage = totalPages;

      const start = (currentPage-1)*PAGE_SIZE;
      const items = capped.slice(start, start+PAGE_SIZE);

      document.getElementById('limit-note').style.display = DATA.length > MAX_ITEMS_CAP ? 'block' : 'none';

      const html = items.map((item)=>{
        const segForItem = SEGMENTS_MAP[item.id]; // {word:[], examples:{'0':[]...}}
        const line1 = `<div class="line meta">${esc(levelSel.value)} ・ ${esc(partSel.value)}</div>`;
        const line2 = showJa   ? `<div class="line"><strong>${jaWithStrictRuby(item, SEGMENTS_MAP)}</strong></div>` : '';
        const line3 = showKana ? `<div class="line">${esc(item.kana||'')}</div>` : '';
        const line4 = showRo   ? `<div class="line">${esc(item.ro||'')}</div>` : '';
        const line5 = showEn   ? `<div class="line">${esc(item.en||'')}</div>` : '';

        const hasEx = Array.isArray(item.examples) && item.examples.length;
        const exHtml = hasEx ? item.examples.map((ex, i)=>`
          <div class="ex">
            ${showEn   && ex.en   ? `<div>• ${esc(ex.en)}</div>`:''}
            ${showJa   && (ex.ja||ex.kana) ? `<div>${exRuby(ex, segForItem, i)}</div>`:''}
            ${showKana && ex.kana ? `<div>${esc(ex.kana)}</div>`:''}
            ${showRo   && ex.ro   ? `<div>${esc(ex.ro)}</div>`:''}
          </div>`).join('') : '';

        return `
          <article class="word-card" data-id="${esc(item.id||'')}">
            ${line1}${line2}${line3}${line4}${line5}
            <div class="word-actions">
              <button class="btn act-learn"   data-id="${esc(item.id||'')}">Learn</button>
              <button class="btn act-learned" data-id="${esc(item.id||'')}">Learned</button>
              ${hasEx ? `<span class="toggle act-toggle">▼ Examples</span>`:''}
            </div>
            ${hasEx ? `<div class="examples" hidden>${exHtml}</div>`:''}
          </article>`;
      }).join('');

      listEl.innerHTML = html || '<p class="notice">No items.</p>';
      renderPager(total, currentPage, PAGE_SIZE);
    }

    // click delegation (learn/learned/toggle)
    document.getElementById('word-list').addEventListener('click', (ev)=>{
      const btnLearn   = ev.target.closest('.act-learn');
      const btnLearned = ev.target.closest('.act-learned');
      const btnToggle  = ev.target.closest('.act-toggle');
      if(!(btnLearn||btnLearned||btnToggle)) return;

      const art = ev.target.closest('article.word-card');
      if(!art) return;
      const id = String(art.getAttribute('data-id')||'');
      const item = (Array.isArray(DATA) ? DATA.find(x=>String(x.id)===id) : null);
      if(!item) return;

      if(btnLearn){
        upsertLearning(item);
        btnLearn.textContent = 'Added';
      } else if(btnLearned){
        moveToLearned(item);
        btnLearned.textContent = 'Moved';
      } else if(btnToggle){
        const box = art.querySelector('.examples');
        if(!box) return;
        const open = !box.hasAttribute('hidden');
        if(open){ box.setAttribute('hidden',''); btnToggle.textContent='▼ Examples'; }
        else { box.removeAttribute('hidden'); btnToggle.textContent='▲ Hide examples'; }
      }
    });

    // pager clicks
    document.getElementById('pager').addEventListener('click', (ev)=>{
      const b = ev.target.closest('button[data-page]');
      if(!b || b.disabled) return;
      const p = parseInt(b.getAttribute('data-page'),10);
      if(!Number.isFinite(p)) return;
      currentPage = Math.max(1, p);

      const u = new URL(location.href);
      u.searchParams.set('page', String(currentPage));
      history.replaceState(null, '', u);

      render();
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // initial load
    syncAndLoad();
  </script>
</body>
</html>
