<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JLPT — Words | nihongotext.com</title>
<link rel="icon" href="/favicon.ico" />
<base href="/" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  :root{
    --ink:#132c3a; --muted:#6b7280; --brand:#e6462d; --border:#e5e7eb; --card:#fff;
  }
  html,body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;color:var(--ink);line-height:1.7;background:#fff}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .pill{padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:.85rem}
  .btn{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
  .btn.brand{border-color:#f2b3aa;background:#fef2f1;color:#b12b18}
  .btn.ghost{background:#fff}
  .btn.small{padding:4px 8px;font-size:.9rem}
  .btn[disabled]{opacity:.5;pointer-events:none}
  .card{border:1px solid var(--border);border-radius:14px;padding:14px 14px 12px;background:var(--card);box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:820px){ .grid{grid-template-columns:1fr} }
  h1{margin:.2rem 0 1rem}
  h2{margin:0 0 .4rem}
  h3{margin:.2rem 0}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0 14px}
  .select{border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:#fff}
  .toggle-row{display:flex;gap:18px;flex-wrap:wrap;margin:6px 0}
  .pager{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin:10px 0 0}
  .pager .btn{min-width:38px;justify-content:center}
  .badge{min-width:22px;height:22px;padding:0 6px;border-radius:12px;background:var(--brand);color:#fff;display:inline-flex;align-items:center;justify-content:center;font-size:.8rem}
  details summary{cursor:pointer;user-select:none}
  details[open] summary .caret{transform:rotate(180deg)}
  .small{font-size:.9rem}
  ruby{ruby-position:over; ruby-align:start}
  rt{font-size:.6em; color:#666; letter-spacing:.03em}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; color:#475569}
  .head-row{display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:8px}
  .kv{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
</style>

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-9QSHWJE0HZ');</script>
</head>
<body>
  <div id="header"></div>

  <main>
    <div class="wrap">
      <div class="head-row">
        <h1 class="row"><i class="fa-solid fa-shapes" style="color:#e6462d"></i> JLPT — Words</h1>
        <span class="pill row">
          <i class="fa-solid fa-book-open" style="color:#e6462d"></i> Learning
          <span id="learning-count-badge" class="badge">0</span>
        </span>
        <span class="pill row">
          <i class="fa-solid fa-circle-check" style="color:#16a34a"></i> Learned
          <span id="learned-count-badge" class="badge" style="background:#16a34a">0</span>
        </span>
      </div>

      <!-- セレクタ -->
      <div class="controls">
        <label class="row">Level
          <select id="sel-level" class="select">
            <option>N5</option><option>N4</option><option>N3</option><option>N2</option><option>N1</option>
          </select>
        </label>
        <label class="row">Part
          <select id="sel-part" class="select"></select>
        </label>
      </div>

      <!-- 表示切替 -->
      <div class="toggle-row">
        <label><input type="checkbox" id="chk-ja" checked> Nihongo（漢字+ふりがな）</label>
        <label><input type="checkbox" id="chk-kana" checked> Hiragana</label>
      </div>
      <div class="toggle-row">
        <label><input type="checkbox" id="chk-ro" checked> Alphabet（romaji）</label>
        <label><input type="checkbox" id="chk-en" checked> English</label>
      </div>

      <!-- 一覧 -->
      <section id="list" class="grid" aria-live="polite"></section>

      <!-- ページャ -->
      <div class="pager" id="pager"></div>
    </div>
  </main>

  <div id="footer"></div>

<script>
/* ==========================
   ユーティリティ
========================== */
const PAGE_SIZE = 5;
const KP = 'nihongo_learning';
const KA = 'nihongo_learned';
const $ = sel => document.querySelector(sel);
const $el = id => document.getElementById(id);
function readStore(k){ try{return JSON.parse(localStorage.getItem(k)||'[]');}catch{return [];} }
function writeStore(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
function uniqById(arr){ const m=new Map(); arr.forEach(x=>{ if(x&&x.id) m.set(String(x.id),x)}); return [...m.values()]; }
function qs(name, d=''){ const u=new URL(location.href); return u.searchParams.get(name) || d; }
function setQS(obj){ const u=new URL(location.href); Object.entries(obj).forEach(([k,v])=> u.searchParams.set(k,v)); history.replaceState(null,'',u.toString()); }
function esc(s){ return String(s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ==========================
   ふりがな生成（簡易）＋厳密上書き
========================== */
// 簡易：同長 or かなを順次マージ（厳密は segments で上書き）
function autoRuby(ja, kana){
  if(!ja) return esc(kana||ja||'');
  try{
    if(kana && ja.length===kana.length){
      let out='';
      for(let i=0;i<ja.length;i++){
        const J=ja[i], K=kana[i];
        if(J===K) out+=esc(J);
        else out+=`<ruby>${esc(J)}<rt>${esc(K)}</rt></ruby>`;
      }
      return out;
    }
    // fallback：そのまま
    return esc(ja);
  }catch{ return esc(ja); }
}

// segments を読み込んで {overrides} を返す
async function loadSegments(level, part){
  try{
    const res = await fetch(`/data/segments/${level}/${part}.json`, {cache:'no-store'});
    if(!res.ok) return {};
    const j = await res.json();
    return (j && j.overrides) || {};
  }catch{ return {}; }
}

/* ==========================
   データ読み込み
========================== */
const PARTS_BY_LEVEL = {
  N5:["verbs","nouns","adjective-i","adjective-na","adverbs","numerals","particles","conjunctions","interjections"],
  N4:["verbs","nouns","adjective-i","adjective-na","adverbs","numerals","particles","conjunctions"],
  N3:["adjective-i","adjective-na","adverbs","numerals","particles","conjunctions"],
  N2:["verbs","nouns","adjective-i","adjective-na","adverbs","numerals","particles","conjunctions","interjections"],
  N1:["adjective-na","interjections"]
};

async function loadMain(level, part){
  const res = await fetch(`/data/json/${level}/${part}.json`, {cache:'no-store'});
  if(!res.ok){
    $el('list').innerHTML = `<div class="muted card" style="grid-column:1/-1">Failed to load dataset. Check <span class="mono">/data/json/${level}/${part}.json</span>.</div>`;
    throw new Error('main load failed');
  }
  return await res.json();
}

/* ==========================
   描画
========================== */
let MAIN = {data:[]}, OV = {}, CUR = {level:'N5', part:'verbs', page:1};
function updateBadges(){
  const lc = uniqById(readStore(KP)).length;
  const ld = uniqById(readStore(KA)).length;
  $el('learning-count-badge').textContent = lc;
  $el('learned-count-badge').textContent = ld;
}

function nihongoHtml(item){
  const o = OV[item.id];
  if(o && o.ruby_ja) return o.ruby_ja;
  return autoRuby(item.ja, item.kana);
}
function exampleHtml(item, idx){
  const ex = item.examples?.[idx] || {};
  const o = OV[item.id];
  if(o && Array.isArray(o.ruby_examples) && o.ruby_examples[idx]) return o.ruby_examples[idx];
  // fallback: 英文 + JA(自動ルビ)
  const ja = autoRuby(ex.ja||'', ex.kana||'');
  const en = esc(ex.en||'');
  const ro = esc(ex.ro||'');
  return `
    ${en ? `・ ${en}` : ''}${en && (ex.ja||ex.kana||ro) ? ' / ' : ''}${ja}${ro?` / ${ro}`:''}
  `;
}

function cardHtml(item){
  const inLearning = readStore(KP).some(x=>x.id===item.id);
  const inLearned  = readStore(KA).some(x=>x.id===item.id);

  return `
  <article class="card" data-id="${esc(item.id)}">
    <div class="kv muted small">${esc(item.level||'')} ${esc(item.pos||'')}</div>

    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="line-ja" ${$el('chk-ja')?.checked? '' : 'hidden'} style="font-size:1.1rem">${nihongoHtml(item)}</div>
        <div class="line-kana" ${$el('chk-kana')?.checked? '' : 'hidden'}>${esc(item.kana||'')}</div>
        <div class="line-ro" ${$el('chk-ro')?.checked? '' : 'hidden'}>${esc(item.ro||'')}</div>
        <div class="line-en" ${$el('chk-en')?.checked? '' : 'hidden'}>${esc(item.en||'')}</div>
      </div>

      <div class="row">
        <button class="btn small ${inLearning?'brand':''}" data-action="learn">${inLearning?'<i class="fa-solid fa-book-open"></i> Learning':'<i class="fa-regular fa-bookmark"></i> Learn'}</button>
        <button class="btn small" data-action="learned"><i class="fa-regular fa-circle-check"></i> Learned</button>
      </div>
    </div>

    <details style="margin-top:8px">
      <summary class="row small"><span class="caret">▾</span> Examples</summary>
      <div class="small" style="margin-top:6px">
        ${(item.examples||[]).map((_,i)=>`<div>${exampleHtml(item,i)}</div>`).join('') || '<div class="muted">No examples.</div>'}
      </div>
    </details>
  </article>`;
}

function renderList(){
  const start = (CUR.page-1)*PAGE_SIZE;
  const slice = (MAIN.data||[]).slice(start, start+PAGE_SIZE);
  $el('list').innerHTML = slice.map(cardHtml).join('') || `<div class="card muted" style="grid-column:1/-1">No items.</div>`;
  renderPager();
  updateBadges();
}

function renderPager(){
  const total = MAIN.data.length;
  const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
  const p = CUR.page;
  let html = '';
  html += `<button class="btn small" data-page="${Math.max(1,p-1)}" ${p<=1?'disabled':''}>&lt; Prev</button>`;
  for(let i=1;i<=pages;i++){
    html += `<button class="btn small ${i===p?'brand':''}" data-page="${i}">${i}</button>`;
    if(i>=p+4 && i<pages){ html += `<span class="muted">…</span><button class="btn small" data-page="${pages}">${pages}</button>`; break; }
  }
  html += `<button class="btn small" data-page="${Math.min(pages,p+1)}" ${p>=pages?'disabled':''}>Next &gt;</button>`;
  $el('pager').innerHTML = html;
}

/* ==========================
   学習トグル
========================== */
function onClickRoot(ev){
  const btn = ev.target.closest('button');
  if(!btn) return;
  // ページャ
  if(btn.dataset.page){
    CUR.page = parseInt(btn.dataset.page,10)||1;
    setQS({page:CUR.page});
    renderList(); return;
  }
  // Learn / Learned
  const card = ev.target.closest('[data-id]');
  if(!card) return;
  const id = card.dataset.id;
  const item = (MAIN.data||[]).find(x=>x.id===id);
  if(!item) return;

  const act = btn.dataset.action;
  if(act==='learn'){
    let arr = readStore(KP);
    const has = arr.some(x=>x.id===id);
    if(!has) arr = uniqById([...arr, tieExamples(item)]);
    writeStore(KP, arr);
    // Learned からは外す
    writeStore(KA, readStore(KA).filter(x=>x.id!==id));
  }
  if(act==='learned'){
    let arr = readStore(KA);
    const has = arr.some(x=>x.id===id);
    if(!has) arr = uniqById([...arr, tieExamples(item)]);
    writeStore(KA, arr);
    // Learning からは外す
    writeStore(KP, readStore(KP).filter(x=>x.id!==id));
  }
  renderList();
}

function tieExamples(item){
  // 学習ボックス用に必要な最小フィールドだけ持たせる
  return {
    id:item.id, level:item.level, pos:item.pos,
    ja:item.ja, kana:item.kana, ro:item.ro, en:item.en,
    examples: item.examples||[]
  };
}

/* ==========================
   セレクタの構築
========================== */
function initSelectors(){
  const level = qs('level', CUR.level);
  const part  = qs('part',  CUR.part);
  const page  = parseInt(qs('page','1'),10)||1;

  CUR.level = level; CUR.part = part; CUR.page = page;

  // level
  $el('sel-level').value = CUR.level;
  // part
  const parts = PARTS_BY_LEVEL[CUR.level] || [];
  $el('sel-part').innerHTML = parts.map(p=>`<option value="${p}">${p}</option>`).join('');
  if(!parts.includes(CUR.part)) CUR.part = parts[0] || 'verbs';
  $el('sel-part').value = CUR.part;

  // 変更イベント
  $el('sel-level').addEventListener('change', async ()=>{
    CUR.level = $el('sel-level').value;
    // part を差し替え
    const ps = PARTS_BY_LEVEL[CUR.level] || [];
    $el('sel-part').innerHTML = ps.map(p=>`<option value="${p}">${p}</option>`).join('');
    CUR.part = ps[0] || 'verbs';
    CUR.page = 1;
    setQS({level:CUR.level, part:CUR.part, page:CUR.page});
    await reload();
  });
  $el('sel-part').addEventListener('change', async ()=>{
    CUR.part = $el('sel-part').value;
    CUR.page = 1;
    setQS({level:CUR.level, part:CUR.part, page:CUR.page});
    await reload();
  });
}

/* ==========================
   初期化・再読込
========================== */
async function reload(){
  // 本体
  MAIN = await loadMain(CUR.level, CUR.part);
  MAIN.data = Array.isArray(MAIN.data)? MAIN.data : (Array.isArray(MAIN)? MAIN : (MAIN.items||[]));
  // レベル/品詞付与の安全策
  MAIN.data = (MAIN.data||[]).map(x=>({level:CUR.level, pos:CUR.part, ...x}));

  // segments 上書き
  OV = await loadSegments(CUR.level, CUR.part);

  // 描画
  renderList();
  updateBadges();
}

async function loadPartials(){
  const [h,f]=await Promise.all([fetch('/partials/header.html'),fetch('/partials/footer.html')]);
  $el('header').innerHTML = await h.text();
  $el('footer').innerHTML = await f.text();
}

/* ==========================
   起動
========================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // 部品
  await (async()=>{
    const [h,f]=await Promise.all([fetch('/partials/header.html'),fetch('/partials/footer.html')]);
    $el('header').innerHTML=await h.text();
    $el('footer').innerHTML=await f.text();
  })();

  initSelectors();

  // 表示トグル
  ['chk-ja','chk-kana','chk-ro','chk-en'].forEach(id=>{
    $el(id).addEventListener('change', ()=> renderList());
  });

  // クリック委譲（Learn/Learned/Pager）
  document.body.addEventListener('click', onClickRoot);

  // 初回ロード
  try{ await reload(); }catch(e){ console.error(e); }
});
</script>
</body>
</html>
