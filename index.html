<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JLPT — Words | nihongotext.com</title>
  <base href="/" />
  <link rel="icon" href="/icon-512.png" />
  <meta name="description" content="Browse JLPT vocabulary by level and part of speech. Add items to Learning and move to Learned. Toggle kanji with furigana, hiragana, romaji, and English." />

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>
    window.dataLayer=window.dataLayer||[];
    function gtag(){dataLayer.push(arguments);}
    gtag('js',new Date()); gtag('config','G-9QSHWJE0HZ');
  </script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{ --brand:#e6462d; --ink:#222; --muted:#666; --border:#eee; }
    html,body{background:#fff;color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
    main{max-width:1100px;margin:20px auto 68px;padding:0 16px}
    h1{margin:10px 0 14px;font-size:20px;color:#d33}

    /* toolbars */
    .toolbar{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin:10px 0 12px}
    .toolbar .grp{display:flex;gap:8px;align-items:center}
    .toolbar.v{flex-direction:column;align-items:flex-start}
    .row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    label{user-select:none}
    select,button,input[type="checkbox"]{font-size:14px}

    /* cards */
    #list .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .card{border:1px solid var(--border);border-radius:10px;background:#fff;padding:12px}
    .topline{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:6px}
    .muted{color:var(--muted)}
    .badge{display:inline-block;padding:2px 8px;border:1px solid #ddd;border-radius:999px;font-size:12px;color:#555;background:#fafafa}

    .btn{border:1px solid #ddd;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .btn:hover{border-color:#ccc}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn-learn{border-color:#ddd;color:#333;background:#fff}
    .btn-learning{border-color:var(--brand);color:#fff;background:var(--brand)}
    .btn-learned{border-color:var(--brand);color:var(--brand);background:#fff}

    .line{margin:2px 0;line-height:1.8}
    ruby rt{font-size:.72em;color:#666}
    details summary{cursor:pointer;list-style:none}
    details summary::-webkit-details-marker{display:none}

    /* pager */
    .pager{display:flex;gap:8px;align-items:center;margin:16px 0 4px}
    .pager .btn-page{min-width:36px}
    .pager .btn[disabled]{opacity:.5}

    /* error */
    .error{border:1px dashed #f2b;background:#fff7f9;color:#a00;padding:10px;border-radius:8px}

    /* header badges at very top (from header.html) get space */
    #header-placeholder{margin-bottom:6px}
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <h1>JLPT — Words</h1>

    <!-- Selectors -->
    <div class="toolbar">
      <div class="grp">
        <label for="sel-level">Level</label>
        <select id="sel-level" aria-label="JLPT level">
          <option>N5</option><option>N4</option><option>N3</option><option>N2</option><option>N1</option>
        </select>
      </div>
      <div class="grp">
        <label for="sel-part">Part</label>
        <select id="sel-part" aria-label="Part of speech">
          <option value="verbs">verbs</option>
          <option value="nouns">nouns</option>
          <option value="adjectives-i">adjectives-i</option>
          <option value="adjectives-na">adjectives-na</option>
          <option value="adverbs">adverbs</option>
          <option value="numerals">numerals</option>
          <option value="particles">particles</option>
          <option value="conjunctions">conjunctions</option>
          <option value="interjections">interjections</option>
        </select>
      </div>
    </div>

    <!-- 2-row toggles -->
    <div class="toolbar v" role="group" aria-label="Display toggles">
      <div class="row">
        <label><input type="checkbox" id="chk-ja" checked> Nihongo（漢字+ふりがな）</label>
        <label><input type="checkbox" id="chk-kana" checked> Hiragana</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="chk-ro" checked> Alphabet（romaji）</label>
        <label><input type="checkbox" id="chk-en" checked> English</label>
      </div>
    </div>

    <!-- pager top -->
    <div class="pager" aria-label="Pagination">
      <button class="btn" id="btn-prev" aria-label="Previous page">&lt; Prev</button>
      <div id="page-numbers" class="muted"></div>
      <button class="btn" id="btn-next" aria-label="Next page">Next &gt;</button>
    </div>

    <div id="list"></div>

    <!-- pager bottom -->
    <div class="pager" aria-label="Pagination">
      <button class="btn" id="btn-prev-b" aria-label="Previous page">&lt; Prev</button>
      <div id="page-numbers-b" class="muted"></div>
      <button class="btn" id="btn-next-b" aria-label="Next page">Next &gt;</button>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <!-- Partials -->
  <script>
    (async function injectPartials(){
      try{
        const [h,f] = await Promise.all([
          fetch('/partials/header.html',{cache:'no-store'}).then(r=>r.text()),
          fetch('/partials/footer.html',{cache:'no-store'}).then(r=>r.text())
        ]);
        document.getElementById('header-placeholder').innerHTML = h;
        document.getElementById('footer-placeholder').innerHTML = f;
        // ヘッダーの Learning/Learned ドロワーの初期レンダリング
        if(window._ntxRenderLearning) window._ntxRenderLearning();
        if(window._ntxRenderLearned) window._ntxRenderLearned();
      }catch(e){ console.warn('partials load failed', e); }
    })();
  </script>

  <!-- Main App -->
  <script>
  (function(){
    /* ===== Constants ===== */
    const PAGE_SIZE      = 5;     // 1ページ5つ
    const MAX_ITEMS      = 30;    // 各品詞は30件まで表示
    const KEY_LEARNING   = 'nihongo_learning';
    const KEY_LEARNED    = 'nihongo_learned';

    /* ===== State ===== */
    const S = { level:'N5', part:'verbs', items:[], segments:{}, page:1 };

    /* ===== Helpers ===== */
    function esc(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
    function R(k){try{return JSON.parse(localStorage.getItem(k)||'[]');}catch{return []}}
    function W(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}
    function M(a,b){const m=new Map();[...a,...b].forEach(x=>{if(x&&x.id!=null)m.set(String(x.id),x)});return [...m.values()]}

    function getParams(){
      const sp=new URLSearchParams(location.search);
      return { level:sp.get('level')||'N5', part:sp.get('part')||'verbs', page:Math.max(1,parseInt(sp.get('page')||'1',10)) };
    }
    function setParams(obj){
      const sp=new URLSearchParams(location.search);
      for(const [k,v] of Object.entries(obj)) sp.set(k,String(v));
      history.replaceState(null,'','?'+sp.toString());
    }

    // 厳密ふりがな：/data/segments/{Level}/{part}.json 形式（{id:[{kanji,kana},{...}], ...}）
    function toRuby(id, ja, kana){
      const seg = S.segments && S.segments[id];
      if(Array.isArray(seg) && seg.length){
        return seg.map(s=>{
          const k=(s.kanji||'').trim(); const r=(s.kana||'').trim();
          if(!k) return '';
          if(!r || k===r) return esc(k);
          return `<ruby>${esc(k)}<rt>${esc(r)}</rt></ruby>`;
        }).join('');
      }
      if(!ja) return '';
      if(!kana || kana===ja) return esc(ja);
      return `<ruby>${esc(ja)}<rt>${esc(kana)}</rt></ruby>`;
    }

    async function fetchJsonStrict(url){
      const res=await fetch(url,{cache:'no-store'});
      const text=await res.text();
      if(!res.ok || /^\s*</.test(text)) throw new Error('Fetch failed '+url);
      return JSON.parse(text);
    }

    async function loadData(){
      const bases=['/data/json','/dada/json'];
      const lv=[S.level,S.level.toUpperCase(),S.level.toLowerCase()];
      const candidates=[];
      for(const b of bases){ for(const L of lv){ candidates.push(`${b}/${L}/${S.part}.json`); } }

      let data=null;
      for(const u of candidates){ try{ data=await fetchJsonStrict(u); break; }catch(e){} }

      if(!Array.isArray(data)){
        document.getElementById('list').innerHTML =
          `<div class="error">Failed to load dataset. Check <code>/data/json/${esc(S.level)}/${esc(S.part)}.json</code>.</div>`;
        S.items=[]; render(); updatePager(); return;
      }

      S.items = data.slice(0,MAX_ITEMS);

      // ふりがなセグメントの併用
      S.segments = {};
      const segBases=['/data/segments','/dada/segments'];
      for(const b of segBases){
        for(const L of lv){
          try{
            const seg = await fetchJsonStrict(`${b}/${L}/${S.part}.json`);
            if(seg && typeof seg==='object'){ S.segments = seg; throw 'done'; }
          }catch(e){ if(e==='done') break; }
        }
      }
      render(); updatePager();
    }

    function render(){
      const list=document.getElementById('list');
      const start=(S.page-1)*PAGE_SIZE;
      const slice=S.items.slice(start,start+PAGE_SIZE);

      const show={
        ja:document.getElementById('chk-ja').checked,
        kana:document.getElementById('chk-kana').checked,
        ro:document.getElementById('chk-ro').checked,
        en:document.getElementById('chk-en').checked,
      };

      list.innerHTML = `<div class="cards">${
        slice.map(item=>{
          const id=item.id??'';
          const ja  = toRuby(id, item.ja, item.kana);
          const kana= esc(item.kana||'');
          const ro  = esc(item.ro||'');
          const en  = esc(item.en||'');
          const examples = Array.isArray(item.examples)?item.examples:[];
          const examplesHtml = examples.map(e=>{
            const l1 = e.ja   ? `<div class="line">${toRuby(id, e.ja, e.kana||'')}</div>` : '';
            const l2 = e.kana ? `<div class="line">${esc(e.kana)}</div>` : '';
            const l3 = e.ro   ? `<div class="line">${esc(e.ro)}</div>`   : '';
            const l4 = e.en   ? `<div class="line">${esc(e.en)}</div>`   : '';
            return `<div class="lines" style="margin:4px 0 8px 0;">${l1}${l2}${l3}${l4}</div>`;
          }).join('');

          const json = JSON.stringify(item).replace(/</g,'\\u003c');
          const inP  = R(KEY_LEARNING).some(x=>String(x.id)===String(id));
          const learnClass = inP ? 'btn-learning' : 'btn-learn';
          const learnLabel = inP ? '<i class="fa-solid fa-book-open"></i> Learning'
                                 : '<i class="fa-solid fa-book-open"></i> Learn';

          return `<article class="card" data-id="${esc(id)}">
            <div class="topline">
              <div class="muted"><span class="badge">${esc(S.level)}</span> <span class="badge">${esc(S.part)}</span></div>
              <div class="badges">
                <button class="btn ${learnClass}" data-action="to-learning" data-id="${esc(id)}" data-json='${json}'>${learnLabel}</button>
                <button class="btn btn-learned"  data-action="to-learned"  data-id="${esc(id)}" data-json='${json}'><i class="fa-solid fa-check"></i> Learned</button>
              </div>
            </div>

            ${show.ja   ? `<div class="line" style="font-size:18px">${ja}</div>`   : ``}
            ${show.kana ? `<div class="line">${kana}</div>`                           : ``}
            ${show.ro   ? `<div class="line">${ro}</div>`                             : ``}
            ${show.en   ? `<div class="line">${en}</div>`                             : ``}

            ${examples.length
              ? `<details style="margin-top:8px;">
                   <summary class="muted"><i class="fa-solid fa-caret-down"></i> Examples</summary>
                   <div style="margin-top:6px;">${examplesHtml}</div>
                 </details>`
              : ``}
          </article>`;
        }).join('')
      }</div>`;
    }

    function updatePager(){
      const pages = Math.max(1, Math.ceil(S.items.length / PAGE_SIZE));
      S.page = Math.min(Math.max(1,S.page), pages);
      const nums = Array.from({length:pages},(_,i)=>i+1)
        .map(p=>`<button class="btn btn-page" data-gop="${p}" ${p===S.page?'disabled':''}>${p}</button>`).join(' ');
      const a=document.getElementById('page-numbers'), b=document.getElementById('page-numbers-b');
      if(a) a.innerHTML = nums; if(b) b.innerHTML = nums;
      document.getElementById('btn-prev').disabled   = (S.page<=1);
      document.getElementById('btn-prev-b').disabled = (S.page<=1);
      document.getElementById('btn-next').disabled   = (S.page>=pages);
      document.getElementById('btn-next-b').disabled = (S.page>=pages);
    }

    // Learn / Learned / Pager click handler
    document.addEventListener('click',(ev)=>{
      const btn = ev.target.closest('button'); if(!btn) return;

      // Pager
      if (btn.dataset.gop || btn.id==='btn-prev' || btn.id==='btn-prev-b' || btn.id==='btn-next' || btn.id==='btn-next-b'){
        const pages = Math.max(1, Math.ceil(S.items.length / PAGE_SIZE));
        if (btn.dataset.gop){ S.page = parseInt(btn.dataset.gop,10); }
        else if (btn.id==='btn-prev' || btn.id==='btn-prev-b'){ S.page = Math.max(1, S.page-1); }
        else if (btn.id==='btn-next' || btn.id==='btn-next-b'){ S.page = Math.min(pages, S.page+1); }
        setParams({level:S.level, part:S.part, page:S.page});
        render(); updatePager();
        // Ads popup hook（承認前はヘッダー側のフォールバックを表示）
        if (window.openAdPopup) try{ window.openAdPopup(); }catch{}
        return;
      }

      // Learn / Learned
      const act = btn.dataset.action; if(!act) return;
      const item = JSON.parse(btn.dataset.json||'{}'); if(item.id==null) return;

      if (act==='to-learning'){
        const cur = R(KEY_LEARNING);
        const exists = cur.some(x=>String(x.id)===String(item.id));
        const next = exists ? cur.filter(x=>String(x.id)!==String(item.id)) : M(cur,[item]);
        W(KEY_LEARNING,next);
        // toggle look
        if (exists){ btn.classList.remove('btn-learning'); btn.classList.add('btn-learn'); btn.innerHTML='<i class="fa-solid fa-book-open"></i> Learn'; }
        else       { btn.classList.remove('btn-learn');    btn.classList.add('btn-learning'); btn.innerHTML='<i class="fa-solid fa-book-open"></i> Learning'; }
        // remove from learned
        W(KEY_LEARNED, R(KEY_LEARNED).filter(x=>String(x.id)!==String(item.id)));
        if (window._ntxRenderLearning) window._ntxRenderLearning();
        if (window._ntxRenderLearned)  window._ntxRenderLearned();
        window.dispatchEvent(new StorageEvent('storage',{key:KEY_LEARNING}));
        return;
      }

      if (act==='to-learned'){
        const done = M(R(KEY_LEARNED), [Object.assign({}, item, {learnedAt: Date.now()})]);
        W(KEY_LEARNED, done);
        W(KEY_LEARNING, R(KEY_LEARNING).filter(x=>String(x.id)!==String(item.id)));
        // reset Learn button look on the same card
        const lb = btn.parentElement?.querySelector('button[data-action="to-learning"]');
        if (lb){ lb.classList.remove('btn-learning'); lb.classList.add('btn-learn'); lb.innerHTML='<i class="fa-solid fa-book-open"></i> Learn'; }
        if (window._ntxRenderLearning) window._ntxRenderLearning();
        if (window._ntxRenderLearned)  window._ntxRenderLearned();
        window.dispatchEvent(new StorageEvent('storage',{key:KEY_LEARNED}));
        return;
      }
    });

    // toggles
    ['chk-ja','chk-kana','chk-ro','chk-en'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.addEventListener('change',()=>render());
    });

    // selects
    document.getElementById('sel-level').addEventListener('change',()=>{
      S.level=document.getElementById('sel-level').value; S.page=1;
      setParams({level:S.level,part:S.part,page:1}); loadData();
    });
    document.getElementById('sel-part').addEventListener('change',()=>{
      S.part=document.getElementById('sel-part').value; S.page=1;
      setParams({level:S.level,part:S.part,page:1}); loadData();
    });

    // init
    (function init(){
      const p=getParams(); S.level=p.level; S.part=p.part; S.page=p.page;
      document.getElementById('sel-level').value=S.level;
      document.getElementById('sel-part').value=S.part;
      loadData();
    })();

    // Listen updates from header drawers
    window.addEventListener('storage',(ev)=>{
      if(!ev) return;
      if(ev.key===KEY_LEARNING && window._ntxRenderLearning) window._ntxRenderLearning();
      if(ev.key===KEY_LEARNED  && window._ntxRenderLearned)  window._ntxRenderLearned();
    });
  })();
  </script>
</body>
</html>
