<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>nihongotext.com</title>
  <base href="/" />
  <link rel="icon" href="/icon-512.png"/>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-9QSHWJE0HZ');
  </script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2358198194205084" crossorigin="anonymous"></script>

  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans"; color:#222; margin:0; }
    main { max-width:1100px; margin:24px auto; padding:0 16px; }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; background:#fff; }
    .card h3 { margin:0 0 6px; font-size:18px; }
    .meta { color:#666; font-size:12px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .btn { padding:6px 10px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer; }
    .btn i { color:#e6462d; }
    .examples { margin-top:8px; font-size:14px; color:#333; border-top:1px dashed #eee; padding-top:8px; }
    .pager { display:flex; gap:8px; align-items:center; justify-content:center; margin:24px 0; }
    .pager button { padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer; }
    .pager .num { min-width:36px; text-align:center; }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <h1 style="color:#e6462d; font-size:24px; margin:10px 0 16px;">JLPT N5 — Verbs (demo)</h1>
    <section id="word-list" class="grid"></section>

    <div class="pager" aria-label="Pagination">
      <button class="prev btn" data-page="prev"><i class="fa-solid fa-chevron-left"></i> Prev</button>
      <button class="num btn" data-page="1">1</button>
      <button class="num btn" data-page="2">2</button>
      <button class="num btn" data-page="3">3</button>
      <button class="next btn" data-page="next">Next <i class="fa-solid fa-chevron-right"></i></button>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <script>
    async function loadPartials() {
      try {
        const [hdr, ftr] = await Promise.all([
          fetch("/partials/header.html").then(r=>r.text()),
          fetch("/partials/footer.html").then(r=>r.text())
        ]);
        document.getElementById("header-placeholder").innerHTML = hdr;
        document.getElementById("footer-placeholder").innerHTML = ftr;
      } catch(e) { console.error("Failed to load partials:", e); }
    }

    const DEMO = [
      { id:"n5-verb-001", en:"to meet", ja:"会う", kana:"あう", ro:"au", level:"N5", pos:"verb",
        examples:[{en:"I meet my friend.", ja:"友達に会う。", ro:"tomodachi ni au."}] },
      { id:"n5-verb-002", en:"to open", ja:"開ける", kana:"あける", ro:"akeru", level:"N5", pos:"verb",
        examples:[{en:"Open the window.", ja:"窓を開ける。", ro:"mado o akeru."}] },
      { id:"n5-verb-003", en:"to go", ja:"行く", kana:"いく", ro:"iku", level:"N5", pos:"verb",
        examples:[{en:"I go to school.", ja:"学校へ行く。", ro:"gakkou e iku."}] },
      { id:"n5-verb-004", en:"to read", ja:"読む", kana:"よむ", ro:"yomu", level:"N5", pos:"verb",
        examples:[{en:"Read a book.", ja:"本を読む。", ro:"hon o yomu."}] },
      { id:"n5-verb-005", en:"to write", ja:"書く", kana:"かく", ro:"kaku", level:"N5", pos:"verb",
        examples:[{en:"Write a letter.", ja:"手紙を書く。", ro:"tegami o kaku."}] }
    ];

    function renderList(data) {
      const wrap = document.getElementById('word-list');
      wrap.innerHTML = data.map(item => {
        const ex = (item.examples||[]).map(e=>`<div>• ${e.en} / ${e.ja}</div>`).join("");
        return `<article class="card" data-id="${item.id}" data-en="${item.en}" data-ja="${item.ja}" data-level="${item.level}" data-pos="${item.pos}">
            <h3>${item.en} <span class="meta">(${item.ja} / ${item.ro})</span></h3>
            <div class="meta">${item.level || ''} ${item.pos ? '· ' + item.pos : ''}</div>
            <div class="actions">
              <button class="btn btn-learn" data-action="learn"><i class="fa-solid fa-book-open"></i> Learn</button>
            </div>
            <div class="examples">${ex}</div>
          </article>`;
      }).join("");
    }

    (async function init(){
      await loadPartials();
      renderList(DEMO);
    })();
  </script>

  <!-- === Learning機能統合スクリプト === -->
  <script>
  (function(){
    const KP='nihongo_learning', KA='ntx_learning_v2';
    const R=k=>{try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]}};
    const W=(k,v)=>localStorage.setItem(k,JSON.stringify(v||[]));
    const M=(a,b)=>{const m=new Map();[...a,...b].forEach(x=>{if(x&&x.id)m.set(String(x.id),x)});return[...m.values()]};

    function setBadge(){
      const n=M(R(KP),R(KA)).length;
      const b=document.querySelector('#learning-count-badge');
      const c=document.querySelector('#learning-count');
      if(b) b.textContent=n;
      if(c) c.textContent='('+n+')';
    }

    function extractItemFromCard(card){
      if(!card) return null;
      const item={
        id:card.dataset.id||'',
        en:card.dataset.en||'',
        ja:card.dataset.ja||'',
        level:card.dataset.level||'',
        pos:card.dataset.pos||'',
        examples:[]
      };
      card.querySelectorAll('.examples div').forEach(li=>{
        const txt=(li.textContent||'').split('/');
        item.examples.push({en:(txt[0]||'').trim(),ja:(txt[1]||'').trim()});
      });
      return item;
    }

    document.addEventListener('click',ev=>{
      const t=ev.target.closest('[data-action="learn"],.btn-learn');
      if(!t) return;
      const card=t.closest('.card');
      const item=extractItemFromCard(card);
      if(!item||!item.id) return;
      const cur=R(KP);
      const idx=cur.findIndex(x=>x.id===item.id);
      if(idx<0) cur.push(item);
      else cur[idx]=item;
      W(KP,cur);
      setBadge();
      if(window._ntxRenderLearning) window._ntxRenderLearning();
    });

    function render(){
      const list=document.querySelector('#learning-list');
      if(!list){setBadge();return;}
      const arr=M(R(KP),R(KA));
      if(!arr.length){list.innerHTML='<p style="color:#666;">No items in Learning yet.</p>';setBadge();return;}
      list.innerHTML=arr.map(it=>{
        const ex=(it.examples||[]).map(e=>`<li>${e.en} / ${e.ja}</li>`).join('');
        return `<div style="border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px;">
          <strong>${it.en}</strong> <span style="color:#666;">(${it.ja})</span>
          ${ex?`<ul>${ex}</ul>`:''}
        </div>`;
      }).join('');
      setBadge();
    }

    window._ntxRenderLearning=render;
    window._ntxOpenLearning=()=>{const o=document.querySelector('#learning-overlay'),d=document.querySelector('#learning-drawer');if(o&&d){o.style.display='block';d.style.right='0';render();}};
    window._ntxCloseLearning=()=>{const o=document.querySelector('#learning-overlay'),d=document.querySelector('#learning-drawer');if(o&&d){d.style.right='-560px';setTimeout(()=>o.style.display='none',250);}};

    render();
    window.addEventListener('storage',ev=>{if([KP,KA].includes(ev.key))render();});
  })();
  </script>
</body>
</html>
