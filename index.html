<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>nihongotext.com</title>
  <base href="/" />
  <link rel="icon" href="/icon-512.png" />
  <meta name="description" content="Japanese learning site with JLPT vocabulary, examples, Learning / Learned list, and quizzes." />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <!-- GA4 (no auto page_view) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-9QSHWJE0HZ', { send_page_view:false });
  </script>

  <style>
    :root{
      --brand:#e6462d; --ink:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif; color:var(--ink); background:var(--bg); line-height:1.7}
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}

    main .wrap{max-width:1100px; margin:auto; padding:16px}
    h1{margin:.5rem 0 1rem; font-size:1.6rem}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 8px}
    .controls select, .controls input[type="search"]{border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:15px}
    .toggles{display:grid; grid-template-columns:repeat(2,auto); gap:8px 16px; align-items:center}
    .panel{border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.03); background:#fff}
    .card{border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff}
    .muted{color:var(--muted)}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border:1px solid var(--border); border-radius:9999px; font-size:12px; color:#555; background:#fafafa}

    /* 単語カード */
    .word{display:flex; flex-direction:column; gap:6px}
    .word-head{
      display:flex; align-items:flex-start; gap:10px; justify-content:space-between;
      border-bottom:1px dashed var(--border); padding-bottom:6px;
    }
    .word-meta{display:flex; gap:6px; flex-wrap:wrap; align-items:center}
    .word-buttons{display:flex; gap:6px; align-items:center; justify-content:flex-end;}
    .btn{
      padding:6px 10px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer;
      display:inline-flex; align-items:center; gap:6px; font-size:14px;
    }
    .btn:hover{background:#f9fafb}
    .btn-brand{border-color:var(--brand); color:#fff; background:var(--brand)}
    .btn-ghost{background:#fff}
    .btn-success{background:#10b981; color:#fff; border-color:#10b981}
    .btn-warning{background:#f59e0b; color:#fff; border-color:#f59e0b}

    .word-body{margin-top:6px}
    .ex-toggle{cursor:pointer; display:inline-flex; align-items:center; gap:6px; user-select:none}
    .examples{margin:8px 0 0; padding-left:18px}
    .examples li{margin:4px 0}
    ruby{ruby-position:over; ruby-align:start}
    rt{font-size:.6em; color:#666; letter-spacing:.03em}

    /* リストとページャー */
    .list{display:flex; flex-direction:column; gap:12px}
    .pager{display:flex; gap:8px; align-items:center; justify-content:center; margin:14px 0 4px}
    .pager .btn{min-width:38px; justify-content:center}

    /* 広告モーダル */
    #adMask{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:90;}
    #adPopup{
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width:min(720px,96vw); max-height:85vh; overflow:auto; background:#fff;
      border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,.2);
    }
    #adPopup .hd{display:flex; justify-content:space-between; align-items:center; gap:8px; border-bottom:1px solid var(--border); padding:12px 14px;}
    #adPopup .bd{padding:14px}
    #adPopup .ft{padding:10px 14px; border-top:1px solid var(--border); text-align:right}
  </style>
</head>
<body>
  <div id="header"></div>

  <main>
    <div class="wrap">
      <h1 class="row">
        <i class="fa-solid fa-language" style="color:var(--brand)"></i>
        JLPT Vocabulary
      </h1>

      <!-- 条件パネル -->
      <section class="panel" aria-label="Filters">
        <div class="controls">
          <label>Level
            <select id="level">
              <option value="N5">N5</option>
              <option value="N4">N4</option>
              <option value="N3">N3</option>
              <option value="N2">N2</option>
              <option value="N1">N1</option>
            </select>
          </label>
          <label>Part of speech
            <select id="part">
              <option value="verbs">verbs</option>
              <option value="nouns">nouns</option>
              <option value="adjectives-i">adjective-i</option>
              <option value="adjectives-na">adjective-na</option>
              <option value="adverbs">adverbs</option>
              <option value="numerals">numerals</option>
              <option value="particles">particles</option>
              <option value="conjunctions">conjunctions</option>
              <option value="interjections">interjections</option>
            </select>
          </label>
          <input id="search" type="search" placeholder="Search..." />
          <span class="badge"><i class="fa-regular fa-rectangle-list"></i> 5 items / page</span>
        </div>

        <!-- 表示トグル（2行構成） -->
        <div class="toggles" style="margin-top:6px">
          <label><input type="checkbox" class="tg" data-key="nihongo" checked> Nihongo (kanji with furigana)</label>
          <label><input type="checkbox" class="tg" data-key="hiragana" checked> Hiragana</label>
          <label><input type="checkbox" class="tg" data-key="alphabet" checked> Alphabet (romaji)</label>
          <label><input type="checkbox" class="tg" data-key="english" checked> English</label>
        </div>
      </section>

      <!-- リスト -->
      <section id="list" class="list" aria-live="polite"></section>

      <!-- ページャー（クリック時に必ず広告） -->
      <div class="pager" id="pager">
        <button class="btn" data-page="prev" aria-label="Previous"><i class="fa-solid fa-angle-left"></i></button>
        <span id="pageLabel" class="badge">1</span>
        <button class="btn" data-page="next" aria-label="Next"><i class="fa-solid fa-angle-right"></i></button>
      </div>
    </div>
  </main>

  <div id="footer"></div>

  <!-- ====== (English) Ad Popup ====== -->
  <div id="adMask" role="dialog" aria-modal="true" aria-labelledby="adTitle">
    <div id="adPopup">
      <div class="hd">
        <h3 id="adTitle" style="margin:0; font-size:16px; display:flex; align-items:center; gap:8px; color:#333;">
          <i class="fa-solid fa-bullhorn" style="color:var(--brand);"></i> Sponsored
        </h3>
        <button class="btn" aria-label="Close" onclick="hideAd()"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="bd">
        <a href="https://preply.com/ja/?pref=MTE2MDM4MjQ=&id=1762934766.097797&ep=w1" target="_blank" rel="noopener" style="text-decoration:none;">
          <div class="card row" style="gap:12px; align-items:center;">
            <img src="/assets/preply-banner.png" alt="Find a Japanese tutor on Preply" style="width:96px; height:96px; object-fit:cover; border-radius:8px; border:1px solid var(--border);">
            <div>
              <div style="font-weight:700; font-size:16px; color:#111">Find a Japanese tutor on Preply</div>
              <div class="muted" style="font-size:14px;">1-on-1 lessons that match your pace. Click to explore tutors.</div>
            </div>
          </div>
        </a>
      </div>
      <div class="ft">
        <button class="btn" onclick="hideAd()"><i class="fa-solid fa-check"></i> OK</button>
      </div>
    </div>
  </div>

  <script>
    /* ------------ Partials ------------ */
    async function loadPartials(){
      const [h,f] = await Promise.all([fetch('/partials/header.html'), fetch('/partials/footer.html')]);
      document.getElementById('header').innerHTML = await h.text();
      document.getElementById('footer').innerHTML = await f.text();
    }

    /* ------------ Ad Popup ------------ */
    function showAd(){ const m=document.getElementById('adMask'); if(m) m.style.display='block'; }
    function hideAd(){ const m=document.getElementById('adMask'); if(m) m.style.display='none'; }

    /* ------------ Storage Helpers ------------ */
    const K_LEARN_A = 'nihongo_learning';
    const K_LEARN_B = 'ntx_learning_v2';
    const K_LEARNED = 'ntx_learned_v1';
    const readJSON = (k, fallback=[]) => { try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(fallback));}catch(_){return fallback;} };
    const writeJSON = (k, v) => { try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){} };
    const mergeLearning = () => {
      const a = readJSON(K_LEARN_A, []), b = readJSON(K_LEARN_B, []);
      const m = new Map(); [...a, ...b].forEach(x=>{ if(x&&x.id)m.set(String(x.id),x); });
      return [...m.values()];
    };
    const setBadgeIfAny = (id, n) => { const el=document.getElementById(id); if(el) el.textContent = String(n); };

    function syncBadges(){
      const learnCount   = mergeLearning().length;
      const learnedCount = readJSON(K_LEARNED, []).length;
      setBadgeIfAny('learning-count-badge', learnCount);
      setBadgeIfAny('badge-learning',        learnCount);
      setBadgeIfAny('badge-learned',         learnedCount);
    }

    function addToLearning(item){
      const cur = mergeLearning();
      if(!cur.find(x=> String(x.id) === String(item.id))) {
        cur.push(item);
      }
      // write to primary
      writeJSON(K_LEARN_A, cur);
      syncBadges();
      if(window._ntxRenderLearning) window._ntxRenderLearning(); // header側のリスト更新（存在すれば）
    }

    function moveToLearned(item){
      // remove from learning
      const cur = mergeLearning().filter(x => String(x.id) !== String(item.id));
      writeJSON(K_LEARN_A, cur);
      // add to learned with date
      const learned = readJSON(K_LEARNED, []);
      const exists = learned.find(x=> String(x.id) === String(item.id));
      const nowISO = new Date().toISOString().slice(0,10);
      if(exists){
        exists.moved_at = nowISO;
      }else{
        learned.push({...item, moved_at: nowISO});
      }
      writeJSON(K_LEARNED, learned);
      syncBadges();
      if(window._ntxRenderLearning) window._ntxRenderLearning();
      if(window._ntxRenderLearned)  window._ntxRenderLearned();
    }

    function backToLearning(item){
      // remove from learned
      const learned = readJSON(K_LEARNED, []).filter(x => String(x.id) !== String(item.id));
      writeJSON(K_LEARNED, learned);
      // add to learning
      addToLearning(item);
      if(window._ntxRenderLearned)  window._ntxRenderLearned();
    }

    /* ------------ Data Load & Render ------------ */
    const PAGE_SIZE = 5;
    let STATE = {
      level:'N5', part:'verbs', q:'', page:1,
      toggles: { nihongo:true, hiragana:true, alphabet:true, english:true },
      data: []
    };

    const elLevel  = ()=>document.getElementById('level');
    const elPart   = ()=>document.getElementById('part');
    const elSearch = ()=>document.getElementById('search');
    const elList   = ()=>document.getElementById('list');
    const elPager  = ()=>document.getElementById('pager');
    const elPageLabel = ()=>document.getElementById('pageLabel');

    function buildUrl(level, part){
      // 本番データのパス仕様：/data/json/{Level}/{part}.json
      return `/data/json/${level}/${part}.json`;
    }

    async function fetchData(){
      const url = buildUrl(STATE.level, STATE.part);
      try{
        const res = await fetch(url, {cache:'no-store'});
        const data = await res.json();
        // 仕様：各品詞は 30 件まで（超過は今後追加）
        STATE.data = Array.isArray(data) ? data.slice(0,30) : [];
      }catch(e){
        STATE.data = [];
      }
    }

    function matchesQuery(item, q){
      if(!q) return true;
      q = q.toLowerCase();
      const hay = [
        item.en, item.ja, item.kana, item.ro, (item.examples||[]).map(e=>[e.en,e.ja,e.kana,e.ro].join(' ')).join(' ')
      ].join(' ').toLowerCase();
      return hay.includes(q);
    }

    function paginated(items){
      const start = (STATE.page-1)*PAGE_SIZE;
      return items.slice(start, start+PAGE_SIZE);
    }

    function renderList(){
      const list = elList(); if(!list) return;
      const filtered = STATE.data.filter(it=>matchesQuery(it, STATE.q));
      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
      if(STATE.page > totalPages) STATE.page = totalPages;

      const pageItems = paginated(filtered);

      if(!pageItems.length){
        list.innerHTML = '<div class="card muted">No items.</div>';
        elPageLabel().textContent = `${STATE.page} / ${totalPages}`;
        return;
      }

      list.innerHTML = pageItems.map((it)=>wordCardHTML(it)).join('');
      elPageLabel().textContent = `${STATE.page} / ${totalPages}`;

      // 展開トグル: 例文
      list.querySelectorAll('.js-ex-toggle').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-id');
          const box = document.getElementById(`ex-${id}`);
          if(!box) return;
          const open = box.getAttribute('data-open') === '1';
          box.style.display = open ? 'none' : 'block';
          box.setAttribute('data-open', open ? '0' : '1');
          btn.querySelector('.arrow').className = open ? 'fa-solid fa-caret-right arrow' : 'fa-solid fa-caret-down arrow';
        });
      });

      // ボタン操作（右揃え部）
      list.querySelectorAll('[data-action]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const action = btn.getAttribute('data-action');
          const id     = btn.getAttribute('data-id');
          const item   = STATE.data.find(x=> String(x.id) === String(id));
          if(!item) return;
          if(action==='learn'){ addToLearning(item); btn.classList.add('btn-brand'); btn.innerHTML='<i class="fa-solid fa-book-open"></i> Learning'; }
          if(action==='toLearned'){ moveToLearned(item); }
          if(action==='backToLearning'){ backToLearning(item); }
        });
      });

      // 表示トグル反映
      applyToggles();
    }

    function wordCardHTML(it){
      const id = String(it.id);
      const examples = (it.examples||[]).map(e=>{
        return `
          <li>
            <div class="ex-line nihongo">${escapeHTML(e.ja||'')}</div>
            <div class="ex-line hiragana">${escapeHTML(e.kana||'')}</div>
            <div class="ex-line alphabet">${escapeHTML(e.ro||'')}</div>
            <div class="ex-line english">${escapeHTML(e.en||'')}</div>
          </li>`;
      }).join('');

      return `
      <article class="card word" data-id="${id}">
        <div class="word-head">
          <div class="word-meta">
            <span class="badge">${STATE.level}</span>
            <span class="badge">${STATE.part}</span>
          </div>
          <div class="word-buttons">
            <button class="btn btn-ghost" data-action="learn" data-id="${id}" title="Add to Learning">
              <i class="fa-regular fa-bookmark"></i> Learn
            </button>
            <button class="btn btn-success" data-action="toLearned" data-id="${id}" title="Move to Learned">
              <i class="fa-solid fa-graduation-cap"></i> Move to Learned
            </button>
            <button class="btn btn-warning" data-action="backToLearning" data-id="${id}" title="Back to Learning">
              <i class="fa-solid fa-rotate-left"></i> Back to Learning
            </button>
          </div>
        </div>

        <div class="word-body">
          <div class="nihongo" style="font-weight:700; font-size:18px;">
            ${withFurigana(it.ja||'', it.kana||'')}
          </div>
          <div class="hiragana">${escapeHTML(it.kana||'')}</div>
          <div class="alphabet">${escapeHTML(it.ro||'')}</div>
          <div class="english">${escapeHTML(it.en||'')}</div>

          <div class="row" style="margin-top:6px;">
            <span class="ex-toggle js-ex-toggle" data-id="${id}" role="button" tabindex="0" aria-expanded="false">
              <i class="fa-solid fa-caret-right arrow"></i> Examples
            </span>
          </div>
          <ul id="ex-${id}" class="examples" style="display:none;" data-open="0">
            ${examples || '<li class="muted">No examples.</li>'}
          </ul>
        </div>
      </article>`;
    }

    function withFurigana(ja, kana){
      // 簡易実装（後でsegments活用に差し替え可）
      if(!ja) return '';
      if(!kana) return escapeHTML(ja);
      return `<ruby>${escapeHTML(ja)}<rt>${escapeHTML(kana)}</rt></ruby>`;
    }

    const escMap = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' };
    const escapeHTML = s => String(s||'').replace(/[&<>"']/g, m=>escMap[m]);

    function applyToggles(){
      const root = elList();
      if(!root) return;
      ['nihongo','hiragana','alphabet','english'].forEach(key=>{
        root.querySelectorAll('.'+key).forEach(el=>{
          el.style.display = STATE.toggles[key] ? '' : 'none';
        });
      });
    }

    /* ------------ Events ------------ */
    function bindUI(){
      elLevel().addEventListener('change', async e=>{
        STATE.level = e.target.value; STATE.page=1;
        await fetchData(); renderList();
      });
      elPart().addEventListener('change', async e=>{
        STATE.part = e.target.value; STATE.page=1;
        await fetchData(); renderList();
      });
      elSearch().addEventListener('input', e=>{
        STATE.q = e.target.value.trim(); STATE.page=1; renderList();
      });

      document.querySelectorAll('.tg').forEach(chk=>{
        chk.addEventListener('change', e=>{
          const key = e.target.getAttribute('data-key');
          STATE.toggles[key] = e.target.checked;
          applyToggles();
        });
      });

      // ページャー：クリックのたびに広告ポップアップ表示
      elPager().addEventListener('click', (ev)=>{
        const btn = ev.target.closest('[data-page]');
        if(!btn) return;
        const filtered = STATE.data.filter(it=>matchesQuery(it, STATE.q));
        const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE));
        if(btn.getAttribute('data-page')==='prev'){ STATE.page = Math.max(1, STATE.page-1); }
        if(btn.getAttribute('data-page')==='next'){ STATE.page = Math.min(totalPages, STATE.page+1); }
        renderList();
        showAd(); // ← すべてのページャークリックで広告表示
      });
    }

    /* ------------ Init ------------ */
    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadPartials();
      syncBadges();
      await fetchData();
      renderList();
    });
  </script>
</body>
</html>
