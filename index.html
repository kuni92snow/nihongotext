<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>nihongotext.com</title>
<link rel="icon" href="/favicon.ico" />

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-9QSHWJE0HZ', { send_page_view:false });
</script>

<!-- AdSense（所有権確認のみ） -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2358198194205084" crossorigin="anonymous"></script>

<style>
:root{
  --shu:#e6462d; --shu-tint:#fff2ef;
  --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb;
  --chip:#f8fafc; --card:#fff7f6;
}
*{box-sizing:border-box}
html,body{margin:0;background:#fff;color:var(--ink);
  font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Meiryo",sans-serif}
a{color:inherit;text-decoration:none}
button{cursor:pointer}

.wrap{max-width:1100px;margin:0 auto;padding:0 16px}
.topbar{border-top:4px solid var(--shu);border-bottom:1px solid var(--shu-tint);background:#fff}
.brandbar{display:flex;gap:14px;align-items:center;padding:14px 0}
.brand{font-weight:900;font-size:34px;color:var(--shu)} /* 2サイズUP */
.small-dot{color:#222}
.beta{color:var(--muted);font-size:12px}
.header-right{margin-left:auto;display:flex;gap:10px;align-items:center}
.learnedIcon{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--shu);color:var(--shu);
  background:#fff;border-radius:999px;padding:6px 10px;font-weight:700}

.footer{border-top:1px solid var(--shu-tint);background:#fff}
.footer-inner{padding:16px 0;display:flex;gap:10px;align-items:center;justify-content:center;color:var(--muted);font-size:12px}

.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:18px 0}
select,input[type="text"]{height:40px;border:1px solid var(--line);border-radius:10px;padding:0 12px;background:#fff}
.grow{flex:1}
.btn{border:1px solid var(--shu);color:var(--shu);background:#fff;border-radius:10px;padding:8px 12px;font-weight:700}
.btn.ok{background:var(--shu);color:#fff}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid var(--line);background:#f8fafc;border-radius:999px;padding:8px 12px;font-weight:700}
.chip.active{border-color:var(--shu);background:#fde3df}

.toggle-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.toggle-row label{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--line);padding:6px 10px;border-radius:10px;background:#fff}

.grid{display:grid;grid-template-columns:1fr;gap:12px}
.card{background:var(--card);border:1px solid #f1cbc6;border-radius:14px;overflow:hidden}
.card.learned{background:#eefbf1;border-color:#cceedd}
.head{display:flex;gap:10px;align-items:center;padding:10px 12px;background:#fff;border-bottom:1px dashed #f0d7d4}
.num{font-weight:800;color:var(--shu)}
.tags{display:flex;gap:6px;flex-wrap:wrap}
.tag{font-size:13px;background:#fff;border:1px solid #f0d7d4;border-radius:8px;padding:3px 8px}
.content{padding:12px 14px}
.line{margin:6px 0}
.ja{font-weight:800}
.kana,.ro,.en{opacity:.95}
.en{font-weight:700} /* 英語を強調 */

.pager{display:flex;gap:8px;align-items:center;justify-content:center;margin:16px 0 10px}
.pagebtn{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px}
.pagebtn.active{border-color:var(--shu);color:var(--shu);font-weight:800}

/* Amazon Associates ポップアップ（ページャー時のみ） */
.admask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:90}
.admask.show{display:flex}
.ad{background:#fff;border-radius:16px;max-width:680px;width:min(96vw,680px);padding:18px;border:2px solid var(--shu)}
.ad .x{float:right;border:1px solid var(--shu);color:var(--shu);background:#fff;border-radius:8px;padding:4px 9px}
.ad h3{margin:4px 0 12px}
.ad small{color:var(--muted)}
#amznAdBox{min-height:250px}
</style>
</head>
<body>

<!-- ===== Header（partials注入。失敗時は簡易表示） ===== -->
<div class="topbar">
  <div id="site-header" class="wrap brandbar">
    <a href="/" class="brand">nihongotext<span class="small-dot">.com</span></a>
    <span class="beta">== beta version ==</span>
    <div class="header-right">
      <button id="langToggleFallback" class="btn" type="button">日本語</button>
      <button id="openLearnedTop" class="learnedIcon" type="button"><i class="fa-solid fa-book-bookmark"></i>&nbsp;Learned</button>
    </div>
  </div>
</div>

<main class="wrap">
  <div class="controls">
    <label>Level
      <select id="levelSel">
        <option>N5</option><option>N4</option><option>N3</option><option>N2</option><option>N1</option>
      </select>
    </label>

    <div class="chips" id="posChips" role="tablist" aria-label="Parts of Speech"></div>

    <input id="kw" class="grow" type="text" placeholder="Search across all levels & parts…" />
    <button id="printBtn" class="btn" type="button">Print Learned</button>

    <!-- 表示切替 -->
    <div class="toggle-row" role="group" aria-label="Field toggles">
      <label><input type="checkbox" id="toggleEN" checked> English</label>
      <label><input type="checkbox" id="toggleJA" checked> Kanji</label>
      <label><input type="checkbox" id="toggleKANA" checked> Hiragana</label>
      <label><input type="checkbox" id="toggleRO" checked> Romaji</label>
    </div>
  </div>

  <div id="meta" style="color:var(--muted);font-size:13px;margin:4px 0 10px"></div>
  <div id="list" class="grid" aria-live="polite"></div>
  <div id="pager" class="pager"></div>
</main>

<!-- ===== Footer（partials注入。失敗時の簡易表示） ===== -->
<div class="footer">
  <div id="site-footer" class="wrap footer-inner">© 2025 nihongotext.com</div>
</div>

<!-- Learned モーダル -->
<div id="learnedModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="learnedTitle" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:80">
  <div class="panel" style="background:#fff;border-radius:14px;max-width:720px;width:min(92vw,720px);padding:16px">
    <button class="close" id="closeLearned" style="float:right;border:1px solid #e5e7eb;padding:4px 8px;border-radius:8px;background:#fff">Close</button>
    <h3 id="learnedTitle" style="margin:0 0 8px">Learned</h3>
    <div id="learnedBody" class="list-simple" style="border-top:1px dashed #ddd;margin-top:10px"></div>
    <div class="tools" style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="clearLearned" class="btn">Clear</button>
      <button id="printLearned" class="btn ok">Print</button>
    </div>
  </div>
</div>

<!-- Amazonアソシエイト（ページャー操作時のみ表示） -->
<div id="adMask" class="admask" aria-hidden="true">
  <div class="ad" role="dialog" aria-label="Amazon Associates">
    <button class="x" id="adClose" aria-label="Close">×</button>
    <h3><i class="fa-brands fa-amazon"></i> Recommended</h3>
    <div id="amznAdBox"></div>
    <small>Amazon Associates (Tracking ID: blog0c9-22)</small>
  </div>
</div>

<script>
/* ========= 設定 ========= */
const LEVELS = ['N5','N4','N3','N2','N1'];
const POS = [
  {k:'nouns', file:'nouns.json',          ja:'名詞',        enLabel:'Nouns'},
  {k:'verbs', file:'verbs.json',          ja:'動詞',        enLabel:'Verbs'},
  {k:'iadj',  file:'adjectives-i.json',   ja:'い形容詞',    enLabel:'i-Adjectives'},
  {k:'naadj', file:'adjectives-na.json',  ja:'な形容詞',    enLabel:'na-Adjectives'},
  {k:'advs',  file:'adverbs.json',        ja:'副詞',        enLabel:'Adverbs'},
  {k:'prt',   file:'particles.json',      ja:'助詞',        enLabel:'Particles'},
  {k:'conj',  file:'conjunctions.json',   ja:'接続詞',      enLabel:'Conjunctions'},
  {k:'interj',file:'interjections.json',  ja:'感動詞',      enLabel:'Interjections'},
  {k:'nums',  file:'numerals.json',       ja:'数詞',        enLabel:'Numerals'},
  {k:'pat',   file:'patterns.json',       ja:'文型',        enLabel:'Patterns'},
];
let level='N5', posKey='verbs', page=1;
const PAGE_SIZE=5, MAX_TOTAL=30;  // ★ 合計30件まで
let lastData=[];
let uiLang='en';                   // 'en' or 'ja'
const enFirstOrder=['en','ja','kana','ro'];

/* ========= ユーティリティ ========= */
function buildPath(lvl=level, pk=posKey){
  return `data/json/${lvl}/${POS.find(p=>p.k===pk).file}`;
}
function coerceArray(json){
  if (Array.isArray(json)) return json;
  const keys=['items','data','entries','list','rows','result','results'];
  for(const k of keys){ if(json && Array.isArray(json[k])) return json[k]; }
  if(json && typeof json==='object'){
    const vals=Object.values(json);
    if(vals.length && vals.every(v=>typeof v==='object')) return vals;
  }
  return [];
}

/* ========= Learned ========= */
const LS_KEY = ()=>`nt_learned_${level}_${posKey}`;
function learnedSet(){return new Set(JSON.parse(localStorage.getItem(LS_KEY())||'[]'));}
function setLearned(s){localStorage.setItem(LS_KEY(),JSON.stringify([...s]));}

/* ========= Learned モーダル ========= */
function openLearned(){
  const modal=document.getElementById('learnedModal');
  const body=document.getElementById('learnedBody');
  const s=learnedSet();
  body.innerHTML='';
  const rows=(lastData||[]).filter(x=>s.has(x.id));
  if(rows.length===0){
    body.innerHTML=`<div class="row" style="color:#6b7280">${uiLang==='en'?'No items yet.':'まだありません。'}</div>`;
  }else{
    rows.forEach((x,i)=>{
      const r=document.createElement('div');
      r.className='row';
      r.textContent=`${i+1}. ${x.ja||''} / ${x.kana||''} / ${x.ro||''} — ${x.en||''}`;
      body.appendChild(r);
    });
  }
  modal.style.display='flex';
}
document.getElementById('closeLearned').onclick=()=>document.getElementById('learnedModal').style.display='none';
document.getElementById('learnedModal').addEventListener('click',e=>{
  if(e.target.id==='learnedModal') e.currentTarget.style.display='none';
});
document.getElementById('clearLearned').onclick=()=>{ localStorage.setItem(LS_KEY(),'[]'); openLearned(); };
document.getElementById('printLearned').onclick=()=>{
  const s=learnedSet(); if(!s.size){ alert('No learned items.'); return; }
  const w=open('','_blank'); const rows=(lastData||[]).filter(x=>s.has(x.id));
  w.document.write('<!doctype html><meta charset="utf-8"><title>Learned</title><style>body{font:14px system-ui;padding:20px}.row{border-bottom:1px dashed #ccc;padding:6px 0}</style><h1>Learned</h1>');
  rows.forEach((x,i)=>w.document.write(`<div class="row">${i+1}. <strong>${x.ja||''}</strong> / ${x.kana||''} / ${x.ro||''} — ${x.en||''}</div>`));
  w.document.close(); w.print();
};

/* ========= Partials & 言語トグル ========= */
function bindLangToggle(root){
  const btn = root.querySelector('#langToggle, [data-lang-toggle], .lang-toggle') || document.getElementById('langToggleFallback');
  if(!btn) return;
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    uiLang = (uiLang==='en') ? 'ja' : 'en';
    btn.textContent = (uiLang==='en') ? '日本語' : 'English';
    rebuildStaticLabels();
    renderList(lastData);
  });
}
async function injectPartials(){
  const hdr=document.getElementById('site-header');
  const ftr=document.getElementById('site-footer');
  try{
    const h=await fetch('partials/header.html',{cache:'no-store'}).then(r=>r.ok?r.text():Promise.reject());
    hdr.innerHTML=h;
  }catch(_){}
  try{
    const f=await fetch('partials/footer.html',{cache:'no-store'}).then(r=>r.ok?r.text():Promise.reject());
    ftr.innerHTML=f;
  }catch(_){}
  // 言語切替ボタンを確実に機能させる
  bindLangToggle(hdr);
  // Learned ボタンが無いテーマにも追加
  if(!document.getElementById('openLearnedTop')){
    const btn=document.createElement('button');
    btn.id='openLearnedTop'; btn.className='learnedIcon'; btn.type='button';
    btn.innerHTML='<i class="fa-solid fa-book-bookmark"></i>&nbsp;Learned';
    (hdr.querySelector('.header-right')||hdr).appendChild(btn);
  }
  document.getElementById('openLearnedTop').addEventListener('click', openLearned);
}

/* ========= ラベル再構築 ========= */
function rebuildStaticLabels(){
  buildChips();
  const kw=document.getElementById('kw');
  kw.placeholder = (uiLang==='en') ? 'Search across all levels & parts…' : 'レベル・品詞を横断して検索…';
  document.getElementById('learnedTitle').textContent = (uiLang==='en') ? 'Learned' : '覚えた一覧';
  document.getElementById('printBtn').textContent   = (uiLang==='en') ? 'Print Learned' : '覚えた一覧を印刷';
}

/* ========= フェッチ ========= */
async function fetchJsonSafe(path){
  try{
    const r=await fetch(path,{cache:'no-store'});
    if(!r.ok) return [];
    return coerceArray(await r.json());
  }catch(_){ return []; }
}

/* ========= UI要素 ========= */
const kw=document.getElementById('kw');
const list=document.getElementById('list');
const pager=document.getElementById('pager');
const chips=document.getElementById('posChips');

const toggleEN   = document.getElementById('toggleEN');
const toggleJA   = document.getElementById('toggleJA');
const toggleKANA = document.getElementById('toggleKANA');
const toggleRO   = document.getElementById('toggleRO');
[toggleEN,toggleJA,toggleKANA,toggleRO].forEach(el=>el.addEventListener('change',()=>renderList(lastData)));

kw.addEventListener('input', onSearchInput, {passive:true});
document.getElementById('levelSel').addEventListener('change', e=>{
  level=e.target.value; page=1; if(!kw.value.trim()) loadSingleAndRender(); else onSearchInput();
});
document.getElementById('printBtn').addEventListener('click', openLearned);

/* ========= 品詞チップ ========= */
function buildChips(){
  chips.innerHTML='';
  POS.forEach(p=>{
    const b=document.createElement('button');
    b.className='chip'+(p.k===posKey?' active':'');
    b.textContent=(uiLang==='en') ? p.enLabel : `${p.ja} / ${p.enLabel}`;
    b.onclick=()=>{posKey=p.k;page=1; if(!kw.value.trim()) loadSingleAndRender(); else onSearchInput(); buildChips();};
    chips.appendChild(b);
  });
}

/* ========= 通常表示（30件に制限） ========= */
const SAMPLE=[{"id":"demo-001","ja":"会う","kana":"あう","ro":"au","en":"meet","examples":[
  {"ja":"毎週友達に会います。","kana":"まいしゅう ともだち に あいます。","ro":"maishuu tomodachi ni aimasu.","en":"I meet my friends every week."},
  {"ja":"駅で先生に会いました。","kana":"えき で せんせい に あいました。","ro":"eki de sensei ni aimashita.","en":"I met my teacher at the station."}
]}];

async function loadSingleAndRender(){
  document.getElementById('meta').textContent=`Level: ${level} • Part: ${POS.find(p=>p.k===posKey).enLabel}`;
  let arr=await fetchJsonSafe(buildPath());
  // ★ 通常表示も最大30件に制限
  lastData = arr.length ? arr.slice(0, MAX_TOTAL) : SAMPLE;
  renderList(lastData);
  try{
    gtag('event','page_view',{page_title:`${level}/${posKey}`,page_location:location.href,page_path:location.pathname+location.search});
  }catch(_){}
}

/* ========= 横断検索（こちらは既にMAX_TOTALを適用） ========= */
let searchAbort=0;
async function onSearchInput(){
  const t=kw.value.trim().toLowerCase();
  if(!t){ page=1; loadSingleAndRender(); return; }

  const myId=++searchAbort;
  document.getElementById('meta').textContent = (uiLang==='en') ? 'Searching across all levels and parts…' : '全レベル・全品詞を横断して検索中…';

  const tasks=[];
  for(const lv of LEVELS){
    for(const p of POS){
      tasks.push(fetchJsonSafe(buildPath(lv,p.k)).then(arr=>arr.map(x=>({...x,_level:lv,_pos:p.enLabel,_posJa:p.ja}))));
    }
  }
  const chunks=await Promise.all(tasks);
  if(myId!==searchAbort) return;

  const joined=chunks.flat();
  const filtered=joined.filter(x=>{
    const hay=[
      x.en||'', x.ja||'', x.kana||'', x.ro||'',
      x._level||'', x._pos||'', x._posJa||'',
      ...(x.examples||[]).flatMap(e=>[e.en||'',e.ja||'',e.kana||'',e.ro||''])
    ].join(' ').toLowerCase();
    return hay.includes(t);
  });

  lastData=filtered.slice(0,MAX_TOTAL);
  page=1;
  document.getElementById('meta').textContent=(uiLang==='en')
    ? `Results: ${lastData.length} item(s) (showing up to ${MAX_TOTAL}).`
    : `検索結果: ${lastData.length} 件（最大 ${MAX_TOTAL} 件を表示）`;
  renderList(lastData);
}

/* ========= ページネーション & 描画 ========= */
function pageBtn(t,fn){const b=document.createElement('button');b.className='pagebtn';b.textContent=t;b.onclick=fn;return b;}

function paginate(data){
  const total=Math.max(1,Math.ceil(data.length/PAGE_SIZE));
  if(page>total)page=total;
  const start=(page-1)*PAGE_SIZE;
  const rows=data.slice(start,start+PAGE_SIZE);

  pager.innerHTML='';
  const prev=pageBtn('Prev',()=>{page--;renderList(lastData,true);showAdPopup();});
  prev.disabled=page<=1; pager.appendChild(prev);

  for(let i=1;i<=total;i++){
    const b=pageBtn(String(i),()=>{page=i;renderList(lastData,true);showAdPopup();});
    if(i===page) b.classList.add('active');
    pager.appendChild(b);
  }
  const next=pageBtn('Next',()=>{page++;renderList(lastData,true);showAdPopup();});
  next.disabled=page>=total; pager.appendChild(next);
  return rows;
}

function div(cls,txt){const d=document.createElement('div');d.className=cls;if(txt!=null)d.textContent=txt;return d;}

function renderList(data){
  list.innerHTML='';
  const base=Array.isArray(data)?data:[];
  const rows=paginate(base);
  if(!rows.length){
    pager.innerHTML='';
    list.innerHTML=`<div style="color:#6b7280; padding:12px 0;">${uiLang==='en'?'No items to show.':'表示できる項目がありません。'}</div>`;
    return;
  }
  let idx=(page-1)*PAGE_SIZE;
  rows.forEach(item=>{
    idx++;
    const card=document.createElement('article'); card.className='card';
    if(learnedSet().has(item.id)) card.classList.add('learned');

    const head=document.createElement('div'); head.className='head';
    const num=div('num',idx+'.');
    const tags=div('tags','');

    const tagMap={en:item.en, ja:item.ja, kana:item.kana, ro:item.ro};
    enFirstOrder.forEach(k=>{
      const v=tagMap[k]; if(v && String(v).trim()){
        const s=document.createElement('span'); s.className='tag '+k; s.textContent=v; tags.appendChild(s);
      }
    });

    const act=document.createElement('button');
    act.className='btn';
    act.textContent = learnedSet().has(item.id) ? (uiLang==='en'?'Unlearn':'覚えたを戻す') : (uiLang==='en'?'Learned':'覚えた');
    act.onclick=()=>toggleLearned(item,card,act);

    head.append(num,/**/tags,act);

    const body=div('content',''); body.dataset.examples='1';
    (item.examples||[]).forEach(ex=>{
      const parts=[];
      if(toggleEN.checked   && ex.en   ) parts.push(`<div class="en">${ex.en}</div>`);
      if(toggleJA.checked   && ex.ja   ) parts.push(`<div class="ja">${ex.ja}</div>`);
      if(toggleKANA.checked && ex.kana ) parts.push(`<div class="kana">${ex.kana}</div>`);
      if(toggleRO.checked   && ex.ro   ) parts.push(`<div class="ro">${ex.ro}</div>`);
      if(parts.length){ const block=div('line',''); block.innerHTML=parts.join(''); body.appendChild(block); }
    });

    card.append(head,body); list.appendChild(card);
    if(learnedSet().has(item.id)) body.style.display='none';
  });

  const posLabel=POS.find(p=>p.k===posKey);
  document.getElementById('meta').textContent=(uiLang==='en')
    ? `Level: ${level} • Part: ${posLabel.enLabel}`
    : `レベル: ${level} • 品詞: ${posLabel.ja}`;
}

function toggleLearned(item,card,btnEl){
  const s=learnedSet();
  const body=card.querySelector('[data-examples]');
  if(s.has(item.id)){
    s.delete(item.id); card.classList.remove('learned'); body.style.display=''; if(btnEl) btnEl.textContent=(uiLang==='en'?'Learned':'覚えた');
  }else{
    s.add(item.id); card.classList.add('learned'); body.style.display='none'; if(btnEl) btnEl.textContent=(uiLang==='en'?'Unlearn':'覚えたを戻す');
  }
  setLearned(s);
}

/* ========= Amazon Associates（ページャー時のみ） ========= */
const adMask=document.getElementById('adMask'), adClose=document.getElementById('adClose');
let amazonBooted=false;
function showAdPopup(){
  adMask.classList.add('show');
  if(!amazonBooted){
    amazonBooted=true;
    const cfg=document.createElement('script');
    cfg.type='text/javascript';
    cfg.text=`
      amzn_assoc_placement="adunit0";
      amzn_assoc_tracking_id="blog0c9-22";
      amzn_assoc_ad_mode="search";
      amzn_assoc_ad_type="smart";
      amzn_assoc_marketplace="amazon";
      amzn_assoc_region="JP";
      amzn_assoc_default_search_phrase="Japanese learning";
      amzn_assoc_default_category="All";
    `;
    const js=document.createElement('script');
    js.async=true;
    // ★ https 明示（ERR_NAME_NOT_RESOLVED対策）
    js.src="https://z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=JP";
    const box=document.getElementById('amznAdBox');
    box.appendChild(cfg); box.appendChild(js);
  }
}
adClose.onclick=()=>adMask.classList.remove('show');
adMask.addEventListener('click',e=>{ if(e.target===adMask) adMask.classList.remove('show'); });

/* ========= 初期化 ========= */
(async function init(){
  await injectPartials();
  rebuildStaticLabels();
  buildChips();
  await loadSingleAndRender();
})();
</script>
</body>
</html>
