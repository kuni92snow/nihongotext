<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>nihongotext.com — JLPT Explorer</title>
<link rel="icon" href="/favicon.ico" />
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --brand:#e6462d; --text:#222; --muted:#666; --line:#eee;
    --bg:#fff; --badge:#fff;
  }
  body{margin:0;background:#fafafa;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  .container{max-width:1100px;margin:0 auto;padding:16px;}
  a{color:var(--brand);text-decoration:none}
  .site-header{background:#fff;border-bottom:1px solid var(--line);position:relative;z-index:30}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .pill{border:1px solid #ddd;background:#fff;border-radius:10px;padding:6px 10px}
  .btn{border:1px solid #ddd;background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
  .btn:hover{box-shadow:0 1px 0 rgba(0,0,0,.06)}
  .btn.brand{border-color:var(--brand);color:#fff;background:var(--brand)}
  .btn.ghost{border-color:#ddd;background:#fff}
  .btn.small{padding:4px 8px;font-size:12px}
  .badge{min-width:18px;height:18px;padding:0 6px;border-radius:9px;background:var(--brand);color:#fff;font-size:12px;display:inline-flex;align-items:center;justify-content:center}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .list{display:grid;gap:10px}
  .twoline{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .seg-title{font-size:12px;color:var(--muted);margin:0 0 6px}
  details>summary{cursor:pointer;list-style:none}
  details>summary::-webkit-details-marker{display:none}
  summary .chev{transition:transform .2s}
  details[open] summary .chev{transform:rotate(180deg)}
  .pager{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:12px}
  .pager .page{border:1px solid #ddd;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
  .pager .page[aria-current="page"]{background:var(--brand);color:#fff;border-color:var(--brand)}
  .row-split{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .hidden{display:none!important}

  /* Learning drawer */
  #learning-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:40}
  #learning-drawer{position:fixed;top:0;right:-560px;width:560px;max-width:96vw;height:100%;
    background:#fff;box-shadow:-12px 0 24px rgba(0,0,0,.12);z-index:50;display:flex;flex-direction:column;transition:right .25s ease}
  ruby rt{font-size:.7em;color:#444}
</style>
</head>
<body>

<!-- ====== Header / Learning Drawer ====== -->
<header class="site-header">
  <div class="container" style="display:flex;flex-direction:column;gap:8px;">
    <!-- 1行目：タイトル -->
    <div class="row">
      <a href="/" style="display:flex;align-items:center;gap:8px;text-decoration:none;">
        <img src="/icon-512.png" alt="nihongotext logo" style="width:28px;height:28px;border-radius:6px" />
        <span style="font-weight:700;font-size:20px;color:var(--brand)">nihongotext<span style="color:#333">.com</span></span>
      </a>
    </div>

    <!-- 2行目：ナビ -->
    <nav class="row" aria-label="Main navigation">
      <a href="/" style="color:#333">Home</a>
      <a href="/blog/index.html" style="color:#333">Blog</a>
      <a href="/inquiry/index.html" style="color:#333">Inquiry</a>
      <a href="/legal.html" style="color:#333">Legal</a>
      <a href="/privacy.html" style="color:#333">Privacy</a>

      <!-- Learning（常に開けるフォールバック付き） -->
      <button id="learnBtn" type="button" class="btn"
        title="Learning list"
        onclick="(window._ntxOpenLearning ? window._ntxOpenLearning() : (function(){var o=document.getElementById('learning-overlay'), d=document.getElementById('learning-drawer'); if(o&&d){o.style.display='block'; setTimeout(function(){d.style.right='0';},10);} })())">
        <i class="fa-solid fa-book-open" style="color:var(--brand)"></i>
        <span>Learning</span>
        <span id="learning-count-badge" class="badge">0</span>
      </button>
    </nav>

    <!-- 3行目：アイコン -->
    <nav class="row" aria-label="Header icons" style="font-size:20px">
      <a href="https://x.com/nihongotext" target="_blank" rel="noopener" title="X (Twitter)" aria-label="X (Twitter)" style="color:var(--brand)"><i class="fa-brands fa-x-twitter"></i></a>
      <a href="https://www.reddit.com/user/nihongotext" target="_blank" rel="noopener" title="Reddit" aria-label="Reddit" style="color:var(--brand)"><i class="fa-brands fa-reddit-alien"></i></a>
      <a href="https://medium.com/@nihongotext" target="_blank" rel="noopener" title="Medium" aria-label="Medium" style="color:var(--brand)"><i class="fa-brands fa-medium"></i></a>
      <a href="https://ko-fi.com/nihongotext" target="_blank" rel="noopener" title="Ko-fi" aria-label="Ko-fi" style="color:var(--brand)"><i class="fa-solid fa-mug-hot"></i></a>
      <a href="https://nihongotext.substack.com/" target="_blank" rel="noopener" title="Substack" aria-label="Substack" style="color:var(--brand)"><i class="fa-solid fa-newspaper"></i></a>
      <a href="/privacy.html" title="Privacy Policy" aria-label="Privacy Policy" style="color:var(--brand)"><i class="fa-solid fa-user-shield"></i></a>
      <a href="/legal.html" title="Legal Notice" aria-label="Legal Notice" style="color:var(--brand)"><i class="fa-solid fa-scale-balanced"></i></a>
    </nav>
  </div>

  <!-- Overlay + Drawer -->
  <div id="learning-overlay"></div>
  <aside id="learning-drawer">
    <div style="display:flex;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)">
      <h2 style="margin:0;font-size:18px;display:flex;align-items:center;gap:8px;">
        <i class="fa-solid fa-book-open" style="color:var(--brand)"></i> Learning
        <span id="learning-count" style="color:var(--muted);font-size:13px"></span>
      </h2>
      <button id="btn-close-learning" class="btn" title="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <!-- Learning 表示エリア -->
    <div id="learning-controls" class="container" style="padding:12px 16px;border-bottom:1px dashed var(--line)">
      <!-- 表示切替（2段） -->
      <div class="row-split">
        <label class="pill"><input type="checkbox" id="LshowJa"  checked> Nihongo（漢字＋ふりがな）</label>
        <label class="pill"><input type="checkbox" id="LshowKana" checked> Hiragana</label>
      </div>
      <div class="row-split" style="margin-top:6px">
        <label class="pill"><input type="checkbox" id="LshowRo"   checked> Alphabet（Romaji）</label>
        <label class="pill"><input type="checkbox" id="LshowEn"   checked> English</label>
      </div>
    </div>

    <div id="learning-content" class="container" style="overflow:auto;flex:1;padding-top:0">
      <div id="learning-list" class="list"></div>

      <!-- Quiz placeholder -->
      <section style="margin-top:18px;border-top:1px dashed var(--line);padding-top:12px">
        <h3 style="font-size:16px;margin:0 0 8px"><i class="fa-solid fa-circle-question" style="color:var(--brand)"></i> Quiz (coming soon)</h3>
        <p style="margin:0;color:var(--muted)">You will be able to test the items currently in Learning here.</p>
      </section>
    </div>
  </aside>
</header>

<!-- ====== Main ====== -->
<main class="container" id="app">
  <!-- フィルター -->
  <section class="card" style="margin-top:12px">
    <div class="row" style="justify-content:space-between;align-items:end">
      <div class="row" style="gap:8px">
        <label class="pill">Level
          <select id="selLevel" class="pill" style="margin-left:6px">
            <option value="N5">N5</option>
            <option value="N4">N4</option>
            <option value="N3">N3</option>
            <option value="N2">N2</option>
            <option value="N1">N1</option>
          </select>
        </label>

        <label class="pill">Part
          <select id="selPart" class="pill" style="margin-left:6px">
            <option value="verbs">verbs</option>
            <option value="nouns">nouns</option>
            <option value="adjectives-i">adjectives-i</option>
            <option value="adjectives-na">adjectives-na</option>
            <option value="adverbs">adverbs</option>
            <option value="particles">particles</option>
            <option value="connectives">connectives</option>
          </select>
        </label>
      </div>

      <!-- 表示切替（2段） -->
      <div style="min-width:320px">
        <div class="row-split">
          <label class="pill"><input type="checkbox" id="showJa"  checked> Nihongo（漢字＋ふりがな）</label>
          <label class="pill"><input type="checkbox" id="showKana" checked> Hiragana</label>
        </div>
        <div class="row-split" style="margin-top:6px">
          <label class="pill"><input type="checkbox" id="showRo"   checked> Alphabet（Romaji）</label>
          <label class="pill"><input type="checkbox" id="showEn"   checked> English</label>
        </div>
      </div>
    </div>
  </section>

  <!-- リスト -->
  <section class="list" id="list" style="margin-top:12px"></section>

  <!-- Pager -->
  <nav class="pager" id="pager" aria-label="Pagination" style="margin-bottom:24px"></nav>
</main>

<script>
/* ==========================================================
   nihongotext.com  — Main Script (production)
   - Data: /data/json/{Level}/{part}.json
   - Furigana override: /data/segments/{Level}/{part}.json (optional)
   - Pagination: 5 items/page
   - Learning/Learned: localStorage (ntx_learning_v2 / ntx_learned_v2)
   ========================================================== */

(function(){
  const PER_PAGE = 5;
  const KEY_LEARNING = 'ntx_learning_v2';
  const KEY_LEARNED  = 'ntx_learned_v2';

  // --- state ---
  let state = {
    level: 'N5',
    part: 'verbs',
    items: [],
    segments: {},  // { id: [{w:'会', r:'かい'}, {w:'う', r:'う'}], ... }
    page: 1,
    show: {ja:true,kana:true,ro:true,en:true},
    Lshow: {ja:true,kana:true,ro:true,en:true},
  };

  // ========== Storage helpers ==========
  const S = {
    read(k){ try { return JSON.parse(localStorage.getItem(k) || '[]'); } catch { return []; } },
    write(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
    has(k, id){ return S.read(k).some(x=>String(x.id)===String(id)); },
    add(k, item){
      const map=new Map(S.read(k).map(x=>[String(x.id),x]));
      map.set(String(item.id), item);
      S.write(k, [...map.values()]);
      window.dispatchEvent(new StorageEvent('storage',{key:k}));
    },
    remove(k, id){
      const next=S.read(k).filter(x=>String(x.id)!==String(id));
      S.write(k,next);
      window.dispatchEvent(new StorageEvent('storage',{key:k}));
    }
  };

  // ========== Furigana ==========
  // 1) 完全厳密：segments に id があればその配列を <ruby>化
  // 2) フォールバック：雑だが ja と kana を丸ごと <ruby> 1 つ
  function rubyFromSegments(id, ja, kana){
    const seg = state.segments[id];
    if (Array.isArray(seg) && seg.length){
      // seg: [{w:'会', r:'かい'}, ...] OR [{w:'会う', r:'あう'}...]
      return seg.map(s=>{
        const w = s.w ?? '';
        const r = s.r ?? '';
        if(!w) return '';
        if(r && /[一-龥々〆ヵヶ]/.test(w)){ // 目立つ漢字にだけ rt
          return `<ruby>${escapeHtml(w)}<rt>${escapeHtml(r)}</rt></ruby>`;
        } else {
          // 読みが同形か、平仮名のみなどはそのまま
          return escapeHtml(w);
        }
      }).join('');
    }
    // fallback: 全体を1つの ruby
    return `<ruby>${escapeHtml(ja)}<rt>${escapeHtml(kana)}</rt></ruby>`;
  }

  function escapeHtml(s){ return String(s??'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ========== Fetchers ==========
  async function fetchJson(url){
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  async function loadData(){
    const {level, part} = state;
    const dataUrl = `/data/json/${level}/${part}.json`;
    const segUrl  = `/data/segments/${level}/${part}.json`; // 任意

    // データ
    try{
      state.items = await fetchJson(dataUrl);
    }catch(e){
      console.warn('Data load failed, fallback to N5/verbs', e);
      state.items = await fetchJson('/data/json/N5/verbs.json');
    }

    // 30件まで（ご要望）
    if (Array.isArray(state.items)) state.items = state.items.slice(0, 30);

    // segments（任意）
    try{
      const seg = await fetchJson(segUrl);
      // 期待形式： { "n5-v-001":[{w:"会",r:"かい"},{w:"う",r:"う"}], ... }
      state.segments = (seg && typeof seg==='object') ? seg : {};
    }catch(e){
      state.segments = {};
    }

    state.page = 1;
    renderList();
    updatePager();
  }

  // ========== Render main list ==========
  function renderList(){
    const root = document.getElementById('list');
    const {page, show} = state;
    const start = (page-1)*PER_PAGE;
    const rows = state.items.slice(start, start+PER_PAGE);

    root.innerHTML = rows.map(item=>{
      const id    = item.id ?? '';
      const ja    = item.ja ?? '';
      const kana  = item.kana ?? '';
      const ro    = item.ro ?? '';
      const en    = item.en ?? '';
      const exs   = Array.isArray(item.examples) ? item.examples : [];

      const line1 = `<div class="seg-title">${escapeHtml(state.level)}・${escapeHtml(state.part)}</div>`;
      const line2 = show.ja   ? `<div>${rubyFromSegments(id,ja,kana)}</div>` : '';
      const line3 = show.kana ? `<div style="color:var(--muted)">${escapeHtml(kana)}</div>` : '';
      const line4 = show.ro   ? `<div style="color:var(--muted)">${escapeHtml(ro)}</div>` : '';
      const line5 = show.en   ? `<div>${escapeHtml(en)}</div>` : '';

      const learnButtons = `
        <div class="row" style="gap:6px;justify-content:flex-end">
          <button class="btn small ghost" data-act="toLearn"   data-id="${escapeHtml(id)}">Learn</button>
          <button class="btn small ghost" data-act="toLearned" data-id="${escapeHtml(id)}">Learned</button>
        </div>`;

      const examples = exs.map((e,i)=>{
        const ej = e.ja ?? ''; const ek = e.kana ?? ''; const er = e.ro ?? ''; const ee = e.en ?? '';
        return `<li class="card" style="padding:8px">
          ${show.ja?`<div>${escapeHtml(ej)}</div>`:''}
          ${show.kana?`<div style="color:var(--muted)">${escapeHtml(ek)}</div>`:''}
          ${show.ro?`<div style="color:var(--muted)">${escapeHtml(er)}</div>`:''}
          ${show.en?`<div>${escapeHtml(ee)}</div>`:''}
        </li>`;
      }).join('');

      const exBlock = `
        <details>
          <summary class="row" style="gap:6px"><span>Examples</span><i class="fa-solid fa-chevron-down chev" style="font-size:12px;color:var(--muted)"></i></summary>
          <ul style="margin:8px 0 0;padding-left:18px">${examples || '<li style="color:var(--muted)">No examples</li>'}</ul>
        </details>`;

      return `<article class="card" data-id="${escapeHtml(id)}">
        <div class="twoline" style="align-items:start">
          <div>
            ${line1}${line2}${line3}${line4}${line5}
          </div>
          <div>${learnButtons}</div>
        </div>
        <div style="margin-top:8px">${exBlock}</div>
      </article>`;
    }).join('');

    // ボタンの委任
    root.querySelectorAll('[data-act]').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        const id  = ev.currentTarget.getAttribute('data-id');
        const act = ev.currentTarget.getAttribute('data-act');
        const item = state.items.find(x=>String(x.id)===String(id));
        if(!item) return;

        if(act==='toLearn'){
          S.remove(KEY_LEARNED, id);
          S.add(KEY_LEARNING, item);
        }else if(act==='toLearned'){
          S.remove(KEY_LEARNING, id);
          S.add(KEY_LEARNED, item);
        }
        updateLearningBadges();
        // Learning ドロワー表示中なら再描画
        if (document.getElementById('learning-overlay').style.display==='block'){
          renderLearning();
        }
      });
    });
  }

  // ========== Pager ==========
  function updatePager(){
    const total = state.items.length;
    const pages = Math.max(1, Math.ceil(total / PER_PAGE));
    const nav = document.getElementById('pager');
    const mk = (p) => `<button class="page" ${p===state.page?'aria-current="page"':''} data-page="${p}">${p}</button>`;
    nav.innerHTML = (Array.from({length:pages}, (_,i)=>mk(i+1))).join('');
    nav.querySelectorAll('.page').forEach(b=>{
      b.addEventListener('click', (ev)=>{
        state.page = Number(ev.currentTarget.getAttribute('data-page'));
        renderList(); updatePager();
        window.scrollTo({top:0,behavior:'smooth'});
      });
    });
  }

  // ========== Learning Drawer ==========
  function updateLearningBadges(){
    const n = new Map([...S.read(KEY_LEARNING), ...S.read(KEY_LEARNED)].map(x=>[String(x.id),1])).size;
    const b = document.getElementById('learning-count-badge');
    const c = document.getElementById('learning-count');
    if(b) b.textContent = n;
    if(c) c.textContent = `(${n})`;
  }

  function renderLearning(){
    const root = document.getElementById('learning-list');
    const show = state.Lshow;
    const L = S.read(KEY_LEARNING);
    if(!L.length){
      root.innerHTML = `<p style="color:var(--muted)">No items in Learning yet. Use the <b>Learn</b> button to add words here.</p>`;
      updateLearningBadges(); return;
    }

    root.innerHTML = L.map(item=>{
      const id    = item.id ?? '';
      const ja    = item.ja ?? '';
      const kana  = item.kana ?? '';
      const ro    = item.ro ?? '';
      const en    = item.en ?? '';
      const exs   = Array.isArray(item.examples) ? item.examples : [];

      const line1 = `<div class="seg-title">${escapeHtml(state.level)}・${escapeHtml(state.part)}</div>`;
      const line2 = show.ja   ? `<div>${rubyFromSegments(id,ja,kana)}</div>` : '';
      const line3 = show.kana ? `<div style="color:var(--muted)">${escapeHtml(kana)}</div>` : '';
      const line4 = show.ro   ? `<div style="color:var(--muted)">${escapeHtml(ro)}</div>` : '';
      const line5 = show.en   ? `<div>${escapeHtml(en)}</div>` : '';

      const examples = exs.map((e,i)=>{
        const ej = e.ja ?? ''; const ek = e.kana ?? ''; const er = e.ro ?? ''; const ee = e.en ?? '';
        return `<li class="card" style="padding:8px">
          ${show.ja?`<div>${escapeHtml(ej)}</div>`:''}
          ${show.kana?`<div style="color:var(--muted)">${escapeHtml(ek)}</div>`:''}
          ${show.ro?`<div style="color:var(--muted)">${escapeHtml(er)}</div>`:''}
          ${show.en?`<div>${escapeHtml(ee)}</div>`:''}
        </li>`;
      }).join('');

      return `<article class="card" data-id="${escapeHtml(id)}">
        <div class="row" style="justify-content:space-between;align-items:start;gap:8px">
          <div style="flex:1 1 auto;min-width:0">
            ${line1}${line2}${line3}${line4}${line5}
          </div>
          <div style="flex:0 0 auto">
            <div class="row" style="gap:6px">
              <button class="btn small ghost" data-Lact="backToLearn" data-id="${escapeHtml(id)}" title="Move back to Learn">learn</button>
              <button class="btn small brand" data-Lact="toLearned"   data-id="${escapeHtml(id)}" title="Move to Learned">learned</button>
            </div>
          </div>
        </div>
        <details style="margin-top:8px">
          <summary class="row" style="gap:6px"><span>Examples</span><i class="fa-solid fa-chevron-down chev" style="font-size:12px;color:var(--muted)"></i></summary>
          <ul style="margin:8px 0 0;padding-left:18px">${examples || '<li style="color:var(--muted)">No examples</li>'}</ul>
        </details>
      </article>`;
    }).join('');

    // 操作
    root.querySelectorAll('[data-Lact]').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        const id  = ev.currentTarget.getAttribute('data-id');
        const act = ev.currentTarget.getAttribute('data-Lact');
        const L = S.read(KEY_LEARNING);
        const item = L.find(x=>String(x.id)===String(id)) || state.items.find(x=>String(x.id)===String(id));
        if(!item) return;
        if(act==='backToLearn'){
          // Learning内では「learn」 = 何もしない…ではなく「ここに置く」意味なので実処理なしでOK
          // ただし Learned にあれば戻す
          S.remove(KEY_LEARNED, id);
          S.add(KEY_LEARNING, item);
        }else if(act==='toLearned'){
          S.remove(KEY_LEARNING, id);
          S.add(KEY_LEARNED, item);
        }
        renderLearning();
        updateLearningBadges();
      });
    });

    updateLearningBadges();
  }

  function openLearning(){ 
    document.getElementById('learning-overlay').style.display='block';
    const d=document.getElementById('learning-drawer'); d.style.right='0';
    renderLearning();
  }
  function closeLearning(){
    const o=document.getElementById('learning-overlay'), d=document.getElementById('learning-drawer');
    d.style.right='-560px'; setTimeout(()=>o.style.display='none',250);
  }

  // expose
  window._ntxOpenLearning = openLearning;
  window._ntxCloseLearning = closeLearning;

  // ========== UI bindings ==========
  document.getElementById('btn-close-learning').addEventListener('click', closeLearning);
  document.getElementById('learning-overlay').addEventListener('click', closeLearning);

  // Main toggles
  ['showJa','showKana','showRo','showEn'].forEach(id=>{
    document.getElementById(id).addEventListener('change', (e)=>{
      state.show[id.replace('show','').toLowerCase()] = e.currentTarget.checked;
      renderList();
    });
  });

  // Learning toggles
  ['LshowJa','LshowKana','LshowRo','LshowEn'].forEach(id=>{
    document.getElementById(id).addEventListener('change', (e)=>{
      state.Lshow[id.replace('Lshow','').toLowerCase()] = e.currentTarget.checked;
      renderLearning();
    });
  });

  // Level/Part selector
  document.getElementById('selLevel').addEventListener('change', (e)=>{ state.level=e.target.value; loadData(); });
  document.getElementById('selPart').addEventListener('change',  (e)=>{ state.part=e.target.value;  loadData(); });

  // cross-tab sync
  window.addEventListener('storage', ev=>{
    if (ev && (ev.key===KEY_LEARNING || ev.key===KEY_LEARNED)) {
      updateLearningBadges();
      if (document.getElementById('learning-overlay').style.display==='block') renderLearning();
    }
  });

  // 初期化
  (function init(){
    // URLクエリ ?level=N5&part=verbs
    const sp = new URLSearchParams(location.search);
    const qLevel = sp.get('level'); const qPart = sp.get('part');
    if (qLevel) state.level = qLevel.toUpperCase();
    if (qPart)  state.part  = qPart;

    document.getElementById('selLevel').value = state.level;
    document.getElementById('selPart').value  = state.part;
    loadData();
    updateLearningBadges();
  })();

})();
</script>
</body>
</html>
