<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JLPT — Words | nihongotext.com</title>
  <base href="/" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root { --brand:#e6462d; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; color:#333; }
    .container { max-width:1100px; margin:0 auto; padding:20px 16px; }
    h1 { margin:12px 0 16px; font-size:22px; }
    .toolbar { display:grid; grid-template-columns:1fr; gap:10px; margin-bottom:14px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .row label { font-size:14px; display:flex; align-items:center; gap:6px; }
    select { padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#fff; }
    .word-card { border:1px solid #eee; border-radius:12px; background:#fff; padding:14px; margin-bottom:12px; }
    .meta { color:#666; font-size:12px; margin-bottom:6px; }
    .line { margin:2px 0; }
    .line strong { font-weight:700; }
    ruby rt { font-size:.65em; color:#666; }
    .btn { border:1px solid #ddd; background:#fff; border-radius:8px; padding:4px 10px; cursor:pointer; }
    .btn:hover { background:#f8f8f8; }
    .word-actions { margin-top:8px; display:flex; gap:8px; align-items:center; }
    .toggle { color:var(--brand); cursor:pointer; font-size:14px; }
    .examples { display:none; padding-left:10px; margin-top:6px; }
    .examples .ex { margin:6px 0; }
    .notice { padding:10px; border:1px dashed #eee; border-radius:8px; color:#666; }
  </style>
</head>

<body>
  <!-- Header -->
  <div id="header-placeholder"></div>

  <main class="container">
    <h1>JLPT — Words</h1>

    <!-- ツールバー -->
    <section class="toolbar" aria-label="Filters">
      <div class="row">
        <label>Level
          <select id="level">
            <option>N5</option><option>N4</option><option>N3</option><option>N2</option><option>N1</option>
          </select>
        </label>
        <label>Part
          <select id="part">
            <option value="verbs">verbs</option>
            <option value="nouns">nouns</option>
            <option value="adjectives-i">adjectives-i</option>
            <option value="adjectives-na">adjectives-na</option>
            <option value="adverbs">adverbs</option>
            <option value="particles">particles</option>
            <option value="conjunctions">conjunctions</option>
          </select>
        </label>
      </div>

      <!-- 表示切替（2行） -->
      <div class="row">
        <label><input type="checkbox" id="show-ja" checked /> Nihongo（漢字＋ふりがな）</label>
        <label><input type="checkbox" id="show-kana" checked /> Hiragana</label>
      </div>
      <div class="row">
        <label><input type="checkbox" id="show-ro" checked /> Alphabet（romaji）</label>
        <label><input type="checkbox" id="show-en" checked /> English</label>
      </div>
    </section>

    <div id="word-list"></div>
    <p class="notice" id="limit-note" style="display:none;">Showing up to 30 items for this part. More will be added later.</p>
  </main>

  <!-- Footer -->
  <div id="footer-placeholder"></div>

  <script>
    // ---------- Partials ----------
    Promise.all([
      fetch('/partials/header.html').then(r=>r.text()),
      fetch('/partials/footer.html').then(r=>r.text())
    ]).then(([h,f])=>{
      document.getElementById('header-placeholder').innerHTML = h;
      document.getElementById('footer-placeholder').innerHTML = f;
    });

    // ---------- Helpers ----------
    const $ = s => document.querySelector(s);
    const MAX_ITEMS = 30;

    function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // 文字クラス
    const RE_KANJI = /[\u4E00-\u9FFF\u3400-\u4DBF]/;               // CJK
    const RE_HIRA  = /[\u3040-\u309F]/;
    const RE_KATA  = /[\u30A0-\u30FF]/;
    const isKanji = ch => RE_KANJI.test(ch);
    const isKana  = ch => RE_HIRA.test(ch) || RE_KATA.test(ch);

    // ---- 厳密ルビ：segments があればそれを優先 ----
    function rubyFromSegments(segs){
      return segs.map(s=>{
        const rb = esc(s.rb ?? '');
        const rt = esc(s.rt ?? '');
        if(!rb) return '';
        if(!rt) return rb;               // 読み無し（助詞など）
        return `<ruby>${rb}<rt>${rt}</rt></ruby>`;
      }).join('');
    }

    // ---- 自動アライン（語ブロック単位の高精度推定）----
    // 方針：
    // 1) 日本語表記を「[KANJI連続]」「かな/記号」ブロックに分割
    // 2) 読み(kana)から「非かな」を除去しポインタ進行
    // 3) KANJIブロックには、直後のかな・既知の送り仮名を考慮してできる限り対応部分を割り当て
    //    例: 開ける(あける) → 「開」=あ, 「ける」=素文字
    function rubyAutoAlign(ja, kana){
      if(!ja) return '';
      if(!kana) return esc(ja);

      const kanaOnly = Array.from(kana).filter(ch=>isKana(ch)).join('');

      // ja をブロック分割
      const blocks = [];
      let cur = '', curType = null;
      for(const ch of Array.from(ja)){
        const t = isKanji(ch) ? 'K' : (isKana(ch)? 'A' : 'O'); // K:漢字, A:かな, O:その他
        if(cur && t===curType){ cur += ch; }
        else { if(cur) blocks.push({t:curType, s:cur}); cur=ch; curType=t; }
      }
      if(cur) blocks.push({t:curType, s:cur});

      // kana ポインタ
      let kp = 0;
      const K = Array.from(kanaOnly);

      const out = [];

      for(const b of blocks){
        if(b.t === 'K'){ // 連続漢字ブロックに読みを割り当て
          // 次のブロックが かな(A) であれば、それは送り仮名の可能性が高い
          // → 今の漢字ブロック用の読みは、次のAブロック長を除いた分を優先的に取る
          // ただし読みが尽きることを避け、最低1文字は割り当てる
          // 緩和：読みが余れば全部付けてもOK（語単位ルビ）
          let read = '';
          // 送り仮名見込み
          // 直後の A ブロックの長さ（例：「開」+「ける」）
          // ただし漢字ブロックが2文字以上（例：学校）で送り仮名なしなら全読みをまとめて充てる
          // ここでは簡易に「次ブロックがAなら、その長さ分は後ろに残す」方法を取る
          const nextA = (blocks[blocks.indexOf(b)+1] && blocks[blocks.indexOf(b)+1].t==='A') ? Array.from(blocks[blocks.indexOf(b)+1].s).length : 0;
          const remain = K.length - kp - nextA;
          const take = Math.max(1, remain); // 最低1文字

          read = K.slice(kp, kp+take).join('');
          kp += take;

          out.push(`<ruby>${esc(b.s)}<rt>${esc(read)}</rt></ruby>`);
        } else if(b.t === 'A'){ // 素のかなはそのまま
          out.push(esc(b.s));
        } else { // 記号など
          out.push(esc(b.s));
        }
      }
      // 残った読みは無視（句読点等に由来することがある）
      return out.join('');
    }

    function jaWithStrictRuby(item){
      // 1) segments があれば完全厳密
      if(Array.isArray(item.segments) && item.segments.length){
        return rubyFromSegments(item.segments);
      }
      // 2) 無ければ自動アライン（語ブロックごと）
      return rubyAutoAlign(item.ja, item.kana);
    }

    // LocalStorage：Learn / Learned（ID配列）
    const LS_LEARNING = 'nihongo_learning';
    const LS_LEARNED  = 'nihongo_learned';
    function pushUnique(key, id){
      const arr = JSON.parse(localStorage.getItem(key)||'[]');
      if(!arr.includes(id)){ arr.push(id); localStorage.setItem(key, JSON.stringify(arr)); }
    }

    // ---------- Data load ----------
    const levelSel = document.getElementById('level');
    const partSel  = document.getElementById('part');

    // URLパラメータから初期値
    const q = new URLSearchParams(location.search);
    if(q.get('level')) levelSel.value = q.get('level');
    if(q.get('part'))  partSel.value  = q.get('part');

    levelSel.addEventListener('change', syncAndLoad);
    partSel .addEventListener('change', syncAndLoad);
    ['show-ja','show-kana','show-ro','show-en'].forEach(id=>{
      document.getElementById(id).addEventListener('change', render);
    });

    let DATA = [];

    async function syncAndLoad(){
      const level = levelSel.value;
      const part  = partSel.value;
      const url = `/data/json/${level}/${part}.json`;
      const u = new URL(location.href);
      u.searchParams.set('level', level);
      u.searchParams.set('part',  part);
      history.replaceState(null, '', u);

      try{
        const res = await fetch(url, {cache:'no-cache'});
        if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
        DATA = await res.json();
        render();
      }catch(e){
        console.error(e);
        document.getElementById('word-list').innerHTML =
          `<p style="color:#c00;">Failed to load dataset. Check <code>${url}</code>.</p>`;
      }
    }

    function render(){
      if(!Array.isArray(DATA)){ document.getElementById('word-list').innerHTML=''; return; }

      const showJa   = document.getElementById('show-ja').checked;
      const showKana = document.getElementById('show-kana').checked;
      const showRo   = document.getElementById('show-ro').checked;
      const showEn   = document.getElementById('show-en').checked;

      const items = DATA.slice(0, MAX_ITEMS);
      document.getElementById('limit-note').style.display = DATA.length > MAX_ITEMS ? 'block' : 'none';

      const html = items.map(item=>{
        const line1 = `<div class="line meta">${esc(levelSel.value)} ・ ${esc(partSel.value)}</div>`;
        const line2 = showJa   ? `<div class="line"><strong>${jaWithStrictRuby(item)}</strong></div>` : '';
        const line3 = showKana ? `<div class="line">${esc(item.kana||'')}</div>` : '';
        const line4 = showRo   ? `<div class="line">${esc(item.ro||'')}</div>` : '';
        const line5 = showEn   ? `<div class="line">${esc(item.en||'')}</div>` : '';

        const exHtml = Array.isArray(item.examples) ? item.examples.map(ex=>{
          return `
            <div class="ex">
              ${showEn   && ex.en   ? `<div>• ${esc(ex.en)}</div>`:''}
              ${showJa   && (ex.ja||ex.kana) ? `<div>${jaWithStrictRuby({ja:ex.ja||'', kana:ex.kana||'', segments:ex.segments||[]})}</div>`:''}
              ${showKana && ex.kana ? `<div>${esc(ex.kana)}</div>`:''}
              ${showRo   && ex.ro   ? `<div>${esc(ex.ro)}</div>`:''}
            </div>`;
        }).join('') : '';

        return `
          <article class="word-card" data-id="${esc(item.id||'')}">
            ${line1}${line2}${line3}${line4}${line5}
            <div class="word-actions">
              <button class="btn" onclick="(function(id){ ${'/* add to Learning */'} pushUnique('${LS_LEARNING}', id); alert('Added to Learning'); })('${esc(item.id||'')}')">Learn</button>
              <button class="btn" onclick="(function(id){ ${'/* move to Learned */'}  pushUnique('${LS_LEARNED}',  id); alert('Moved to Learned'); })('${esc(item.id||'')}')">Learned</button>
              ${exHtml ? `<span class="toggle" onclick="toggleExamples(this)">▼ Examples</span>`:''}
            </div>
            ${exHtml ? `<div class="examples">${exHtml}</div>`:''}
          </article>`;
      }).join('');

      document.getElementById('word-list').innerHTML = html || '<p class="notice">No items.</p>';
    }

    window.toggleExamples = function(el){
      const box = el.parentElement.nextElementSibling;
      if(!box) return;
      const open = box.style.display!=='none';
      box.style.display = open ? 'none' : 'block';
      el.textContent = open ? '▼ Examples' : '▲ Hide examples';
    };

    // 初回ロード
    syncAndLoad();
  </script>
</body>
</html>
