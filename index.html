<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JLPT — Words | nihongotext.com</title>
<link rel="icon" href="/favicon.ico" />
<base href="/" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  :root{--ink:#132c3a;--muted:#6b7280;--brand:#e6462d;--border:#e5e7eb;--card:#fff}
  html,body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif;color:var(--ink);line-height:1.7;background:#fff}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .select{border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:#fff}
  .toggle-row{display:flex;gap:18px;flex-wrap:wrap;margin:6px 0}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:820px){ .grid{grid-template-columns:1fr} }
  .card{border:1px solid var(--border);border-radius:14px;padding:14px 14px 12px;background:var(--card);box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .btn{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
  .btn.small{padding:4px 8px;font-size:.9rem}
  .btn.brand{border-color:#f2b3aa;background:#fef2f1;color:#b12b18}
  .btn[disabled]{opacity:.5;pointer-events:none}
  .pager{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin:10px 0 0}
  h1{margin:.2rem 0 1rem}
  details summary{cursor:pointer;user-select:none}
  details[open] summary .caret{transform:rotate(180deg)}
  .small{font-size:.9rem}
  ruby{ruby-position:over; ruby-align:start}
  rt{font-size:.6em;color:#666;letter-spacing:.03em}
  .legend{margin-top:8px}
  .legend .lv{margin:.3rem 0}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; color:#475569}
</style>

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-9QSHWJE0HZ');</script>
</head>
<body>
  <div id="header"></div>

  <main>
    <div class="wrap">
      <h1 class="row"><i class="fa-solid fa-shapes" style="color:#e6462d"></i> JLPT — Words</h1>

      <!-- レベル別の対応品詞（固定表示） -->
      <div class="legend small muted" id="legend">
        <div class="lv">N5 <span class="mono">verbs nouns adjective-i adjective-na adverbs numerals particles conjunctions interjections</span></div>
        <div class="lv">N4 <span class="mono">verbs nouns adjective-i adjective-na adverbs numerals particles conjunctions interjections</span></div>
        <div class="lv">N3 <span class="mono">adjective-i adjective-na adverbs numerals particles conjunctions</span></div>
        <div class="lv">N2 <span class="mono">verbs nouns adjective-i adjective-na adverbs numerals particles conjunctions interjections</span></div>
        <div class="lv">N1 <span class="mono">adjective-na interjections</span></div>
      </div>

      <!-- セレクタ -->
      <div class="row" style="margin-top:8px">
        <label class="row">Level
          <select id="sel-level" class="select">
            <option>N5</option><option>N4</option><option>N3</option><option>N2</option><option>N1</option>
          </select>
        </label>
        <label class="row">Part
          <select id="sel-part" class="select"></select>
        </label>
      </div>

      <!-- 表示切替 -->
      <div class="toggle-row">
        <label><input type="checkbox" id="chk-ja" checked> Nihongo（漢字+ふりがな）</label>
        <label><input type="checkbox" id="chk-kana" checked> Hiragana</label>
      </div>
      <div class="toggle-row">
        <label><input type="checkbox" id="chk-ro" checked> Alphabet（romaji）</label>
        <label><input type="checkbox" id="chk-en" checked> English</label>
      </div>

      <!-- 一覧 -->
      <section id="list" class="grid" aria-live="polite"></section>
      <!-- ページャ -->
      <div class="pager" id="pager"></div>
    </div>
  </main>

  <div id="footer"></div>

<script>
/* ========= 基本設定 ========= */
const PAGE_SIZE = 5;
const KP = 'nihongo_learning';
const KA = 'nihongo_learned';
const PARTS_BY_LEVEL = {
  N5:["verbs","nouns","adjective-i","adjective-na","adverbs","numerals","particles","conjunctions","interjections"],
  N4:["verbs","nouns","adjective-i","adjective-na","adverbs","numerals","particles","conjunctions","interjections"],
  N3:["adjective-i","adjective-na","adverbs","numerals","particles","conjunctions"],
  N2:["verbs","nouns","adjective-i","adjective-na","adverbs","numerals","particles","conjunctions","interjections"],
  N1:["adjective-na","interjections"]
};
const $ = s=>document.querySelector(s); const $id = id=>document.getElementById(id);
const qs=(k,d='')=>new URL(location.href).searchParams.get(k)||d;
const setQS=o=>{const u=new URL(location.href);Object.entries(o).forEach(([k,v])=>u.searchParams.set(k,v));history.replaceState(null,'',u.toString());};
const read=(k)=>{try{return JSON.parse(localStorage.getItem(k)||'[]')}catch{return[]}};
const write=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uniq=arr=>{const m=new Map();arr.forEach(x=>x&&x.id&&m.set(String(x.id),x));return[...m.values()]};
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* ========= ふりがな ========= */
function autoRuby(ja,kana){
  if(!ja) return esc(kana||ja||'');
  try{
    if(kana && ja.length===kana.length){
      let out=''; for(let i=0;i<ja.length;i++){
        const J=ja[i],K=kana[i]; out += (J===K)?esc(J):`<ruby>${esc(J)}<rt>${esc(K)}</rt></ruby>`;
      } return out;
    }
    return esc(ja);
  }catch{ return esc(ja); }
}
async function loadSegments(level, part){
  try{
    const res=await fetch(`/data/segments/${level}/${part}.json`,{cache:'no-store'});
    if(!res.ok) return {};
    const j=await res.json(); return j.overrides||{};
  }catch{return {}}
}

/* ========= データ読み込み ========= */
let CUR={level:'N5',part:'verbs',page:1}, MAIN={data:[]}, OV={};

async function loadMain(level, part){
  const url=`/data/json/${level}/${part}.json`;
  let res; try{res=await fetch(url,{cache:'no-store'})}catch(e){res=null}
  if(!res || !res.ok){
    $id('list').innerHTML = `<div class="card muted" style="grid-column:1/-1">Failed to load dataset.<br><span class="mono">${esc(url)}</span></div>`;
    $id('pager').innerHTML='';
    throw new Error('Load failed: '+url);
  }
  let data;
  try{ data = await res.json(); }
  catch{
    $id('list').innerHTML = `<div class="card muted" style="grid-column:1/-1">This file is not valid JSON.<br><span class="mono">${esc(url)}</span></div>`;
    $id('pager').innerHTML='';
    throw new Error('Invalid JSON: '+url);
  }
  const arr = Array.isArray(data?.data) ? data.data : (Array.isArray(data) ? data : (data.items||[]));
  return (arr||[]).map(x=>({level, pos:part, ...x}));
}

/* ========= 描画 ========= */
function nihongoHtml(it){ const o=OV[it.id]; if(o?.ruby_ja) return o.ruby_ja; return autoRuby(it.ja,it.kana); }
function exLine(it,i){
  const ex=it.examples?.[i]||{}; const o=OV[it.id];
  if(o && Array.isArray(o.ruby_examples) && o.ruby_examples[i]) return o.ruby_examples[i];
  const ja=autoRuby(ex.ja||'',ex.kana||''); const ro=esc(ex.ro||''); const en=esc(ex.en||'');
  return `${en?`・ ${en}`:''}${en&&(ex.ja||ex.kana||ro)?' / ':''}${ja}${ro?` / ${ro}`:''}`;
}
function card(it){
  const inLearning = read(KP).some(x=>x.id===it.id);
  return `
  <article class="card" data-id="${esc(it.id)}">
    <div class="muted small">${esc(it.level)} ${esc(it.pos)}</div>
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="line-ja" ${$id('chk-ja').checked?'':'hidden'} style="font-size:1.1rem">${nihongoHtml(it)}</div>
        <div class="line-kana" ${$id('chk-kana').checked?'':'hidden'}>${esc(it.kana||'')}</div>
        <div class="line-ro" ${$id('chk-ro').checked?'':'hidden'}>${esc(it.ro||'')}</div>
        <div class="line-en" ${$id('chk-en').checked?'':'hidden'}>${esc(it.en||'')}</div>
      </div>
      <div class="row">
        <button class="btn small ${inLearning?'brand':''}" data-action="learn">${inLearning?'<i class="fa-solid fa-book-open"></i> Learning':'<i class="fa-regular fa-bookmark"></i> Learn'}</button>
        <button class="btn small" data-action="learned"><i class="fa-regular fa-circle-check"></i> Learned</button>
      </div>
    </div>
    <details style="margin-top:8px">
      <summary class="row small"><span class="caret">▾</span> Examples</summary>
      <div class="small" style="margin-top:6px">
        ${(it.examples||[]).map((_,i)=>`<div>${exLine(it,i)}</div>`).join('')||'<div class="muted">No examples.</div>'}
      </div>
    </details>
  </article>`;
}
function render(){
  const start=(CUR.page-1)*PAGE_SIZE;
  const slice=MAIN.slice(start,start+PAGE_SIZE);
  $id('list').innerHTML = slice.length ? slice.map(card).join('') : `<div class="card muted" style="grid-column:1/-1">No items.</div>`;
  const pages = Math.max(1, Math.ceil(MAIN.length/PAGE_SIZE));
  let h=`<button class="btn small" data-page="${Math.max(1,CUR.page-1)}" ${CUR.page<=1?'disabled':''}>&lt; Prev</button>`;
  for(let i=1;i<=pages;i++){
    h+=`<button class="btn small ${i===CUR.page?'brand':''}" data-page="${i}">${i}</button>`;
    if(i>=CUR.page+4 && i<pages){ h+=`<span class="muted">…</span><button class="btn small" data-page="${pages}">${pages}</button>`; break; }
  }
  h+=`<button class="btn small" data-page="${Math.min(pages,CUR.page+1)}" ${CUR.page>=pages?'disabled':''}>Next &gt;</button>`;
  $id('pager').innerHTML=h;
}

/* ========= 学習操作（ヘッダー連携） ========= */
function tie(it){return {id:it.id,level:it.level,pos:it.pos,ja:it.ja,kana:it.kana,ro:it.ro,en:it.en,examples:it.examples||[]}}
function updateHeaderBadges(){
  const lc = uniq(read(KP)).length, ld = uniq(read(KA)).length;
  const b1 = document.getElementById('nt-badge-learning');
  const b2 = document.getElementById('nt-badge-learned');
  if(b1) b1.textContent = lc;
  if(b2) b2.textContent = ld;
  document.dispatchEvent(new CustomEvent('nt:updateCounts',{detail:{learning:lc, learned:ld}}));
}
function onClick(ev){
  const btn=ev.target.closest('button'); if(!btn) return;
  if(btn.dataset.page){ CUR.page=parseInt(btn.dataset.page,10)||1; setQS({page:CUR.page}); render(); return; }
  const card=ev.target.closest('[data-id]'); if(!card) return;
  const id=card.dataset.id; const it = MAIN.find(x=>x.id===id); if(!it) return;
  if(btn.dataset.action==='learn'){
    let a=read(KP); if(!a.some(x=>x.id===id)) a=uniq([...a,tie(it)]); write(KP,a);
    write(KA, read(KA).filter(x=>x.id!==id));
  }
  if(btn.dataset.action==='learned'){
    let a=read(KA); if(!a.some(x=>x.id===id)) a=uniq([...a,tie(it)]); write(KA,a);
    write(KP, read(KP).filter(x=>x.id!==id));
  }
  updateHeaderBadges(); render();
}

/* ========= セレクタ ========= */
async function buildParts(level){
  // 定義上の候補を「存在チェック」で絞る
  const candidates = PARTS_BY_LEVEL[level]||[];
  const exist = [];
  for(const p of candidates){
    const url=`/data/json/${level}/${p}.json`;
    try{ const r=await fetch(url,{method:'GET',cache:'no-store'}); if(r.ok){ exist.push(p); } }catch{}
  }
  if(exist.length===0){ $id('sel-part').innerHTML=''; return []; }
  $id('sel-part').innerHTML = exist.map(p=>`<option value="${p}">${p}</option>`).join('');
  return exist;
}

/* ========= 初期化 ========= */
async function reload(){
  try{
    MAIN = await loadMain(CUR.level, CUR.part);
    OV = await loadSegments(CUR.level, CUR.part);
    render();
  }catch(e){ console.warn(e); }
  updateHeaderBadges();
}

document.addEventListener('DOMContentLoaded', async ()=>{
  // ヘッダー/フッター
  const [h,f]=await Promise.all([fetch('/partials/header.html'),fetch('/partials/footer.html')]);
  $id('header').innerHTML=await h.text();
  $id('footer').innerHTML=await f.text();

  // ヘッダーボタンのクリック連携（必要ならここで遷移先を指定）
  document.addEventListener('click', (e)=>{
    const bL = e.target.closest('#nt-btn-learning');
    const bD = e.target.closest('#nt-btn-learned');
    if(bL){ /* 例：learning.html へ */ /* location.href='/learning/'; */ e.preventDefault(); }
    if(bD){ /* 例：learned.html へ */  /* location.href='/learned/';  */ e.preventDefault(); }
  });

  // 選択状態
  CUR.level = qs('level','N5'); CUR.page = parseInt(qs('page','1'),10)||1;
  const parts = await buildParts(CUR.level);
  CUR.part = parts.includes(qs('part','verbs')) ? qs('part','verbs') : (parts[0]||'');
  $id('sel-level').value = CUR.level; $id('sel-part').value = CUR.part;

  // チェンジイベント
  $id('sel-level').addEventListener('change', async ()=>{
    CUR.level = $id('sel-level').value; CUR.page=1;
    const ps = await buildParts(CUR.level);
    CUR.part = ps[0]||''; $id('sel-part').value = CUR.part;
    setQS({level:CUR.level,part:CUR.part,page:CUR.page});
    await reload();
  });
  $id('sel-part').addEventListener('change', async ()=>{
    CUR.part = $id('sel-part').value; CUR.page=1;
    setQS({level:CUR.level,part:CUR.part,page:CUR.page});
    await reload();
  });

  // 表示トグル
  ['chk-ja','chk-kana','chk-ro','chk-en'].forEach(id=> $id(id).addEventListener('change', render));
  document.body.addEventListener('click', onClick);

  await reload();
});
</script>
</body>
</html>
