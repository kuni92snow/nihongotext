<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>nihongotext.com</title>
  <base href="/" />
  <link rel="icon" href="/icon-512.png"/>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9QSHWJE0HZ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-9QSHWJE0HZ');
  </script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- AdSense（publisher id を本番値に） -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2358198194205084" crossorigin="anonymous"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; color:#222; margin:0; }
    main { max-width:1100px; margin:24px auto; padding:0 16px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px,1fr)); gap:12px; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; background:#fff; }
    .card h3 { margin:0 0 6px; font-size:18px; }
    .meta { color:#666; font-size:12px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .btn { padding:6px 10px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer; }
    .btn i { color:#e6462d; }
    .examples { margin-top:8px; font-size:14px; color:#333; border-top:1px dashed #eee; padding-top:8px; }
    .pager { display:flex; gap:8px; align-items:center; justify-content:center; margin:24px 0; }
    .pager button { padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer; }
    .pager .num { min-width:36px; text-align:center; }
    /* Ad modal */
    #adMask { position:fixed; inset:0; background:rgba(0,0,0,0.35); display:none; z-index:90; }
    #adMask.show { display:block; }
    #adPopup {
      position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width: min(720px, 96vw); max-height: 85vh; overflow:auto;
      background:#fff; border-radius:12px; box-shadow: 0 20px 40px rgba(0,0,0,.2); z-index:100;
    }
    #adPopup .hd { display:flex; justify-content:space-between; align-items:center; gap:8px; border-bottom:1px solid #eee; padding:12px 14px; }
    #adPopup .bd { padding:12px 14px; }
    #adPopup .ft { padding:10px 14px; border-top:1px solid #eee; text-align:right; }
    #adFallback { display:none; margin-top:10px; border:1px solid #eee; border-radius:8px; padding:10px; }
    #adFallback a { color:#e6462d; text-decoration:none; }
  </style>
</head>
<body>
  <!-- Partials -->
  <div id="header-placeholder"></div>

  <main>
    <h1 style="color:#e6462d; font-size:24px; margin:10px 0 16px;">JLPT N5 — Verbs (demo)</h1>

    <!-- 単語カード（デモ）。実際はJSONから生成 -->
    <section id="word-list" class="grid"></section>

    <!-- ページャー -->
    <div class="pager" aria-label="Pagination">
      <button class="prev btn" data-page="prev"><i class="fa-solid fa-chevron-left"></i> Prev</button>
      <button class="num btn" data-page="1">1</button>
      <button class="num btn" data-page="2">2</button>
      <button class="num btn" data-page="3">3</button>
      <button class="next btn" data-page="next">Next <i class="fa-solid fa-chevron-right"></i></button>
    </div>
  </main>

  <div id="footer-placeholder"></div>

  <!-- ====== 広告モーダル ====== -->
  <div id="adMask" role="dialog" aria-modal="true" aria-labelledby="adTitle">
    <div id="adPopup">
      <div class="hd">
        <h3 id="adTitle" style="margin:0; font-size:16px; display:flex; align-items:center; gap:8px; color:#333;">
          <i class="fa-solid fa-bullhorn" style="color:#e6462d;"></i> Sponsored
        </h3>
        <button id="adCloseBtn" class="btn" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="bd">
        <!-- AdSense slot（publisher / slot を実値に） -->
        <div id="amznAdBox" style="margin:8px 0;">
          <ins class="adsbygoogle"
               style="display:block; min-height:220px"
               data-ad-client="ca-pub-2358198194205084"
               data-ad-slot="3714541070"
               data-ad-format="auto"
               data-full-width-responsive="true"></ins>
        </div>

        <!-- フォールバック（Preplyなど） -->
        <div id="adFallback">
          <a href="https://preply.com/" target="_blank" rel="noopener" style="display:flex; gap:10px; align-items:center;">
            <img src="/assets/preply-banner.png" alt="Find a Japanese tutor on Preply" style="width:96px; height:96px; object-fit:cover; border-radius:8px; border:1px solid #eee;">
            <div>
              <div style="font-weight:600; font-size:16px; color:#333;">Find a Japanese tutor on Preply</div>
              <div style="color:#666; font-size:14px;">1-on-1 lessons that match your pace. Click to explore tutors.</div>
            </div>
          </a>
        </div>
      </div>
      <div class="ft">
        <button id="adOkBtn" class="btn"><i class="fa-solid fa-check"></i> OK</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 共通パーシャル読込 =====
    async function loadPartials() {
      try {
        const [hdr, ftr] = await Promise.all([
          fetch("/partials/header.html").then(r=>r.text()),
          fetch("/partials/footer.html").then(r=>r.text())
        ]);
        document.getElementById("header-placeholder").innerHTML = hdr;
        document.getElementById("footer-placeholder").innerHTML = ftr;
      } catch(e) {
        console.error("Failed to load partials:", e);
      }
    }

    // ===== デモ用データ（実際は /data/json/N5/verbs.json 等から取得） =====
    const DEMO = [
      { id:"n5-verb-001", en:"to meet", ja:"会う", kana:"あう", ro:"au", level:"N5", pos:"verb",
        examples:[ {en:"I meet my friend.", ja:"友達に会う。", ro:"tomodachi ni au."} ] },
      { id:"n5-verb-002", en:"to open", ja:"開ける", kana:"あける", ro:"akeru", level:"N5", pos:"verb",
        examples:[ {en:"Open the window.", ja:"窓を開ける。", ro:"mado o akeru."} ] },
      { id:"n5-verb-003", en:"to go", ja:"行く", kana:"いく", ro:"iku", level:"N5", pos:"verb",
        examples:[ {en:"I go to school.", ja:"学校へ行く。", ro:"gakkou e iku."} ] },
      { id:"n5-verb-004", en:"to read", ja:"読む", kana:"よむ", ro:"yomu", level:"N5", pos:"verb",
        examples:[ {en:"Read a book.", ja:"本を読む。", ro:"hon o yomu."} ] },
      { id:"n5-verb-005", en:"to write", ja:"書く", kana:"かく", ro:"kaku", level:"N5", pos:"verb",
        examples:[ {en:"Write a letter.", ja:"手紙を書く。", ro:"tegami o kaku."} ] }
    ];

    // ===== 単語レンダリング =====
    function renderList(data) {
      const wrap = document.getElementById('word-list');
      wrap.innerHTML = data.map(item => {
        const ex = (item.examples||[]).map((e,i)=>`<div>• ${[e.en, e.ja, e.ro].filter(Boolean).join(' / ')}</div>`).join("");
        return `
          <article class="card" data-id="${item.id}">
            <h3>${item.en} <span class="meta">(${item.ja} / ${item.ro})</span></h3>
            <div class="meta">${item.level || ''} ${item.pos ? '· ' + item.pos : ''}</div>
            <div class="actions">
              <button class="btn btn-learn"><i class="fa-solid fa-book-open"></i> Learn</button>
            </div>
            <div class="examples">${ex}</div>
          </article>
        `;
      }).join("");

      // Learn クリック → Learning に追加
      wrap.querySelectorAll('.btn-learn').forEach(btn => {
        btn.addEventListener('click', (ev) => {
          const card = ev.currentTarget.closest('.card');
          const id = card.getAttribute('data-id');
          const item = data.find(x => String(x.id) === String(id));
          if (!item) return;
          // ヘッダー実装の公開APIを使用
          if (window.NT && typeof window.NT.addToLearning === 'function') {
            window.NT.addToLearning({
              id: item.id,
              en: item.en, ja: item.ja, kana: item.kana || '', ro: item.ro || '',
              level: item.level, pos: item.pos,
              examples: Array.isArray(item.examples) ? item.examples : []
            });
          }
          // 視覚的な即時反映（任意）
          ev.currentTarget.textContent = 'Learning';
        });
      });
    }

    // ===== ページャー（クリックで広告モーダル） =====
    function bindPager() {
      const pager = document.querySelector('.pager');
      if (!pager) return;
      pager.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        // ここで実際のページ切替処理（JSON再読込等）を先に走らせてもOK
        showAdPopup();
      });
    }

    // ===== 広告ポップアップ =====
    function showAdPopup() {
      const mask = document.getElementById('adMask');
      const closeBtn = document.getElementById('adCloseBtn');
      const okBtn = document.getElementById('adOkBtn');
      const fb = document.getElementById('adFallback');
      const box = document.getElementById('amznAdBox');
      const ins = box ? box.querySelector('ins.adsbygoogle') : null;

      if (!mask) return;
      mask.classList.add('show');

      function close() { mask.classList.remove('show'); }

      if (closeBtn) closeBtn.onclick = close;
      if (okBtn) okBtn.onclick = close;
      mask.addEventListener('click', (ev) => {
        if (ev.target === mask) close();
      });

      // AdSense 試行 → 2秒反応なければフォールバック
      let done = false;
      function revealFallback(){
        if (done) return;
        done = true;
        if (fb) fb.style.display = 'block';
      }

      try {
        if (ins) {
          ins.style.display = 'block';
          (window.adsbygoogle = window.adsbygoogle || []).push({});
          const startH = ins.offsetHeight;
          setTimeout(() => {
            const nowH = ins.offsetHeight;
            if (!nowH || nowH === startH) revealFallback();
          }, 2000);
        } else {
          revealFallback();
        }
      } catch(_) {
        revealFallback();
      }
    }

    // ===== 起動 =====
    (async function init() {
      await loadPartials();
      renderList(DEMO);
      bindPager();
    })();
  </script>
</body>
</html>
